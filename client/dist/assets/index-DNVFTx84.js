(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))l(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&l(c)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function l(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();const at=25,kt=1e3/at,R=2400,O=2400,Ge=280,X=32,Z=2.5,Xe=16,qe=18,Pt=1.5,xe=1,be=2,Ee=4,Se=8,rt=0,Ct=1,dt=2;function Nt(e,t){const n=new ArrayBuffer(4),l=new DataView(n);return l.setUint8(0,Ct),l.setUint16(1,e,!0),l.setUint8(3,t&255),n}function G(e,t){const n=e.getUint8(t);if(n===0)return{s:"",next:t+1};const l=new Uint8Array(e.buffer,t+1,n);return{s:new TextDecoder().decode(l),next:t+1+n}}function Rt(e){const t=new DataView(e);let n=0;if(t.getUint8(n++)!==dt)throw new Error("Invalid snapshot message");const l=t.getUint32(n,!0);n+=4;const o=t.getUint32(n,!0);n+=4;const i=t.getUint8(n++),c=[];for(let w=0;w<i;w++){const{s:v,next:L}=G(t,n);n=L;const{s:a,next:g}=G(t,n);n=g;const T=t.getFloat32(n,!0);n+=4;const M=t.getFloat32(n,!0);n+=4;const I=t.getFloat32(n,!0);n+=4;const J=t.getFloat32(n,!0);n+=4;const W=t.getFloat32(n,!0);n+=4;const j=t.getUint32(n,!0);n+=4;const Ie=t.getUint8(n++),A=[];for(let We=0;We<Ie;We++){const{s:At,next:Bt}=G(t,n);n=Bt,A.push(At)}const te=t.getUint32(n,!0);n+=4;const Mt=t.getUint8(n++);c.push({id:v,displayName:a||v,x:T,y:M,vx:I,vy:J,size:W,totalAdoptions:j,petsInside:A,speedBoostUntil:te,inputSeq:Mt})}const y=t.getUint8(n++),d=[];for(let w=0;w<y;w++){const{s:v,next:L}=G(t,n);n=L;const a=t.getFloat32(n,!0);n+=4;const g=t.getFloat32(n,!0);n+=4;const T=t.getFloat32(n,!0);n+=4;const M=t.getFloat32(n,!0);n+=4;const I=t.getUint8(n++),{s:J,next:W}=G(t,n-1);n=W;const j=I===0?null:J;d.push({id:v,x:a,y:g,vx:T,vy:M,insideShelterId:j})}const f=t.getUint8(n++),h=[];for(let w=0;w<f;w++){const{s:v,next:L}=G(t,n);n=L;const a=t.getFloat32(n,!0);n+=4;const g=t.getFloat32(n,!0);n+=4;const T=t.getFloat32(n,!0);n+=4,h.push({id:v,x:a,y:g,radius:T})}const x=t.getUint8(n++),S=[];for(let w=0;w<x;w++){const{s:v,next:L}=G(t,n);n=L;const a=t.getFloat32(n,!0);n+=4;const g=t.getFloat32(n,!0);n+=4;const T=t.getUint8(n++);S.push({id:v,x:a,y:g,type:T})}return{tick:l,matchEndAt:o,players:c,pets:d,adoptionZones:h,pickups:S}}const ut="rescueworld_music",ft="rescueworld_sfx";function yt(e,t){try{const n=localStorage.getItem(e);if(n==="0"||n==="false")return!1;if(n==="1"||n==="true")return!0}catch{}return t}function ht(e,t){try{localStorage.setItem(e,t?"1":"0")}catch{}}function Ce(){return yt(ut,!0)}function Ut(e){ht(ut,e),E&&(E.volume=e?1:0),!e&&E&&E.pause()}function mt(){return yt(ft,!0)}function Ot(e){ht(ft,e)}let se=null;function Dt(){if(se)return se;try{se=new(window.AudioContext||window.webkitAudioContext)}catch{return null}return se}function P(e,t,n="sine",l=.3){if(!mt())return;const o=Dt();if(o)try{const i=o.createOscillator(),c=o.createGain();i.connect(c),c.connect(o.destination),i.frequency.value=e,i.type=n,c.gain.setValueAtTime(l,o.currentTime),c.gain.exponentialRampToValueAtTime(.001,o.currentTime+t),i.start(o.currentTime),i.stop(o.currentTime+t)}catch{}}function Ft(){P(523,.12,"sine",.25),setTimeout(()=>P(659,.1,"sine",.2),80)}function _t(){P(440,.08,"square",.2),setTimeout(()=>P(880,.08,"square",.15),60)}function Ht(){P(392,.1,"sine",.25),setTimeout(()=>P(523,.12,"sine",.22),70),setTimeout(()=>P(659,.15,"sine",.2),140)}function zt(){P(330,.06,"sine",.18)}function $t(){P(523,.15,"sine",.25),setTimeout(()=>P(659,.15,"sine",.22),120),setTimeout(()=>P(784,.2,"sine",.2),240)}function Yt(){P(440,.08,"sine",.2),setTimeout(()=>P(554,.08,"sine",.18),80),setTimeout(()=>P(659,.12,"sine",.2),160)}let E=null;function Kt(){var l;const e=import.meta,t=typeof((l=e.env)==null?void 0:l.BASE_URL)=="string"?e.env.BASE_URL:"/";return t.endsWith("/")?`${t}music.mp3`:`${t}/music.mp3`}function _e(){if(Ce())try{E||(E=new Audio,E.loop=!0,E.volume=1,E.preload="auto",E.src=Kt(),E.addEventListener("error",()=>{E&&!E.src.endsWith("/music.mp3")&&(E.src="/music.mp3",E.play().catch(()=>{}))}),E.load()),E.volume=Ce()?1:0;const e=E.play();e&&typeof e.catch=="function"&&e.catch(()=>{})}catch{}}const Wt=(()=>{const{protocol:e,host:t}=window.location;return`${e==="https:"?"wss:":"ws:"}//${t}/ws-signaling`})();let fe=0,Gt=0;const D={};let K=null,m=null,N=null,u=null;const ye=new Map,he=new Map,Xt=100;let r=null,Je=0,je=0,Ze=0,Ve=0,Qe=!1,gt=0,Ne=0,Le=0,ie=null;const qt=200,b=document.getElementById("game"),s=b.getContext("2d"),Jt=document.getElementById("minimap"),p=Jt.getContext("2d"),jt=document.getElementById("score"),Zt=document.getElementById("carried"),et=document.getElementById("tag-cooldown"),Vt=document.getElementById("timer"),ee=document.getElementById("leaderboard"),k=document.getElementById("connection-overlay"),tt=document.getElementById("how-to-play"),Qt=document.getElementById("settings-btn"),pt=document.getElementById("settings-panel"),ae=document.getElementById("music-toggle"),Re=document.getElementById("sfx-toggle"),en=document.getElementById("settings-close");document.getElementById("ping");const tn=document.getElementById("switch-server"),nn=document.getElementById("switch-server-btn"),Te=document.getElementById("auth-area"),xt=document.getElementById("landing"),Ue=document.getElementById("game-wrap"),on=document.getElementById("landing-play"),$=document.getElementById("landing-nick"),Me=document.getElementById("landing-profile-name"),Ae=document.getElementById("landing-profile-avatar"),Be=document.getElementById("landing-profile-actions"),re=document.getElementById("landing-auth-buttons"),He=document.getElementById("cookie-banner"),sn=document.getElementById("cookie-accept"),ln=document.getElementById("cookie-essential"),de=document.getElementById("fight-ally-overlay"),cn=document.getElementById("fight-ally-name"),an=document.getElementById("fight-ally-fight"),rn=document.getElementById("fight-ally-ally"),le=document.getElementById("lobby-overlay"),nt=document.getElementById("lobby-message"),ke=document.getElementById("lobby-countdown"),V=document.getElementById("lobby-ready-btn"),ze="cookieConsent";let q=null;const dn=new Set;let Y="playing",Pe=0,un=0,me=!1;const bt="rescueworld_money",ge={size:50,speed:30,adoptSpeed:40};let we="ffa";const B={sizeBonus:0,speedBoost:!1,adoptSpeed:!1};function pe(){return parseInt(localStorage.getItem(bt)||"0",10)}function Et(e){localStorage.setItem(bt,String(Math.max(0,e)))}function ve(){const e=document.getElementById("landing-money");e&&(e.textContent=`Money: ${pe()}`);const t=pe();document.querySelectorAll(".landing-buy").forEach(n=>{const l=n.dataset.boost;if(!l||!(l in ge))return;const o=ge[l];n.disabled=t<o||l==="speed"&&B.speedBoost||l==="adoptSpeed"&&B.adoptSpeed})}async function fn(){try{const t=await(await fetch("/auth/me",{credentials:"include"})).json(),{displayName:n,signedIn:l}=t,o=n??"";if(l&&o)Te.innerHTML=`
        <span class="auth-profile">${ot(o)}</span>
        <a href="/auth/signout" class="auth-link">Sign out</a>
      `,Me.textContent=o,Ae.textContent=o.charAt(0).toUpperCase(),Be.innerHTML='<a href="/auth/signout" class="auth-link" style="font-size:12px">Sign out</a>',re.innerHTML='<a href="/auth/google" class="auth-link" style="display:inline-block">Sign in with Google</a> <a href="#" id="landing-facebook" style="opacity:0.7">Sign in with Facebook</a>',$&&($.placeholder=o);else{const i=o?`Guest · ${ot(o)}`:"Guest";Te.innerHTML=`
        <a href="/auth/google" class="auth-link">Sign in with Google</a>
        <span class="auth-guest">${i}</span>
      `,Me.textContent=o||"Guest",Ae.textContent=o?o.charAt(0).toUpperCase():"?",Be.innerHTML="",re.innerHTML=`
        <a href="/auth/google">Sign in with Google</a>
        <a href="#" id="landing-facebook" style="opacity:0.7">Sign in with Facebook</a>
      `,$&&($.placeholder=o||"rescue123")}$&&o&&($.value=o)}catch{Te.innerHTML=`
      <a href="/auth/google" class="auth-link">Sign in with Google</a>
      <span class="auth-guest">Guest</span>
    `,Me.textContent="Guest",Ae.textContent="?",Be.innerHTML="",re.innerHTML='<a href="/auth/google">Sign in with Google</a> <a href="#" id="landing-facebook" style="opacity:0.7">Sign in with Facebook</a>',$&&($.placeholder="rescue123")}}function ot(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function St(){const e=window.innerWidth,t=window.innerHeight;b.width=e,b.height=t}function U(e,t){t?fe|=e:fe&=~e}function yn(e){D[e.code]=!0,(e.code==="KeyW"||e.code==="ArrowUp")&&U(Ee,!0),(e.code==="KeyS"||e.code==="ArrowDown")&&U(Se,!0),(e.code==="KeyA"||e.code==="ArrowLeft")&&U(xe,!0),(e.code==="KeyD"||e.code==="ArrowRight")&&U(be,!0),e.preventDefault()}function hn(e){D[e.code]=!1,(e.code==="KeyW"||e.code==="ArrowUp")&&U(Ee,!1),(e.code==="KeyS"||e.code==="ArrowDown")&&U(Se,!1),(e.code==="KeyA"||e.code==="ArrowLeft")&&U(xe,!1),(e.code==="KeyD"||e.code==="ArrowRight")&&U(be,!1),e.preventDefault()}function mn(){if(!K||!r)return{dx:0,dy:0};const e=b.getBoundingClientRect(),t=b.width/e.width,n=b.height/e.height,l=(K.x-e.left)*t,o=(K.y-e.top)*n,i=It(),c=l-i.x+i.w/2,y=o-i.y+i.h/2,d=c-r.x,f=y-r.y,h=Math.hypot(d,f)||1;return{dx:d/h,dy:f/h}}function gn(){return!!(D.KeyW||D.KeyS||D.KeyA||D.KeyD||D.ArrowUp||D.ArrowDown||D.ArrowLeft||D.ArrowRight)}function pn(){if(gn())return;const{dx:e,dy:t}=mn();U(xe,e<-.3),U(be,e>.3),U(Ee,t<-.3),U(Se,t>.3)}let wt=0,vt=0,Oe=0,De=0;b.addEventListener("touchstart",e=>{e.preventDefault(),e.touches.length&&(K={x:e.touches[0].clientX,y:e.touches[0].clientY},wt=e.touches[0].clientX,vt=e.touches[0].clientY,Oe=e.touches[0].clientX,De=e.touches[0].clientY)});b.addEventListener("touchmove",e=>{if(e.preventDefault(),e.touches.length){const t=e.touches[0].clientX,n=e.touches[0].clientY;!ue&&Math.hypot(t-wt,n-vt)>xn&&(ue=!0,K=null),ue?(bn(t-Oe,n-De),Oe=t,De=n):K={x:t,y:n}}});b.addEventListener("touchend",e=>{e.preventDefault(),e.touches.length===0&&(K=null,ue=!1)});b.addEventListener("mousedown",e=>{e.preventDefault()});b.addEventListener("mousemove",e=>{e.preventDefault()});b.addEventListener("mouseup",e=>{e.preventDefault()});b.addEventListener("contextmenu",e=>{e.preventDefault()});window.addEventListener("keydown",yn);window.addEventListener("keyup",hn);let H=null,z=null;const st=.22;let ne=0,oe=0;const xn=10;let ue=!1,F=null,_=null;const it=.28;function It(){const e=b.width,t=b.height;let n=(r==null?void 0:r.x)??R/2,l=(r==null?void 0:r.y)??O/2;(!Number.isFinite(n)||!Number.isFinite(l))&&(n=R/2,l=O/2);let o=n-e/2+ne,i=l-t/2+oe;if(o=Math.max(0,Math.min(R-e,o)),i=Math.max(0,Math.min(O-t,i)),r==null)return H=null,z=null,{x:o,y:i,w:e,h:t};H==null||z==null||!Number.isFinite(H)||!Number.isFinite(z)?(H=o,z=i):(H+=(o-H)*st,z+=(i-z)*st);let c=H,y=z;return(!Number.isFinite(c)||!Number.isFinite(y))&&(c=o,y=i,H=c,z=y),c=Math.max(0,Math.min(R-e,c)),y=Math.max(0,Math.min(O-t,y)),{x:c,y,w:e,h:t}}function bn(e,t){ne-=e,oe-=t;const n=b.width,l=b.height,o=(r==null?void 0:r.x)??R/2,i=(r==null?void 0:r.y)??O/2,c=Math.max(0,R-n),y=Math.max(0,O-l),d=-(o-n/2),f=c-(o-n/2),h=-(i-l/2),x=y-(i-l/2);ne=Math.max(d,Math.min(f,ne)),oe=Math.max(h,Math.min(x,oe))}function En(e,t,n){let l=0,o=0;t&xe&&(l-=1),t&be&&(l+=1),t&Ee&&(o-=1),t&Se&&(o+=1);let i=0,c=0;if(l!==0||o!==0){const h=Math.hypot(l,o)||1,S=((e.speedBoostUntil??0)>0?Ge*Pt:Ge)*n;i=l/h*S,c=o/h*S}const y=X+e.size*4;let d=e.x+i,f=e.y+c;return d=Math.max(y,Math.min(R-y,d)),f=Math.max(y,Math.min(O-y,f)),{...e,x:d,y:f,vx:i,vy:c,petsInside:[...e.petsInside],speedBoostUntil:e.speedBoostUntil??0}}const lt=1e4;function $e(e){k.classList.remove("hidden"),k.innerHTML=`
    <h2>Could not connect</h2>
    <p class="error">${e}</p>
    <p>The game server is not running or not reachable.</p>
    <p><strong>To start the game:</strong></p>
    <p>From the project root folder, run: <code>npm run dev</code></p>
    <p>That starts both the server (ports 4000, 4001) and the client. Wait a few seconds, then refresh this page.</p>
    <p>Or run in two terminals: first <code>npm run dev:server</code>, then <code>npm run dev:client</code>.</p>
  `}async function Ye(e){ie&&(clearInterval(ie),ie=null),tn.classList.add("hidden");let t="ws://localhost:4001";const n=new WebSocket(Wt);await new Promise((o,i)=>{const c=setTimeout(()=>{n.close(),i(new Error("Connection timeout. Is the server running? Run: npm run dev"))},lt);n.onopen=()=>{n.send(JSON.stringify({type:"join",latency:e==null?void 0:e.latency,mode:(e==null?void 0:e.mode)??"ffa"}))},n.onmessage=y=>{try{const d=JSON.parse(y.data);d.type==="joined"&&d.gameUrl&&(clearTimeout(c),t=d.gameUrl,o())}catch{}},n.onerror=()=>{clearTimeout(c),i(new Error("WebSocket error. Server not running?"))},n.onclose=()=>{clearTimeout(c),n.readyState!==WebSocket.OPEN&&i(new Error("Signaling connection closed. Run: npm run dev"))}});const l=new WebSocket(t);l.binaryType="arraybuffer",l.onopen=()=>{m=l,m.send(JSON.stringify({type:"mode",mode:(e==null?void 0:e.mode)??"ffa"})),(B.sizeBonus>0||B.speedBoost||B.adoptSpeed)&&(m.send(JSON.stringify({type:"startingBoosts",sizeBonus:B.sizeBonus,speedBoost:B.speedBoost,adoptSpeed:B.adoptSpeed})),B.sizeBonus=0,B.speedBoost=!1,B.adoptSpeed=!1)},l.onmessage=o=>{var c,y;if(typeof o.data=="string"){try{const d=JSON.parse(o.data);d.type==="welcome"&&d.playerId&&(N=d.playerId,Yt()),d.type==="matchState"&&typeof d.phase=="string"&&(Y=d.phase,Pe=typeof d.countdownRemainingSec=="number"?d.countdownRemainingSec:0,un=typeof d.readyCount=="number"?d.readyCount:0,Y==="lobby"?(le.classList.remove("hidden"),nt.textContent="Waiting for another player…",ke.classList.add("hidden"),V.classList.add("hidden")):Y==="countdown"?(le.classList.remove("hidden"),nt.textContent="Match starting soon",ke.classList.remove("hidden"),ke.textContent=Pe>0?`Starting in ${Pe}s…`:"Starting…",V.classList.remove("hidden"),me?V.textContent="Ready!":V.textContent="Ready"):le.classList.add("hidden")),d.type==="pong"&&typeof d.ts=="number"&&(Ne=Math.round(Date.now()-d.ts),Ne>qt?Le=Le||Date.now():Le=0)}catch{}return}const i=o.data;if(!(i.byteLength<1)&&new DataView(i).getUint8(0)===dt){const d=Rt(i);u=d,Y!=="playing"&&(Y="playing",le.classList.add("hidden"));for(const h of d.players){const x=((c=ye.get(h.id))==null?void 0:c.next)??h;ye.set(h.id,{prev:x,next:{...h},t:0})}for(const h of d.pets){const x=((y=he.get(h.id))==null?void 0:y.next)??h;he.set(h.id,{prev:x,next:{...h},t:0})}const f=d.players.find(h=>h.id===N);if(f){f.size>Je&&(gt=Date.now()+1500,Ft()),(f.speedBoostUntil??0)>Ve&&_t(),Ve=f.speedBoostUntil??0,f.totalAdoptions>je&&Ht(),je=f.totalAdoptions,f.petsInside.length>Ze&&zt(),Ze=f.petsInside.length,Je=f.size;const h=(r==null?void 0:r.x)??f.x,x=(r==null?void 0:r.y)??f.y;r={...f,petsInside:[...f.petsInside]},f.inputSeq,Math.hypot(f.x-h,f.y-x)>300&&(H=null,z=null,ne=0,oe=0,F=f.x,_=f.y)}}},l.onclose=()=>{m=null,N=null,u=null,r=null,Y="playing",me=!1},await new Promise((o,i)=>{const c=Date.now()+lt,y=()=>{(m==null?void 0:m.readyState)===WebSocket.OPEN?o():Date.now()>c?i(new Error("Game server connection timeout")):setTimeout(y,50)};y()}),k.classList.add("hidden"),tt.classList.remove("hidden"),setTimeout(()=>tt.classList.add("hidden"),12e3),_e(),ie=setInterval(()=>{(m==null?void 0:m.readyState)===WebSocket.OPEN&&m.send(JSON.stringify({type:"ping",ts:Date.now()}))},2e3)}let ce=0,ct=0;function Ke(e){ce||(ce=e);const t=Math.min((e-ce)/1e3,.1);ce=e,K&&pn();const n=u!=null&&u.matchEndAt>0&&u.tick>=u.matchEndAt,l=Y==="playing"&&!n;if(l&&(m==null?void 0:m.readyState)===WebSocket.OPEN&&e-ct>=kt){ct=e;const i=Nt(fe,Gt++);m.send(i)}if(l&&r&&N){const i=r.x,c=r.y;r=En(r,fe,t);const y=X+r.size*Z;if(u)for(const x of u.players){if(x.id===N)continue;const S=Fe(x.id)??x,w=X+S.size*Z,v=Math.hypot(r.x-S.x,r.y-S.y);if(v<y+w&&v>0){r={...r,x:i,y:c};break}}let d=r.x,f=r.y;(!Number.isFinite(d)||!Number.isFinite(f))&&(d=R/2,f=O/2),F==null||_==null?(F=d,_=f):(F+=(d-F)*it,_+=(f-_)*it),(!Number.isFinite(F)||!Number.isFinite(_))&&(F=d,_=f);let h=null;if(u){const x=F??r.x,S=_??r.y,w=X+r.size*Z;for(const v of u.players){if(v.id===N)continue;const L=Fe(v.id)??v,a=X+L.size*Z,g=Math.hypot(x-L.x,S-L.y);if(g<w+a&&g>0){h=v.id;break}}}if(h){const x=u.players.find(S=>S.id===h);q=h,cn.textContent=(x==null?void 0:x.displayName)??h,de.classList.remove("hidden")}else de.classList.add("hidden"),q=null}else F=null,_=null,de.classList.add("hidden"),q=null;const o=t*(1e3/Xt);for(const i of ye.values())i.t=Math.min(1,i.t+o);for(const i of he.values())i.t=Math.min(1,i.t+o);An(),requestAnimationFrame(Ke)}function Q(e,t,n){return e+(t-e)*n}function Fe(e){const t=ye.get(e);if(!t)return null;const n=t.t;return{...t.next,x:Q(t.prev.x,t.next.x,n),y:Q(t.prev.y,t.next.y,n),vx:Q(t.prev.vx,t.next.vx,n),vy:Q(t.prev.vy,t.next.vy,n)}}function Sn(e){const t=he.get(e);if(!t)return null;const n=t.t;return{...t.next,x:Q(t.prev.x,t.next.x,n),y:Q(t.prev.y,t.next.y,n)}}const C=36,wn=1.8;function Lt(e){let t=0;for(let l=0;l<e.length;l++)t=t*31+e.charCodeAt(l)>>>0;return`hsl(${t%360}, 72%, 58%)`}function vn(e){const t=C*2,n=Math.floor((e.x-t)/C)*C,l=Math.floor((e.y-t)/C)*C,o=Math.ceil((e.x+e.w+t)/C)*C,i=Math.ceil((e.y+e.h+t)/C)*C;s.fillStyle="#3d6b3d",s.fillRect(e.x,e.y,e.w,e.h),s.fillStyle="rgba(255,255,255,0.35)";for(let c=l;c<=i;c+=C)for(let y=n;y<=o;y+=C)s.beginPath(),s.arc(y,c,wn,0,Math.PI*2),s.fill()}function In(e){const t=e.x,n=e.y,l=e.radius;s.save(),s.strokeStyle="rgba(123, 237, 159, 0.6)",s.lineWidth=4,s.setLineDash([8,8]),s.beginPath(),s.arc(t,n,l,0,Math.PI*2),s.stroke(),s.setLineDash([]),s.fillStyle="rgba(74, 124, 89, 0.2)",s.beginPath(),s.arc(t,n,l,0,Math.PI*2),s.fill(),s.fillStyle="#7bed9f",s.font="bold 14px Rubik, sans-serif",s.textAlign="center",s.fillText("ADOPTION CENTER",t,n-l-8),s.fillText("Bring pets here to adopt out",t,n),s.restore()}function Ln(e,t){const n=X+e.size*Z,l=e.x,o=e.y;s.save(),s.shadowColor="rgba(0,0,0,0.4)",s.shadowBlur=10;const i=t?"#7bed9f":Lt(e.id);s.fillStyle=i,s.beginPath(),s.arc(l,o,n,0,Math.PI*2),s.fill(),s.strokeStyle=t?"rgba(255,255,255,0.9)":"rgba(255,255,255,0.5)",s.lineWidth=t?3:2,s.stroke(),s.fillStyle="#2d2d2d",s.font="bold 12px Rubik, sans-serif",s.textAlign="center";const c=t?"You":e.displayName??e.id;s.fillText(c,l,o-n-6),s.fillText(`Pets: ${e.petsInside.length}/${Math.floor(e.size)}`,l,o+4),s.restore()}function Tn(e,t){s.save(),s.fillStyle="#c9a86c",s.beginPath(),s.arc(e,t,Xe,0,Math.PI*2),s.fill(),s.strokeStyle="#8B4513",s.lineWidth=1.5,s.stroke(),s.font="10px Rubik, sans-serif",s.fillStyle="#333",s.textAlign="center",s.fillText("Stray",e,t+Xe+10),s.restore()}function Mn(e){const t=e.type===rt;s.save(),s.fillStyle=t?"#7bed9f":"#70a3ff",s.beginPath(),s.arc(e.x,e.y,qe,0,Math.PI*2),s.fill(),s.strokeStyle=t?"#2d5a38":"#2d4a6e",s.lineWidth=2,s.stroke(),s.fillStyle="#333",s.font="10px Rubik, sans-serif",s.textAlign="center",s.fillText(t?"+Size":"Speed",e.x,e.y+qe+10),s.restore()}function An(e){try{const t=It(),n=Number.isFinite(t.x)?Math.max(0,Math.min(R-t.w,t.x)):0,l=Number.isFinite(t.y)?Math.max(0,Math.min(O-t.h,t.y)):0,o={x:n,y:l,w:t.w,h:t.h};if(s.save(),s.translate(-o.x,-o.y),vn(o),u){for(const a of u.adoptionZones)In(a);for(const a of u.pickups??[])Mn(a)}for(const a of(u==null?void 0:u.pets)??[]){if(a.insideShelterId!==null)continue;const g=Sn(a.id)??a;!Number.isFinite(g.x)||!Number.isFinite(g.y)||Tn(g.x,g.y)}for(const a of(u==null?void 0:u.players)??[]){const g=a.id===N;let T;if(g&&r){let M=F??r.x,I=_??r.y;(!Number.isFinite(M)||!Number.isFinite(I))&&(M=r.x,I=r.y),(!Number.isFinite(M)||!Number.isFinite(I))&&(M=R/2,I=O/2),T={...r,x:M,y:I}}else T=Fe(a.id)??a;if(!(!Number.isFinite(T.x)||!Number.isFinite(T.y))&&(Ln(T,g),g&&gt>Date.now())){s.save(),s.setTransform(1,0,0,1,0,0);const M=b.width/2,I=b.height/2-60;s.fillStyle="#7bed9f",s.font="bold 28px Rubik, sans-serif",s.textAlign="center",s.fillText("+1 Size!",M,I),s.restore()}}s.restore();const i=120/R;p.fillStyle="#2d4a2d",p.fillRect(0,0,120,120);for(let a=0;a<=O;a+=C*3)for(let g=0;g<=R;g+=C*3)p.fillStyle="rgba(255,255,255,0.15)",p.beginPath(),p.arc(g*i,a*i,.8,0,Math.PI*2),p.fill();if(u){for(const a of u.adoptionZones)p.fillStyle="rgba(123, 237, 159, 0.6)",p.beginPath(),p.arc(a.x*i,a.y*i,a.radius*i|0,0,Math.PI*2),p.fill();for(const a of u.pets)a.insideShelterId===null&&(p.fillStyle="#c9a86c",p.beginPath(),p.arc(a.x*i,a.y*i,2,0,Math.PI*2),p.fill());for(const a of u.pickups??[])p.fillStyle=a.type===rt?"#7bed9f":"#70a3ff",p.beginPath(),p.arc(a.x*i,a.y*i,2,0,Math.PI*2),p.fill();for(const a of u.players){p.fillStyle=a.id===N?"#7bed9f":Lt(a.id);const g=(X+a.size*Z)*i;p.beginPath(),p.arc(a.x*i,a.y*i,Math.max(2,g),0,Math.PI*2),p.fill()}}p.strokeStyle="rgba(255,255,255,0.2)",p.lineWidth=1,p.strokeRect(.5,.5,119,119);const c=(u==null?void 0:u.players.find(a=>a.id===N))??r,y=c?Math.floor(c.size):0,d=(c==null?void 0:c.petsInside.length)??0,f=(u==null?void 0:u.pets.filter(a=>a.insideShelterId===null).length)??0;jt.textContent=`Size: ${y}`,Zt.textContent=`Pets: ${d}/${y}`;const h=(u==null?void 0:u.tick)??0,x=at,S=c&&(c.speedBoostUntil??0)>h?((c.speedBoostUntil-h)/x).toFixed(1):"";et&&(et.textContent=c?`Adoptions: ${c.totalAdoptions}  •  Strays: ${f}${S?`  •  Speed: ${S}s`:""}`:"");const w=(u==null?void 0:u.matchEndAt)??0,L=Math.max(0,w-h)/x;if(Vt.textContent=L>0?`${Math.floor(L/60)}:${String(Math.floor(L%60)).padStart(2,"0")}`:"0:00",L<=0&&(u!=null&&u.players.length)){Qe||(Qe=!0,$t()),ee.classList.add("show");const a=[...u.players].sort((A,te)=>te.size-A.size),g=a.find(A=>A.id===N),T=g?Math.floor(g.size):0,M=[100,50,25],I=g?a.findIndex(A=>A.id===N)+1:0,J=I>0&&I<=M.length?M[I-1]:0,W=T+J,j=pe()+W;Et(j);const Ie=I>0?` (${I}. place +${J})`:"";ee.innerHTML="<strong>Match over</strong><br><br>"+a.map((A,te)=>`${te+1}. ${A.id===N?"You":A.displayName??A.id}: size ${Math.floor(A.size)} (${A.totalAdoptions} adoptions)`).join("<br>")+(W>0?`<br><br>+${W} money (size ${T}${Ie}) · total: ${j}`:"")+'<br><br><button type="button" id="play-again-btn" class="fight-ally-btn ally-btn" style="margin-right:8px">Play again</button><button type="button" id="lobby-btn" class="fight-ally-btn fight-btn">Back to lobby</button>'}else ee.classList.remove("show")}catch(t){console.error("Render error:",t),s.save(),s.setTransform(1,0,0,1,0,0),s.fillStyle="#3d6b3d",s.fillRect(0,0,b.width,b.height),s.restore()}}ee.addEventListener("click",e=>{var n,l;const t=(l=(n=e.target).closest)==null?void 0:l.call(n,"button");t&&(t.id==="play-again-btn"?(m&&(m.close(),m=null),ee.classList.remove("show"),k.classList.remove("hidden"),k.innerHTML="<h2>Connecting…</h2><p>Starting new match.</p>",Ye({mode:we}).then(()=>{k.classList.add("hidden"),k.innerHTML="",Ue.classList.add("visible"),requestAnimationFrame(Ke)}).catch(o=>$e(o.message||"Connection failed."))):t.id==="lobby-btn"&&(m&&(m.close(),m=null),ee.classList.remove("show"),Ue.classList.remove("visible"),xt.classList.remove("hidden"),ve()))});V.addEventListener("click",()=>{me||Y!=="countdown"||!m||m.readyState!==WebSocket.OPEN||(me=!0,m.send(JSON.stringify({type:"ready"})),V.textContent="Ready!")});function Tt(e){!q||!m||m.readyState!==WebSocket.OPEN||(m.send(JSON.stringify({type:"fightAlly",targetId:q,choice:e})),dn.add(q),de.classList.add("hidden"),q=null)}an.addEventListener("click",()=>Tt("fight"));rn.addEventListener("click",()=>Tt("ally"));ae.checked=Ce();Re.checked=mt();ae.addEventListener("change",()=>{Ut(ae.checked),ae.checked&&_e()});Re.addEventListener("change",()=>Ot(Re.checked));Qt.addEventListener("click",()=>pt.classList.toggle("hidden"));en.addEventListener("click",()=>pt.classList.add("hidden"));nn.addEventListener("click",()=>{m&&(m.close(),m=null),k.classList.remove("hidden"),k.innerHTML="<h2>Switching server…</h2><p>Reconnecting to a closer server.</p>",Ye({latency:Ne,mode:we}).then(()=>{k.classList.add("hidden"),k.innerHTML=""}).catch(e=>$e(e.message||"Switch failed."))});document.querySelectorAll(".mode-option").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".mode-option").forEach(t=>t.classList.remove("selected")),e.classList.add("selected"),we=e.dataset.mode})});re.addEventListener("click",e=>{e.target.closest('a[href="#"]')&&e.preventDefault()});on.addEventListener("click",()=>{_e(),xt.classList.add("hidden"),k.classList.remove("hidden"),k.innerHTML="<h2>Connecting…</h2><p>Waiting for game server.</p>",Ye({mode:we}).then(()=>{k.classList.add("hidden"),Ue.classList.add("visible"),requestAnimationFrame(Ke)}).catch(e=>{$e(e.message||"Connection failed.")})});localStorage.getItem(ze)||He.classList.remove("hidden");sn.addEventListener("click",()=>{localStorage.setItem(ze,"full"),He.classList.add("hidden")});ln.addEventListener("click",()=>{localStorage.setItem(ze,"essential"),He.classList.add("hidden")});ve();document.querySelectorAll(".landing-buy").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.boost;if(!t||!(t in ge))return;const n=ge[t],l=pe();l<n||(Et(l-n),t==="size"?B.sizeBonus+=1:t==="speed"?B.speedBoost=!0:t==="adoptSpeed"&&(B.adoptSpeed=!0),ve())})});fn();ve();window.addEventListener("resize",St);St();
