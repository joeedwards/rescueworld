(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}})();const ci=25,ga=1e3/ci,ie=4800,de=4800,So=280,wt=32,St=2.5,zn=140,Io=10,xo=18,pa=1.5,di=50,_e=1,Ue=2,Fe=4,Ye=8,ba=0,va=1,fi=2,ui=3,hi=4,Ze=0,mi=1,yi=2,gi=3,oo=4,Ea=1,pi=2;function bi(e,t){const n=new ArrayBuffer(4),o=new DataView(n);return o.setUint8(0,Ea),o.setUint16(1,e,!0),o.setUint8(3,t&255),n}function le(e,t){const n=e.getUint8(t);if(n===0)return{s:"",next:t+1};const o=e.buffer.byteLength-(t+1);if(n>o||n<0)throw new RangeError(`Snapshot string length ${n} exceeds buffer (${o} bytes left)`);const i=new Uint8Array(e.buffer,t+1,n);return{s:new TextDecoder().decode(i),next:t+1+n}}function wa(e){const t=new DataView(e);let n=0;if(t.getUint8(n++)!==pi)throw new Error("Invalid snapshot message");const o=t.getUint32(n,!0);n+=4;const i=t.getUint32(n,!0);n+=4;const r=t.getUint8(n++)!==0,{s:l,next:c}=le(t,n);n=c;const h=t.getUint32(n,!0);n+=4;const y=t.getUint8(n++),g=t.getUint32(n,!0);n+=4;const x=t.getUint8(n++),R=[];for(let N=0;N<x;N++){const{s:F,next:Y}=le(t,n);n=Y;const{s:K,next:q}=le(t,n);n=q;const j=t.getFloat32(n,!0);n+=4;const V=t.getFloat32(n,!0);n+=4;const se=t.getFloat32(n,!0);n+=4;const oe=t.getFloat32(n,!0);n+=4;const me=t.getFloat32(n,!0);n+=4;const Be=t.getUint32(n,!0);n+=4;const Qe=t.getUint8(n++),et=[];for(let E=0;E<Qe;E++){const{s:b,next:S}=le(t,n);n=S,et.push(b)}const He=t.getUint32(n,!0);n+=4;const $t=t.getUint8(n++),Pe=t.getUint8(n++)!==0,Nt=t.getUint8(n++)!==0,ct=t.getUint8(n++),Ot=t.getUint8(n++),Eo=t.getUint8(n++),Mn=[];for(let E=0;E<Eo;E++){const{s:b,next:S}=le(t,n);n=S,Mn.push(b)}const{s:Bn,next:wo}=le(t,n);n=wo;const an=t.getUint16(n,!0);n+=2;const{s:rn,next:dt}=le(t,n);n=dt;const v=t.getUint8(n++)!==0;R.push({id:F,displayName:K||F,x:j,y:V,vx:se,vy:oe,size:me,totalAdoptions:Be,petsInside:et,speedBoostUntil:He,inputSeq:$t,...Mn.length?{allies:Mn}:{},...Pe?{eliminated:!0}:{},...Nt?{grounded:!0}:{},...ct>0?{portCharges:ct}:{},...Ot>0?{shelterPortCharges:Ot}:{},...Bn?{shelterColor:Bn}:{},...an>0?{money:an}:{},...rn?{shelterId:rn}:{},...v?{vanSpeedUpgrade:!0}:{}})}const f=t.getUint16(n,!0);n+=2;const C=[];for(let N=0;N<f;N++){const{s:F,next:Y}=le(t,n);n=Y;const K=t.getFloat32(n,!0);n+=4;const q=t.getFloat32(n,!0);n+=4;const j=t.getFloat32(n,!0);n+=4;const V=t.getFloat32(n,!0);n+=4;const{s:se,next:oe}=le(t,n);n=oe;const me=se===""?null:se,Be=n<t.byteLength?t.getUint8(n++):0;C.push({id:F,x:K,y:q,vx:j,vy:V,insideShelterId:me,petType:Be})}const w=t.getUint8(n++),I=[];for(let N=0;N<w;N++){const{s:F,next:Y}=le(t,n);n=Y;const K=t.getFloat32(n,!0);n+=4;const q=t.getFloat32(n,!0);n+=4;const j=t.getFloat32(n,!0);n+=4,I.push({id:F,x:K,y:q,radius:j})}const m=t.getUint8(n++),B=[];for(let N=0;N<m;N++){const{s:F,next:Y}=le(t,n);n=Y;const K=t.getFloat32(n,!0);n+=4;const q=t.getFloat32(n,!0);n+=4;const j=t.getUint8(n++),V=t.getUint8(n++);B.push({id:F,x:K,y:q,type:j,level:V>0?V:void 0})}const $=t.getUint8(n++),O=[];for(let N=0;N<$;N++){const{s:F,next:Y}=le(t,n);n=Y;const{s:K,next:q}=le(t,n);n=q;const j=t.getFloat32(n,!0);n+=4;const V=t.getFloat32(n,!0);n+=4;const se=t.getUint8(n++),oe=(se&1)!==0,me=(se&2)!==0,Be=(se&4)!==0,Qe=t.getUint8(n++),et=[];for(let Nt=0;Nt<Qe;Nt++){const{s:ct,next:Ot}=le(t,n);n=Ot,et.push(ct)}const He=t.getFloat32(n,!0);n+=4;const $t=t.getUint32(n,!0);n+=4;const Pe=n<t.byteLength?t.getUint8(n++):He<100?1:He<250?2:He<500?3:He<1e3?4:5;O.push({id:F,ownerId:K,x:j,y:V,hasAdoptionCenter:oe,hasGravity:me,hasAdvertising:Be,petsInside:et,size:He,totalAdoptions:$t,tier:Pe})}const U=n<t.byteLength?t.getUint8(n++):0,z=[];for(let N=0;N<U;N++){const{s:F,next:Y}=le(t,n);n=Y;const K=t.getFloat32(n,!0);n+=4;const q=t.getFloat32(n,!0);n+=4;const j=t.getUint8(n++),V=t.getFloat32(n,!0);n+=4,z.push({id:F,x:K,y:q,level:j,size:V})}const ne=n<t.byteLength?t.getUint8(n++):0,he=[];for(let N=0;N<ne;N++){const{s:F,next:Y}=le(t,n);n=Y;const{s:K,next:q}=le(t,n);n=q;const j=t.getFloat32(n,!0);n+=4;const V=t.getFloat32(n,!0);n+=4;const se=t.getUint32(n,!0);n+=4;const oe=t.getUint32(n,!0);n+=4;const me=n+4<=t.byteLength?t.getUint16(n,!0):0;n+=2;const Be=n+2<=t.byteLength?t.getUint16(n,!0):0;n+=2,he.push({id:F,type:K,x:j,y:V,radius:0,requirements:[],totalNeeded:me,totalRescued:Be,contributions:{},startTick:se,durationTicks:oe,rewards:{top1:0,top2:0,top3:0,participation:0}})}return{tick:o,matchEndAt:i,matchEndedEarly:r||void 0,winnerId:l||void 0,totalMatchAdoptions:h,scarcityLevel:y>0?y:void 0,matchDurationMs:g,players:R,pets:C,adoptionZones:I,pickups:B,shelters:O.length>0?O:void 0,breederShelters:z.length>0?z:void 0,adoptionEvents:he.length>0?he:void 0}}const vi="rescueworld_music",Ei="rescueworld_sfx";function wi(e,t){try{const n=localStorage.getItem(e);if(n==="0"||n==="false")return!1;if(n==="1"||n==="true")return!0}catch{}return t}function Si(e,t){try{localStorage.setItem(e,t?"1":"0")}catch{}}function Vt(){return wi(vi,!0)}function Ii(e){Si(vi,e),ce&&(ce.volume=e?1:0),!e&&ce&&ce.pause()}function xi(){return wi(Ei,!0)}function Sa(e){Si(Ei,e)}let Pn=null;function Ia(){if(Pn)return Pn;try{Pn=new(window.AudioContext||window.webkitAudioContext)}catch{return null}return Pn}function fe(e,t,n="sine",o=.3){if(!xi())return;const i=Ia();if(i)try{const r=i.createOscillator(),l=i.createGain();r.connect(l),l.connect(i.destination),r.frequency.value=e,r.type=n,l.gain.setValueAtTime(o,i.currentTime),l.gain.exponentialRampToValueAtTime(.001,i.currentTime+t),r.start(i.currentTime),r.stop(i.currentTime+t)}catch{}}function Vn(){fe(523,.12,"sine",.25),setTimeout(()=>fe(659,.1,"sine",.2),80)}function xa(){fe(440,.08,"square",.2),setTimeout(()=>fe(880,.08,"square",.15),60)}function La(){fe(392,.1,"sine",.25),setTimeout(()=>fe(523,.12,"sine",.22),70),setTimeout(()=>fe(659,.15,"sine",.2),140)}function ka(){fe(330,.06,"sine",.18)}function Ca(){fe(523,.15,"sine",.25),setTimeout(()=>fe(659,.15,"sine",.22),120),setTimeout(()=>fe(784,.2,"sine",.2),240)}function Ta(){fe(440,.08,"sine",.2),setTimeout(()=>fe(554,.08,"sine",.18),80),setTimeout(()=>fe(659,.12,"sine",.2),160)}function Zn(){fe(220,.15,"sawtooth",.35),setTimeout(()=>fe(180,.12,"sawtooth",.3),100),setTimeout(()=>fe(220,.1,"sawtooth",.25),200)}let ce=null;function Ma(){var o;const e=import.meta;let t=typeof((o=e.env)==null?void 0:o.BASE_URL)=="string"?e.env.BASE_URL:"";if(!t||t==="/"){const i=typeof window<"u"?window.location.pathname:"";if(i.includes("rescueworld"))t="/rescueworld/";else{const r=i.lastIndexOf("/");t=r<=0?"/":i.slice(0,r+1)}}return t.endsWith("/")?`${t}music.mp3`:`${t}/music.mp3`}function Tn(){if(Vt())try{if(!ce){ce=new Audio,ce.loop=!0,ce.volume=1,ce.preload="auto",ce.src=Ma();let t=!1;ce.addEventListener("error",()=>{!ce||t||(t=!0,ce.src="/rescueworld/music.mp3",ce.play().catch(()=>{}))}),ce.load()}ce.volume=Vt()?1:0;const e=ce.play();e&&typeof e.catch=="function"&&e.catch(()=>{})}catch{}}const dn=new Image;let Li=!1;function Ba(){const e=["/breeder-mill.png","/rescueworld/breeder-mill.png"];let t=0;const n=()=>{if(t>=e.length){console.error("Failed to load breeder-mill.png from all paths");return}dn.src=e[t],t++};dn.onload=()=>{Li=!0},dn.onerror=()=>{console.warn("Failed to load breeder-mill.png from",dn.src),n()},n()}Ba();const nt=new Image;let ki=!1;function Pa(){const e=["/adoption-event.png","/rescueworld/adoption-event.png"];let t=0;const n=()=>{if(t>=e.length){console.error("[AdoptionEvent] Failed to load adoption-event.png from all paths:",e);return}const o=e[t];console.log(`[AdoptionEvent] Attempting to load image from: ${o}`),nt.src=o,t++};nt.onload=()=>{ki=!0,console.log(`[AdoptionEvent] Image loaded successfully from: ${nt.src} (${nt.width}x${nt.height})`)},nt.onerror=o=>{console.error(`[AdoptionEvent] Failed to load from ${nt.src}:`,o),n()},n()}Pa();const Ci=(()=>{const{protocol:e,host:t}=window.location;return`${e==="https:"?"wss:":"ws:"}//${t}/ws-signaling`})();let xn=0,Ti=0;const ae={};let nn=!1,Qn=0,es=0,gs=0,ps=0;const Aa=15,Lo=60;let d=null,M=null,a=null;const ts=new Map,ns=new Map,Ra=100;let L=null,Is=0,xs=0,ko=0,fn=0,Co=[],To=[];const Ls=new Map;let Mo=0,ot=!1,It=!1,Mi=0,Ys=0,ks=0,An=null,Ws=null,En=null;const $a=200,T=document.getElementById("game"),s=T.getContext("2d"),We=document.getElementById("minimap"),u=We.getContext("2d"),Na=document.getElementById("score"),Cs=document.getElementById("event-panel"),Bo=document.getElementById("event-panel-list"),Oa=document.getElementById("carried"),Po=document.getElementById("tag-cooldown"),Da=document.getElementById("timer"),_a=document.getElementById("game-clock"),$e=document.getElementById("leaderboard"),te=document.getElementById("connection-overlay"),Ua=document.getElementById("how-to-play"),Fa=document.getElementById("settings-btn"),io=document.getElementById("settings-panel"),Ya=document.getElementById("exit-to-lobby-btn"),Wt=document.getElementById("music-toggle"),Hs=document.getElementById("sfx-toggle"),Wa=document.getElementById("settings-close"),Rn=document.getElementById("fps-select");document.getElementById("ping");const Ha=document.getElementById("switch-server"),za=document.getElementById("switch-server-btn"),Se=document.getElementById("auth-area"),Zt=document.getElementById("landing"),Tt=document.getElementById("game-wrap"),qa=document.getElementById("landing-play"),ue=document.getElementById("landing-nick"),xe=document.getElementById("nick-save-btn"),tt=document.getElementById("nick-hint"),ln=document.getElementById("landing-music-toggle"),Ht=document.getElementById("landing-profile-name"),zt=document.getElementById("landing-profile-avatar"),Ts=document.getElementById("landing-profile-actions"),Ms=document.getElementById("landing-auth-buttons"),xt=document.getElementById("referral-status"),Bs=document.getElementById("referral-link"),zs=document.getElementById("referral-copy-btn"),qn=document.getElementById("referral-claim-btn"),ao=document.getElementById("cookie-banner"),Xa=document.getElementById("cookie-accept"),Ga=document.getElementById("cookie-essential"),un=document.getElementById("fight-ally-overlay"),Ka=document.getElementById("fight-ally-name"),ja=document.getElementById("fight-ally-fight"),Ja=document.getElementById("fight-ally-ally"),$n=document.getElementById("cpu-warning"),ss=document.getElementById("action-menu"),Va=document.getElementById("action-menu-close"),Za=document.getElementById("action-size-text"),Qa=document.getElementById("action-size-bar"),er=document.getElementById("action-tokens-text"),tr=document.getElementById("action-tokens-bar"),st=document.getElementById("action-build-btn"),Ao=document.getElementById("action-build-shelter"),Nn=document.getElementById("action-adoption-center"),On=document.getElementById("action-gravity"),Dn=document.getElementById("action-advertising"),Ro=document.getElementById("action-van-speed"),hn=document.getElementById("action-adoption-btn"),mn=document.getElementById("action-gravity-btn"),yn=document.getElementById("action-advertising-btn"),gn=document.getElementById("action-van-speed-btn"),qs=document.getElementById("ground-btn"),Xn=document.getElementById("port-btn"),be=document.getElementById("shelter-port-btn"),pt=document.getElementById("transfer-btn"),pn=document.getElementById("build-shelter-btn"),os=document.getElementById("center-van-btn"),wn=document.getElementById("center-shelter-btn"),nr=document.getElementById("game-tokens"),_t=document.getElementById("lobby-overlay"),Xs=document.getElementById("lobby-message"),Ps=document.getElementById("lobby-player-list"),As=document.getElementById("lobby-countdown"),Ut=document.getElementById("lobby-ready-btn"),sr=document.getElementById("lobby-back-btn"),bn=document.getElementById("lobby-gift-btn"),Gs=document.getElementById("breeder-minigame"),or=document.getElementById("breeder-timer"),ir=document.getElementById("breeder-tokens"),$o=document.getElementById("breeder-pets"),at=document.getElementById("breeder-foods"),Bi=document.getElementById("breeder-result"),ar=document.getElementById("breeder-result-title"),Pi=document.getElementById("breeder-rewards"),rr=document.getElementById("breeder-close-btn"),Ai=document.getElementById("daily-gift-modal"),lr=document.getElementById("daily-gift-close"),Rs=document.getElementById("daily-gift-subtitle"),No=document.getElementById("daily-gift-grid"),mt=document.getElementById("daily-gift-claim-btn"),yt=document.getElementById("daily-gift-btn"),cr=document.getElementById("server-clock-time"),Oo=document.getElementById("server-clock-next-gift"),Ri=document.getElementById("leaderboard-modal"),dr=document.getElementById("leaderboard-close"),is=document.getElementById("leaderboard-content"),Ft=document.getElementById("leaderboard-my-rank"),fr=document.getElementById("leaderboard-btn"),Re=document.getElementById("lobby-leaderboard-content");let Le=null,as=0,it=null;const ur=3e4,hr=document.getElementById("equip-rt"),mr=document.getElementById("equip-ports"),yr=document.getElementById("equip-speed"),gr=document.getElementById("equip-size"),cn=document.getElementById("equip-note"),Do=document.getElementById("karma-display"),pr=document.getElementById("karma-points");let $i=0,Ge={storedRt:0,portCharges:0,speedBoosts:0,sizeBoosts:0,signedIn:!1};const p={active:!1,pets:[],selectedPetIndex:null,timeLeft:30,timerInterval:null,addPetInterval:null,totalPets:0,rescuedCount:0,level:1,selectedIngredients:[]},Ni={apple:5,carrot:8,chicken:15,seeds:5,water:20,bowl:20},br={apple:["horse","rabbit"],carrot:["horse","bird","rabbit"],chicken:["dog","cat"],seeds:["bird"],water:[],bowl:[]},vr={2:[{ingredients:["chicken","carrot"],worksOn:["dog","cat"]},{ingredients:["seeds","apple"],worksOn:["bird"]},{ingredients:["apple","carrot"],worksOn:["horse","rabbit"]}],3:[{ingredients:["water","chicken","carrot"],worksOn:["dog","cat"]},{ingredients:["water","seeds","apple"],worksOn:["bird"]},{ingredients:["water","apple","carrot"],worksOn:["horse","rabbit"]}],4:[{ingredients:["bowl","water","chicken","carrot"],worksOn:["dog","cat"]},{ingredients:["bowl","water","seeds","apple"],worksOn:["bird"]},{ingredients:["bowl","water","apple","carrot"],worksOn:["horse","rabbit"]}]};function sn(e){return e<=2?1:e<=5?2:e<=9?3:4}const Er={dog:"ðŸ•",cat:"ðŸ±",horse:"ðŸ´",bird:"ðŸ¦",rabbit:"ðŸ°"},ro="cookieConsent",Oi="rescueworld_mode",Di="rescueworld_fps",_i="rescueworld_ref",wr="rescueworld_skin_unlocked";let bt=null;const Ks=new Set,rs=new Set;let _n=0;const _o=2e3,Ui=new Map,Ln=new Map,js=400,Uo=new Map,Gn=[],Fo=800,Sr={[Ze]:"ðŸˆ",[mi]:"ðŸ•",[yi]:"ðŸ¦",[gi]:"ðŸ°",[oo]:"â­"};let Ir=0;function Yo(e,t,n,o,i){const r=Date.now();for(let l=0;l<i.length;l++){const c=i[l]??Ze,h=l*100,y=(Math.random()-.5)*30,g=(Math.random()-.5)*30;Gn.push({id:`adopt-${Ir++}`,startTime:r+h,fromX:e+y,fromY:t+g,toX:n,toY:o,petType:c})}}let ee="playing",$s=0,xr=0,ls=!1;const Fi="rescueworld_tokens",lo="rescueworld_color",Yi="rescueworld_unlocked_colors",cs={size:50,speed:30,adoptSpeed:40},ds={preset:50,custom:200,gradient:500};let H="ffa",Ne=!1;const pe={sizeBonus:0,speedBoost:!1,adoptSpeed:!1};let ke=null,re=!1,bs=null,Lr=null,De=null;const Js="rescueworld_active_mp_match";function kr(){try{const e=localStorage.getItem(Js);if(e){const t=JSON.parse(e);if(t.matchId&&(t.mode==="ffa"||t.mode==="teams"))return t}}catch{}return null}function qt(e){De=e,e?localStorage.setItem(Js,JSON.stringify(e)):localStorage.removeItem(Js)}function Wi(e){const t=e.split("-");return t.length>=2?t.slice(1).join("-").toUpperCase().slice(-6):e.slice(-6).toUpperCase()}let Lt=null;function Te(){return parseInt(localStorage.getItem(Fi)||"0",10)}function Mt(e){localStorage.setItem(Fi,String(Math.max(0,e)))}function Me(){const e=document.getElementById("landing-tokens");e&&(e.textContent=`Tokens: ${Te()} RT`);const t=Te();document.querySelectorAll(".landing-buy").forEach(n=>{const o=n.dataset.boost;if(!o||!(o in cs))return;const i=cs[o];n.disabled=t<i||o==="speed"&&pe.speedBoost||o==="adoptSpeed"&&pe.adoptSpeed})}function Hi(){return localStorage.getItem(lo)||"#7bed9f"}function Qt(e){localStorage.setItem(lo,e),re&&fetch("/auth/profile",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({shelterColor:e})}).catch(()=>{})}function vs(){try{const e=localStorage.getItem(Yi);if(e)return JSON.parse(e)}catch{}return{preset:!1,custom:null,gradient:null}}function Vs(e){localStorage.setItem(Yi,JSON.stringify(e))}function kt(){const e=Hi(),t=vs(),n=Te();document.querySelectorAll(".color-btn").forEach(i=>{const r=i.dataset.color;i.classList.toggle("selected",r===e)});const o=document.getElementById("preset-colors-row");o&&(o.style.display=t.preset?"flex":"none",o.querySelectorAll(".preset-color").forEach(i=>{const r=i.dataset.color;i.classList.toggle("selected",r===e)})),document.querySelectorAll(".color-buy").forEach(i=>{const r=i.dataset.color,l=ds[r],c=r==="preset"?t.preset:r==="custom"?!!t.custom:!!t.gradient;i.disabled=c||n<l,i.classList.toggle("unlocked",c),c&&(r==="preset"?i.textContent="Preset Colors Unlocked":r==="custom"?i.textContent="Custom Color: Click to use":r==="gradient"&&(i.textContent="Gradient: Click to use"))})}let Ns=null;function G(e,t="info",n=!1){let o=document.getElementById("toast");o||(o=document.createElement("div"),o.id="toast",o.className="toast",document.body.appendChild(o)),n?o.innerHTML=e:o.textContent=e,o.classList.remove("toast-success","toast-error","toast-info"),o.classList.add(`toast-${t}`),t==="success"?o.style.background="linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)":t==="error"?o.style.background="linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)":o.style.background="linear-gradient(135deg, #3498db 0%, #2980b9 100%)",o.classList.add("show"),Ns&&clearTimeout(Ns),Ns=setTimeout(()=>{o.classList.remove("show")},3e3)}const Ct=[];let Ee=null,Kn=!1;function Cr(e){for(Ct.push(...e);Ct.length>3;)Ct.shift();zi()}function Zs(){Ct.length=0,Kn=!1,Ee&&(Ee.style.display="none",Ee.innerHTML="")}function zi(){if(Kn||Ct.length===0)return;const e=Ct.shift();Kn=!0;const t=["rescued","shut down","destroyed","saved","stopped","is shutting down","farmers market","school fair","petco","stadium","event started","partial win","dropped off","instant adoption","won "],n=["arrived","appeared","failed","formed","expanding","breeding","warning","danger","urgent","critical","strays on the map","game over at"],o=e.toLowerCase(),i=t.some(x=>o.includes(x)),r=n.some(x=>o.includes(x)),l=i&&!r||!r&&(o.includes("event")||o.includes("adoption")),c=l?"rgba(46,204,113,":"rgba(255,107,107,",h=l?"rgba(46,204,113,0.8)":"rgba(255,107,107,0.8)",y=l?"âœ…":"âš ï¸";Ee||(Ee=document.createElement("div"),Ee.id="announcement-bar",document.body.appendChild(Ee)),Ee.style.cssText=`
    position: fixed;
    top: 60px;
    left: 0;
    width: 100%;
    height: 40px;
    background: linear-gradient(90deg, ${c}0) 0%, ${c}0.4) 15%, ${c}0.4) 85%, ${c}0) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    z-index: 150;
    pointer-events: none;
  `;const g=document.createElement("div");if(g.style.cssText=`
    white-space: nowrap;
    font: bold 18px 'Rubik', sans-serif;
    color: #fff;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 10px ${h};
    animation: announcementScroll 8s linear forwards;
  `,g.textContent=`${y} ${e} ${y}`,!document.getElementById("announcement-keyframes")){const x=document.createElement("style");x.id="announcement-keyframes",x.textContent=`
      @keyframes announcementScroll {
        0% { transform: translateX(100vw); opacity: 0; }
        5% { opacity: 1; }
        95% { opacity: 1; }
        100% { transform: translateX(-100vw); opacity: 0; }
      }
    `,document.head.appendChild(x)}Ee.style.display="flex",Ee.innerHTML="",Ee.appendChild(g),g.addEventListener("animationend",()=>{Kn=!1,Ct.length===0&&Ee&&(Ee.style.display="none"),zi()})}const fs=document.getElementById("ally-request-popup"),Wo=document.getElementById("ally-requester-name"),Ho=document.getElementById("ally-accept-btn"),zo=document.getElementById("ally-deny-btn");let us=null,Xt=null;function Tr(e,t){!fs||!Wo||(us=e,Wo.textContent=t,fs.classList.remove("hidden"),Xt&&clearTimeout(Xt),Xt=setTimeout(()=>{qi()},1e4))}function qi(){fs&&fs.classList.add("hidden"),us=null,Xt&&(clearTimeout(Xt),Xt=null)}function Xi(e){!us||!d||d.readyState!==WebSocket.OPEN||(d.send(JSON.stringify({type:"allyResponse",targetId:us,accept:e})),qi())}Ho&&Ho.addEventListener("click",()=>Xi(!0));const qo=document.getElementById("transfer-confirm-popup");document.getElementById("transfer-confirm-count");const Xo=document.getElementById("transfer-confirm-btn"),Go=document.getElementById("transfer-cancel-btn");let Qs=null;function co(){qo&&qo.classList.add("hidden"),Qs=null}Xo&&Xo.addEventListener("click",()=>{!d||d.readyState!==WebSocket.OPEN||!Qs||(d.send(JSON.stringify({type:"transferPets",targetShelterId:Qs})),co())});Go&&Go.addEventListener("click",co);zo&&zo.addEventListener("click",()=>Xi(!1));const hs=document.getElementById("abandon-confirm-popup"),Ko=document.getElementById("abandon-confirm-btn"),jo=document.getElementById("abandon-cancel-btn");let ms=null;function Jo(e){hs&&(ms=e,hs.classList.remove("hidden"))}function Gi(){hs&&hs.classList.add("hidden"),ms=null}Ko&&Ko.addEventListener("click",()=>{ms&&ms(),Gi()});jo&&jo.addEventListener("click",Gi);function Mr(){const e=window.location.pathname;if(e.includes("rescueworld"))return"/rescueworld/";const t=e.lastIndexOf("/");return t<=0?"/":e.slice(0,t+1)}function Br(){try{const e=new URL(window.location.href),t=e.searchParams.get("ref");t&&(localStorage.setItem(_i,t),e.searchParams.delete("ref"),window.history.replaceState({},document.title,e.toString()))}catch{}}function Pr(){try{const e=localStorage.getItem(_i);return e&&e.length?e:null}catch{return null}}function vn(e){const t=Pr();return t?`${e}?ref=${encodeURIComponent(t)}`:e}function Ki(e){const t=Mr();return`${window.location.origin}${t}?ref=${encodeURIComponent(e)}`}let we=null;async function ji(){if(!re){we=null;return}try{const e=await fetch("/referrals/me",{credentials:"include"});if(!e.ok){we=null;return}we=await e.json()}catch{we=null}}function Ji(){if(!re||!we){xt.textContent="Sign in to get your referral link.",Bs.classList.add("referral-hidden"),zs.classList.add("referral-hidden"),qn.classList.add("referral-hidden");return}const e=Ki(we.referralCode);xt.textContent=`Referrals: ${we.referralCount}/${we.rewardThreshold} (OAuth signups)`,Bs.textContent=e,Bs.classList.remove("referral-hidden"),zs.classList.remove("referral-hidden"),we.rewardEligible&&!we.rewardClaimed?qn.classList.remove("referral-hidden"):qn.classList.add("referral-hidden")}async function Gt(){if(!bs){Ne=!1,Oe();return}try{Ne=!!(await(await fetch("/api/saved-match",{credentials:"include"})).json()).hasSavedMatch}catch{Ne=!1}Oe()}function Oe(){const e=document.getElementById("resume-match-btn"),t=document.getElementById("landing-play");if(!(!e||!t)){if(Ne&&H==="solo"){e.classList.remove("hidden"),e.textContent="Resume Match",t.textContent="Start new game";return}if(De||(De=kr()),De&&re&&H===De.mode){const n=Wi(De.matchId);e.classList.remove("hidden"),e.textContent=`Return to Match '${n}'`,t.textContent="Abandon & New Match";return}e.classList.add("hidden"),e.textContent="Resume Match",t.textContent="Play"}}async function Ar(){try{const n=await(await fetch("/auth/me",{credentials:"include"})).json(),{displayName:o,signedIn:i,userId:r,shelterColor:l}=n,c=o??"";if(ke=c||null,re=i,bs=r,Lr=l,i&&l&&localStorage.setItem(lo,l),i&&c)Se.innerHTML=`
        <span class="auth-profile">${rt(c)}</span>
        <a href="/auth/signout" class="auth-link">Sign out</a>
      `,Ht.textContent=c,zt.textContent=c.charAt(0).toUpperCase(),Ts.innerHTML='<a href="/auth/signout" class="auth-link" style="font-size:12px">Sign out</a>',Ms.innerHTML="",ue&&(ue.placeholder=c);else{const h=c?`${rt(c)}`:"Guest";Se.innerHTML=`
        <a href="${vn("/auth/google")}" class="auth-link">Sign in with Google</a>
        <span class="auth-guest">${h}</span>
      `,Ht.textContent=c||"Guest",zt.textContent=c?c.charAt(0).toUpperCase():"?",Ts.innerHTML="",Ms.innerHTML=`
        <a href="${vn("/auth/google")}">Sign in with Google</a>
      `,ue&&(ue.placeholder=c||"Nickname")}ue&&c&&(ue.value=c)}catch{ke=null,re=!1,Se.innerHTML=`
      <a href="${vn("/auth/google")}" class="auth-link">Sign in with Google</a>
      <span class="auth-guest">Guest</span>
    `,Ht.textContent="Guest",zt.textContent="?",Ts.innerHTML="",Ms.innerHTML=`<a href="${vn("/auth/google")}">Sign in with Google</a>`,ue&&(ue.placeholder="Nickname")}await ji(),Ji(),await la(),await Gt(),new URLSearchParams(window.location.search).get("registered")==="1"&&re&&setTimeout(()=>{G("Welcome! Registration gift: 50 RT + Day 1 gift claimed!","success"),window.history.replaceState({},"",window.location.pathname)},500)}async function Vi(){var t;const e=(t=ue==null?void 0:ue.value)==null?void 0:t.trim();if(!e||e.length<1){tt&&(tt.textContent="Enter a nickname first!");return}if(re)try{const o=await(await fetch("/auth/profile",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({nickname:e})})).json();o.success&&(ke=o.displayName,Ht.textContent=o.displayName,zt.textContent=o.displayName.charAt(0).toUpperCase(),xe&&(xe.textContent="Saved!",xe.classList.add("saved"),setTimeout(()=>{xe.textContent="Save",xe.classList.remove("saved")},2e3)),tt&&(tt.textContent=""))}catch{tt&&(tt.textContent="Failed to save")}else ke=e,Ht.textContent=e,zt.textContent=e.charAt(0).toUpperCase(),xe&&(xe.textContent="Saved!",xe.classList.add("saved"),setTimeout(()=>{xe.textContent="Save",xe.classList.remove("saved")},2e3)),tt&&(tt.textContent="Sign in to save permanently")}xe&&xe.addEventListener("click",Vi);ue&&ue.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),Vi())});async function Rr(){var n;const e=(n=ue==null?void 0:ue.value)==null?void 0:n.trim();if(e){if(re&&e!==ke)try{await fetch("/auth/profile",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({nickname:e})})}catch{}return ke=e,e}if(ke)return ke;try{const i=await(await fetch("/auth/guest",{method:"POST",credentials:"include"})).json();if(i.displayName)return ke=i.displayName,Ht.textContent=i.displayName,zt.textContent=i.displayName.charAt(0).toUpperCase(),i.displayName}catch{}const t=`rescue${Date.now().toString(36)}`;return ke=t,t}function rt(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Zi(){const e=window.innerWidth,t=window.innerHeight;T.width=e,T.height=t}function A(e,t){t?xn|=e:xn&=~e}let eo=!1;function on(){const e=a==null?void 0:a.players.find(t=>t.id===M);return(e==null?void 0:e.eliminated)===!0}function $r(){const e=on();if(e&&!eo){const t=a==null?void 0:a.players.find(n=>n.id===M);t&&(Je=t.x,Ve=t.y)}eo=e}function Nr(e){const t=e.target;if(!(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable)){if(ae[e.code]=!0,p.active){e.preventDefault();return}if(on()){e.preventDefault();return}(e.code==="KeyW"||e.code==="ArrowUp")&&A(Fe,!0),(e.code==="KeyS"||e.code==="ArrowDown")&&A(Ye,!0),(e.code==="KeyA"||e.code==="ArrowLeft")&&A(_e,!0),(e.code==="KeyD"||e.code==="ArrowRight")&&A(Ue,!0),e.preventDefault()}}function Or(e){if(ae[e.code]=!1,p.active){e.preventDefault();return}if(on()){e.preventDefault();return}(e.code==="KeyW"||e.code==="ArrowUp")&&A(Fe,!1),(e.code==="KeyS"||e.code==="ArrowDown")&&A(Ye,!1),(e.code==="KeyA"||e.code==="ArrowLeft")&&A(_e,!1),(e.code==="KeyD"||e.code==="ArrowRight")&&A(Ue,!1),e.preventDefault()}function Dr(){return!!(ae.KeyW||ae.KeyS||ae.KeyA||ae.KeyD||ae.ArrowUp||ae.ArrowDown||ae.ArrowLeft||ae.ArrowRight)}function _r(){if(Dr())return;if(p.active){A(_e,!1),A(Ue,!1),A(Fe,!1),A(Ye,!1);return}if(!nn){A(_e,!1),A(Ue,!1),A(Fe,!1),A(Ye,!1);return}const e=gs-Qn,t=ps-es,n=Math.hypot(e,t);if(n<Aa){A(_e,!1),A(Ue,!1),A(Fe,!1),A(Ye,!1);return}const o=e/n,i=t/n;A(_e,o<-.3),A(Ue,o>.3),A(Fe,i<-.3),A(Ye,i>.3)}T.addEventListener("touchstart",e=>{e.preventDefault(),e.touches.length&&(nn=!0,Qn=e.touches[0].clientX,es=e.touches[0].clientY,gs=Qn,ps=es)},{passive:!1});T.addEventListener("touchmove",e=>{e.preventDefault(),e.touches.length&&nn&&(gs=e.touches[0].clientX,ps=e.touches[0].clientY)},{passive:!1});function fo(){if((d==null?void 0:d.readyState)===WebSocket.OPEN){const e=bi(xn,Ti++);d.send(e)}}T.addEventListener("touchend",e=>{e.preventDefault(),e.touches.length===0&&(nn=!1,A(_e,!1),A(Ue,!1),A(Fe,!1),A(Ye,!1),fo())},{passive:!1});T.addEventListener("touchcancel",e=>{e.preventDefault(),nn=!1,A(_e,!1),A(Ue,!1),A(Fe,!1),A(Ye,!1),fo()},{passive:!1});let uo=!1,to=0,no=0;T.addEventListener("mousedown",e=>{e.preventDefault(),on()&&(uo=!0,to=e.clientX,no=e.clientY)});T.addEventListener("mousemove",e=>{if(e.preventDefault(),on()&&uo){const t=e.clientX-to,n=e.clientY-no;Je-=t,Ve-=n,Je=Math.max(T.width/2,Math.min(ie-T.width/2,Je)),Ve=Math.max(T.height/2,Math.min(de-T.height/2,Ve)),to=e.clientX,no=e.clientY}});T.addEventListener("mouseup",e=>{e.preventDefault(),uo=!1});T.addEventListener("contextmenu",e=>{e.preventDefault()});function Qi(e,t){if(!a||!M||!d||d.readyState!==WebSocket.OPEN)return;const n=ea(),o=e+n.x,i=t+n.y;for(const r of a.players){if(r.id===M||r.eliminated)continue;const l=wt+r.size*St;if(o>=r.x-l&&o<=r.x+l&&i>=r.y-l&&i<=r.y+l){rs.has(r.id)||(d.send(JSON.stringify({type:"allyRequest",targetId:r.id})),rs.add(r.id));break}}}T.addEventListener("click",e=>{if(!a||!M||!d||d.readyState!==WebSocket.OPEN)return;const t=T.getBoundingClientRect(),n=T.width/t.width,o=T.height/t.height,i=(e.clientX-t.left)*n,r=(e.clientY-t.top)*o;Qi(i,r)});T.addEventListener("touchend",e=>{if(!a||!M||!d||d.readyState!==WebSocket.OPEN||e.changedTouches.length!==1)return;const t=e.changedTouches[0],n=T.getBoundingClientRect(),o=T.width/n.width,i=T.height/n.height,r=(t.clientX-n.left)*o,l=(t.clientY-n.top)*i;Qi(r,l)});window.addEventListener("keydown",Nr);window.addEventListener("keyup",Or);let lt=!1;function Es(e,t){const n=We.getBoundingClientRect(),o=e-n.left,i=t-n.top,r=ie/120,l=o*r,c=i*r,h=(L==null?void 0:L.x)??ie/2,y=(L==null?void 0:L.y)??de/2;Bt=l-h,Pt=c-y}We.addEventListener("mousedown",e=>{e.preventDefault(),lt=!0,Es(e.clientX,e.clientY)});We.addEventListener("mousemove",e=>{lt&&Es(e.clientX,e.clientY)});We.addEventListener("mouseup",()=>{lt=!1});We.addEventListener("mouseleave",()=>{lt=!1});We.addEventListener("touchstart",e=>{e.preventDefault(),lt=!0,e.touches.length>0&&Es(e.touches[0].clientX,e.touches[0].clientY)},{passive:!1});We.addEventListener("touchmove",e=>{lt&&e.touches.length>0&&(e.preventDefault(),Es(e.touches[0].clientX,e.touches[0].clientY))},{passive:!1});We.addEventListener("touchend",()=>{lt=!1});We.addEventListener("touchcancel",()=>{lt=!1});let qe=null,Xe=null;const Vo=.22;let Bt=0,Pt=0,Je=ie/2,Ve=de/2;const Un=15;let Ke=null,je=null;const Zo=.2;function ea(){const e=T.width,t=T.height,n=a==null?void 0:a.players.find(g=>g.id===M);if((n==null?void 0:n.eliminated)===!0){const g=Math.max(0,Math.min(ie-e,Je-e/2)),x=Math.max(0,Math.min(de-t,Ve-t/2));return{x:g,y:x,w:e,h:t}}let i=(L==null?void 0:L.x)??ie/2,r=(L==null?void 0:L.y)??de/2;(!Number.isFinite(i)||!Number.isFinite(r))&&(i=ie/2,r=de/2);let l=i-e/2+Bt,c=r-t/2+Pt;if(l=Math.max(0,Math.min(ie-e,l)),c=Math.max(0,Math.min(de-t,c)),L==null)return qe=null,Xe=null,{x:l,y:c,w:e,h:t};qe==null||Xe==null||!Number.isFinite(qe)||!Number.isFinite(Xe)?(qe=l,Xe=c):(qe+=(l-qe)*Vo,Xe+=(c-Xe)*Vo);let h=qe,y=Xe;return(!Number.isFinite(h)||!Number.isFinite(y))&&(h=l,y=c,qe=h,Xe=y),h=Math.max(0,Math.min(ie-e,h)),y=Math.max(0,Math.min(de-t,y)),{x:h,y,w:e,h:t}}const Ur=30;function Fr(e,t,n){let o=0,i=0;t&_e&&(o-=1),t&Ue&&(o+=1),t&Fe&&(i-=1),t&Ye&&(i+=1);let r=0,l=0;if(o!==0||i!==0){const g=Math.hypot(o,i)||1,R=((e.speedBoostUntil??0)>0?So*pa:So)*n;r=o/g*R,l=i/g*R}const c=Ur;let h=e.x+r,y=e.y+l;return h=Math.max(c,Math.min(ie-c,h)),y=Math.max(c,Math.min(de-c,y)),{...e,x:h,y,vx:r,vy:l,petsInside:[...e.petsInside],speedBoostUntil:e.speedBoostUntil??0}}const Qo=1e4;function ho(e){te.classList.remove("hidden"),te.innerHTML=`
    <h2>Could not connect</h2>
    <p class="error">${e}</p>
    <p>The game server is not running or not reachable.</p>
    <p><strong>To start the game:</strong></p>
    <p>From the project root folder, run: <code>npm run dev</code></p>
    <p>That starts both the server (ports 4000, 4001) and the client. Wait a few seconds, then refresh this page.</p>
    <p>Or run in two terminals: first <code>npm run dev:server</code>, then <code>npm run dev:client</code>.</p>
  `}async function mo(e){hl(),yl(),An&&(clearInterval(An),An=null),Ha.classList.add("hidden");const t=l=>/^wss?:\/\/localhost(\b|:|\/|$)/i.test(l)||/^wss?:\/\/127\.0\.0\.1(\b|:|\/|$)/i.test(l),n=()=>{const{protocol:l,host:c}=window.location;return`${l==="https:"?"wss:":"ws:"}//${c}/ws-game`};let o=t(window.location.href)?"ws://localhost:4001":n();const i=new WebSocket(Ci);await new Promise((l,c)=>{const h=setTimeout(()=>{i.close(),c(new Error("Connection timeout. Is the server running? Run: npm run dev"))},Qo);i.onopen=()=>{i.send(JSON.stringify({type:"join",latency:e==null?void 0:e.latency,mode:(e==null?void 0:e.mode)??"ffa"}))},i.onmessage=y=>{try{const g=JSON.parse(y.data);g.type==="joined"&&g.gameUrl&&(clearTimeout(h),o=g.gameUrl,!t(window.location.href)&&t(o)&&(o=n()),l())}catch{}},i.onerror=()=>{clearTimeout(h),c(new Error("WebSocket error. Server not running?"))},i.onclose=()=>{clearTimeout(h),i.readyState!==WebSocket.OPEN&&c(new Error("Signaling connection closed. Run: npm run dev"))}});const r=new WebSocket(o);r.binaryType="arraybuffer",r.onopen=async()=>{d=r;const l=await Rr(),c=await Cl(),h=c.rt,y=c.ports;h>0&&G(`Starting with ${h} RT from chest!`,"success"),d.send(JSON.stringify({type:"mode",mode:(e==null?void 0:e.mode)??"ffa",displayName:l,startingRT:h,startingPorts:y,userId:bs})),(pe.sizeBonus>0||pe.speedBoost||pe.adoptSpeed)&&(d.send(JSON.stringify({type:"startingBoosts",sizeBonus:pe.sizeBonus,speedBoost:pe.speedBoost,adoptSpeed:pe.adoptSpeed})),pe.sizeBonus=0,pe.speedBoost=!1,pe.adoptSpeed=!1);const g=Hi();d.send(JSON.stringify({type:"setColor",color:g})),(e==null?void 0:e.mode)==="solo"&&oi&&d.send(JSON.stringify({type:"setCpuBreederBehavior",canShutdown:oi.checked}))},r.onmessage=l=>{var h,y,g,x,R;if(typeof l.data=="string"){try{const f=JSON.parse(l.data);if(f.type==="welcome"&&f.playerId&&(M=f.playerId,f.matchId&&(H==="ffa"||H==="teams")&&(f.resumed&&(qt(null),G(`Rejoined match ${Wi(f.matchId)}!`,"success")),Lt=f.matchId),Ta()),f.type==="savedMatchExpired"){Ne=!1,Oe(),Gt();const C=typeof f.reason=="string"?f.reason:"Match already ended";G(C,"info"),d&&(d.close(),d=null),M=null,a=null,Lt=null,qt(null),$e.classList.remove("show"),ot=!1,It=!1,Zs(),Tt.classList.remove("visible"),Zt.classList.remove("hidden"),Se.classList.remove("hidden"),Me(),en(),te==null||te.classList.add("hidden"),tn(),At(),bo()}if(f.type==="serverShutdown"){const C=typeof f.message=="string"?f.message:"Server is updating. Your progress has been saved.";G(C,"info",!0),d&&(d.close(),d=null),M=null,a=null,Lt=null,qt(null),$e.classList.remove("show"),ot=!1,It=!1,Zs(),Tt.classList.remove("visible"),Zt.classList.remove("hidden"),Se.classList.remove("hidden"),Me(),en(),Oe(),Gt(),te==null||te.classList.add("hidden"),tn(),At()}if(f.type==="matchState"&&typeof f.phase=="string"&&(ee=f.phase,$s=typeof f.countdownRemainingSec=="number"?f.countdownRemainingSec:0,xr=typeof f.readyCount=="number"?f.readyCount:0,Array.isArray(f.players)&&f.players.length>0?Ps.innerHTML=f.players.map(C=>`<div class="lobby-player">${rt(C.displayName)}</div>`).join(""):Ps.innerHTML="",ee==="lobby"?H==="solo"?_t.classList.add("hidden"):(_t.classList.remove("hidden"),Xs.textContent="Waiting for another playerâ€¦",As.classList.add("hidden"),Ut.classList.add("hidden")):ee==="countdown"?(_t.classList.remove("hidden"),Xs.textContent="Match starting soon",As.classList.remove("hidden"),As.textContent=$s>0?`Starting in ${$s}sâ€¦`:"Startingâ€¦",Ut.classList.remove("hidden"),ls?Ut.textContent="Ready!":Ut.textContent="Ready"):(_t.classList.add("hidden"),Ps.innerHTML="")),f.type==="pong"&&typeof f.ts=="number"&&(Ys=Math.round(Date.now()-f.ts),Ys>$a?ks=ks||Date.now():ks=0),f.type==="groundFailed"&&typeof f.reason=="string"&&G(f.reason),f.type==="breederStart"&&typeof f.petCount=="number"){const C=typeof f.level=="number"?f.level:1,w=!!f.isMill,I=typeof f.timeLimitSeconds=="number"?f.timeLimitSeconds:void 0,m=typeof f.addPetIntervalSeconds=="number"?f.addPetIntervalSeconds:void 0;nl(f.petCount,C,{isMill:w,timeLimitSeconds:I,addPetIntervalSeconds:m})}if(f.type==="breederAddPet"&&p.active){const C=["dog","cat","horse","bird","rabbit"],w=C[Math.floor(Math.random()*C.length)];p.pets.push({type:w,rescued:!1}),p.totalPets++,kn(),Et()}if(f.type==="breederRewards"){const C=typeof f.tokenBonus=="number"?f.tokenBonus:0,w=Array.isArray(f.rewards)?f.rewards:[];ll(C,w)}f.type==="matchEndInventory"&&(Ne=!1,Oe(),Gt(),typeof f.karmaAwarded=="number"&&f.karmaAwarded>0&&(G(`+${f.karmaAwarded} Karma Point!`,"success"),fa())),f.type==="announcement"&&Array.isArray(f.messages)&&Cr(f.messages),f.type==="allyRequestReceived"&&typeof f.fromId=="string"&&typeof f.fromName=="string"&&Tr(f.fromId,f.fromName),f.type==="transferResult"&&(co(),f.success&&typeof f.count=="number"?G(`Transferred ${f.count} pets! You +${f.senderScore??0} score, ally +${f.receiverScore??0}`):typeof f.reason=="string"&&G(f.reason))}catch{}return}const c=l.data;if(!(c.byteLength<1)&&new DataView(c).getUint8(0)===pi){const f=wa(c);a=f,ee!=="playing"&&(ee="playing",_t.classList.add("hidden"));for(const I of f.players){const m=((h=ts.get(I.id))==null?void 0:h.next)??I;ts.set(I.id,{prev:m,next:{...I},t:0});const B=Uo.get(I.id);if(B){const $=I.x-B.x,O=I.y-B.y;Math.hypot($,O)>200&&!Ln.has(I.id)&&Ln.set(I.id,{startTime:Date.now(),fromX:B.x,fromY:B.y,toX:I.x,toY:I.y,phase:"fadeIn"})}Uo.set(I.id,{x:I.x,y:I.y})}const C=f.players.find(I=>I.id===M);if(C){const I=C.shelterPortCharges??0;if(I>fn){const m=I-fn;G(`+${m} Home Port${m>1?"s":""} ðŸ `,"success")}fn=I}for(const I of f.pets){const m=((y=ns.get(I.id))==null?void 0:y.next)??I;ns.set(I.id,{prev:m,next:{...I},t:0})}const w=f.players.find(I=>I.id===M);if(w){const I=!!w.shelterId;if(w.size>Is&&!I&&w.size<50?(Mi=Date.now()+1500,Vn()):w.size>Is&&Vn(),(w.speedBoostUntil??0)>Mo&&xa(),Mo=w.speedBoostUntil??0,w.totalAdoptions>xs){La();const U=w.totalAdoptions-xs,z=(g=a==null?void 0:a.shelters)==null?void 0:g.find(he=>he.ownerId===M);let ne;if(z!=null&&z.hasAdoptionCenter){ne=To.filter(N=>!z.petsInside.includes(N)).slice(0,U);const he=ne.map(N=>Ls.get(N)??Ze);Yo(z.x,z.y,z.x,z.y-100,he)}else{ne=Co.filter(F=>!w.petsInside.includes(F)).slice(0,U);const he=ne.map(F=>Ls.get(F)??Ze),N=(x=a==null?void 0:a.adoptionZones)==null?void 0:x[0];N&&Yo(w.x,w.y,N.x,N.y,he)}}xs=w.totalAdoptions,w.petsInside.length>ko&&ka(),ko=w.petsInside.length,Co=[...w.petsInside];const m=(R=a==null?void 0:a.shelters)==null?void 0:R.find(U=>U.ownerId===M);To=m?[...m.petsInside]:[];for(const U of f.pets)Ls.set(U.id,U.petType??Ze);Is=w.size;const B=(L==null?void 0:L.x)??w.x,$=(L==null?void 0:L.y)??w.y;L={...w,petsInside:[...w.petsInside]},w.inputSeq,Math.hypot(w.x-B,w.y-$)>300&&(qe=null,Xe=null,Bt=0,Pt=0,Ke=w.x,je=w.y)}}},r.onclose=()=>{d=null,M=null,a=null,fn=0,L=null,ee="playing",rs.clear(),ls=!1},await new Promise((l,c)=>{const h=Date.now()+Qo,y=()=>{(d==null?void 0:d.readyState)===WebSocket.OPEN?l():Date.now()>h?c(new Error("Game server connection timeout")):setTimeout(y,50)};y()}),te.classList.add("hidden"),Ua.classList.add("hidden"),Tn(),An=setInterval(()=>{(d==null?void 0:d.readyState)===WebSocket.OPEN&&d.send(JSON.stringify({type:"ping",ts:Date.now()}))},2e3)}function Yr(){return localStorage.getItem(Di)==="60"?60:30}let jn=Yr(),ta=1e3/jn,Fn=0,ei=0,Os=0;function yo(e){var c,h;if(requestAnimationFrame(yo),Os&&e-Os<ta-1)return;Fn||(Fn=e);const t=Math.min((e-Fn)/1e3,.1);Fn=e,Os=e,_r(),$r(),on()&&((ae.KeyW||ae.ArrowUp)&&(Ve-=Un),(ae.KeyS||ae.ArrowDown)&&(Ve+=Un),(ae.KeyA||ae.ArrowLeft)&&(Je-=Un),(ae.KeyD||ae.ArrowRight)&&(Je+=Un),Je=Math.max(T.width/2,Math.min(ie-T.width/2,Je)),Ve=Math.max(T.height/2,Math.min(de-T.height/2,Ve)));const n=a!=null&&a.matchEndAt>0&&a.tick>=a.matchEndAt,o=a==null?void 0:a.players.find(y=>y.id===M),r=ee==="playing"&&!n&&!(o!=null&&o.eliminated)&&!p.active;if(r&&(d==null?void 0:d.readyState)===WebSocket.OPEN&&e-ei>=ga){ei=e;const y=bi(xn,Ti++);d.send(y)}if(r&&L&&M){L.x,L.y,L=Fr(L,xn,t);let y=L.x,g=L.y;(!Number.isFinite(y)||!Number.isFinite(g))&&(y=ie/2,g=de/2),Ke==null||je==null?(Ke=y,je=g):(Ke+=(y-Ke)*Zo,je+=(g-je)*Zo),(!Number.isFinite(Ke)||!Number.isFinite(je))&&(Ke=y,je=g);let x=null,R=!1;if(a){const f=a.players.find(w=>w.id===M),C=f!=null&&f.shelterId?(c=a.shelters)==null?void 0:c.find(w=>w.id===f.shelterId):null;if(C){const w=wt+C.size*St;for(const I of a.players){if(I.id===M)continue;const m=I.shelterId?(h=a.shelters)==null?void 0:h.find(O=>O.id===I.shelterId):null;if(!m)continue;const B=wt+m.size*St;if(Math.abs(C.x-m.x)<=w+B&&Math.abs(C.y-m.y)<=w+B&&!(C.size<Io||m.size<Io)){if(I.id.startsWith("cpu-")){R=!0;continue}if(!Ks.has(I.id)){x=I.id;break}}}}}if(x){const f=a.players.find(w=>w.id===x);bt=x,Ka.textContent=(f==null?void 0:f.displayName)??x;const C=un.classList.contains("hidden");un.classList.remove("hidden"),C&&Date.now()-_n>_o&&(_n=Date.now(),Zn())}else un.classList.add("hidden"),bt=null,Ks.clear();if(R){const f=$n.classList.contains("hidden");$n.classList.remove("hidden"),f&&Date.now()-_n>_o&&(_n=Date.now(),Zn())}else $n.classList.add("hidden")}else Ke=null,je=null,un.classList.add("hidden"),bt=null,$n.classList.add("hidden");const l=t*(1e3/Ra);for(const y of ts.values())y.t=Math.min(1,y.t+l);for(const y of ns.values())y.t=Math.min(1,y.t+l);Qr()}function Yt(e,t,n){return e+(t-e)*n}function Wr(e){const t=ts.get(e);if(!t)return null;const n=t.t;return{...t.next,x:Yt(t.prev.x,t.next.x,n),y:Yt(t.prev.y,t.next.y,n),vx:Yt(t.prev.vx,t.next.vx,n),vy:Yt(t.prev.vy,t.next.vy,n)}}function Hr(e){const t=ns.get(e);if(!t)return null;const n=t.t;return{...t.next,x:Yt(t.prev.x,t.next.x,n),y:Yt(t.prev.y,t.next.y,n)}}const ve=36,Yn=1.8;function go(e){let t=0;for(let o=0;o<e.length;o++)t=t*31+e.charCodeAt(o)>>>0;return`hsl(${t%360}, 72%, 58%)`}function zr(e){const t=ve*2,n=Math.floor((e.x-t)/ve)*ve,o=Math.floor((e.y-t)/ve)*ve,i=Math.ceil((e.x+e.w+t)/ve)*ve,r=Math.ceil((e.y+e.h+t)/ve)*ve;s.fillStyle="#3d6b3d",s.fillRect(e.x,e.y,e.w,e.h),s.fillStyle="rgba(255,255,255,0.35)";for(let l=o;l<=r;l+=ve)for(let c=n;c<=i;c+=ve)s.fillRect(c-Yn,l-Yn,Yn*2,Yn*2)}function qr(e){const t=e.x,n=e.y,o=e.radius||zn;!Number.isFinite(t)||!Number.isFinite(n)||!Number.isFinite(o)||(s.save(),s.strokeStyle="rgba(123, 237, 159, 0.6)",s.lineWidth=4,s.setLineDash([8,8]),s.strokeRect(t-o,n-o,o*2,o*2),s.setLineDash([]),s.fillStyle="rgba(74, 124, 89, 0.2)",s.fillRect(t-o,n-o,o*2,o*2),s.fillStyle="#7bed9f",s.font="bold 14px Rubik, sans-serif",s.textAlign="center",s.fillText("ADOPTION CENTER",t,n-o-8),s.fillText("Bring pets here to adopt out",t,n),s.restore())}function Xr(e,t){const n=e.x,o=e.y,i=e.radius,r=Math.max(0,e.startTick+e.durationTicks-t),l=Math.ceil(r/25),c=100,h=.8+.2*Math.sin(t*.15),y=a==null?void 0:a.players.find(m=>m.id===M),x=(y?Math.hypot(y.x-n,y.y-o):1/0)<=i;s.save(),x&&(s.fillStyle=`rgba(255, 193, 7, ${.15*h})`,s.beginPath(),s.arc(n,o,i+20,0,Math.PI*2),s.fill()),ki?s.drawImage(nt,n-c/2,o-c/2,c,c):(s.fillStyle=`rgba(255, 193, 7, ${.5*h})`,s.beginPath(),s.arc(n,o,c/2,0,Math.PI*2),s.fill(),s.strokeStyle="#ffc107",s.lineWidth=4,s.stroke(),s.fillStyle="#1a1a2e",s.font="bold 36px sans-serif",s.textAlign="center",s.textBaseline="middle",s.fillText("ðŸŽª",n,o)),s.strokeStyle=x?`rgba(123, 237, 159, ${.9*h})`:`rgba(255, 193, 7, ${.8*h})`,s.lineWidth=x?6:4,s.setLineDash([12,8]),s.beginPath(),s.arc(n,o,i,0,Math.PI*2),s.stroke(),s.setLineDash([]),s.fillStyle=x?"rgba(123, 237, 159, 0.15)":"rgba(255, 193, 7, 0.15)",s.beginPath(),s.arc(n,o,i,0,Math.PI*2),s.fill(),s.fillStyle=x?"#7bed9f":"#ffc107",s.font="bold 16px Rubik, sans-serif",s.textAlign="center",s.textBaseline="alphabetic";const R=e.type.replace(/_/g," ").replace(/\b\w/g,m=>m.toUpperCase());s.fillText(`ðŸ“¢ ${R}`,n,o-i-12),s.font="bold 14px Rubik, sans-serif";const f=e.totalNeeded??100,w=`${e.totalRescued??0}/${f} rescued`,I=x?`${l}s - DROP PETS HERE!`:`${l}s left - bring pets here!`;s.fillText(I,n,o+c/2+18),s.fillText(w,n,o+c/2+36),s.restore()}function ti(e,t,n,o){s.save();const i=60,r=o?n:1-n,l=o?.5+n*.5:1+n*.5;s.translate(e,t),s.scale(l,l),s.beginPath(),s.arc(0,0,i,0,Math.PI*2),s.strokeStyle=`rgba(200, 150, 255, ${r*.8})`,s.lineWidth=4,s.stroke();const c=s.createRadialGradient(0,0,0,0,0,i);c.addColorStop(0,`rgba(180, 120, 255, ${r*.6})`),c.addColorStop(.5,`rgba(140, 80, 220, ${r*.3})`),c.addColorStop(1,"rgba(100, 50, 180, 0)"),s.fillStyle=c,s.beginPath(),s.arc(0,0,i,0,Math.PI*2),s.fill();const h=8,y=Date.now()/100;for(let g=0;g<h;g++){const x=g/h*Math.PI*2+y*.5,R=i*.6*(.8+Math.sin(y+g)*.2),f=Math.cos(x)*R,C=Math.sin(x)*R,w=3+Math.sin(y*2+g)*1.5;s.beginPath(),s.arc(f,C,w,0,Math.PI*2),s.fillStyle=`rgba(255, 255, 255, ${r*.9})`,s.fill()}s.restore()}function ni(e,t,n,o,i="large"){s.save();const r=i==="small"?.5:1,l=i==="small"?.6:1,c=n+8*r,h=e-o*c,y=t,g=Date.now()/100,x=Math.sin(g*3)*.3+.7,R=Math.cos(g*4)*.2+.8,f=25*r,C=s.createRadialGradient(h,y,0,h,y,f);C.addColorStop(0,`rgba(255, 200, 50, ${.6*x*l})`),C.addColorStop(.5,`rgba(255, 100, 20, ${.4*x*l})`),C.addColorStop(1,"rgba(255, 50, 0, 0)"),s.fillStyle=C,s.beginPath(),s.arc(h,y,f,0,Math.PI*2),s.fill();const w=18*r,I=10*r,m=w+Math.sin(g*5)*4*r,B=I+Math.cos(g*6)*2*r;s.translate(h,y),o>0&&s.rotate(Math.PI),s.beginPath(),s.moveTo(-5,-B/2),s.quadraticCurveTo(m*.6,-B*.3*R,m,0),s.quadraticCurveTo(m*.6,B*.3*R,-5,B/2),s.closePath();const $=s.createLinearGradient(-5,0,m,0);$.addColorStop(0,"#FFD700"),$.addColorStop(.3,"#FF8C00"),$.addColorStop(.7,"#FF4500"),$.addColorStop(1,"rgba(255, 69, 0, 0.3)"),s.fillStyle=$,s.fill();const O=m*.6,U=B*.5;s.beginPath(),s.moveTo(-5,-U/2),s.quadraticCurveTo(O*.5,-U*.2,O,0),s.quadraticCurveTo(O*.5,U*.2,-5,U/2),s.closePath(),s.fillStyle="#FFFF80",s.fill(),s.restore()}function Gr(e,t){var se;const i=e.x,r=e.y,l=Ln.get(e.id);let c=1;if(l){const oe=Date.now()-l.startTime;l.phase==="fadeIn"&&(c=Math.min(1,oe/js),oe>=js&&(Ln.delete(e.id),c=1))}const h=Math.hypot(e.vx,e.vy),y=Ui.get(e.id)??1,R=h>.01?r+Math.sin(Date.now()*.012)*3:r;s.save(),s.globalAlpha=c,s.shadowColor="rgba(0,0,0,0.4)",s.shadowBlur=10;const f=(a==null?void 0:a.tick)??0,C=(e.speedBoostUntil??0)>f,w=!!e.vanSpeedUpgrade;e.eliminated||(C?ni(i,R,50,y,"large"):w&&ni(i,R,50,y,"small"));let I,m=t?"#7bed9f":go(e.id);if(e.eliminated)I="rgba(100,100,100,0.5)",m="#666";else if(e.shelterColor)if(e.shelterColor.startsWith("gradient:")){const oe=e.shelterColor.split(":"),me=oe[1]||"#ff5500";oe[2],I=me,m=me}else I=e.shelterColor,m=e.shelterColor;else I=m;const B=50*2,$=50*1.2,O=Math.min(12,50*.3),U=Math.min(10,50*.25);if(s.translate(i,R),y<0&&s.scale(-1,1),(se=e.shelterColor)!=null&&se.startsWith("gradient:")&&!e.eliminated){const oe=e.shelterColor.split(":"),me=oe[1]||"#ff5500",Be=oe[2]||"#00aaff",Qe=s.createLinearGradient(-50,0,50,0);Qe.addColorStop(0,me),Qe.addColorStop(1,Be),I=Qe}s.fillStyle=I,s.beginPath(),s.roundRect(-50,-$*.5,B,$,O),s.fill();const z=B*.3;s.fillStyle="rgba(0,0,0,0.15)",s.beginPath(),s.roundRect(-50+B-z,-$*.5,z,$,[0,O,O,0]),s.fill();const ne=4,he=z-ne*2,N=$*.4;s.fillStyle="rgba(135,206,250,0.7)",s.beginPath(),s.roundRect(-50+B-z+ne,-$*.5+ne,he,N,4),s.fill();const F=!t&&rs.has(e.id);F?(s.strokeStyle="#7bed9f",s.lineWidth=3,s.setLineDash([6,4])):(s.strokeStyle=t?"rgba(255,255,255,0.9)":"rgba(255,255,255,0.5)",s.lineWidth=t?3:2),s.beginPath(),s.roundRect(-50,-$*.5,B,$,O),s.stroke(),s.setLineDash([]),s.fillStyle="#333";const Y=50-B*.3,K=-50+B*.3,q=$*.5+U*.3;s.beginPath(),s.arc(K,q,U,0,Math.PI*2),s.fill(),s.beginPath(),s.arc(Y,q,U,0,Math.PI*2),s.fill(),s.fillStyle="#888",s.beginPath(),s.arc(K,q,U*.4,0,Math.PI*2),s.fill(),s.beginPath(),s.arc(Y,q,U*.4,0,Math.PI*2),s.fill(),y<0&&s.scale(-1,1);const j=Math.min(Math.floor(e.size),di);s.fillStyle="#fff",s.font="bold 13px Rubik, sans-serif";const V=10;s.textAlign="center",s.textBaseline="middle",s.fillText(`Pets: ${e.petsInside.length}/${j}`,0,V),t||s.fillText(e.displayName??e.id,0,-74),F&&(s.fillStyle="#7bed9f",s.fillText("ðŸ¤",60,-50),s.fillStyle="#2d2d2d"),e.eliminated&&(s.font="18px sans-serif",s.fillText("ðŸ‘»",0,0),s.font="bold 12px Rubik, sans-serif"),s.restore()}function Kr(e,t,n){const o=e.x,i=e.y,r=wt+e.size*St,l=Math.min(400,Math.max(40,r));s.save(),s.shadowColor="rgba(0,0,0,0.4)",s.shadowBlur=12;let c;if(n!=null&&n.startsWith("gradient:")){const Y=n.split(":"),K=Y[1]||"#7bed9f",q=Y[2]||"#3cb371",j=s.createLinearGradient(o-l,i,o+l,i);j.addColorStop(0,K),j.addColorStop(1,q),c=j}else n?c=n:c=t?"#7bed9f":go(e.ownerId);s.fillStyle=c;const h=l*2,y=l*1.4,g=o-l,x=i-y*.4;s.beginPath(),s.roundRect(g,x,h,y,6),s.fill(),s.fillStyle="#8B4513",s.beginPath(),s.moveTo(g-10,x),s.lineTo(o,x-l*.5),s.lineTo(g+h+10,x),s.closePath(),s.fill(),s.strokeStyle="#654321",s.lineWidth=2,s.stroke();const R=h*.2,f=y*.5;s.fillStyle="#654321",s.fillRect(o-R/2,x+y-f,R,f);const C=12,w=4,I=Math.floor((h-40)/(C+w)),m=Math.min(e.petsInside.length+2,I*2);for(let Y=0;Y<m;Y++){const K=Math.floor(Y/I),q=Y%I,j=g+20+q*(C+w),V=x+15+K*(C+w),se=Y<e.petsInside.length;s.fillStyle=se?"#c9a86c":"#aaa",s.fillRect(j,V,C,C),s.strokeStyle="#666",s.lineWidth=1,s.strokeRect(j,V,C,C)}s.setLineDash([5,5]),s.strokeStyle=t?"#7bed9f":"rgba(255,255,255,0.5)",s.lineWidth=2;const B=15;s.strokeRect(g-B,x-l*.5-B,h+B*2,y+l*.5+B*2),s.setLineDash([]);const $=x-l*.5-25;let O=o-30;s.font="14px sans-serif",s.textAlign="center",e.hasAdoptionCenter&&(s.fillText("ðŸ¾",O,$),O+=20),e.hasGravity&&(s.fillText("ðŸ§²",O,$),O+=20),e.hasAdvertising&&(s.fillText("ðŸ“¢",O,$),O+=20),s.fillStyle="#333",s.font="bold 11px Rubik, sans-serif",s.textAlign="center";const U=t?"Your Shelter":"Shelter";s.fillText(U,o,x-l*.5-8);const z=e.tier??1,he=["#888","#7bed9f","#70a3ff","#c77dff","#ffd700"][Math.min(z-1,4)],N=o+l*.8,F=x-l*.3;s.fillStyle=he,s.beginPath(),s.arc(N,F,14,0,Math.PI*2),s.fill(),s.strokeStyle="#fff",s.lineWidth=2,s.stroke(),s.fillStyle=z>=5?"#333":"#fff",s.font="bold 12px Rubik, sans-serif",s.textBaseline="middle",z>=5?s.fillText("â˜…"+z,N,F):s.fillText(String(z),N,F),s.textBaseline="alphabetic",s.fillStyle="#fff",s.font="10px Rubik, sans-serif",s.fillText(`Pets: ${e.petsInside.length}`,o,x+y+12),s.fillStyle="#7bed9f",s.fillText(`Adoptions: ${e.totalAdoptions}`,o,x+y+24),s.restore()}function jr(e){const t=e.x,n=e.y,o=80+e.size*.8;s.save();const i=.5+.5*Math.sin(Date.now()/200);if(s.shadowColor=`rgba(255, 0, 0, ${.4+i*.3})`,s.shadowBlur=20+i*10,Li){const r=o*1.5,l=o*1.2;s.drawImage(dn,t-r/2,n-l/2,r,l)}else s.fillStyle="#4a1a1a",s.beginPath(),s.roundRect(t-o/2,n-o/2.5,o,o*.8,6),s.fill(),s.strokeStyle=`rgba(255, 68, 68, ${.6+i*.4})`,s.lineWidth=3,s.stroke();s.shadowBlur=0,s.fillStyle="#ff4444",s.font="bold 12px Rubik, sans-serif",s.textAlign="center",s.textBaseline="bottom",s.fillText(`Breeder Mill Lv${e.level}`,t,n-o/2-5),s.fillStyle="#ffaa00",s.font="10px Rubik, sans-serif",s.textBaseline="top",s.fillText("Spawning wild strays!",t,n+o/2.5+5),s.restore()}const si={[Ze]:"ðŸˆ",[mi]:"ðŸ•",[yi]:"ðŸ¦",[gi]:"ðŸ°",[oo]:"â­"};function Jr(e,t,n=Ze){s.save(),s.globalAlpha=1;const o=si[n]??si[Ze];s.font="30px sans-serif",s.textAlign="center",s.textBaseline="middle",s.shadowColor="rgba(0,0,0,0.8)",s.shadowBlur=4,s.fillText(o,e,t),n===oo&&(s.shadowColor="#ffd700",s.shadowBlur=12,s.fillText(o,e,t)),s.shadowBlur=0,s.restore()}function Vr(e,t,n=1){s.save(),s.translate(e,t),s.beginPath(),s.arc(0,0,31,0,Math.PI*2),s.fillStyle="#5a4a3a",s.fill(),s.fillStyle="#8B4513",s.strokeStyle="#5a3810",s.lineWidth=1;for(let B=0;B<10;B++){const $=B/10*Math.PI*2,O=Math.cos($)*14,U=Math.sin($)*14;s.fillRect(O-3/2,U-8/2,3,8)}s.beginPath(),s.arc(0,0,14,0,Math.PI*2),s.strokeStyle="#6d4c35",s.lineWidth=2,s.stroke();const h=(e*7+t*31+n*101|0)>>>0,y=["#ff9f43","#a17851","#74b9ff","#dfe6e9"],g=2+h%3;for(let B=0;B<g;B++){const $=h+B*17>>>0,O=($%17-8)*.9,U=(($>>4)%17-8)*.9;s.beginPath(),s.arc(O,U,4,0,Math.PI*2),s.fillStyle=y[($>>8)%y.length],s.fill(),s.strokeStyle="#333",s.lineWidth=.8,s.stroke()}s.beginPath(),s.moveTo(-20,12),s.lineTo(0,-18),s.lineTo(20,12),s.closePath(),s.fillStyle="#D2B48C",s.fill(),s.strokeStyle="#8B7355",s.lineWidth=1.5,s.stroke(),s.beginPath(),s.moveTo(-7,12),s.lineTo(0,4),s.lineTo(7,12),s.fillStyle="#4a3a2a",s.fill(),s.restore();const x=e+35-10,R=t-35+5;s.fillStyle="#fff",s.beginPath(),s.roundRect(x-10,R-8,20,16,3),s.fill(),s.strokeStyle="#333",s.lineWidth=1,s.stroke(),s.fillStyle="#000",s.font="bold 11px sans-serif",s.textAlign="center",s.textBaseline="middle",s.fillText(`${n}`,x,R);const f=3+Math.min(2,Math.floor(n/2)),C=Math.min(f+Math.floor(n/2),8);let w=1,I=8;n>=10?(w=4,I=13):n>=6?(w=3,I=11):n>=3&&(w=2);const m=C*w*I;s.font="bold 10px Rubik, sans-serif",s.fillStyle="#ff6b6b",s.textAlign="center",s.textBaseline="alphabetic",s.fillText(`Lv${n} ~${m}RT`,e,t+35+12)}function Zr(e){const t=xo;if(s.save(),e.type===ui){Vr(e.x,e.y,e.level??1),s.restore();return}let n="#7bed9f",o="#2d5a38",i="+Size";e.type===va?(n="#70a3ff",o="#2d4a6e",i="Speed"):e.type===fi?(n="#c77dff",o="#6a3d7a",i="Random"):e.type===hi&&(n="#10b981",o="#047857",i="Home"),s.fillStyle=n,s.fillRect(e.x-t,e.y-t,t*2,t*2),s.strokeStyle=o,s.lineWidth=2,s.strokeRect(e.x-t,e.y-t,t*2,t*2),s.fillStyle="#333",s.font="10px Rubik, sans-serif",s.textAlign="center",s.fillText(i,e.x,e.y+xo+10),s.restore()}function Qr(e){var t,n,o;try{if(a)for(const v of a.players)Math.abs(v.vx)>.5&&Ui.set(v.id,v.vx>0?1:-1);const i=ea(),r=Number.isFinite(i.x)?Math.max(0,Math.min(ie-i.w,i.x)):0,l=Number.isFinite(i.y)?Math.max(0,Math.min(de-i.h,i.y)):0,c={x:r,y:l,w:i.w,h:i.h};if(s.save(),s.translate(-c.x,-c.y),zr(c),a){const v=a.adoptionZones.length>0?a.adoptionZones:[{id:"adopt-fallback",x:ie/2,y:de/2,radius:zn}];for(const E of v)qr(E);for(const E of a.adoptionEvents??[])Xr(E,a.tick);for(const E of a.pickups??[])Zr(E);for(const E of a.shelters??[]){const b=E.ownerId===M,S=a.players.find(P=>P.id===E.ownerId),k=S==null?void 0:S.shelterColor;Kr(E,b,k)}for(const E of a.breederShelters??[])jr(E)}for(const v of(a==null?void 0:a.pets)??[]){if(v.insideShelterId!==null)continue;const E=Hr(v.id)??v;!Number.isFinite(E.x)||!Number.isFinite(E.y)||E.x===0&&E.y===0||Jr(E.x,E.y,v.petType??Ze)}const h=[...(a==null?void 0:a.players)??[]].sort((v,E)=>v.size-E.size);for(const v of h){const E=v.id===M;let b;if(E&&L){let S=Ke??L.x,k=je??L.y;(!Number.isFinite(S)||!Number.isFinite(k))&&(S=L.x,k=L.y),(!Number.isFinite(S)||!Number.isFinite(k))&&(S=ie/2,k=de/2),b={...L,x:S,y:k}}else b=Wr(v.id)??v;if(!(!Number.isFinite(b.x)||!Number.isFinite(b.y))&&(Gr(b,E),E&&Mi>Date.now())){s.save(),s.setTransform(1,0,0,1,0,0);const S=T.width/2,k=T.height/2-60;s.fillStyle="#7bed9f",s.font="bold 28px Rubik, sans-serif",s.textAlign="center",s.fillText("+1 Size!",S,k),s.restore()}}const y=Date.now();for(let v=Gn.length-1;v>=0;v--){const E=Gn[v],b=y-E.startTime;if(b<0)continue;if(b>Fo){Gn.splice(v,1);continue}const S=b/Fo,k=1-Math.pow(1-S,3),P=E.fromX+(E.toX-E.fromX)*k,D=E.fromY+(E.toY-E.fromY)*k-Math.sin(S*Math.PI)*50,Q=S<.8?1:1-(S-.8)/.2;s.save(),s.globalAlpha=Q,s.font="bold 32px sans-serif",s.textAlign="center",s.textBaseline="middle",s.fillText(Sr[E.petType]??"ðŸ¾",P,D),s.restore()}for(const[v,E]of Ln){const b=Date.now()-E.startTime,S=Math.min(1,b/js);E.phase==="fadeIn"&&(ti(E.toX,E.toY,S,!0),S<.5&&ti(E.fromX,E.fromY,S*2,!1))}s.restore();const g=120/ie;u.fillStyle="#2d4a2d",u.fillRect(0,0,120,120);for(let v=0;v<=de;v+=ve*3)for(let E=0;E<=ie;E+=ve*3)u.fillStyle="rgba(255,255,255,0.15)",u.fillRect(E*g-.8,v*g-.8,1.6,1.6);if(a){const v=a.adoptionZones.length>0?a.adoptionZones:[{id:"adopt-fallback",x:ie/2,y:de/2,radius:zn}];for(const b of v){const S=b.radius||zn,k=Math.max(3,S*g|0);u.fillStyle="rgba(123, 237, 159, 0.6)",u.fillRect(b.x*g-k,b.y*g-k,k*2,k*2)}for(const b of a.pets)b.insideShelterId===null&&(b.x===0&&b.y===0||(u.fillStyle="#c9a86c",u.fillRect(b.x*g-2,b.y*g-2,4,4)));for(const b of a.pickups??[]){const S=b.x*g,k=b.y*g;if(b.type===ui){const P=.5+.5*Math.sin(Date.now()/200),D=8+P*4;u.save(),u.shadowColor="#ff4444",u.shadowBlur=D,u.fillStyle="#8B4513",u.beginPath(),u.arc(S,k,4,0,Math.PI*2),u.fill(),u.strokeStyle=`rgba(255, 68, 68, ${.7+P*.3})`,u.lineWidth=2,u.stroke(),u.restore()}else u.fillStyle=b.type===ba?"#7bed9f":b.type===fi?"#c77dff":b.type===hi?"#10b981":"#70a3ff",u.fillRect(S-2,k-2,4,4)}for(const b of a.shelters??[]){const S=b.ownerId===M,k=b.x*g,P=b.y*g,D=Math.min(b.size,2e3),Q=(wt+D*St)*g,Z=Math.min(60,Math.max(4,Q)),W=4;if(u.fillStyle=S?"#e8d5b7":"#d4c4a8",u.fillRect(k-W,P-W,W*2,W*2),u.strokeStyle=S?"#7bed9f":"#8B4513",u.lineWidth=1,u.strokeRect(k-W,P-W,W*2,W*2),S&&(u.fillStyle="#7bed9f",u.beginPath(),u.moveTo(k,P-W-4),u.lineTo(k-5,P-W+1),u.lineTo(k+5,P-W+1),u.closePath(),u.fill(),u.fillRect(k-3,P-W+1,6,5),Z>8)){u.save();const Ae=Date.now()/1500,J=Ae%1,ge=Z*J,Ie=.6*(1-J);u.strokeStyle=`rgba(123, 237, 159, ${Ie})`,u.lineWidth=2,u.beginPath(),u.arc(k,P,ge,0,Math.PI*2),u.stroke();const ze=(Ae+.5)%1,_=Z*ze,X=.6*(1-ze);u.strokeStyle=`rgba(123, 237, 159, ${X})`,u.beginPath(),u.arc(k,P,_,0,Math.PI*2),u.stroke(),u.strokeStyle="rgba(123, 237, 159, 0.4)",u.lineWidth=1,u.setLineDash([3,3]),u.beginPath(),u.arc(k,P,Z,0,Math.PI*2),u.stroke(),u.setLineDash([]),u.restore()}}for(const b of a.breederShelters??[]){const S=b.x*g,k=b.y*g,P=Math.max(10,(40+b.size*.5)*g),D=.5+.5*Math.sin(Date.now()/200);u.save(),u.shadowColor="#ff0000",u.shadowBlur=8+D*8,u.fillStyle="#cc2222",u.fillRect(S-P,k-P,P*2,P*2),u.strokeStyle=`rgba(255, 50, 50, ${.9+D*.1})`,u.lineWidth=2.5,u.strokeRect(S-P,k-P,P*2,P*2),u.restore()}for(const b of a.adoptionEvents??[]){const S=b.x*g,k=b.y*g,P=Math.min(12,b.radius*g),Q=Date.now()%2e3/2e3,Z=P+Q*8,W=1-Q;u.save(),u.strokeStyle=`rgba(94, 234, 212, ${W*.8})`,u.lineWidth=3-Q*2,u.beginPath(),u.arc(S,k,Z,0,Math.PI*2),u.stroke();const J=(Date.now()+1e3)%2e3/2e3,ge=P+J*8,Ie=1-J;u.strokeStyle=`rgba(94, 234, 212, ${Ie*.8})`,u.lineWidth=3-J*2,u.beginPath(),u.arc(S,k,ge,0,Math.PI*2),u.stroke(),u.shadowColor="#5eead4",u.shadowBlur=6+Math.sin(Date.now()*.005)*3,u.strokeStyle="#5eead4",u.lineWidth=2,u.setLineDash([4,4]),u.beginPath(),u.arc(S,k,P,0,Math.PI*2),u.stroke(),u.setLineDash([]),u.fillStyle="rgba(94, 234, 212, 0.4)",u.fill(),u.fillStyle="#5eead4",u.font="bold 8px sans-serif",u.textAlign="center",u.textBaseline="middle",u.fillText("ðŸ“¢",S,k),u.restore()}const E=[...a.players].sort((b,S)=>S.totalAdoptions-b.totalAdoptions);for(const b of a.players){let S=b.id===M?"#7bed9f":go(b.id);b.shelterColor&&(b.shelterColor.startsWith("gradient:")?S=b.shelterColor.split(":")[1]||S:S=b.shelterColor),u.fillStyle=S;const P=50*g,D=E.indexOf(b),Q=D===0?1.5:D<=2?1.2:1,Z=Math.max(2,P)*Q;u.fillRect(b.x*g-Z,b.y*g-Z,Z*2,Z*2),D===0&&a.players.length>1&&(u.fillStyle="#ffd700",u.beginPath(),u.arc(b.x*g,b.y*g-Z-3,3,0,Math.PI*2),u.fill())}}const x=c.x*g,R=c.y*g,f=c.w*g,C=c.h*g;u.strokeStyle="rgba(255,255,255,0.6)",u.lineWidth=1.5,u.strokeRect(x,R,f,C),u.strokeStyle="rgba(255,255,255,0.2)",u.lineWidth=1,u.strokeRect(.5,.5,119,119);const w=a==null?void 0:a.players.find(v=>v.id===M),I=w!=null&&w.shelterId?((t=a==null?void 0:a.shelters)==null?void 0:t.find(v=>v.id===w.shelterId))??null:null;if(I&&w&&!w.eliminated){const v=(L==null?void 0:L.x)??w.x,E=(L==null?void 0:L.y)??w.y,b=I.x,S=I.y,k=c.x,P=c.x+c.w,D=c.y,Q=c.y+c.h;if(!(b>=k&&b<=P&&S>=D&&S<=Q)){const W=c.x+c.w/2,Ae=c.y+c.h/2,J=Math.atan2(S-Ae,b-W),ge=Math.hypot(b-v,S-E),Ie=60,ze=T.width/2-Ie,_=T.height/2-Ie;let X=T.width/2+Math.cos(J)*ze,ft=T.height/2+Math.sin(J)*_;const ws=ze/_;Math.abs(Math.cos(J))>Math.abs(Math.sin(J))*ws?(X=T.width/2+Math.sign(Math.cos(J))*ze,ft=T.height/2+Math.tan(J)*Math.sign(Math.cos(J))*ze):(ft=T.height/2+Math.sign(Math.sin(J))*_,X=T.width/2+1/Math.tan(J)*Math.sign(Math.sin(J))*_),X=Math.max(Ie,Math.min(T.width-Ie,X)),ft=Math.max(Ie,Math.min(T.height-Ie,ft)),s.save();const Ss=.7+.3*Math.sin(Date.now()/300);s.translate(X,ft),s.rotate(J),s.fillStyle=`rgba(123, 237, 159, ${Ss})`,s.strokeStyle="rgba(255, 255, 255, 0.8)",s.lineWidth=2,s.beginPath(),s.moveTo(20,0),s.lineTo(5,-10),s.lineTo(5,-5),s.lineTo(-15,-5),s.lineTo(-15,5),s.lineTo(5,5),s.lineTo(5,10),s.closePath(),s.fill(),s.stroke(),s.restore(),s.save();const ha=-Math.cos(J)*35,ma=-Math.sin(J)*35,ut=X+ha,ht=ft+ma;s.fillStyle=`rgba(232, 213, 183, ${Ss})`,s.strokeStyle="rgba(123, 237, 159, 0.9)",s.lineWidth=2,s.fillRect(ut-12,ht-8,24,18),s.strokeRect(ut-12,ht-8,24,18),s.fillStyle=`rgba(123, 237, 159, ${Ss})`,s.beginPath(),s.moveTo(ut,ht-20),s.lineTo(ut-16,ht-8),s.lineTo(ut+16,ht-8),s.closePath(),s.fill(),s.stroke(),s.fillStyle="rgba(139, 90, 43, 0.8)",s.fillRect(ut-4,ht,8,10),s.fillStyle="#fff",s.font="bold 12px Rubik, sans-serif",s.textAlign="center",s.textBaseline="top";const ya=ge>=1e3?`${(ge/1e3).toFixed(1)}k`:`${Math.round(ge)}`;s.fillText(ya,ut,ht+14),s.restore()}}if(nn){const v=T.getBoundingClientRect(),E=T.width/v.width,b=T.height/v.height,S=(Qn-v.left)*E,k=(es-v.top)*b,P=(gs-v.left)*E,D=(ps-v.top)*b,Q=P-S,Z=D-k,W=Math.hypot(Q,Z),Ae=Math.min(W,Lo*E),J=W>0?S+Q/W*Ae:S,ge=W>0?k+Z/W*Ae:k;s.save(),s.globalAlpha=.3,s.strokeStyle="#fff",s.lineWidth=3,s.beginPath(),s.arc(S,k,Lo*E,0,Math.PI*2),s.stroke(),s.fillStyle="rgba(255,255,255,0.1)",s.fill(),s.globalAlpha=.6,s.fillStyle="#7bed9f",s.beginPath(),s.arc(J,ge,20*E,0,Math.PI*2),s.fill(),s.strokeStyle="#fff",s.lineWidth=2,s.stroke(),s.restore()}const m=(a==null?void 0:a.players.find(v=>v.id===M))??L,B=m?Math.floor(m.size):0,$=Math.min(B,di),O=(m==null?void 0:m.petsInside.length)??0,U=(a==null?void 0:a.pets.filter(v=>v.insideShelterId===null).length)??0;Na.textContent=m!=null&&m.eliminated?"Observer Mode":`Size: ${B}`,Oa.textContent=m!=null&&m.eliminated?"WASD to pan | Drag to move":`Pets: ${O}/${$}`;const z=!!(m!=null&&m.shelterId),ne=!!(m!=null&&m.eliminated),he=(m==null?void 0:m.money)??0,N=m&&m.size>=50&&!z&&!ne&&ee==="playing";nr.textContent=`${he} RT`;const F=m&&!ne&&ee==="playing";F?(pn.classList.remove("hidden"),pn.disabled=!1,pn.textContent="Menu [E]"):pn.classList.add("hidden"),Kt&&(F?Rt():(Kt=!1,ss.classList.add("hidden"))),qs.classList.add("hidden");const Y=(m==null?void 0:m.portCharges)??0;m&&Y>0&&!ne&&ee==="playing"?(Xn.textContent=`Random [P] (${Y})`,Xn.classList.remove("hidden")):Xn.classList.add("hidden");const K=Math.max((m==null?void 0:m.shelterPortCharges)??0,fn);m&&K>0&&!ne?(z?(be.textContent=`Home [H] (${K})`,be.disabled=!1,be.setAttribute("aria-disabled","false"),be.style.opacity="1",be.style.cursor="pointer"):(be.textContent=`Home [H] (${K}) ðŸ”’`,be.disabled=!1,be.setAttribute("aria-disabled","true"),be.style.opacity="0.6",be.style.cursor="not-allowed"),be.classList.remove("hidden")):be.classList.add("hidden");let q=null;if(m&&m.petsInside.length>0&&!ne&&ee==="playing")for(const v of(a==null?void 0:a.shelters)??[]){if(v.ownerId===M)continue;const E=a==null?void 0:a.players.find(W=>W.id===v.ownerId);if(!(((n=m.allies)==null?void 0:n.includes(v.ownerId))||!1))continue;const S=((L==null?void 0:L.x)??m.x)-v.x,k=((L==null?void 0:L.y)??m.y)-v.y,P=Math.hypot(S,k),D=Math.min(v.size,1e3),Z=wt+D*St+100;if(P<=Z){q=v;break}}q?(pt.textContent="Transfer [T] ðŸ¤",pt.classList.remove("hidden"),pt.dataset.targetShelterId=q.id):(pt.classList.add("hidden"),delete pt.dataset.targetShelterId);const j=Math.abs(Bt)>50||Math.abs(Pt)>50,V=m!=null&&m.shelterId?((o=a==null?void 0:a.shelters)==null?void 0:o.find(v=>v.id===m.shelterId))??null:null;m&&!ne&&ee==="playing"&&j?os.classList.remove("hidden"):os.classList.add("hidden"),m&&!ne&&ee==="playing"&&V&&Math.hypot(V.x-((L==null?void 0:L.x)??0)-Bt,V.y-((L==null?void 0:L.y)??0)-Pt)>100?wn.classList.remove("hidden"):wn.classList.add("hidden");const se=(a==null?void 0:a.tick)??0,oe=ci,me=m&&(m.speedBoostUntil??0)>se?((m.speedBoostUntil-se)/oe).toFixed(1):"";Po&&(Po.textContent=m?`Adoptions: ${m.totalAdoptions}  â€¢  Strays: ${U}${me?`  â€¢  Speed: ${me}s`:""}`:"");const Be=(a==null?void 0:a.matchEndAt)??0,et=Math.max(0,Be-se)/oe,He=(a==null?void 0:a.shelters)??[],$t=ie*de,Pe=He.reduce((v,E)=>!v||E.size>v.size?E:v,null),Nt=Math.min((Pe==null?void 0:Pe.size)??0,1e4),ct=Pe?wt+Nt*St:0,Ot=Math.PI*ct*ct,Eo=$t>0?Math.min(100,Math.floor(Ot/$t*100)):0,Mn=a==null?void 0:a.players.find(v=>v.shelterId===(Pe==null?void 0:Pe.id)),Bn=(m==null?void 0:m.totalAdoptions)??0;if(Da.textContent=ee==="playing"?`Points: ${Bn}`:"",!(a!=null&&a.matchEndAt>0&&a.tick>=a.matchEndAt)){const v=(a==null?void 0:a.matchDurationMs)??0,E=Math.floor(v/1e3),b=Math.floor(E/3600),S=Math.floor(E%3600/60),k=E%60;_a.textContent=`${b.toString().padStart(2,"0")}:${S.toString().padStart(2,"0")}:${k.toString().padStart(2,"0")}`}const an=(a==null?void 0:a.adoptionEvents)??[],rn=a;Cs&&Bo&&(an.length>0&&ee==="playing"&&rn?(Bo.innerHTML=an.map(v=>{const E=v.type.replace(/_/g," ").replace(/\b\w/g,Q=>Q.toUpperCase()),b=Math.max(0,v.startTick+v.durationTicks-rn.tick),S=Math.ceil(b/25),k=v.totalNeeded??100,D=`${v.totalRescued??0}/${k}`;return`<div class="event-item"><div class="event-name">${rt(E)}</div><div class="event-reqs">Need: ${D} pets rescued</div><div class="event-time">${S}s left</div></div>`}).join(""),Cs.classList.remove("hidden")):Cs.classList.add("hidden"));const dt=!!(m!=null&&m.eliminated);if((et<=0||dt)&&(a!=null&&a.players.length)){p.active&&Cn(!1),ot||(ot=!0,Ca()),$e.classList.add("show");const v=et<=0&&!(a!=null&&a.matchEndedEarly),E=[...a.players].sort((_,X)=>v?X.size-_.size||X.totalAdoptions-_.totalAdoptions:_.eliminated!==X.eliminated?(_.eliminated?1:0)-(X.eliminated?1:0):_.eliminated?_.totalAdoptions-X.totalAdoptions:X.size-_.size||X.totalAdoptions-_.totalAdoptions),b=!!(a!=null&&a.strayLoss),S=E.find(_=>_.id===M),k=S&&!S.eliminated?Math.floor(S.size):0,P=[100,50,25],D=S?E.findIndex(_=>_.id===M)+1:0,Q=D>0&&D<=P.length&&!dt&&!b?P[D-1]:0,Z=b||dt?0:k+Q,W=ot&&!It?Te()+Z:Te();It||(Mt(W),It=!0);const Ae=D===1?"Win bonus":D===2?"2nd place":D===3?"3rd place":D>0?`${D}th place`:"",J=Z>0?`<br><br><strong>Total: ${W.toLocaleString()} RT</strong>${Ae?`<br>${Ae}: +${Q} RT`:""}`:b?`<br><br>No RT â€” too many strays! <strong>Total: ${Te().toLocaleString()} RT</strong>`:dt?`<br><br><strong>Total: ${Te().toLocaleString()} RT</strong>`:"";let ge="Match over";if(a!=null&&a.strayLoss)ge="Match lost â€” too many strays!";else if(dt)ge="You were consumed";else if(a&&a.winnerId){const _=a.winnerId,X=a.players.find(ws=>ws.id===_);ge=`${(X==null?void 0:X.id)===M?"You":(X==null?void 0:X.displayName)??"Someone"} won!`}const Ie=`
      <div class="match-ads">
        <div class="match-ad-slot">
          <h4>Sponsored</h4>
          <div id="match-ad-slot" class="match-ad-placeholder">Ad placeholder</div>
        </div>
        <div class="match-self-promo">
          <h4>Boost your shelter</h4>
          <p>Earn Rescue Tokens each match to buy boosts. Invite friends with your referral link. For every 5 confirmed signups, unlock a special shelter skin.</p>
        </div>
      </div>
    `,ze=_=>_.eliminated?"â€”":`${Math.floor(_.size)}`;$e.innerHTML=`<strong>${ge}</strong><br><br>`+E.map((_,X)=>`${X+1}. ${_.id===M?"You":_.displayName??_.id}: size ${ze(_)} (${_.totalAdoptions} adoptions)`).join("<br>")+J+Ie+'<button type="button" id="play-again-btn" class="fight-ally-btn ally-btn" style="margin-right:8px">Play again</button><button type="button" id="lobby-btn" class="fight-ally-btn fight-btn">Back to lobby</button>'}else $e.classList.remove("show")}catch(i){console.error("Render error:",i),s.save(),s.setTransform(1,0,0,1,0,0),s.fillStyle="#3d6b3d",s.fillRect(0,0,T.width,T.height),s.restore()}}let Ds=!1;function po(e){Ds||(Ds=!0,setTimeout(()=>{Ds=!1},500),e.id==="play-again-btn"?(d&&(d.close(),d=null),$e.classList.remove("show"),ot=!1,eo=!1,a=null,te.classList.remove("hidden"),te.innerHTML=H==="ffa"?"<h2>Connectingâ€¦</h2><p>Joining FFA lobbyâ€¦</p>":"<h2>Connectingâ€¦</h2><p>Starting new match.</p>",Se.classList.add("hidden"),mo({mode:H}).then(()=>{te.classList.add("hidden"),te.innerHTML="",Tt.classList.add("visible"),requestAnimationFrame(yo)}).catch(t=>ho(t.message||"Connection failed."))):e.id==="lobby-btn"&&(d&&(d.close(),d=null),$e.classList.remove("show"),ot=!1,It=!1,a=null,Lt=null,Tt.classList.remove("visible"),Zt.classList.remove("hidden"),Se.classList.remove("hidden"),Me(),en(),Ne=!1,qt(null),Oe(),Gt(),tn(),At()))}$e.addEventListener("click",e=>{const n=e.target.closest("button");n&&(e.preventDefault(),e.stopPropagation(),po(n))},!0);$e.addEventListener("mouseup",e=>{const n=e.target.closest("button");n&&e.button===0&&(e.preventDefault(),e.stopPropagation(),po(n))},!0);$e.addEventListener("touchend",e=>{const n=e.target.closest("button");n&&(e.preventDefault(),e.stopPropagation(),po(n))},{passive:!1,capture:!0});Ut.addEventListener("click",()=>{ls||ee!=="countdown"||!d||d.readyState!==WebSocket.OPEN||(ls=!0,d.send(JSON.stringify({type:"ready"})),Ut.textContent="Ready!",Xs.textContent="You're ready! Waiting for other player(s)â€¦")});sr.addEventListener("click",()=>{d&&(d.close(),d=null),_t.classList.add("hidden"),Tt.classList.remove("visible"),Zt.classList.remove("hidden"),Se.classList.remove("hidden"),Me(),en(),tn(),At()});function na(e){!bt||!d||d.readyState!==WebSocket.OPEN||(d.send(JSON.stringify({type:"fightAlly",targetId:bt,choice:e})),Ks.add(bt),un.classList.add("hidden"),bt=null)}ja.addEventListener("click",()=>na("fight"));Ja.addEventListener("click",()=>na("ally"));qs.addEventListener("click",()=>{!d||d.readyState!==WebSocket.OPEN||(d.send(JSON.stringify({type:"ground"})),qs.classList.add("hidden"))});Xn.addEventListener("click",()=>{p.active||!d||d.readyState!==WebSocket.OPEN||d.send(JSON.stringify({type:"usePort"}))});be.addEventListener("click",()=>{if(p.active||!d||d.readyState!==WebSocket.OPEN)return;const e=a==null?void 0:a.players.find(t=>t.id===M);if(e&&!((e.shelterPortCharges??0)<=0)){if(!e.shelterId){G("Build a shelter first!","info");return}e.eliminated||ee!=="playing"||d.send(JSON.stringify({type:"useShelterPort"}))}});pt.addEventListener("click",()=>{if(p.active||!d||d.readyState!==WebSocket.OPEN)return;const e=pt.dataset.targetShelterId;e&&d.send(JSON.stringify({type:"transferPets",targetShelterId:e}))});os.addEventListener("click",()=>{Bt=0,Pt=0,os.classList.add("hidden")});wn.addEventListener("click",()=>{var n;const e=a==null?void 0:a.players.find(o=>o.id===M),t=e!=null&&e.shelterId?(n=a==null?void 0:a.shelters)==null?void 0:n.find(o=>o.id===e.shelterId):null;t&&L&&(Bt=t.x-L.x,Pt=t.y-L.y),wn.classList.add("hidden")});pn.addEventListener("click",()=>{sa()});let Kt=!1;function sa(){if(ee!=="playing")return;const e=a==null?void 0:a.players.find(t=>t.id===M);!e||e.eliminated||(Kt=!Kt,Kt?(ss.classList.remove("hidden"),Rt()):ss.classList.add("hidden"))}function el(){var n;if(!a)return null;const e=a.players.find(o=>o.id===M);return e!=null&&e.shelterId?((n=a.shelters)==null?void 0:n.find(o=>o.id===e.shelterId))??null:null}function Rt(){const e=a==null?void 0:a.players.find(f=>f.id===M);if(!e)return;const t=Math.floor(e.size),n=e.money??0,o=!!e.shelterId,i=el(),r=!!e.vanSpeedUpgrade;o?(Ao.classList.add("hidden"),Nn.classList.remove("hidden"),On.classList.remove("hidden"),Dn.classList.remove("hidden")):(Ao.classList.remove("hidden"),Nn.classList.add("hidden"),On.classList.add("hidden"),Dn.classList.add("hidden"));const l=Math.min(100,t/50*100),c=Math.min(100,n/250*100);Za.textContent=`${t}/50`,Qa.style.width=`${l}%`,er.textContent=`${n}/250 RT`,tr.style.width=`${c}%`;const h=t>=50&&n>=250&&!o;if(st.disabled=!h,h)st.textContent="Build Shelter",st.classList.add("ready");else if(o)st.textContent="Already Built",st.classList.remove("ready");else{const f=[];t<50&&f.push(`Size ${t}/50`),n<250&&f.push(`${n}/250 RT`),st.textContent=`Need: ${f.join(" & ")}`,st.classList.remove("ready")}const y=o&&!(i!=null&&i.hasAdoptionCenter)&&n>=250,g=o&&!(i!=null&&i.hasGravity)&&n>=300,x=o&&!(i!=null&&i.hasAdvertising)&&n>=200,R=!r&&n>=150;hn.disabled=!y,hn.textContent=i!=null&&i.hasAdoptionCenter?"Owned":"Buy",y?hn.classList.add("ready"):hn.classList.remove("ready"),i!=null&&i.hasAdoptionCenter?Nn.classList.add("owned"):Nn.classList.remove("owned"),mn.disabled=!g,mn.textContent=i!=null&&i.hasGravity?"Owned":"Buy",g?mn.classList.add("ready"):mn.classList.remove("ready"),i!=null&&i.hasGravity?On.classList.add("owned"):On.classList.remove("owned"),yn.disabled=!x,yn.textContent=i!=null&&i.hasAdvertising?"Owned":"Buy",x?yn.classList.add("ready"):yn.classList.remove("ready"),i!=null&&i.hasAdvertising?Dn.classList.add("owned"):Dn.classList.remove("owned"),gn.disabled=!R,gn.textContent=r?"Owned":"Buy",R?gn.classList.add("ready"):gn.classList.remove("ready"),r?Ro.classList.add("owned"):Ro.classList.remove("owned")}document.addEventListener("keydown",e=>{if((e.key==="e"||e.key==="E")&&sa(),e.key==="p"||e.key==="P"){if(p.active)return;if(d&&d.readyState===WebSocket.OPEN){const t=a==null?void 0:a.players.find(n=>n.id===M);t&&(t.portCharges??0)>0&&!t.eliminated&&ee==="playing"&&d.send(JSON.stringify({type:"usePort"}))}}if(e.key==="h"||e.key==="H"){if(p.active)return;if(d&&d.readyState===WebSocket.OPEN){const t=a==null?void 0:a.players.find(n=>n.id===M);if(!t||(t.shelterPortCharges??0)<=0)return;if(!t.shelterId){G("Build a shelter first!","info");return}if(t.eliminated||ee!=="playing")return;d.send(JSON.stringify({type:"useShelterPort"}))}}});Va.addEventListener("click",()=>{Kt=!1,ss.classList.add("hidden")});st.addEventListener("click",()=>{if(!d||d.readyState!==WebSocket.OPEN)return;const e=a==null?void 0:a.players.find(t=>t.id===M);!e||e.eliminated||e.shelterId||e.size<50||(e.money??0)<250||(d.send(JSON.stringify({type:"buildShelter"})),Rt())});hn.addEventListener("click",()=>{!d||d.readyState!==WebSocket.OPEN||(d.send(JSON.stringify({type:"buyAdoptionCenter"})),Rt())});mn.addEventListener("click",()=>{!d||d.readyState!==WebSocket.OPEN||(d.send(JSON.stringify({type:"buyGravity"})),Rt())});yn.addEventListener("click",()=>{!d||d.readyState!==WebSocket.OPEN||(d.send(JSON.stringify({type:"buyAdvertising"})),Rt())});gn.addEventListener("click",()=>{!d||d.readyState!==WebSocket.OPEN||(d.send(JSON.stringify({type:"buyVanSpeed"})),Rt())});Wt.checked=Vt();Hs.checked=xi();Wt.addEventListener("change",()=>{Ii(Wt.checked),Wt.checked&&Tn()});Hs.addEventListener("change",()=>Sa(Hs.checked));Fa.addEventListener("click",()=>io.classList.toggle("hidden"));Wa.addEventListener("click",()=>io.classList.add("hidden"));Rn&&(Rn.value=String(jn),Rn.addEventListener("change",()=>{const e=Rn.value==="60"?60:30;jn=e,ta=1e3/jn,localStorage.setItem(Di,String(e))}));Ya.addEventListener("click",async()=>{var t;const e=(d==null?void 0:d.readyState)===WebSocket.OPEN;if(e){if(H==="solo")G("Your match has been saved.","success");else if(H==="ffa"||H==="teams"){const n=a==null?void 0:a.players.find(i=>i.id===M),o=n!=null&&n.shelterId?(t=a==null?void 0:a.shelters)==null?void 0:t.find(i=>i.id===n.shelterId):null;G(o?"Your van will stop but your shelter continues. Return to rejoin!":"Your van will stop. Return to rejoin the match!","info")}}io.classList.add("hidden"),d&&(d.close(),d=null),M=null,a=null,$e.classList.remove("show"),ot=!1,It=!1,Zs(),Tt.classList.remove("visible"),Zt.classList.remove("hidden"),Se.classList.remove("hidden"),Me(),en(),H==="solo"&&e?(Ne=!0,Oe()):(H==="ffa"||H==="teams")&&Lt&&re?(qt({matchId:Lt,mode:H}),Oe()):Gt(),Lt=null,tn(),At(),bo()});za.addEventListener("click",()=>{d&&(d.close(),d=null),te.classList.remove("hidden"),te.innerHTML="<h2>Switching serverâ€¦</h2><p>Reconnecting to a closer server.</p>",Se.classList.add("hidden"),mo({latency:Ys,mode:H}).then(()=>{te.classList.add("hidden"),te.innerHTML=""}).catch(e=>{ho(e.message||"Switch failed."),Se.classList.remove("hidden")})});function en(){document.querySelectorAll(".mode-option").forEach(e=>{e.dataset.mode===H?e.classList.add("selected"):e.classList.remove("selected")})}const Wn=localStorage.getItem(Oi);(Wn==="ffa"||Wn==="teams"||Wn==="solo")&&(H=Wn);en();const _s=document.getElementById("solo-options"),oi=document.getElementById("cpu-shutdown-breeders");function oa(){_s&&(H==="solo"?_s.classList.remove("hidden"):_s.classList.add("hidden"))}document.querySelectorAll(".mode-option").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".mode-option").forEach(t=>t.classList.remove("selected")),e.classList.add("selected"),H=e.dataset.mode,localStorage.setItem(Oi,H),oa(),Oe()})});oa();zs.addEventListener("click",async()=>{if(!we||!we.referralCode)return;const e=Ki(we.referralCode);try{await navigator.clipboard.writeText(e),xt.textContent="Referral link copied."}catch{const t=document.createElement("input");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),xt.textContent="Referral link copied."}});qn.addEventListener("click",async()=>{try{const t=await(await fetch("/referrals/claim",{method:"POST",credentials:"include"})).json();if(t.ok){const n=typeof t.moneyBonus=="number"?t.moneyBonus:0;n>0&&Mt(Te()+n),localStorage.setItem(wr,"1"),xt.textContent="Reward claimed. Special skin unlocked.",await ji(),Ji(),Me()}else xt.textContent="Reward not available yet."}catch{xt.textContent="Unable to claim reward. Try again."}});function Sn(e){Tn(),Ml(),Zt.classList.add("hidden"),te.classList.remove("hidden"),te.innerHTML=e.resume?"<h2>Resumingâ€¦</h2><p>Loading your saved match.</p>":"<h2>Connectingâ€¦</h2><p>Waiting for game server.</p>",Se.classList.add("hidden"),mo({mode:e.mode,abandon:e.abandon}).then(()=>{te.classList.add("hidden"),Tt.classList.add("visible"),Wt&&(Wt.checked=Vt()),requestAnimationFrame(yo)}).catch(t=>{ho(t.message||"Connection failed."),Se.classList.remove("hidden")})}const ii=document.getElementById("resume-match-btn");ii&&ii.addEventListener("click",()=>{if(H==="solo"&&Ne){Sn({mode:"solo",resume:!0});return}if(De&&H===De.mode){Sn({mode:H});return}});qa.addEventListener("click",()=>{if(H==="solo"&&Ne){Jo(()=>{fetch("/api/saved-match",{method:"DELETE",credentials:"include"}).then(()=>{Ne=!1,Oe(),Sn({mode:"solo",abandon:!0})}).catch(()=>G("Failed to abandon saved match.","error"))});return}if(De&&H===De.mode){Jo(()=>{qt(null),Oe(),Sn({mode:H})});return}Sn({mode:H})});localStorage.getItem(ro)||ao.classList.remove("hidden");Xa.addEventListener("click",()=>{localStorage.setItem(ro,"full"),ao.classList.add("hidden")});Ga.addEventListener("click",()=>{localStorage.setItem(ro,"essential"),ao.classList.add("hidden")});Me();document.querySelectorAll(".landing-buy").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.boost;if(!t||!(t in cs))return;const n=cs[t],o=Te();o<n||(Mt(o-n),t==="size"?pe.sizeBonus+=1:t==="speed"?pe.speedBoost=!0:t==="adoptSpeed"&&(pe.adoptSpeed=!0),Me())})});kt();document.querySelectorAll(".color-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.color;t&&(Qt(t),kt())})});document.querySelectorAll(".preset-color").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.color;t&&vs().preset&&(Qt(t),kt())})});const Ce=document.getElementById("color-picker-modal"),Dt=document.getElementById("color-picker-input"),vt=document.getElementById("color-picker-input2"),Hn=document.getElementById("color-picker-title"),Us=document.getElementById("color-picker-cancel"),Fs=document.getElementById("color-picker-confirm");let so="custom";document.querySelectorAll(".color-buy").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.color,n=ds[t],o=vs(),i=Te();if(t==="preset"){if(o.preset||i<n)return;Mt(i-n),Vs({...o,preset:!0}),Me(),kt()}else if(t==="custom"){if(o.custom){Qt(o.custom),kt();return}if(i<n)return;so="custom",Hn&&(Hn.textContent="Pick Your Custom Color"),vt&&(vt.style.display="none"),Ce==null||Ce.classList.remove("hidden")}else if(t==="gradient"){if(o.gradient){Qt(o.gradient),kt();return}if(i<n)return;so="gradient",Hn&&(Hn.textContent="Pick Gradient Colors"),vt&&(vt.style.display="block"),Ce==null||Ce.classList.remove("hidden")}})});Us==null||Us.addEventListener("click",()=>{Ce==null||Ce.classList.add("hidden")});Fs==null||Fs.addEventListener("click",()=>{const e=vs(),t=Te();if(so==="custom"){const n=(Dt==null?void 0:Dt.value)||"#ff5500";Mt(t-ds.custom),Vs({...e,custom:n}),Qt(n)}else{const n=(Dt==null?void 0:Dt.value)||"#ff5500",o=(vt==null?void 0:vt.value)||"#00aaff",i=`gradient:${n}:${o}`;Mt(t-ds.gradient),Vs({...e,gradient:i}),Qt(i)}Ce==null||Ce.classList.add("hidden"),Me(),kt()});ln&&(ln.checked=Vt(),ln.addEventListener("change",()=>{Ii(ln.checked),ln.checked&&Tn()}));Vt()&&Tn();function tl(e){return e<=5?15:e<=9?30:e<=14?40:45}function nl(e,t=1,n={}){p.active=!0,A(_e,!1),A(Ue,!1),A(Fe,!1),A(Ye,!1),fo(),p.pets=[],p.selectedPetIndex=null,p.timeLeft=typeof n.timeLimitSeconds=="number"?n.timeLimitSeconds:tl(t),p.totalPets=e,p.rescuedCount=0,p.level=t,p.selectedIngredients=[],p.isMill=!!n.isMill;const o=["dog","cat","horse","bird","rabbit"];for(let h=0;h<e;h++){const y=o[Math.floor(Math.random()*o.length)];p.pets.push({type:y,rescued:!1})}il(t),kn(),jt(),Et(),Bi.classList.add("hidden"),at.style.display="flex",Gs.classList.add("show");const i=Gs.querySelector(".breeder-title");i&&(i.textContent=p.isMill?"ðŸ›‘ Stop the Mill!":`ðŸš¨ Stop Level ${t} Breeders!`);const r=document.getElementById("breeder-instruction-1"),l=document.getElementById("breeder-instruction-2"),c=sn(t);r&&l&&(c===1?(r.textContent="1. Click a pet to select it",l.textContent="2. Click the matching food to rescue it!"):(r.textContent=`1. Click ${c} ingredients to make a meal`,l.textContent="2. Select a pet - if the meal matches, they're rescued!")),sl(),p.timerInterval=setInterval(()=>{p.timeLeft--,or.textContent=`${p.timeLeft}s`,p.timeLeft<=0&&Cn(!1)},1e3)}function ia(){const e=p.pets.filter(o=>!o.rescued).length,t=sn(p.level);let n=8;return p.level>=10?n=12:p.level>=6&&(n=10),e*t*n}function sl(){var h,y;const e=document.getElementById("instant-rescue-btn");if(!e)return;const t=a==null?void 0:a.players.find(g=>g.id===M),n=(h=a==null?void 0:a.shelters)==null?void 0:h.find(g=>g.ownerId===M);if(((n==null?void 0:n.tier)??0)<3){e.classList.add("hidden");return}const i=ia(),l=((t==null?void 0:t.money)??0)>=i;e.textContent=`âš¡ Instant Rescue (${i} RT)`,e.disabled=!l,e.classList.remove("hidden");const c=e.cloneNode(!0);(y=e.parentNode)==null||y.replaceChild(c,e),c.addEventListener("click",()=>{if(!l){G(`Not enough RT! Need ${i}`,"error");return}ol()})}function ol(){if(!d||d.readyState!==WebSocket.OPEN)return;const e=ia();d.send(JSON.stringify({type:"instantRescue",cost:e,totalPets:p.totalPets,level:p.level,isMill:p.isMill})),p.rescuedCount=p.totalPets,p.pets.forEach(t=>t.rescued=!0),Cn(!0)}function il(e){const t=at.querySelector('[data-food="water"]'),n=at.querySelector('[data-food="bowl"]');t&&(t.style.display=e>=6?"flex":"none"),n&&(n.style.display=e>=10?"flex":"none")}function Et(){var r;const e=sn(p.level);let t=document.getElementById("breeder-selected-ingredients");if(t||(t=document.createElement("div"),t.id="breeder-selected-ingredients",t.className="breeder-ingredients",(r=at.parentNode)==null||r.insertBefore(t,at)),e<=1){t.style.display="none";return}t.style.display="flex";const n={apple:"ðŸŽ",carrot:"ðŸ¥•",chicken:"ðŸ—",seeds:"ðŸŒ»",water:"ðŸ’§",bowl:"ðŸ¥£"},o=[];for(let l=0;l<e;l++)if(l<p.selectedIngredients.length){const c=p.selectedIngredients[l];o.push(`<div class="ingredient-slot filled">${n[c]}</div>`)}else o.push('<div class="ingredient-slot empty">?</div>');t.innerHTML=`
    <span class="ingredients-label">Building meal (${p.selectedIngredients.length}/${e}):</span>
    <div class="ingredient-slots">${o.join("")}</div>
    ${p.selectedIngredients.length>0?'<button type="button" class="clear-ingredients-btn" id="clear-ingredients">Clear</button>':""}
  `;const i=document.getElementById("clear-ingredients");i&&i.addEventListener("click",()=>{p.selectedIngredients=[],Et(),jt()})}function kn(){$o.innerHTML=p.pets.map((e,t)=>`
    <div class="breeder-pet${e.rescued?" rescued":""}${p.selectedPetIndex===t?" selected":""}" 
         data-index="${t}">
      <span>${Er[e.type]}</span>
      <span class="breeder-pet-label">${e.type}</span>
    </div>
  `).join(""),$o.querySelectorAll(".breeder-pet:not(.rescued)").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.index??"-1",10);t>=0&&!p.pets[t].rescued&&(p.selectedPetIndex=t,kn(),jt())})})}function jt(){const e=a==null?void 0:a.players.find(o=>o.id===M),t=(e==null?void 0:e.money)??0;ir.textContent=`Your Tokens: ${t} RT`;const n=sn(p.level);at.querySelectorAll(".breeder-food-btn").forEach(o=>{const i=o.dataset.food,r=Ni[i],l=t>=r,c=p.selectedIngredients.includes(i);n===1?o.disabled=!l||p.selectedPetIndex===null:o.disabled=!l||c})}function al(e,t){const n=sn(p.level),o=vr[n];if(!o)return!1;const i=[...e].sort();for(const r of o){if(!r.worksOn.includes(t))continue;const l=[...r.ingredients].sort();if(i.length!==l.length)continue;let c=!0;for(let h=0;h<i.length;h++)if(i[h]!==l[h]){c=!1;break}if(c)return!0}return!1}function rl(e){const t=Ni[e],n=a==null?void 0:a.players.find(r=>r.id===M);if(((n==null?void 0:n.money)??0)<t)return;const i=sn(p.level);if(i===1){if(p.selectedPetIndex===null)return;const r=p.pets[p.selectedPetIndex];if(!r||r.rescued)return;if((d==null?void 0:d.readyState)===WebSocket.OPEN){const c=br[e].includes(r.type);d.send(JSON.stringify({type:"breederUseFood",food:e,petIndex:p.selectedPetIndex,petType:r.type,success:c})),c?(r.rescued=!0,p.rescuedCount++,p.selectedPetIndex=null,Vn(),p.rescuedCount>=p.totalPets?Cn(!0):kn()):Zn(),jt()}return}if(p.selectedIngredients.includes(e)){G("Already added to meal!");return}if((d==null?void 0:d.readyState)===WebSocket.OPEN&&d.send(JSON.stringify({type:"breederUseFood",food:e,petIndex:-1,petType:"ingredient",success:!1})),p.selectedIngredients.push(e),Et(),jt(),p.selectedIngredients.length>=i){if(p.selectedPetIndex===null){G("Select a pet to feed this meal to!");return}const r=p.pets[p.selectedPetIndex];if(!r||r.rescued){p.selectedIngredients=[],Et();return}al(p.selectedIngredients,r.type)?(r.rescued=!0,p.rescuedCount++,p.selectedPetIndex=null,p.selectedIngredients=[],Vn(),G("Meal complete! Pet rescued!","success"),p.rescuedCount>=p.totalPets?Cn(!0):(kn(),Et())):(p.selectedIngredients=[],Zn(),G("Wrong meal! Try again.","error"),Et()),jt()}}function Cn(e){p.timerInterval&&(clearInterval(p.timerInterval),p.timerInterval=null),(d==null?void 0:d.readyState)===WebSocket.OPEN&&d.send(JSON.stringify({type:"breederComplete",rescuedCount:p.rescuedCount,totalPets:p.totalPets,level:p.level})),at.style.display="none",Bi.classList.remove("hidden"),ar.textContent=e?"All Pets Rescued!":`Time's Up! (${p.rescuedCount}/${p.totalPets})`,Pi.innerHTML='<p style="color:rgba(255,255,255,0.7)">Calculating rewards...</p>'}function ll(e,t){const n=t.some(h=>h.type==="penalty"),o=e>0||t.some(h=>h.type!=="penalty"),i=[],r=t.find(h=>h.type==="penalty");r&&i.push(`<div class="breeder-reward-item" style="color:#ff6b6b;">-${r.amount} Size (pets escaped!)</div>`),e>0&&i.push(`<div class="breeder-reward-item">+${e} RT</div>`),t.forEach(h=>{h.type==="size"&&i.push(`<div class="breeder-reward-item">+${h.amount} Size</div>`),h.type==="speed"&&i.push('<div class="breeder-reward-item">Speed Boost!</div>'),h.type==="port"&&i.push(`<div class="breeder-reward-item">+${h.amount} Port Charge</div>`),h.type==="shelterPort"&&i.push(`<div class="breeder-reward-item">+${h.amount} Home Port ðŸ </div>`)});const l=o?"ðŸŽ Rescue Chest":n?"âŒ Breeder Escape!":"No Rewards",c=o?"#ffd93d":"#ff6b6b";Pi.innerHTML=`
    <div class="breeder-result-title" style="color:${c};margin-bottom:8px;">${l}</div>
    ${i.join("")}
  `}function cl(){p.active=!1,Gs.classList.remove("show")}at.querySelectorAll(".breeder-food-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.food;t&&rl(t)})});rr.addEventListener("click",cl);let ye=null;function aa(e){const t=[];return e.tokens>0&&t.push(`${e.tokens} RT`),e.sizeBonus&&t.push(`+${e.sizeBonus} Size`),e.speedBoost&&t.push("Speed"),e.portCharge&&t.push("Random Port"),t.join(" + ")}function ra(){if(!ye)return;const{currentDay:e,canClaimToday:t,rewards:n}=ye;let o="";const i=!re;for(let r=0;r<7;r++){const l=r+1,c=n[r];let h=!1,y=!1,g=!0;i||(h=l===e&&t,y=l<e,g=l>e||l===e&&!t);const x=["daily-gift-day",h?"current":"",y?"claimed":"",g||i?"locked":"",l===7?"daily-gift-day7":""].filter(Boolean).join(" ");o+=`
      <div class="${x}">
        <div class="daily-gift-day-label">Day ${l}</div>
        <div class="daily-gift-day-icon">${y?"âœ“":h?"ðŸ”“":"ðŸ”’"}</div>
        <div class="daily-gift-day-reward">${aa(c)}</div>
      </div>
    `}re?(No.innerHTML=o,mt.classList.remove("hidden"),t?(mt.disabled=!1,mt.textContent=`Claim Day ${e} Gift`,Rs.textContent="Play to unlock today's gift!"):(mt.disabled=!0,mt.textContent="Come back tomorrow!",Rs.textContent=`Next gift: Day ${e>7?1:e}`)):(o=`
      <div class="daily-gift-signin-overlay">
        <div class="daily-gift-signin-message">Sign in for daily gifts!</div>
        <div class="daily-gift-signin-buttons">
          <a href="${vn("/auth/google")}" class="daily-gift-signin-btn google">Sign in with Google</a>
        </div>
      </div>
      <div class="daily-gift-grid-greyed">${o}</div>
    `,No.innerHTML=o,mt.classList.add("hidden"),Rs.textContent="")}async function la(){if(yt.classList.remove("hidden"),!re){ye={currentDay:1,canClaimToday:!0,lastClaimDate:null,totalClaims:0,rewards:[{tokens:15},{tokens:25,speedBoost:!0},{tokens:40},{tokens:50,sizeBonus:3},{tokens:75,speedBoost:!0},{tokens:100,portCharge:!0},{tokens:150,sizeBonus:5,speedBoost:!0}]},yt.classList.add("has-gift");return}try{const e=await fetch("/api/daily-gift",{credentials:"include"});if(!e.ok){ye={currentDay:1,canClaimToday:!0,lastClaimDate:null,totalClaims:0,rewards:[{tokens:15},{tokens:25,speedBoost:!0},{tokens:40},{tokens:50,sizeBonus:3},{tokens:75,speedBoost:!0},{tokens:100,portCharge:!0},{tokens:150,sizeBonus:5,speedBoost:!0}]},yt.classList.add("has-gift");return}ye=await e.json(),ye!=null&&ye.canClaimToday?yt.classList.add("has-gift"):yt.classList.remove("has-gift")}catch{ye={currentDay:1,canClaimToday:!0,lastClaimDate:null,totalClaims:0,rewards:[{tokens:15},{tokens:25,speedBoost:!0},{tokens:40},{tokens:50,sizeBonus:3},{tokens:75,speedBoost:!0},{tokens:100,portCharge:!0},{tokens:150,sizeBonus:5,speedBoost:!0}]},yt.classList.add("has-gift")}Tl()}function ca(){ye&&(ra(),Ai.classList.add("show"))}function da(){Ai.classList.remove("show")}async function dl(){var e;if(!re){G("Sign in to collect daily rewards!"),da();return}if(ye!=null&&ye.canClaimToday)try{const t=await fetch("/api/daily-gift/claim",{method:"POST",credentials:"include"});if(!t.ok){const i=await t.json();G(i.error||"Failed to claim gift");return}const n=await t.json();(e=n.reward)!=null&&e.tokens&&(Mt(Te()+n.reward.tokens),Me()),await la(),ra();const o=aa(n.reward);G(`Gift claimed: ${o}`,"success")}catch{G("Failed to claim gift")}}yt.addEventListener("click",ca);lr.addEventListener("click",da);mt.addEventListener("click",dl);bn.addEventListener("click",ca);function fl(e){if(!Re)return;if(e.length===0){Re.innerHTML='<div class="lobby-leaderboard-loading">No scores yet. Play to appear!</div>';return}const t=bs??"";Re.innerHTML=e.map(n=>{const o=n.adoptionScore??n.rtEarned??0,i=n.userId===t?" highlight":"",r=n.rank===1?"gold":n.rank===2?"silver":n.rank===3?"bronze":"",l=n.shelterColor?`<span class="leaderboard-color" style="background:${rt(n.shelterColor)}"></span>`:"";return`<div class="lobby-leaderboard-entry${i}">
      <span class="lobby-leaderboard-rank ${r}">#${n.rank}</span>
      ${l}
      <span class="lobby-leaderboard-name">${rt(n.displayName)}</span>
      <span class="lobby-leaderboard-score">${o}</span>
    </div>`}).join("")}function At(){if(!Re||(Le==null?void 0:Le.readyState)===WebSocket.OPEN)return;if(Le){try{Le.close()}catch{}Le=null}it&&(clearTimeout(it),it=null),Re.innerHTML='<div class="lobby-leaderboard-loading">Connectingâ€¦</div>';const e=new WebSocket(Ci);Le=e,e.onopen=()=>{as=0,e.send(JSON.stringify({type:"subscribeLeaderboard"}))},e.onmessage=t=>{try{const n=JSON.parse(t.data);n.type==="leaderboardUpdate"&&Array.isArray(n.entries)&&fl(n.entries)}catch{}},e.onerror=()=>{Re&&(Re.innerHTML='<div class="lobby-leaderboard-loading">Connection error</div>')},e.onclose=()=>{Le===e&&(Le=null,ul())}}function ul(){const e=document.getElementById("landing");if(!e||e.style.display==="none")return;as++;const t=Math.min(1e3*Math.pow(2,as-1),ur);Re&&(Re.innerHTML=`<div class="lobby-leaderboard-loading">Reconnecting in ${Math.round(t/1e3)}sâ€¦</div>`),it=setTimeout(()=>{it=null,At()},t)}function hl(){if(it&&(clearTimeout(it),it=null),as=0,Le){try{Le.close()}catch{}Le=null}Re&&(Re.innerHTML='<div class="lobby-leaderboard-loading">Connectingâ€¦</div>')}const ys=document.getElementById("game-stats-content");let In=null;async function ai(){if(ys)try{const e=await fetch("/api/game-stats",{credentials:"include"});if(!e.ok)throw new Error("Failed to fetch stats");const t=await e.json();ml(t)}catch{ys.innerHTML='<div style="color:rgba(255,255,255,0.6)">Stats unavailable</div>'}}function ml(e){if(!ys)return;const{realtime:t,historical:n}=e,o=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px 12px;margin-bottom:8px">
      <div><span style="color:#7bed9f;font-weight:700">${t.onlinePlayers}</span> online now</div>
      <div><span style="color:#ffd93d;font-weight:700">${t.ffaWaiting}</span> in FFA queue</div>
      <div><span style="color:#70a3ff">${t.playingSolo}</span> playing Solo</div>
      <div><span style="color:#c77dff">${t.playingFfa}</span> playing FFA</div>
      <div><span style="color:#ff9f43">${t.playingTeams}</span> playing Teams</div>
    </div>
    <div style="border-top:1px solid rgba(255,255,255,0.15);padding-top:6px;margin-top:4px">
      <div><span style="font-weight:700">${n.totalGamesPlayed.toLocaleString()}</span> total games played</div>
      <div>Popular mode: <span style="color:#7bed9f;font-weight:600">${n.mostPopularMode??"N/A"}</span></div>
      <div><span style="color:#5eead4">${n.newUsersToday}</span> new players today</div>
    </div>
  `;ys.innerHTML=o}function bo(){In||(ai(),In=setInterval(ai,1e4))}function yl(){In&&(clearInterval(In),In=null)}let gt="alltime",Jn="score";const Jt=document.getElementById("leaderboard-sort");async function gl(e){try{const t=e?`?limit=${e}`:"",n=await fetch(`/api/match-history${t}`,{credentials:"include"});return n.ok?(await n.json()).matches??[]:[]}catch{return[]}}async function pl(e,t){try{const n=(e==="alltime"||e==="games")&&t?`&sort=${t}`:"",o=await fetch(`/api/leaderboard?type=${e}${n}`,{credentials:"include"});return o.ok?(await o.json()).entries??[]:[]}catch{return[]}}async function bl(){try{const e=await fetch("/api/leaderboard/my-rank",{credentials:"include"});return e.ok?await e.json():{alltime:{rank:0},daily:{rank:0}}}catch{return{alltime:{rank:0},daily:{rank:0}}}}function vl(e){const t=new Date(e),o=Date.now()-e;return o<6e4?"Just now":o<36e5?`${Math.floor(o/6e4)}m ago`:o<864e5?`${Math.floor(o/36e5)}h ago`:t.toLocaleDateString(void 0,{month:"short",day:"numeric",year:t.getFullYear()!==new Date().getFullYear()?"numeric":void 0})}function El(e){if(e<60)return`${e}s`;const t=Math.floor(e/60),n=e%60;return n?`${t}m ${n}s`:`${t}m`}function wl(e){if(e.length===0){is.innerHTML='<div class="leaderboard-empty">No match history yet. Play matches to see them here!</div>',Ft.innerHTML=re?"Your recent matches":"Sign in to see your match history";return}const t={win:"Win",loss:"Loss",stray_loss:"Stray loss",quit:"Quit"};is.innerHTML=e.map(n=>{const o=t[n.result]??n.result;return`
      <div class="match-history-entry">
        <span class="match-history-result ${n.result==="win"?"history-win":n.result==="stray_loss"?"history-stray":n.result==="quit"?"history-quit":"history-loss"}">${o}</span>
        <span class="match-history-mode">${rt(n.mode)}</span>
        <span class="match-history-rt">${n.rt_earned} RT</span>
        <span class="match-history-adopt">${n.adoptions} adoptions</span>
        <span class="match-history-dur">${El(n.duration_seconds)}</span>
        <span class="match-history-date">${vl(n.played_at)}</span>
      </div>
    `}).join(""),Ft.innerHTML=`Your last ${e.length} matches`}function Sl(e,t){if(e.length===0){is.innerHTML='<div class="leaderboard-empty">No rankings yet. Play to be the first!</div>',Ft.innerHTML="";return}is.innerHTML=e.map(n=>{const o=n.rank===1?"gold":n.rank===2?"silver":n.rank===3?"bronze":"",i=n.displayName===ke?"highlight":"",r=n.shelterColor?`<span class="leaderboard-color" style="background:${n.shelterColor}"></span>`:"";return`
      <div class="leaderboard-entry ${i}">
        <div class="leaderboard-rank ${o}">#${n.rank}</div>
        ${r}
        <div class="leaderboard-name">${rt(n.displayName)}</div>
        <div class="leaderboard-stats">
          <span class="wins">${n.wins} wins</span>${typeof n.gamesPlayed=="number"?` Â· ${n.gamesPlayed} games`:""}${typeof n.losses=="number"?` Â· ${n.losses} losses`:""}<br>
          ${n.rtEarned} RT
        </div>
      </div>
    `}).join(""),t>0&&t<=10?Ft.innerHTML=`Your rank: <strong>#${t}</strong> (Top 10 gets daily rewards!)`:t>10?Ft.innerHTML=`Your rank: <strong>#${t}</strong> - Get into top 10 for daily rewards!`:Ft.innerHTML="Win matches to appear on the leaderboard!"}async function Il(){Ri.classList.add("show"),await vo()}function xl(){Ri.classList.remove("show")}async function vo(){const e=Jt==null?void 0:Jt.closest(".leaderboard-sort");if(gt==="history"){e==null||e.classList.add("hidden");const i=await gl(50);wl(i);return}e==null||e.classList.remove("hidden");const n=await pl(gt,gt==="games"&&Jn==="score"?"games":Jn);let o;if(gt==="alltime"||gt==="daily"){const i=await bl();o=gt==="alltime"?i.alltime.rank:i.daily.rank}else{const i=n.find(r=>r.displayName===ke);o=i?i.rank:0}Sl(n,o)}document.querySelectorAll(".leaderboard-tab").forEach(e=>{e.addEventListener("click",async()=>{document.querySelectorAll(".leaderboard-tab").forEach(t=>t.classList.remove("active")),e.classList.add("active"),gt=e.dataset.type,await vo()})});Jt&&Jt.addEventListener("change",async()=>{Jn=Jt.value,await vo()});fr.addEventListener("click",Il);dr.addEventListener("click",xl);async function Ll(){try{const e=await fetch("/api/inventory",{credentials:"include"});if(!e.ok)return;Ge=await e.json(),ua()}catch{}}async function fa(){try{const e=await fetch("/api/karma",{credentials:"include"});if(!e.ok)return;const t=await e.json();t.signedIn&&typeof t.karmaPoints=="number"&&($i=t.karmaPoints,kl())}catch{}}function kl(){re?(Do.classList.remove("hidden"),pr.textContent=String($i)):Do.classList.add("hidden")}function ua(){hr.textContent=String(Ge.storedRt),mr.textContent=String(Ge.portCharges),yr.textContent=String(Ge.speedBoosts),gr.textContent=String(Ge.sizeBoosts),Ge.signedIn?(Ge.storedRt>0||Ge.portCharges>0?cn.textContent="Items will be used next match":cn.textContent="Earn items by winning matches!",cn.classList.add("signed-in")):(cn.textContent="Sign in to save equipment",cn.classList.remove("signed-in"))}async function Cl(){if(!re)return{rt:0,ports:0};try{const e=await fetch("/api/inventory/withdraw",{method:"POST",credentials:"include"});if(!e.ok)return{rt:0,ports:0};const t=await e.json();return Ge={storedRt:0,portCharges:0,speedBoosts:0,sizeBoosts:0,signedIn:!0},ua(),{rt:t.storedRt??0,ports:t.portCharges??0}}catch{return{rt:0,ports:0}}}function Tl(){ye?(bn.classList.remove("hidden"),ye.canClaimToday||!re?bn.classList.add("has-gift"):bn.classList.remove("has-gift")):bn.classList.add("hidden")}async function ri(){try{const e=await fetch("/api/server-time",{credentials:"include"});if(!e.ok)return;const t=await e.json();typeof t.nextMidnightUtc=="string"&&(Ws=t.nextMidnightUtc)}catch{}}function li(){const e=new Date,t=e.getUTCHours(),n=e.getUTCMinutes(),o=e.getUTCSeconds();if(cr.textContent=`${String(t).padStart(2,"0")}:${String(n).padStart(2,"0")}:${String(o).padStart(2,"0")} UTC`,Ws){const i=new Date(Ws).getTime();let r=Math.max(0,i-Date.now());const l=Math.floor(r/36e5);r%=36e5;const c=Math.floor(r/6e4);Oo.textContent=`Next daily gift: in ${l}h ${c}m`}else Oo.textContent="Next daily gift: at 00:00 UTC"}function tn(){En||(ri(),li(),En=setInterval(()=>{li()},1e3),setInterval(()=>ri(),3e4),At(),bo())}function Ml(){En&&(clearInterval(En),En=null)}Br();Ar().then(()=>{Ll(),fa()});Me();tn();window.addEventListener("resize",Zi);Zi();
