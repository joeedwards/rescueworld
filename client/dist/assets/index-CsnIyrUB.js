(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}})();const hi=25,ha=1e3/hi,te=4800,le=4800,ko=280,wt=32,St=2.5,qn=140,Co=10,To=18,ma=1.5,mi=50,Oe=1,De=2,_e=4,Ue=8,ya=0,ga=1,yi=2,gi=3,pi=4,Fe=0,ro=1,lo=2,co=3,gs=4,pa=1,bi=2;function vi(e,t){const n=new ArrayBuffer(4),o=new DataView(n);return o.setUint8(0,pa),o.setUint16(1,e,!0),o.setUint8(3,t&255),n}function ae(e,t){const n=e.getUint8(t);if(n===0)return{s:"",next:t+1};const o=e.buffer.byteLength-(t+1);if(n>o||n<0)throw new RangeError(`Snapshot string length ${n} exceeds buffer (${o} bytes left)`);const i=new Uint8Array(e.buffer,t+1,n);return{s:new TextDecoder().decode(i),next:t+1+n}}function ba(e){const t=new DataView(e);let n=0;if(t.getUint8(n++)!==bi)throw new Error("Invalid snapshot message");const o=t.getUint32(n,!0);n+=4;const i=t.getUint32(n,!0);n+=4;const r=t.getUint8(n++)!==0,{s:c,next:l}=ae(t,n);n=l;const f=t.getUint32(n,!0);n+=4;const g=t.getUint8(n++),m=t.getUint32(n,!0);n+=4;const x=t.getUint8(n++),R=[];for(let A=0;A<x;A++){const{s:U,next:F}=ae(t,n);n=F;const{s:K,next:j}=ae(t,n);n=j;const Y=t.getFloat32(n,!0);n+=4;const V=t.getFloat32(n,!0);n+=4;const ne=t.getFloat32(n,!0);n+=4;const me=t.getFloat32(n,!0);n+=4;const Qe=t.getFloat32(n,!0);n+=4;const ct=t.getUint32(n,!0);n+=4;const Mn=t.getUint8(n++),et=[];for(let tt=0;tt<Mn;tt++){const{s:_t,next:He}=ae(t,n);n=He,et.push(_t)}const We=t.getUint32(n,!0);n+=4;const $t=t.getUint8(n++),Me=t.getUint8(n++)!==0,Nt=t.getUint8(n++)!==0,dt=t.getUint8(n++),Ot=t.getUint8(n++),Lo=t.getUint8(n++),Bn=[];for(let tt=0;tt<Lo;tt++){const{s:_t,next:He}=ae(t,n);n=He,Bn.push(_t)}const{s:Pn,next:Ss}=ae(t,n);n=Ss;const Dt=t.getUint16(n,!0);n+=2;const{s:An,next:Is}=ae(t,n);n=Is;const xs=t.getUint8(n++)!==0;R.push({id:U,displayName:K||U,x:Y,y:V,vx:ne,vy:me,size:Qe,totalAdoptions:ct,petsInside:et,speedBoostUntil:We,inputSeq:$t,...Bn.length?{allies:Bn}:{},...Me?{eliminated:!0}:{},...Nt?{grounded:!0}:{},...dt>0?{portCharges:dt}:{},...Ot>0?{shelterPortCharges:Ot}:{},...Pn?{shelterColor:Pn}:{},...Dt>0?{money:Dt}:{},...An?{shelterId:An}:{},...xs?{vanSpeedUpgrade:!0}:{}})}const u=t.getUint16(n,!0);n+=2;const k=[];for(let A=0;A<u;A++){const{s:U,next:F}=ae(t,n);n=F;const K=t.getFloat32(n,!0);n+=4;const j=t.getFloat32(n,!0);n+=4;const Y=t.getFloat32(n,!0);n+=4;const V=t.getFloat32(n,!0);n+=4;const{s:ne,next:me}=ae(t,n);n=me;const Qe=ne===""?null:ne,ct=n<t.byteLength?t.getUint8(n++):0;k.push({id:U,x:K,y:j,vx:Y,vy:V,insideShelterId:Qe,petType:ct})}const b=t.getUint8(n++),S=[];for(let A=0;A<b;A++){const{s:U,next:F}=ae(t,n);n=F;const K=t.getFloat32(n,!0);n+=4;const j=t.getFloat32(n,!0);n+=4;const Y=t.getFloat32(n,!0);n+=4,S.push({id:U,x:K,y:j,radius:Y})}const y=t.getUint8(n++),P=[];for(let A=0;A<y;A++){const{s:U,next:F}=ae(t,n);n=F;const K=t.getFloat32(n,!0);n+=4;const j=t.getFloat32(n,!0);n+=4;const Y=t.getUint8(n++),V=t.getUint8(n++);P.push({id:U,x:K,y:j,type:Y,level:V>0?V:void 0})}const _=t.getUint8(n++),O=[];for(let A=0;A<_;A++){const{s:U,next:F}=ae(t,n);n=F;const{s:K,next:j}=ae(t,n);n=j;const Y=t.getFloat32(n,!0);n+=4;const V=t.getFloat32(n,!0);n+=4;const ne=t.getUint8(n++),me=(ne&1)!==0,Qe=(ne&2)!==0,ct=(ne&4)!==0,Mn=t.getUint8(n++),et=[];for(let Nt=0;Nt<Mn;Nt++){const{s:dt,next:Ot}=ae(t,n);n=Ot,et.push(dt)}const We=t.getFloat32(n,!0);n+=4;const $t=t.getUint32(n,!0);n+=4;const Me=n<t.byteLength?t.getUint8(n++):We<100?1:We<250?2:We<500?3:We<1e3?4:5;O.push({id:U,ownerId:K,x:Y,y:V,hasAdoptionCenter:me,hasGravity:Qe,hasAdvertising:ct,petsInside:et,size:We,totalAdoptions:$t,tier:Me})}const J=n<t.byteLength?t.getUint8(n++):0,G=[];for(let A=0;A<J;A++){const{s:U,next:F}=ae(t,n);n=F;const K=t.getFloat32(n,!0);n+=4;const j=t.getFloat32(n,!0);n+=4;const Y=t.getUint8(n++),V=t.getFloat32(n,!0);n+=4,G.push({id:U,x:K,y:j,level:Y,size:V})}const ie=n<t.byteLength?t.getUint8(n++):0,fe=[];for(let A=0;A<ie;A++){const{s:U,next:F}=ae(t,n);n=F;const{s:K,next:j}=ae(t,n);n=j;const Y=t.getFloat32(n,!0);n+=4;const V=t.getFloat32(n,!0);n+=4;const ne=t.getUint32(n,!0);n+=4;const me=t.getUint32(n,!0);n+=4,fe.push({id:U,type:K,x:Y,y:V,startTick:ne,durationTicks:me,requirements:[],contributions:{},rewards:{top1:0,top2:0,top3:0,participation:0}})}return{tick:o,matchEndAt:i,matchEndedEarly:r||void 0,winnerId:c||void 0,totalMatchAdoptions:f,scarcityLevel:g>0?g:void 0,matchDurationMs:m,players:R,pets:k,adoptionZones:S,pickups:P,shelters:O.length>0?O:void 0,breederShelters:G.length>0?G:void 0,adoptionEvents:fe.length>0?fe:void 0}}const Ei="rescueworld_music",wi="rescueworld_sfx";function Si(e,t){try{const n=localStorage.getItem(e);if(n==="0"||n==="false")return!1;if(n==="1"||n==="true")return!0}catch{}return t}function Ii(e,t){try{localStorage.setItem(e,t?"1":"0")}catch{}}function Qt(){return Si(Ei,!0)}function xi(e){Ii(Ei,e),re&&(re.volume=e?1:0),!e&&re&&re.pause()}function Li(){return Si(wi,!0)}function va(e){Ii(wi,e)}let Rn=null;function Ea(){if(Rn)return Rn;try{Rn=new(window.AudioContext||window.webkitAudioContext)}catch{return null}return Rn}function ce(e,t,n="sine",o=.3){if(!Li())return;const i=Ea();if(i)try{const r=i.createOscillator(),c=i.createGain();r.connect(c),c.connect(i.destination),r.frequency.value=e,r.type=n,c.gain.setValueAtTime(o,i.currentTime),c.gain.exponentialRampToValueAtTime(.001,i.currentTime+t),r.start(i.currentTime),r.stop(i.currentTime+t)}catch{}}function Vn(){ce(523,.12,"sine",.25),setTimeout(()=>ce(659,.1,"sine",.2),80)}function wa(){ce(440,.08,"square",.2),setTimeout(()=>ce(880,.08,"square",.15),60)}function Sa(){ce(392,.1,"sine",.25),setTimeout(()=>ce(523,.12,"sine",.22),70),setTimeout(()=>ce(659,.15,"sine",.2),140)}function Ia(){ce(330,.06,"sine",.18)}function xa(){ce(523,.15,"sine",.25),setTimeout(()=>ce(659,.15,"sine",.22),120),setTimeout(()=>ce(784,.2,"sine",.2),240)}function La(){ce(440,.08,"sine",.2),setTimeout(()=>ce(554,.08,"sine",.18),80),setTimeout(()=>ce(659,.12,"sine",.2),160)}function Zn(){ce(220,.15,"sawtooth",.35),setTimeout(()=>ce(180,.12,"sawtooth",.3),100),setTimeout(()=>ce(220,.1,"sawtooth",.25),200)}let re=null;function ka(){var o;const e=import.meta;let t=typeof((o=e.env)==null?void 0:o.BASE_URL)=="string"?e.env.BASE_URL:"";if(!t||t==="/"){const i=typeof window<"u"?window.location.pathname:"";if(i.includes("rescueworld"))t="/rescueworld/";else{const r=i.lastIndexOf("/");t=r<=0?"/":i.slice(0,r+1)}}return t.endsWith("/")?`${t}music.mp3`:`${t}/music.mp3`}function Tn(){if(Qt())try{if(!re){re=new Audio,re.loop=!0,re.volume=1,re.preload="auto",re.src=ka();let t=!1;re.addEventListener("error",()=>{!re||t||(t=!0,re.src="/rescueworld/music.mp3",re.play().catch(()=>{}))}),re.load()}re.volume=Qt()?1:0;const e=re.play();e&&typeof e.catch=="function"&&e.catch(()=>{})}catch{}}const dn=new Image;let ki=!1;function Ca(){const e=["/breeder-mill.png","/rescueworld/breeder-mill.png"];let t=0;const n=()=>{if(t>=e.length){console.error("Failed to load breeder-mill.png from all paths");return}dn.src=e[t],t++};dn.onload=()=>{ki=!0},dn.onerror=()=>{console.warn("Failed to load breeder-mill.png from",dn.src),n()},n()}Ca();const st=new Image;let Ci=!1;function Ta(){const e=["/adoption-event.png","/rescueworld/adoption-event.png"];let t=0;const n=()=>{if(t>=e.length){console.error("[AdoptionEvent] Failed to load adoption-event.png from all paths:",e);return}const o=e[t];console.log(`[AdoptionEvent] Attempting to load image from: ${o}`),st.src=o,t++};st.onload=()=>{Ci=!0,console.log(`[AdoptionEvent] Image loaded successfully from: ${st.src} (${st.width}x${st.height})`)},st.onerror=o=>{console.error(`[AdoptionEvent] Failed to load from ${st.src}:`,o),n()},n()}Ta();const Ti=(()=>{const{protocol:e,host:t}=window.location;return`${e==="https:"?"wss:":"ws:"}//${t}/ws-signaling`})();let xn=0,Mi=0;const oe={};let on=!1,Qn=0,es=0,ps=0,bs=0;const Ma=15,Mo=60;let d=null,M=null,a=null;const ts=new Map,ns=new Map,Ba=100;let L=null,Cs=0,Ts=0,Bo=0,fn=0,Po=[],Ao=[];const Ms=new Map;let Ro=0,it=!1,It=!1,Bi=0,zs=0,Bs=0,$n=null,qs=null,En=null;const Pa=200,T=document.getElementById("game"),s=T.getContext("2d"),Ye=document.getElementById("minimap"),h=Ye.getContext("2d"),Aa=document.getElementById("score"),Ps=document.getElementById("event-panel"),$o=document.getElementById("event-panel-list"),Ra=document.getElementById("carried"),No=document.getElementById("tag-cooldown"),$a=document.getElementById("timer"),Na=document.getElementById("game-clock"),Ae=document.getElementById("leaderboard"),ee=document.getElementById("connection-overlay"),Oa=document.getElementById("how-to-play"),Da=document.getElementById("settings-btn"),fo=document.getElementById("settings-panel"),_a=document.getElementById("exit-to-lobby-btn"),zt=document.getElementById("music-toggle"),Xs=document.getElementById("sfx-toggle"),Ua=document.getElementById("settings-close");document.getElementById("ping");const Fa=document.getElementById("switch-server"),Ya=document.getElementById("switch-server-btn"),we=document.getElementById("auth-area"),en=document.getElementById("landing"),Tt=document.getElementById("game-wrap"),Wa=document.getElementById("landing-play"),ue=document.getElementById("landing-nick"),Ie=document.getElementById("nick-save-btn"),nt=document.getElementById("nick-hint"),ln=document.getElementById("landing-music-toggle"),qt=document.getElementById("landing-profile-name"),Xt=document.getElementById("landing-profile-avatar"),As=document.getElementById("landing-profile-actions"),Rs=document.getElementById("landing-auth-buttons"),xt=document.getElementById("referral-status"),$s=document.getElementById("referral-link"),Gs=document.getElementById("referral-copy-btn"),Xn=document.getElementById("referral-claim-btn"),uo=document.getElementById("cookie-banner"),Ha=document.getElementById("cookie-accept"),za=document.getElementById("cookie-essential"),un=document.getElementById("fight-ally-overlay"),qa=document.getElementById("fight-ally-name"),Xa=document.getElementById("fight-ally-fight"),Ga=document.getElementById("fight-ally-ally"),Nn=document.getElementById("cpu-warning"),ss=document.getElementById("action-menu"),Ka=document.getElementById("action-menu-close"),ja=document.getElementById("action-size-text"),Ja=document.getElementById("action-size-bar"),Va=document.getElementById("action-tokens-text"),Za=document.getElementById("action-tokens-bar"),ot=document.getElementById("action-build-btn"),Oo=document.getElementById("action-build-shelter"),On=document.getElementById("action-adoption-center"),Dn=document.getElementById("action-gravity"),_n=document.getElementById("action-advertising"),Do=document.getElementById("action-van-speed"),hn=document.getElementById("action-adoption-btn"),mn=document.getElementById("action-gravity-btn"),yn=document.getElementById("action-advertising-btn"),gn=document.getElementById("action-van-speed-btn"),Ks=document.getElementById("ground-btn"),Gn=document.getElementById("port-btn"),pe=document.getElementById("shelter-port-btn"),pt=document.getElementById("transfer-btn"),pn=document.getElementById("build-shelter-btn"),os=document.getElementById("center-van-btn"),wn=document.getElementById("center-shelter-btn"),Qa=document.getElementById("game-tokens"),Ft=document.getElementById("lobby-overlay"),js=document.getElementById("lobby-message"),Ns=document.getElementById("lobby-player-list"),Os=document.getElementById("lobby-countdown"),Yt=document.getElementById("lobby-ready-btn"),er=document.getElementById("lobby-back-btn"),bn=document.getElementById("lobby-gift-btn"),Js=document.getElementById("breeder-minigame"),tr=document.getElementById("breeder-timer"),nr=document.getElementById("breeder-tokens"),_o=document.getElementById("breeder-pets"),rt=document.getElementById("breeder-foods"),Pi=document.getElementById("breeder-result"),sr=document.getElementById("breeder-result-title"),Ai=document.getElementById("breeder-rewards"),or=document.getElementById("breeder-close-btn"),Ri=document.getElementById("daily-gift-modal"),ir=document.getElementById("daily-gift-close"),Ds=document.getElementById("daily-gift-subtitle"),Uo=document.getElementById("daily-gift-grid"),mt=document.getElementById("daily-gift-claim-btn"),yt=document.getElementById("daily-gift-btn"),ar=document.getElementById("server-clock-time"),Fo=document.getElementById("server-clock-next-gift"),$i=document.getElementById("leaderboard-modal"),rr=document.getElementById("leaderboard-close"),is=document.getElementById("leaderboard-content"),Wt=document.getElementById("leaderboard-my-rank"),lr=document.getElementById("leaderboard-btn"),Pe=document.getElementById("lobby-leaderboard-content");let xe=null,as=0,at=null;const cr=3e4,dr=document.getElementById("equip-rt"),fr=document.getElementById("equip-ports"),ur=document.getElementById("equip-speed"),hr=document.getElementById("equip-size"),cn=document.getElementById("equip-note");let Ge={storedRt:0,portCharges:0,speedBoosts:0,sizeBoosts:0,signedIn:!1};const p={active:!1,pets:[],selectedPetIndex:null,timeLeft:30,timerInterval:null,addPetInterval:null,totalPets:0,rescuedCount:0,level:1,selectedIngredients:[]},Ni={apple:5,carrot:8,chicken:15,seeds:5,water:20,bowl:20},mr={apple:["horse","rabbit"],carrot:["horse","bird","rabbit"],chicken:["dog","cat"],seeds:["bird"],water:[],bowl:[]},yr={2:[{ingredients:["chicken","carrot"],worksOn:["dog","cat"]},{ingredients:["seeds","apple"],worksOn:["bird"]},{ingredients:["apple","carrot"],worksOn:["horse","rabbit"]}],3:[{ingredients:["water","chicken","carrot"],worksOn:["dog","cat"]},{ingredients:["water","seeds","apple"],worksOn:["bird"]},{ingredients:["water","apple","carrot"],worksOn:["horse","rabbit"]}],4:[{ingredients:["bowl","water","chicken","carrot"],worksOn:["dog","cat"]},{ingredients:["bowl","water","seeds","apple"],worksOn:["bird"]},{ingredients:["bowl","water","apple","carrot"],worksOn:["horse","rabbit"]}]};function an(e){return e<=2?1:e<=5?2:e<=9?3:4}const gr={dog:"ðŸ•",cat:"ðŸ±",horse:"ðŸ´",bird:"ðŸ¦",rabbit:"ðŸ°"},ho="cookieConsent",Oi="rescueworld_mode",Di="rescueworld_ref",pr="rescueworld_skin_unlocked";let bt=null;const Vs=new Set,rs=new Set;let Un=0;const Yo=2e3,Wo=new Map,Ln=new Map,Zs=400,Ho=new Map,Kn=[],zo=800,br={[Fe]:"ðŸˆ",[ro]:"ðŸ•",[lo]:"ðŸ¦",[co]:"ðŸ°",[gs]:"â­"};let vr=0;function qo(e,t,n,o,i){const r=Date.now();for(let c=0;c<i.length;c++){const l=i[c]??Fe,f=c*100,g=(Math.random()-.5)*30,m=(Math.random()-.5)*30;Kn.push({id:`adopt-${vr++}`,startTime:r+f,fromX:e+g,fromY:t+m,toX:n,toY:o,petType:l})}}let Q="playing",_s=0,Er=0,ls=!1;const _i="rescueworld_tokens",mo="rescueworld_color",Ui="rescueworld_unlocked_colors",cs={size:50,speed:30,adoptSpeed:40},ds={preset:50,custom:200,gradient:500};let H="ffa",Re=!1;const ge={sizeBonus:0,speedBoost:!1,adoptSpeed:!1};let Le=null,de=!1,vs=null,wr=null,Ne=null;const Qs="rescueworld_active_mp_match";function Sr(){try{const e=localStorage.getItem(Qs);if(e){const t=JSON.parse(e);if(t.matchId&&(t.mode==="ffa"||t.mode==="teams"))return t}}catch{}return null}function Gt(e){Ne=e,e?localStorage.setItem(Qs,JSON.stringify(e)):localStorage.removeItem(Qs)}function Fi(e){const t=e.split("-");return t.length>=2?t.slice(1).join("-").toUpperCase().slice(-6):e.slice(-6).toUpperCase()}let Lt=null;function Ce(){return parseInt(localStorage.getItem(_i)||"0",10)}function Mt(e){localStorage.setItem(_i,String(Math.max(0,e)))}function Te(){const e=document.getElementById("landing-tokens");e&&(e.textContent=`Tokens: ${Ce()} RT`);const t=Ce();document.querySelectorAll(".landing-buy").forEach(n=>{const o=n.dataset.boost;if(!o||!(o in cs))return;const i=cs[o];n.disabled=t<i||o==="speed"&&ge.speedBoost||o==="adoptSpeed"&&ge.adoptSpeed})}function Yi(){return localStorage.getItem(mo)||"#7bed9f"}function tn(e){localStorage.setItem(mo,e),de&&fetch("/auth/profile",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({shelterColor:e})}).catch(()=>{})}function Es(){try{const e=localStorage.getItem(Ui);if(e)return JSON.parse(e)}catch{}return{preset:!1,custom:null,gradient:null}}function eo(e){localStorage.setItem(Ui,JSON.stringify(e))}function kt(){const e=Yi(),t=Es(),n=Ce();document.querySelectorAll(".color-btn").forEach(i=>{const r=i.dataset.color;i.classList.toggle("selected",r===e)});const o=document.getElementById("preset-colors-row");o&&(o.style.display=t.preset?"flex":"none",o.querySelectorAll(".preset-color").forEach(i=>{const r=i.dataset.color;i.classList.toggle("selected",r===e)})),document.querySelectorAll(".color-buy").forEach(i=>{const r=i.dataset.color,c=ds[r],l=r==="preset"?t.preset:r==="custom"?!!t.custom:!!t.gradient;i.disabled=l||n<c,i.classList.toggle("unlocked",l),l&&(r==="preset"?i.textContent="Preset Colors Unlocked":r==="custom"?i.textContent="Custom Color: Click to use":r==="gradient"&&(i.textContent="Gradient: Click to use"))})}let Us=null;function X(e,t="info"){let n=document.getElementById("toast");n||(n=document.createElement("div"),n.id="toast",n.className="toast",document.body.appendChild(n)),n.textContent=e,n.classList.remove("toast-success","toast-error","toast-info"),n.classList.add(`toast-${t}`),t==="success"?n.style.background="linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)":t==="error"?n.style.background="linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)":n.style.background="linear-gradient(135deg, #3498db 0%, #2980b9 100%)",n.classList.add("show"),Us&&clearTimeout(Us),Us=setTimeout(()=>{n.classList.remove("show")},3e3)}const Ct=[];let ve=null,jn=!1;function Ir(e){for(Ct.push(...e);Ct.length>3;)Ct.shift();Wi()}function to(){Ct.length=0,jn=!1,ve&&(ve.style.display="none",ve.innerHTML="")}function Wi(){if(jn||Ct.length===0)return;const e=Ct.shift();jn=!0;const t=["rescued","shut down","destroyed","saved","stopped","is shutting down","farmers market","school fair","petco","stadium","event started","partial win","dropped off","instant adoption","won "],n=["arrived","appeared","failed","formed","expanding","breeding","warning","danger","urgent","critical","strays on the map","game over at"],o=e.toLowerCase(),i=t.some(x=>o.includes(x)),r=n.some(x=>o.includes(x)),c=i&&!r||!r&&(o.includes("event")||o.includes("adoption")),l=c?"rgba(46,204,113,":"rgba(255,107,107,",f=c?"rgba(46,204,113,0.8)":"rgba(255,107,107,0.8)",g=c?"âœ…":"âš ï¸";ve||(ve=document.createElement("div"),ve.id="announcement-bar",document.body.appendChild(ve)),ve.style.cssText=`
    position: fixed;
    top: 60px;
    left: 0;
    width: 100%;
    height: 40px;
    background: linear-gradient(90deg, ${l}0) 0%, ${l}0.4) 15%, ${l}0.4) 85%, ${l}0) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    z-index: 150;
    pointer-events: none;
  `;const m=document.createElement("div");if(m.style.cssText=`
    white-space: nowrap;
    font: bold 18px 'Rubik', sans-serif;
    color: #fff;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 10px ${f};
    animation: announcementScroll 8s linear forwards;
  `,m.textContent=`${g} ${e} ${g}`,!document.getElementById("announcement-keyframes")){const x=document.createElement("style");x.id="announcement-keyframes",x.textContent=`
      @keyframes announcementScroll {
        0% { transform: translateX(100vw); opacity: 0; }
        5% { opacity: 1; }
        95% { opacity: 1; }
        100% { transform: translateX(-100vw); opacity: 0; }
      }
    `,document.head.appendChild(x)}ve.style.display="flex",ve.innerHTML="",ve.appendChild(m),m.addEventListener("animationend",()=>{jn=!1,Ct.length===0&&ve&&(ve.style.display="none"),Wi()})}const fs=document.getElementById("ally-request-popup"),Xo=document.getElementById("ally-requester-name"),Go=document.getElementById("ally-accept-btn"),Ko=document.getElementById("ally-deny-btn");let us=null,Kt=null;function xr(e,t){!fs||!Xo||(us=e,Xo.textContent=t,fs.classList.remove("hidden"),Kt&&clearTimeout(Kt),Kt=setTimeout(()=>{Hi()},1e4))}function Hi(){fs&&fs.classList.add("hidden"),us=null,Kt&&(clearTimeout(Kt),Kt=null)}function zi(e){!us||!d||d.readyState!==WebSocket.OPEN||(d.send(JSON.stringify({type:"allyResponse",targetId:us,accept:e})),Hi())}Go&&Go.addEventListener("click",()=>zi(!0));const jo=document.getElementById("transfer-confirm-popup");document.getElementById("transfer-confirm-count");const Jo=document.getElementById("transfer-confirm-btn"),Vo=document.getElementById("transfer-cancel-btn");let no=null;function yo(){jo&&jo.classList.add("hidden"),no=null}Jo&&Jo.addEventListener("click",()=>{!d||d.readyState!==WebSocket.OPEN||!no||(d.send(JSON.stringify({type:"transferPets",targetShelterId:no})),yo())});Vo&&Vo.addEventListener("click",yo);Ko&&Ko.addEventListener("click",()=>zi(!1));const hs=document.getElementById("abandon-confirm-popup"),Zo=document.getElementById("abandon-confirm-btn"),Qo=document.getElementById("abandon-cancel-btn");let ms=null;function ei(e){hs&&(ms=e,hs.classList.remove("hidden"))}function qi(){hs&&hs.classList.add("hidden"),ms=null}Zo&&Zo.addEventListener("click",()=>{ms&&ms(),qi()});Qo&&Qo.addEventListener("click",qi);function Lr(){const e=window.location.pathname;if(e.includes("rescueworld"))return"/rescueworld/";const t=e.lastIndexOf("/");return t<=0?"/":e.slice(0,t+1)}function kr(){try{const e=new URL(window.location.href),t=e.searchParams.get("ref");t&&(localStorage.setItem(Di,t),e.searchParams.delete("ref"),window.history.replaceState({},document.title,e.toString()))}catch{}}function Cr(){try{const e=localStorage.getItem(Di);return e&&e.length?e:null}catch{return null}}function vn(e){const t=Cr();return t?`${e}?ref=${encodeURIComponent(t)}`:e}function Xi(e){const t=Lr();return`${window.location.origin}${t}?ref=${encodeURIComponent(e)}`}let Ee=null;async function Gi(){if(!de){Ee=null;return}try{const e=await fetch("/referrals/me",{credentials:"include"});if(!e.ok){Ee=null;return}Ee=await e.json()}catch{Ee=null}}function Ki(){if(!de||!Ee){xt.textContent="Sign in to get your referral link.",$s.classList.add("referral-hidden"),Gs.classList.add("referral-hidden"),Xn.classList.add("referral-hidden");return}const e=Xi(Ee.referralCode);xt.textContent=`Referrals: ${Ee.referralCount}/${Ee.rewardThreshold} (OAuth signups)`,$s.textContent=e,$s.classList.remove("referral-hidden"),Gs.classList.remove("referral-hidden"),Ee.rewardEligible&&!Ee.rewardClaimed?Xn.classList.remove("referral-hidden"):Xn.classList.add("referral-hidden")}async function jt(){if(!vs){Re=!1,$e();return}try{Re=!!(await(await fetch("/api/saved-match",{credentials:"include"})).json()).hasSavedMatch}catch{Re=!1}$e()}function $e(){const e=document.getElementById("resume-match-btn"),t=document.getElementById("landing-play");if(!(!e||!t)){if(Re&&H==="solo"){e.classList.remove("hidden"),e.textContent="Resume Match",t.textContent="Start new game";return}if(Ne||(Ne=Sr()),Ne&&de&&H===Ne.mode){const n=Fi(Ne.matchId);e.classList.remove("hidden"),e.textContent=`Return to Match '${n}'`,t.textContent="Abandon & New Match";return}e.classList.add("hidden"),e.textContent="Resume Match",t.textContent="Play"}}async function Tr(){try{const n=await(await fetch("/auth/me",{credentials:"include"})).json(),{displayName:o,signedIn:i,userId:r,shelterColor:c}=n,l=o??"";if(Le=l||null,de=i,vs=r,wr=c,i&&c&&localStorage.setItem(mo,c),i&&l)we.innerHTML=`
        <span class="auth-profile">${Ze(l)}</span>
        <a href="/auth/signout" class="auth-link">Sign out</a>
      `,qt.textContent=l,Xt.textContent=l.charAt(0).toUpperCase(),As.innerHTML='<a href="/auth/signout" class="auth-link" style="font-size:12px">Sign out</a>',Rs.innerHTML="",ue&&(ue.placeholder=l);else{const f=l?`${Ze(l)}`:"Guest";we.innerHTML=`
        <a href="${vn("/auth/google")}" class="auth-link">Sign in with Google</a>
        <span class="auth-guest">${f}</span>
      `,qt.textContent=l||"Guest",Xt.textContent=l?l.charAt(0).toUpperCase():"?",As.innerHTML="",Rs.innerHTML=`
        <a href="${vn("/auth/google")}">Sign in with Google</a>
      `,ue&&(ue.placeholder=l||"Nickname")}ue&&l&&(ue.value=l)}catch{Le=null,de=!1,we.innerHTML=`
      <a href="${vn("/auth/google")}" class="auth-link">Sign in with Google</a>
      <span class="auth-guest">Guest</span>
    `,qt.textContent="Guest",Xt.textContent="?",As.innerHTML="",Rs.innerHTML=`<a href="${vn("/auth/google")}">Sign in with Google</a>`,ue&&(ue.placeholder="Nickname")}await Gi(),Ki(),await aa(),await jt(),new URLSearchParams(window.location.search).get("registered")==="1"&&de&&setTimeout(()=>{X("Welcome! Registration gift: 50 RT + Day 1 gift claimed!","success"),window.history.replaceState({},"",window.location.pathname)},500)}async function ji(){var t;const e=(t=ue==null?void 0:ue.value)==null?void 0:t.trim();if(!e||e.length<1){nt&&(nt.textContent="Enter a nickname first!");return}if(de)try{const o=await(await fetch("/auth/profile",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({nickname:e})})).json();o.success&&(Le=o.displayName,qt.textContent=o.displayName,Xt.textContent=o.displayName.charAt(0).toUpperCase(),Ie&&(Ie.textContent="Saved!",Ie.classList.add("saved"),setTimeout(()=>{Ie.textContent="Save",Ie.classList.remove("saved")},2e3)),nt&&(nt.textContent=""))}catch{nt&&(nt.textContent="Failed to save")}else Le=e,qt.textContent=e,Xt.textContent=e.charAt(0).toUpperCase(),Ie&&(Ie.textContent="Saved!",Ie.classList.add("saved"),setTimeout(()=>{Ie.textContent="Save",Ie.classList.remove("saved")},2e3)),nt&&(nt.textContent="Sign in to save permanently")}Ie&&Ie.addEventListener("click",ji);ue&&ue.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),ji())});async function Mr(){var n;const e=(n=ue==null?void 0:ue.value)==null?void 0:n.trim();if(e){if(de&&e!==Le)try{await fetch("/auth/profile",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({nickname:e})})}catch{}return Le=e,e}if(Le)return Le;try{const i=await(await fetch("/auth/guest",{method:"POST",credentials:"include"})).json();if(i.displayName)return Le=i.displayName,qt.textContent=i.displayName,Xt.textContent=i.displayName.charAt(0).toUpperCase(),i.displayName}catch{}const t=`rescue${Date.now().toString(36)}`;return Le=t,t}function Ze(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Ji(){const e=window.innerWidth,t=window.innerHeight;T.width=e,T.height=t}function $(e,t){t?xn|=e:xn&=~e}let so=!1;function rn(){const e=a==null?void 0:a.players.find(t=>t.id===M);return(e==null?void 0:e.eliminated)===!0}function Br(){const e=rn();if(e&&!so){const t=a==null?void 0:a.players.find(n=>n.id===M);t&&(Je=t.x,Ve=t.y)}so=e}function Pr(e){const t=e.target;if(!(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable)){if(oe[e.code]=!0,p.active){e.preventDefault();return}if(rn()){e.preventDefault();return}(e.code==="KeyW"||e.code==="ArrowUp")&&$(_e,!0),(e.code==="KeyS"||e.code==="ArrowDown")&&$(Ue,!0),(e.code==="KeyA"||e.code==="ArrowLeft")&&$(Oe,!0),(e.code==="KeyD"||e.code==="ArrowRight")&&$(De,!0),e.preventDefault()}}function Ar(e){if(oe[e.code]=!1,p.active){e.preventDefault();return}if(rn()){e.preventDefault();return}(e.code==="KeyW"||e.code==="ArrowUp")&&$(_e,!1),(e.code==="KeyS"||e.code==="ArrowDown")&&$(Ue,!1),(e.code==="KeyA"||e.code==="ArrowLeft")&&$(Oe,!1),(e.code==="KeyD"||e.code==="ArrowRight")&&$(De,!1),e.preventDefault()}function Rr(){return!!(oe.KeyW||oe.KeyS||oe.KeyA||oe.KeyD||oe.ArrowUp||oe.ArrowDown||oe.ArrowLeft||oe.ArrowRight)}function $r(){if(Rr())return;if(p.active){$(Oe,!1),$(De,!1),$(_e,!1),$(Ue,!1);return}if(!on){$(Oe,!1),$(De,!1),$(_e,!1),$(Ue,!1);return}const e=ps-Qn,t=bs-es,n=Math.hypot(e,t);if(n<Ma){$(Oe,!1),$(De,!1),$(_e,!1),$(Ue,!1);return}const o=e/n,i=t/n;$(Oe,o<-.3),$(De,o>.3),$(_e,i<-.3),$(Ue,i>.3)}T.addEventListener("touchstart",e=>{e.preventDefault(),e.touches.length&&(on=!0,Qn=e.touches[0].clientX,es=e.touches[0].clientY,ps=Qn,bs=es)},{passive:!1});T.addEventListener("touchmove",e=>{e.preventDefault(),e.touches.length&&on&&(ps=e.touches[0].clientX,bs=e.touches[0].clientY)},{passive:!1});function go(){if((d==null?void 0:d.readyState)===WebSocket.OPEN){const e=vi(xn,Mi++);d.send(e)}}T.addEventListener("touchend",e=>{e.preventDefault(),e.touches.length===0&&(on=!1,$(Oe,!1),$(De,!1),$(_e,!1),$(Ue,!1),go())},{passive:!1});T.addEventListener("touchcancel",e=>{e.preventDefault(),on=!1,$(Oe,!1),$(De,!1),$(_e,!1),$(Ue,!1),go()},{passive:!1});let po=!1,oo=0,io=0;T.addEventListener("mousedown",e=>{e.preventDefault(),rn()&&(po=!0,oo=e.clientX,io=e.clientY)});T.addEventListener("mousemove",e=>{if(e.preventDefault(),rn()&&po){const t=e.clientX-oo,n=e.clientY-io;Je-=t,Ve-=n,Je=Math.max(T.width/2,Math.min(te-T.width/2,Je)),Ve=Math.max(T.height/2,Math.min(le-T.height/2,Ve)),oo=e.clientX,io=e.clientY}});T.addEventListener("mouseup",e=>{e.preventDefault(),po=!1});T.addEventListener("contextmenu",e=>{e.preventDefault()});function Vi(e,t){if(!a||!M||!d||d.readyState!==WebSocket.OPEN)return;const n=Zi(),o=e+n.x,i=t+n.y;for(const r of a.players){if(r.id===M||r.eliminated)continue;const c=wt+r.size*St;if(o>=r.x-c&&o<=r.x+c&&i>=r.y-c&&i<=r.y+c){rs.has(r.id)||(d.send(JSON.stringify({type:"allyRequest",targetId:r.id})),rs.add(r.id));break}}}T.addEventListener("click",e=>{if(!a||!M||!d||d.readyState!==WebSocket.OPEN)return;const t=T.getBoundingClientRect(),n=T.width/t.width,o=T.height/t.height,i=(e.clientX-t.left)*n,r=(e.clientY-t.top)*o;Vi(i,r)});T.addEventListener("touchend",e=>{if(!a||!M||!d||d.readyState!==WebSocket.OPEN||e.changedTouches.length!==1)return;const t=e.changedTouches[0],n=T.getBoundingClientRect(),o=T.width/n.width,i=T.height/n.height,r=(t.clientX-n.left)*o,c=(t.clientY-n.top)*i;Vi(r,c)});window.addEventListener("keydown",Pr);window.addEventListener("keyup",Ar);let lt=!1;function ws(e,t){const n=Ye.getBoundingClientRect(),o=e-n.left,i=t-n.top,r=te/120,c=o*r,l=i*r,f=(L==null?void 0:L.x)??te/2,g=(L==null?void 0:L.y)??le/2;Bt=c-f,Pt=l-g}Ye.addEventListener("mousedown",e=>{e.preventDefault(),lt=!0,ws(e.clientX,e.clientY)});Ye.addEventListener("mousemove",e=>{lt&&ws(e.clientX,e.clientY)});Ye.addEventListener("mouseup",()=>{lt=!1});Ye.addEventListener("mouseleave",()=>{lt=!1});Ye.addEventListener("touchstart",e=>{e.preventDefault(),lt=!0,e.touches.length>0&&ws(e.touches[0].clientX,e.touches[0].clientY)},{passive:!1});Ye.addEventListener("touchmove",e=>{lt&&e.touches.length>0&&(e.preventDefault(),ws(e.touches[0].clientX,e.touches[0].clientY))},{passive:!1});Ye.addEventListener("touchend",()=>{lt=!1});Ye.addEventListener("touchcancel",()=>{lt=!1});let qe=null,Xe=null;const ti=.22;let Bt=0,Pt=0,Je=te/2,Ve=le/2;const Fn=15;let Ke=null,je=null;const ni=.2;function Zi(){const e=T.width,t=T.height,n=a==null?void 0:a.players.find(m=>m.id===M);if((n==null?void 0:n.eliminated)===!0){const m=Math.max(0,Math.min(te-e,Je-e/2)),x=Math.max(0,Math.min(le-t,Ve-t/2));return{x:m,y:x,w:e,h:t}}let i=(L==null?void 0:L.x)??te/2,r=(L==null?void 0:L.y)??le/2;(!Number.isFinite(i)||!Number.isFinite(r))&&(i=te/2,r=le/2);let c=i-e/2+Bt,l=r-t/2+Pt;if(c=Math.max(0,Math.min(te-e,c)),l=Math.max(0,Math.min(le-t,l)),L==null)return qe=null,Xe=null,{x:c,y:l,w:e,h:t};qe==null||Xe==null||!Number.isFinite(qe)||!Number.isFinite(Xe)?(qe=c,Xe=l):(qe+=(c-qe)*ti,Xe+=(l-Xe)*ti);let f=qe,g=Xe;return(!Number.isFinite(f)||!Number.isFinite(g))&&(f=c,g=l,qe=f,Xe=g),f=Math.max(0,Math.min(te-e,f)),g=Math.max(0,Math.min(le-t,g)),{x:f,y:g,w:e,h:t}}const Nr=30;function Or(e,t,n){let o=0,i=0;t&Oe&&(o-=1),t&De&&(o+=1),t&_e&&(i-=1),t&Ue&&(i+=1);let r=0,c=0;if(o!==0||i!==0){const m=Math.hypot(o,i)||1,R=((e.speedBoostUntil??0)>0?ko*ma:ko)*n;r=o/m*R,c=i/m*R}const l=Nr;let f=e.x+r,g=e.y+c;return f=Math.max(l,Math.min(te-l,f)),g=Math.max(l,Math.min(le-l,g)),{...e,x:f,y:g,vx:r,vy:c,petsInside:[...e.petsInside],speedBoostUntil:e.speedBoostUntil??0}}const si=1e4;function bo(e){ee.classList.remove("hidden"),ee.innerHTML=`
    <h2>Could not connect</h2>
    <p class="error">${e}</p>
    <p>The game server is not running or not reachable.</p>
    <p><strong>To start the game:</strong></p>
    <p>From the project root folder, run: <code>npm run dev</code></p>
    <p>That starts both the server (ports 4000, 4001) and the client. Wait a few seconds, then refresh this page.</p>
    <p>Or run in two terminals: first <code>npm run dev:server</code>, then <code>npm run dev:client</code>.</p>
  `}async function vo(e){ll(),dl(),$n&&(clearInterval($n),$n=null),Fa.classList.add("hidden");const t=c=>/^wss?:\/\/localhost(\b|:|\/|$)/i.test(c)||/^wss?:\/\/127\.0\.0\.1(\b|:|\/|$)/i.test(c),n=()=>{const{protocol:c,host:l}=window.location;return`${c==="https:"?"wss:":"ws:"}//${l}/ws-game`};let o=t(window.location.href)?"ws://localhost:4001":n();const i=new WebSocket(Ti);await new Promise((c,l)=>{const f=setTimeout(()=>{i.close(),l(new Error("Connection timeout. Is the server running? Run: npm run dev"))},si);i.onopen=()=>{i.send(JSON.stringify({type:"join",latency:e==null?void 0:e.latency,mode:(e==null?void 0:e.mode)??"ffa"}))},i.onmessage=g=>{try{const m=JSON.parse(g.data);m.type==="joined"&&m.gameUrl&&(clearTimeout(f),o=m.gameUrl,!t(window.location.href)&&t(o)&&(o=n()),c())}catch{}},i.onerror=()=>{clearTimeout(f),l(new Error("WebSocket error. Server not running?"))},i.onclose=()=>{clearTimeout(f),i.readyState!==WebSocket.OPEN&&l(new Error("Signaling connection closed. Run: npm run dev"))}});const r=new WebSocket(o);r.binaryType="arraybuffer",r.onopen=async()=>{d=r;const c=await Mr(),l=await wl(),f=l.rt,g=l.ports;f>0&&X(`Starting with ${f} RT from chest!`,"success"),d.send(JSON.stringify({type:"mode",mode:(e==null?void 0:e.mode)??"ffa",displayName:c,startingRT:f,startingPorts:g,userId:vs})),(ge.sizeBonus>0||ge.speedBoost||ge.adoptSpeed)&&(d.send(JSON.stringify({type:"startingBoosts",sizeBonus:ge.sizeBonus,speedBoost:ge.speedBoost,adoptSpeed:ge.adoptSpeed})),ge.sizeBonus=0,ge.speedBoost=!1,ge.adoptSpeed=!1);const m=Yi();d.send(JSON.stringify({type:"setColor",color:m})),(e==null?void 0:e.mode)==="solo"&&li&&d.send(JSON.stringify({type:"setCpuBreederBehavior",canShutdown:li.checked}))},r.onmessage=c=>{var f,g,m,x,R;if(typeof c.data=="string"){try{const u=JSON.parse(c.data);if(u.type==="welcome"&&u.playerId&&(M=u.playerId,u.matchId&&(H==="ffa"||H==="teams")&&(u.resumed&&(Gt(null),X(`Rejoined match ${Fi(u.matchId)}!`,"success")),Lt=u.matchId),La()),u.type==="savedMatchExpired"){Re=!1,$e(),jt();const k=typeof u.reason=="string"?u.reason:"Match already ended";X(k,"info"),d&&(d.close(),d=null),M=null,a=null,Lt=null,Gt(null),Ae.classList.remove("show"),it=!1,It=!1,to(),Tt.classList.remove("visible"),en.classList.remove("hidden"),we.classList.remove("hidden"),Te(),nn(),ee==null||ee.classList.add("hidden"),sn(),At(),Io()}if(u.type==="serverShutdown"){const k=typeof u.message=="string"?u.message:"Server is updating. Your progress has been saved.";X(k,"info"),d&&(d.close(),d=null),M=null,a=null,Lt=null,Gt(null),Ae.classList.remove("show"),it=!1,It=!1,to(),Tt.classList.remove("visible"),en.classList.remove("hidden"),we.classList.remove("hidden"),Te(),nn(),$e(),jt(),ee==null||ee.classList.add("hidden"),sn(),At()}if(u.type==="matchState"&&typeof u.phase=="string"&&(Q=u.phase,_s=typeof u.countdownRemainingSec=="number"?u.countdownRemainingSec:0,Er=typeof u.readyCount=="number"?u.readyCount:0,Array.isArray(u.players)&&u.players.length>0?Ns.innerHTML=u.players.map(k=>`<div class="lobby-player">${Ze(k.displayName)}</div>`).join(""):Ns.innerHTML="",Q==="lobby"?H==="solo"?Ft.classList.add("hidden"):(Ft.classList.remove("hidden"),js.textContent="Waiting for another playerâ€¦",Os.classList.add("hidden"),Yt.classList.add("hidden")):Q==="countdown"?(Ft.classList.remove("hidden"),js.textContent="Match starting soon",Os.classList.remove("hidden"),Os.textContent=_s>0?`Starting in ${_s}sâ€¦`:"Startingâ€¦",Yt.classList.remove("hidden"),ls?Yt.textContent="Ready!":Yt.textContent="Ready"):(Ft.classList.add("hidden"),Ns.innerHTML="")),u.type==="pong"&&typeof u.ts=="number"&&(zs=Math.round(Date.now()-u.ts),zs>Pa?Bs=Bs||Date.now():Bs=0),u.type==="groundFailed"&&typeof u.reason=="string"&&X(u.reason),u.type==="breederStart"&&typeof u.petCount=="number"){const k=typeof u.level=="number"?u.level:1,b=!!u.isMill,S=typeof u.timeLimitSeconds=="number"?u.timeLimitSeconds:void 0,y=typeof u.addPetIntervalSeconds=="number"?u.addPetIntervalSeconds:void 0;Vr(u.petCount,k,{isMill:b,timeLimitSeconds:S,addPetIntervalSeconds:y})}if(u.type==="breederAddPet"&&p.active){const k=["dog","cat","horse","bird","rabbit"],b=k[Math.floor(Math.random()*k.length)];p.pets.push({type:b,rescued:!1}),p.totalPets++,kn(),Et()}if(u.type==="breederRewards"){const k=typeof u.tokenBonus=="number"?u.tokenBonus:0,b=Array.isArray(u.rewards)?u.rewards:[];sl(k,b)}u.type==="matchEndInventory"&&(Re=!1,$e(),jt()),u.type==="announcement"&&Array.isArray(u.messages)&&Ir(u.messages),u.type==="allyRequestReceived"&&typeof u.fromId=="string"&&typeof u.fromName=="string"&&xr(u.fromId,u.fromName),u.type==="transferResult"&&(yo(),u.success&&typeof u.count=="number"?X(`Transferred ${u.count} pets! You +${u.senderScore??0} score, ally +${u.receiverScore??0}`):typeof u.reason=="string"&&X(u.reason))}catch{}return}const l=c.data;if(!(l.byteLength<1)&&new DataView(l).getUint8(0)===bi){const u=ba(l);a=u,Q!=="playing"&&(Q="playing",Ft.classList.add("hidden"));for(const S of u.players){const y=((f=ts.get(S.id))==null?void 0:f.next)??S;ts.set(S.id,{prev:y,next:{...S},t:0});const P=Ho.get(S.id);if(P){const _=S.x-P.x,O=S.y-P.y;Math.hypot(_,O)>200&&!Ln.has(S.id)&&Ln.set(S.id,{startTime:Date.now(),fromX:P.x,fromY:P.y,toX:S.x,toY:S.y,phase:"fadeIn"})}Ho.set(S.id,{x:S.x,y:S.y})}const k=u.players.find(S=>S.id===M);if(k){const S=k.shelterPortCharges??0;if(S>fn){const y=S-fn;X(`+${y} Home Port${y>1?"s":""} ðŸ `,"success")}fn=S}for(const S of u.pets){const y=((g=ns.get(S.id))==null?void 0:g.next)??S;ns.set(S.id,{prev:y,next:{...S},t:0})}const b=u.players.find(S=>S.id===M);if(b){const S=!!b.shelterId;if(b.size>Cs&&!S&&b.size<50?(Bi=Date.now()+1500,Vn()):b.size>Cs&&Vn(),(b.speedBoostUntil??0)>Ro&&wa(),Ro=b.speedBoostUntil??0,b.totalAdoptions>Ts){Sa();const J=b.totalAdoptions-Ts,G=(m=a==null?void 0:a.shelters)==null?void 0:m.find(fe=>fe.ownerId===M);let ie;if(G!=null&&G.hasAdoptionCenter){ie=Ao.filter(A=>!G.petsInside.includes(A)).slice(0,J);const fe=ie.map(A=>Ms.get(A)??Fe);qo(G.x,G.y,G.x,G.y-100,fe)}else{ie=Po.filter(U=>!b.petsInside.includes(U)).slice(0,J);const fe=ie.map(U=>Ms.get(U)??Fe),A=(x=a==null?void 0:a.adoptionZones)==null?void 0:x[0];A&&qo(b.x,b.y,A.x,A.y,fe)}}Ts=b.totalAdoptions,b.petsInside.length>Bo&&Ia(),Bo=b.petsInside.length,Po=[...b.petsInside];const y=(R=a==null?void 0:a.shelters)==null?void 0:R.find(J=>J.ownerId===M);Ao=y?[...y.petsInside]:[];for(const J of u.pets)Ms.set(J.id,J.petType??Fe);Cs=b.size;const P=(L==null?void 0:L.x)??b.x,_=(L==null?void 0:L.y)??b.y;L={...b,petsInside:[...b.petsInside]},b.inputSeq,Math.hypot(b.x-P,b.y-_)>300&&(qe=null,Xe=null,Bt=0,Pt=0,Ke=b.x,je=b.y)}}},r.onclose=()=>{d=null,M=null,a=null,fn=0,L=null,Q="playing",rs.clear(),ls=!1},await new Promise((c,l)=>{const f=Date.now()+si,g=()=>{(d==null?void 0:d.readyState)===WebSocket.OPEN?c():Date.now()>f?l(new Error("Game server connection timeout")):setTimeout(g,50)};g()}),ee.classList.add("hidden"),Oa.classList.add("hidden"),Tn(),$n=setInterval(()=>{(d==null?void 0:d.readyState)===WebSocket.OPEN&&d.send(JSON.stringify({type:"ping",ts:Date.now()}))},2e3)}let Yn=0,oi=0;function Eo(e){var l,f;Yn||(Yn=e);const t=Math.min((e-Yn)/1e3,.1);Yn=e,$r(),Br(),rn()&&((oe.KeyW||oe.ArrowUp)&&(Ve-=Fn),(oe.KeyS||oe.ArrowDown)&&(Ve+=Fn),(oe.KeyA||oe.ArrowLeft)&&(Je-=Fn),(oe.KeyD||oe.ArrowRight)&&(Je+=Fn),Je=Math.max(T.width/2,Math.min(te-T.width/2,Je)),Ve=Math.max(T.height/2,Math.min(le-T.height/2,Ve)));const n=a!=null&&a.matchEndAt>0&&a.tick>=a.matchEndAt,o=a==null?void 0:a.players.find(g=>g.id===M),r=Q==="playing"&&!n&&!(o!=null&&o.eliminated)&&!p.active;if(r&&(d==null?void 0:d.readyState)===WebSocket.OPEN&&e-oi>=ha){oi=e;const g=vi(xn,Mi++);d.send(g)}if(r&&L&&M){L.x,L.y,L=Or(L,xn,t);let g=L.x,m=L.y;(!Number.isFinite(g)||!Number.isFinite(m))&&(g=te/2,m=le/2),Ke==null||je==null?(Ke=g,je=m):(Ke+=(g-Ke)*ni,je+=(m-je)*ni),(!Number.isFinite(Ke)||!Number.isFinite(je))&&(Ke=g,je=m);let x=null,R=!1;if(a){const u=a.players.find(b=>b.id===M),k=u!=null&&u.shelterId?(l=a.shelters)==null?void 0:l.find(b=>b.id===u.shelterId):null;if(k){const b=wt+k.size*St;for(const S of a.players){if(S.id===M)continue;const y=S.shelterId?(f=a.shelters)==null?void 0:f.find(O=>O.id===S.shelterId):null;if(!y)continue;const P=wt+y.size*St;if(Math.abs(k.x-y.x)<=b+P&&Math.abs(k.y-y.y)<=b+P&&!(k.size<Co||y.size<Co)){if(S.id.startsWith("cpu-")){R=!0;continue}if(!Vs.has(S.id)){x=S.id;break}}}}}if(x){const u=a.players.find(b=>b.id===x);bt=x,qa.textContent=(u==null?void 0:u.displayName)??x;const k=un.classList.contains("hidden");un.classList.remove("hidden"),k&&Date.now()-Un>Yo&&(Un=Date.now(),Zn())}else un.classList.add("hidden"),bt=null,Vs.clear();if(R){const u=Nn.classList.contains("hidden");Nn.classList.remove("hidden"),u&&Date.now()-Un>Yo&&(Un=Date.now(),Zn())}else Nn.classList.add("hidden")}else Ke=null,je=null,un.classList.add("hidden"),bt=null,Nn.classList.add("hidden");const c=t*(1e3/Ba);for(const g of ts.values())g.t=Math.min(1,g.t+c);for(const g of ns.values())g.t=Math.min(1,g.t+c);Kr(),requestAnimationFrame(Eo)}function Ht(e,t,n){return e+(t-e)*n}function Dr(e){const t=ts.get(e);if(!t)return null;const n=t.t;return{...t.next,x:Ht(t.prev.x,t.next.x,n),y:Ht(t.prev.y,t.next.y,n),vx:Ht(t.prev.vx,t.next.vx,n),vy:Ht(t.prev.vy,t.next.vy,n)}}function _r(e){const t=ns.get(e);if(!t)return null;const n=t.t;return{...t.next,x:Ht(t.prev.x,t.next.x,n),y:Ht(t.prev.y,t.next.y,n)}}const be=36,Wn=1.8;function wo(e){let t=0;for(let o=0;o<e.length;o++)t=t*31+e.charCodeAt(o)>>>0;return`hsl(${t%360}, 72%, 58%)`}function Ur(e){const t=be*2,n=Math.floor((e.x-t)/be)*be,o=Math.floor((e.y-t)/be)*be,i=Math.ceil((e.x+e.w+t)/be)*be,r=Math.ceil((e.y+e.h+t)/be)*be;s.fillStyle="#3d6b3d",s.fillRect(e.x,e.y,e.w,e.h),s.fillStyle="rgba(255,255,255,0.35)";for(let c=o;c<=r;c+=be)for(let l=n;l<=i;l+=be)s.fillRect(l-Wn,c-Wn,Wn*2,Wn*2)}function Fr(e){const t=e.x,n=e.y,o=e.radius||qn;!Number.isFinite(t)||!Number.isFinite(n)||!Number.isFinite(o)||(s.save(),s.strokeStyle="rgba(123, 237, 159, 0.6)",s.lineWidth=4,s.setLineDash([8,8]),s.strokeRect(t-o,n-o,o*2,o*2),s.setLineDash([]),s.fillStyle="rgba(74, 124, 89, 0.2)",s.fillRect(t-o,n-o,o*2,o*2),s.fillStyle="#7bed9f",s.font="bold 14px Rubik, sans-serif",s.textAlign="center",s.fillText("ADOPTION CENTER",t,n-o-8),s.fillText("Bring pets here to adopt out",t,n),s.restore())}const Qi=350;function Yr(e,t){const n=e.x,o=e.y,i=Qi,r=Math.max(0,e.startTick+e.durationTicks-t),c=Math.ceil(r/25),l=100,f=.8+.2*Math.sin(t*.15),g=a==null?void 0:a.players.find(k=>k.id===M),x=(g?Math.hypot(g.x-n,g.y-o):1/0)<=i;s.save(),x&&(s.fillStyle=`rgba(255, 193, 7, ${.15*f})`,s.beginPath(),s.arc(n,o,i+20,0,Math.PI*2),s.fill()),Ci?s.drawImage(st,n-l/2,o-l/2,l,l):(s.fillStyle=`rgba(255, 193, 7, ${.5*f})`,s.beginPath(),s.arc(n,o,l/2,0,Math.PI*2),s.fill(),s.strokeStyle="#ffc107",s.lineWidth=4,s.stroke(),s.fillStyle="#1a1a2e",s.font="bold 36px sans-serif",s.textAlign="center",s.textBaseline="middle",s.fillText("ðŸŽª",n,o)),s.strokeStyle=x?`rgba(123, 237, 159, ${.9*f})`:`rgba(255, 193, 7, ${.8*f})`,s.lineWidth=x?6:4,s.setLineDash([12,8]),s.beginPath(),s.arc(n,o,i,0,Math.PI*2),s.stroke(),s.setLineDash([]),s.fillStyle=x?"rgba(123, 237, 159, 0.15)":"rgba(255, 193, 7, 0.15)",s.beginPath(),s.arc(n,o,i,0,Math.PI*2),s.fill(),s.fillStyle=x?"#7bed9f":"#ffc107",s.font="bold 16px Rubik, sans-serif",s.textAlign="center",s.textBaseline="alphabetic";const R=e.type.replace(/_/g," ").replace(/\b\w/g,k=>k.toUpperCase());s.fillText(`ðŸ“¢ ${R}`,n,o-i-12),s.font="bold 14px Rubik, sans-serif";const u=x?`${c}s - DROP PETS HERE!`:`${c}s left - bring pets here!`;s.fillText(u,n,o+l/2+18),s.restore()}function ii(e,t,n,o){s.save();const i=60,r=o?n:1-n,c=o?.5+n*.5:1+n*.5;s.translate(e,t),s.scale(c,c),s.beginPath(),s.arc(0,0,i,0,Math.PI*2),s.strokeStyle=`rgba(200, 150, 255, ${r*.8})`,s.lineWidth=4,s.stroke();const l=s.createRadialGradient(0,0,0,0,0,i);l.addColorStop(0,`rgba(180, 120, 255, ${r*.6})`),l.addColorStop(.5,`rgba(140, 80, 220, ${r*.3})`),l.addColorStop(1,"rgba(100, 50, 180, 0)"),s.fillStyle=l,s.beginPath(),s.arc(0,0,i,0,Math.PI*2),s.fill();const f=8,g=Date.now()/100;for(let m=0;m<f;m++){const x=m/f*Math.PI*2+g*.5,R=i*.6*(.8+Math.sin(g+m)*.2),u=Math.cos(x)*R,k=Math.sin(x)*R,b=3+Math.sin(g*2+m)*1.5;s.beginPath(),s.arc(u,k,b,0,Math.PI*2),s.fillStyle=`rgba(255, 255, 255, ${r*.9})`,s.fill()}s.restore()}function ai(e,t,n,o,i="large"){s.save();const r=i==="small"?.5:1,c=i==="small"?.6:1,l=e-o*(n+8*r),f=t,g=Date.now()/100,m=Math.sin(g*3)*.3+.7,x=Math.cos(g*4)*.2+.8,R=25*r,u=s.createRadialGradient(l,f,0,l,f,R);u.addColorStop(0,`rgba(255, 200, 50, ${.6*m*c})`),u.addColorStop(.5,`rgba(255, 100, 20, ${.4*m*c})`),u.addColorStop(1,"rgba(255, 50, 0, 0)"),s.fillStyle=u,s.beginPath(),s.arc(l,f,R,0,Math.PI*2),s.fill();const k=18*r,b=10*r,S=k+Math.sin(g*5)*4*r,y=b+Math.cos(g*6)*2*r;s.beginPath(),s.moveTo(l+o*5,f-y/2),s.quadraticCurveTo(l-o*S*.6,f-y*.3*x,l-o*S,f),s.quadraticCurveTo(l-o*S*.6,f+y*.3*x,l+o*5,f+y/2),s.closePath();const P=s.createLinearGradient(l+o*5,f,l-o*S,f);P.addColorStop(0,"#FFD700"),P.addColorStop(.3,"#FF8C00"),P.addColorStop(.7,"#FF4500"),P.addColorStop(1,"rgba(255, 69, 0, 0.3)"),s.fillStyle=P,s.fill();const _=S*.6,O=y*.5;s.beginPath(),s.moveTo(l+o*5,f-O/2),s.quadraticCurveTo(l-o*_*.5,f-O*.2,l-o*_,f),s.quadraticCurveTo(l-o*_*.5,f+O*.2,l+o*5,f+O/2),s.closePath(),s.fillStyle="#FFFF80",s.fill(),s.restore()}function Wr(e,t){const i=e.x,r=e.y,c=Ln.get(e.id);let l=1;if(c){const Y=Date.now()-c.startTime;c.phase==="fadeIn"&&(l=Math.min(1,Y/Zs),Y>=Zs&&(Ln.delete(e.id),l=1))}Math.abs(e.vx)>.01&&Wo.set(e.id,e.vx>0?1:-1);const f=Wo.get(e.id)??1;s.save(),s.globalAlpha=l,s.shadowColor="rgba(0,0,0,0.4)",s.shadowBlur=10;const g=(a==null?void 0:a.tick)??0,m=(e.speedBoostUntil??0)>g,x=!!e.vanSpeedUpgrade;e.eliminated||(m?ai(i,r,50,f,"large"):x&&ai(i,r,50,f,"small"));let R,u=t?"#7bed9f":wo(e.id);if(e.eliminated)R="rgba(100,100,100,0.5)",u="#666";else if(e.shelterColor)if(e.shelterColor.startsWith("gradient:")){const Y=e.shelterColor.split(":"),V=Y[1]||"#ff5500",ne=Y[2]||"#00aaff",me=s.createLinearGradient(i-50,r-50*.6,i+50,r+50*.6);me.addColorStop(0,V),me.addColorStop(1,ne),R=me,u=V}else R=e.shelterColor,u=e.shelterColor;else R=u;const k=50*2,b=50*1.2,S=i-50,y=r-b*.5,P=Math.min(12,50*.3),_=Math.min(10,50*.25);s.translate(i,r),f<0&&s.scale(-1,1),s.fillStyle=R,s.beginPath(),s.roundRect(-50,-b*.5,k,b,P),s.fill();const O=k*.3;s.fillStyle="rgba(0,0,0,0.15)",s.beginPath(),s.roundRect(-50+k-O,-b*.5,O,b,[0,P,P,0]),s.fill();const J=4,G=O-J*2,ie=b*.4;s.fillStyle="rgba(135,206,250,0.7)",s.beginPath(),s.roundRect(-50+k-O+J,-b*.5+J,G,ie,4),s.fill();const fe=!t&&rs.has(e.id);fe?(s.strokeStyle="#7bed9f",s.lineWidth=3,s.setLineDash([6,4])):(s.strokeStyle=t?"rgba(255,255,255,0.9)":"rgba(255,255,255,0.5)",s.lineWidth=t?3:2),s.beginPath(),s.roundRect(-50,-b*.5,k,b,P),s.stroke(),s.setLineDash([]),f<0&&s.scale(-1,1),s.translate(-i,-r),s.fillStyle="#333";const A=y+b+_*.3,U=S+k*.2,F=S+k*.7;s.beginPath(),s.arc(U,A,_,0,Math.PI*2),s.fill(),s.beginPath(),s.arc(F,A,_,0,Math.PI*2),s.fill(),s.fillStyle="#888",s.beginPath(),s.arc(U,A,_*.4,0,Math.PI*2),s.fill(),s.beginPath(),s.arc(F,A,_*.4,0,Math.PI*2),s.fill(),s.fillStyle="#2d2d2d",s.font="bold 12px Rubik, sans-serif",s.textAlign="center";const K=t?"You":e.displayName??e.id;s.fillText(K,i,y-6),fe&&(s.fillStyle="#7bed9f",s.fillText("ðŸ¤",i+50+10,y+10),s.fillStyle="#2d2d2d"),e.eliminated&&(s.font="18px sans-serif",s.fillText("ðŸ‘»",i-50*.3,r),s.font="bold 12px Rubik, sans-serif");const j=Math.min(Math.floor(e.size),mi);s.fillStyle="#fff",s.fillText(`Pets: ${e.petsInside.length}/${j}`,i,r+4),s.restore()}function Hr(e,t,n){const o=e.x,i=e.y,r=wt+e.size*St,c=Math.min(400,Math.max(40,r));s.save(),s.shadowColor="rgba(0,0,0,0.4)",s.shadowBlur=12;let l;if(n!=null&&n.startsWith("gradient:")){const F=n.split(":"),K=F[1]||"#7bed9f",j=F[2]||"#3cb371",Y=s.createLinearGradient(o-c,i,o+c,i);Y.addColorStop(0,K),Y.addColorStop(1,j),l=Y}else n?l=n:l=t?"#7bed9f":wo(e.ownerId);s.fillStyle=l;const f=c*2,g=c*1.4,m=o-c,x=i-g*.4;s.beginPath(),s.roundRect(m,x,f,g,6),s.fill(),s.fillStyle="#8B4513",s.beginPath(),s.moveTo(m-10,x),s.lineTo(o,x-c*.5),s.lineTo(m+f+10,x),s.closePath(),s.fill(),s.strokeStyle="#654321",s.lineWidth=2,s.stroke();const R=f*.2,u=g*.5;s.fillStyle="#654321",s.fillRect(o-R/2,x+g-u,R,u);const k=12,b=4,S=Math.floor((f-40)/(k+b)),y=Math.min(e.petsInside.length+2,S*2);for(let F=0;F<y;F++){const K=Math.floor(F/S),j=F%S,Y=m+20+j*(k+b),V=x+15+K*(k+b),ne=F<e.petsInside.length;s.fillStyle=ne?"#c9a86c":"#aaa",s.fillRect(Y,V,k,k),s.strokeStyle="#666",s.lineWidth=1,s.strokeRect(Y,V,k,k)}s.setLineDash([5,5]),s.strokeStyle=t?"#7bed9f":"rgba(255,255,255,0.5)",s.lineWidth=2;const P=15;s.strokeRect(m-P,x-c*.5-P,f+P*2,g+c*.5+P*2),s.setLineDash([]);const _=x-c*.5-25;let O=o-30;s.font="14px sans-serif",s.textAlign="center",e.hasAdoptionCenter&&(s.fillText("ðŸ¾",O,_),O+=20),e.hasGravity&&(s.fillText("ðŸ§²",O,_),O+=20),e.hasAdvertising&&(s.fillText("ðŸ“¢",O,_),O+=20),s.fillStyle="#333",s.font="bold 11px Rubik, sans-serif",s.textAlign="center";const J=t?"Your Shelter":"Shelter";s.fillText(J,o,x-c*.5-8);const G=e.tier??1,fe=["#888","#7bed9f","#70a3ff","#c77dff","#ffd700"][Math.min(G-1,4)],A=o+c*.8,U=x-c*.3;s.fillStyle=fe,s.beginPath(),s.arc(A,U,14,0,Math.PI*2),s.fill(),s.strokeStyle="#fff",s.lineWidth=2,s.stroke(),s.fillStyle=G>=5?"#333":"#fff",s.font="bold 12px Rubik, sans-serif",s.textBaseline="middle",G>=5?s.fillText("â˜…"+G,A,U):s.fillText(String(G),A,U),s.textBaseline="alphabetic",s.fillStyle="#fff",s.font="10px Rubik, sans-serif",s.fillText(`Pets: ${e.petsInside.length}`,o,x+g+12),s.fillStyle="#7bed9f",s.fillText(`Adoptions: ${e.totalAdoptions}`,o,x+g+24),s.restore()}function zr(e){const t=e.x,n=e.y,o=80+e.size*.8;s.save();const i=.5+.5*Math.sin(Date.now()/200);if(s.shadowColor=`rgba(255, 0, 0, ${.4+i*.3})`,s.shadowBlur=20+i*10,ki){const r=o*1.5,c=o*1.2;s.drawImage(dn,t-r/2,n-c/2,r,c)}else s.fillStyle="#4a1a1a",s.beginPath(),s.roundRect(t-o/2,n-o/2.5,o,o*.8,6),s.fill(),s.strokeStyle=`rgba(255, 68, 68, ${.6+i*.4})`,s.lineWidth=3,s.stroke();s.shadowBlur=0,s.fillStyle="#ff4444",s.font="bold 12px Rubik, sans-serif",s.textAlign="center",s.textBaseline="bottom",s.fillText(`Breeder Mill Lv${e.level}`,t,n-o/2-5),s.fillStyle="#ffaa00",s.font="10px Rubik, sans-serif",s.textBaseline="top",s.fillText("Spawning wild strays!",t,n+o/2.5+5),s.restore()}const ri={[Fe]:"ðŸˆ",[ro]:"ðŸ•",[lo]:"ðŸ¦",[co]:"ðŸ°",[gs]:"â­"};function qr(e,t,n=Fe){s.save(),s.globalAlpha=1;const o=ri[n]??ri[Fe];s.font="30px sans-serif",s.textAlign="center",s.textBaseline="middle",s.shadowColor="rgba(0,0,0,0.8)",s.shadowBlur=4,s.fillText(o,e,t),n===gs&&(s.shadowColor="#ffd700",s.shadowBlur=12,s.fillText(o,e,t)),s.shadowBlur=0,s.restore()}function Xr(e,t,n=1){s.save(),s.translate(e,t),s.beginPath(),s.arc(0,0,31,0,Math.PI*2),s.fillStyle="#5a4a3a",s.fill(),s.fillStyle="#8B4513",s.strokeStyle="#5a3810",s.lineWidth=1;for(let P=0;P<10;P++){const _=P/10*Math.PI*2,O=Math.cos(_)*14,J=Math.sin(_)*14;s.fillRect(O-3/2,J-8/2,3,8)}s.beginPath(),s.arc(0,0,14,0,Math.PI*2),s.strokeStyle="#6d4c35",s.lineWidth=2,s.stroke();const f=(e*7+t*31+n*101|0)>>>0,g=["#ff9f43","#a17851","#74b9ff","#dfe6e9"],m=2+f%3;for(let P=0;P<m;P++){const _=f+P*17>>>0,O=(_%17-8)*.9,J=((_>>4)%17-8)*.9;s.beginPath(),s.arc(O,J,4,0,Math.PI*2),s.fillStyle=g[(_>>8)%g.length],s.fill(),s.strokeStyle="#333",s.lineWidth=.8,s.stroke()}s.beginPath(),s.moveTo(-20,12),s.lineTo(0,-18),s.lineTo(20,12),s.closePath(),s.fillStyle="#D2B48C",s.fill(),s.strokeStyle="#8B7355",s.lineWidth=1.5,s.stroke(),s.beginPath(),s.moveTo(-7,12),s.lineTo(0,4),s.lineTo(7,12),s.fillStyle="#4a3a2a",s.fill(),s.restore();const x=e+35-10,R=t-35+5;s.fillStyle="#fff",s.beginPath(),s.roundRect(x-10,R-8,20,16,3),s.fill(),s.strokeStyle="#333",s.lineWidth=1,s.stroke(),s.fillStyle="#000",s.font="bold 11px sans-serif",s.textAlign="center",s.textBaseline="middle",s.fillText(`${n}`,x,R);const u=3+Math.min(2,Math.floor(n/2)),k=Math.min(u+Math.floor(n/2),8);let b=1,S=8;n>=10?(b=4,S=13):n>=6?(b=3,S=11):n>=3&&(b=2);const y=k*b*S;s.font="bold 10px Rubik, sans-serif",s.fillStyle="#ff6b6b",s.textAlign="center",s.textBaseline="alphabetic",s.fillText(`Lv${n} ~${y}RT`,e,t+35+12)}function Gr(e){const t=To;if(s.save(),e.type===gi){Xr(e.x,e.y,e.level??1),s.restore();return}let n="#7bed9f",o="#2d5a38",i="+Size";e.type===ga?(n="#70a3ff",o="#2d4a6e",i="Speed"):e.type===yi?(n="#c77dff",o="#6a3d7a",i="Random"):e.type===pi&&(n="#10b981",o="#047857",i="Home"),s.fillStyle=n,s.fillRect(e.x-t,e.y-t,t*2,t*2),s.strokeStyle=o,s.lineWidth=2,s.strokeRect(e.x-t,e.y-t,t*2,t*2),s.fillStyle="#333",s.font="10px Rubik, sans-serif",s.textAlign="center",s.fillText(i,e.x,e.y+To+10),s.restore()}function Kr(e){var t,n,o;try{const i=Zi(),r=Number.isFinite(i.x)?Math.max(0,Math.min(te-i.w,i.x)):0,c=Number.isFinite(i.y)?Math.max(0,Math.min(le-i.h,i.y)):0,l={x:r,y:c,w:i.w,h:i.h};if(s.save(),s.translate(-l.x,-l.y),Ur(l),a){const I=a.adoptionZones.length>0?a.adoptionZones:[{id:"adopt-fallback",x:te/2,y:le/2,radius:qn}];for(const E of I)Fr(E);for(const E of a.adoptionEvents??[])Yr(E,a.tick);for(const E of a.pickups??[])Gr(E);for(const E of a.shelters??[]){const v=E.ownerId===M,w=a.players.find(B=>B.id===E.ownerId),C=w==null?void 0:w.shelterColor;Hr(E,v,C)}for(const E of a.breederShelters??[])zr(E)}for(const I of(a==null?void 0:a.pets)??[]){if(I.insideShelterId!==null)continue;const E=_r(I.id)??I;!Number.isFinite(E.x)||!Number.isFinite(E.y)||E.x===0&&E.y===0||qr(E.x,E.y,I.petType??Fe)}const f=[...(a==null?void 0:a.players)??[]].sort((I,E)=>I.size-E.size);for(const I of f){const E=I.id===M;let v;if(E&&L){let w=Ke??L.x,C=je??L.y;(!Number.isFinite(w)||!Number.isFinite(C))&&(w=L.x,C=L.y),(!Number.isFinite(w)||!Number.isFinite(C))&&(w=te/2,C=le/2),v={...L,x:w,y:C}}else v=Dr(I.id)??I;if(!(!Number.isFinite(v.x)||!Number.isFinite(v.y))&&(Wr(v,E),E&&Bi>Date.now())){s.save(),s.setTransform(1,0,0,1,0,0);const w=T.width/2,C=T.height/2-60;s.fillStyle="#7bed9f",s.font="bold 28px Rubik, sans-serif",s.textAlign="center",s.fillText("+1 Size!",w,C),s.restore()}}const g=Date.now();for(let I=Kn.length-1;I>=0;I--){const E=Kn[I],v=g-E.startTime;if(v<0)continue;if(v>zo){Kn.splice(I,1);continue}const w=v/zo,C=1-Math.pow(1-w,3),B=E.fromX+(E.toX-E.fromX)*C,N=E.fromY+(E.toY-E.fromY)*C-Math.sin(w*Math.PI)*50,se=w<.8?1:1-(w-.8)/.2;s.save(),s.globalAlpha=se,s.font="bold 32px sans-serif",s.textAlign="center",s.textBaseline="middle",s.fillText(br[E.petType]??"ðŸ¾",B,N),s.restore()}for(const[I,E]of Ln){const v=Date.now()-E.startTime,w=Math.min(1,v/Zs);E.phase==="fadeIn"&&(ii(E.toX,E.toY,w,!0),w<.5&&ii(E.fromX,E.fromY,w*2,!1))}s.restore();const m=120/te;h.fillStyle="#2d4a2d",h.fillRect(0,0,120,120);for(let I=0;I<=le;I+=be*3)for(let E=0;E<=te;E+=be*3)h.fillStyle="rgba(255,255,255,0.15)",h.fillRect(E*m-.8,I*m-.8,1.6,1.6);if(a){const I=a.adoptionZones.length>0?a.adoptionZones:[{id:"adopt-fallback",x:te/2,y:le/2,radius:qn}];for(const v of I){const w=v.radius||qn,C=Math.max(3,w*m|0);h.fillStyle="rgba(123, 237, 159, 0.6)",h.fillRect(v.x*m-C,v.y*m-C,C*2,C*2)}for(const v of a.pets)v.insideShelterId===null&&(v.x===0&&v.y===0||(h.fillStyle="#c9a86c",h.fillRect(v.x*m-2,v.y*m-2,4,4)));for(const v of a.pickups??[]){const w=v.x*m,C=v.y*m;if(v.type===gi){const B=.5+.5*Math.sin(Date.now()/200),N=8+B*4;h.save(),h.shadowColor="#ff4444",h.shadowBlur=N,h.fillStyle="#8B4513",h.beginPath(),h.arc(w,C,4,0,Math.PI*2),h.fill(),h.strokeStyle=`rgba(255, 68, 68, ${.7+B*.3})`,h.lineWidth=2,h.stroke(),h.restore()}else h.fillStyle=v.type===ya?"#7bed9f":v.type===yi?"#c77dff":v.type===pi?"#10b981":"#70a3ff",h.fillRect(w-2,C-2,4,4)}for(const v of a.shelters??[]){const w=v.ownerId===M,C=v.x*m,B=v.y*m,N=Math.min(v.size,2e3),se=(wt+N*St)*m,Z=Math.min(60,Math.max(4,se)),W=4;if(h.fillStyle=w?"#e8d5b7":"#d4c4a8",h.fillRect(C-W,B-W,W*2,W*2),h.strokeStyle=w?"#7bed9f":"#8B4513",h.lineWidth=1,h.strokeRect(C-W,B-W,W*2,W*2),w&&(h.fillStyle="#7bed9f",h.beginPath(),h.moveTo(C,B-W-4),h.lineTo(C-5,B-W+1),h.lineTo(C+5,B-W+1),h.closePath(),h.fill(),h.fillRect(C-3,B-W+1,6,5),Z>8)){h.save();const Be=Date.now()/1500,q=Be%1,ye=Z*q,Se=.6*(1-q);h.strokeStyle=`rgba(123, 237, 159, ${Se})`,h.lineWidth=2,h.beginPath(),h.arc(C,B,ye,0,Math.PI*2),h.stroke();const ze=(Be+.5)%1,D=Z*ze,z=.6*(1-ze);h.strokeStyle=`rgba(123, 237, 159, ${z})`,h.beginPath(),h.arc(C,B,D,0,Math.PI*2),h.stroke(),h.strokeStyle="rgba(123, 237, 159, 0.4)",h.lineWidth=1,h.setLineDash([3,3]),h.beginPath(),h.arc(C,B,Z,0,Math.PI*2),h.stroke(),h.setLineDash([]),h.restore()}}for(const v of a.breederShelters??[]){const w=v.x*m,C=v.y*m,B=Math.max(10,(40+v.size*.5)*m),N=.5+.5*Math.sin(Date.now()/200);h.save(),h.shadowColor="#ff0000",h.shadowBlur=8+N*8,h.fillStyle="#cc2222",h.fillRect(w-B,C-B,B*2,B*2),h.strokeStyle=`rgba(255, 50, 50, ${.9+N*.1})`,h.lineWidth=2.5,h.strokeRect(w-B,C-B,B*2,B*2),h.restore()}for(const v of a.adoptionEvents??[]){const w=v.x*m,C=v.y*m,B=Math.min(12,Qi*m),se=Date.now()%2e3/2e3,Z=B+se*8,W=1-se;h.save(),h.strokeStyle=`rgba(94, 234, 212, ${W*.8})`,h.lineWidth=3-se*2,h.beginPath(),h.arc(w,C,Z,0,Math.PI*2),h.stroke();const q=(Date.now()+1e3)%2e3/2e3,ye=B+q*8,Se=1-q;h.strokeStyle=`rgba(94, 234, 212, ${Se*.8})`,h.lineWidth=3-q*2,h.beginPath(),h.arc(w,C,ye,0,Math.PI*2),h.stroke(),h.shadowColor="#5eead4",h.shadowBlur=6+Math.sin(Date.now()*.005)*3,h.strokeStyle="#5eead4",h.lineWidth=2,h.setLineDash([4,4]),h.beginPath(),h.arc(w,C,B,0,Math.PI*2),h.stroke(),h.setLineDash([]),h.fillStyle="rgba(94, 234, 212, 0.4)",h.fill(),h.fillStyle="#5eead4",h.font="bold 8px sans-serif",h.textAlign="center",h.textBaseline="middle",h.fillText("ðŸ“¢",w,C),h.restore()}const E=[...a.players].sort((v,w)=>w.totalAdoptions-v.totalAdoptions);for(const v of a.players){let w=v.id===M?"#7bed9f":wo(v.id);v.shelterColor&&(v.shelterColor.startsWith("gradient:")?w=v.shelterColor.split(":")[1]||w:w=v.shelterColor),h.fillStyle=w;const B=50*m,N=E.indexOf(v),se=N===0?1.5:N<=2?1.2:1,Z=Math.max(2,B)*se;h.fillRect(v.x*m-Z,v.y*m-Z,Z*2,Z*2),N===0&&a.players.length>1&&(h.fillStyle="#ffd700",h.beginPath(),h.arc(v.x*m,v.y*m-Z-3,3,0,Math.PI*2),h.fill())}}const x=l.x*m,R=l.y*m,u=l.w*m,k=l.h*m;h.strokeStyle="rgba(255,255,255,0.6)",h.lineWidth=1.5,h.strokeRect(x,R,u,k),h.strokeStyle="rgba(255,255,255,0.2)",h.lineWidth=1,h.strokeRect(.5,.5,119,119);const b=a==null?void 0:a.players.find(I=>I.id===M),S=b!=null&&b.shelterId?((t=a==null?void 0:a.shelters)==null?void 0:t.find(I=>I.id===b.shelterId))??null:null;if(S&&b&&!b.eliminated){const I=(L==null?void 0:L.x)??b.x,E=(L==null?void 0:L.y)??b.y,v=S.x,w=S.y,C=l.x,B=l.x+l.w,N=l.y,se=l.y+l.h;if(!(v>=C&&v<=B&&w>=N&&w<=se)){const W=l.x+l.w/2,Be=l.y+l.h/2,q=Math.atan2(w-Be,v-W),ye=Math.hypot(v-I,w-E),Se=60,ze=T.width/2-Se,D=T.height/2-Se;let z=T.width/2+Math.cos(q)*ze,ft=T.height/2+Math.sin(q)*D;const Ls=ze/D;Math.abs(Math.cos(q))>Math.abs(Math.sin(q))*Ls?(z=T.width/2+Math.sign(Math.cos(q))*ze,ft=T.height/2+Math.tan(q)*Math.sign(Math.cos(q))*ze):(ft=T.height/2+Math.sign(Math.sin(q))*D,z=T.width/2+1/Math.tan(q)*Math.sign(Math.sin(q))*D),z=Math.max(Se,Math.min(T.width-Se,z)),ft=Math.max(Se,Math.min(T.height-Se,ft)),s.save();const ks=.7+.3*Math.sin(Date.now()/300);s.translate(z,ft),s.rotate(q),s.fillStyle=`rgba(123, 237, 159, ${ks})`,s.strokeStyle="rgba(255, 255, 255, 0.8)",s.lineWidth=2,s.beginPath(),s.moveTo(20,0),s.lineTo(5,-10),s.lineTo(5,-5),s.lineTo(-15,-5),s.lineTo(-15,5),s.lineTo(5,5),s.lineTo(5,10),s.closePath(),s.fill(),s.stroke(),s.restore(),s.save();const da=-Math.cos(q)*35,fa=-Math.sin(q)*35,ut=z+da,ht=ft+fa;s.fillStyle=`rgba(232, 213, 183, ${ks})`,s.strokeStyle="rgba(123, 237, 159, 0.9)",s.lineWidth=2,s.fillRect(ut-12,ht-8,24,18),s.strokeRect(ut-12,ht-8,24,18),s.fillStyle=`rgba(123, 237, 159, ${ks})`,s.beginPath(),s.moveTo(ut,ht-20),s.lineTo(ut-16,ht-8),s.lineTo(ut+16,ht-8),s.closePath(),s.fill(),s.stroke(),s.fillStyle="rgba(139, 90, 43, 0.8)",s.fillRect(ut-4,ht,8,10),s.fillStyle="#fff",s.font="bold 12px Rubik, sans-serif",s.textAlign="center",s.textBaseline="top";const ua=ye>=1e3?`${(ye/1e3).toFixed(1)}k`:`${Math.round(ye)}`;s.fillText(ua,ut,ht+14),s.restore()}}if(on){const I=T.getBoundingClientRect(),E=T.width/I.width,v=T.height/I.height,w=(Qn-I.left)*E,C=(es-I.top)*v,B=(ps-I.left)*E,N=(bs-I.top)*v,se=B-w,Z=N-C,W=Math.hypot(se,Z),Be=Math.min(W,Mo*E),q=W>0?w+se/W*Be:w,ye=W>0?C+Z/W*Be:C;s.save(),s.globalAlpha=.3,s.strokeStyle="#fff",s.lineWidth=3,s.beginPath(),s.arc(w,C,Mo*E,0,Math.PI*2),s.stroke(),s.fillStyle="rgba(255,255,255,0.1)",s.fill(),s.globalAlpha=.6,s.fillStyle="#7bed9f",s.beginPath(),s.arc(q,ye,20*E,0,Math.PI*2),s.fill(),s.strokeStyle="#fff",s.lineWidth=2,s.stroke(),s.restore()}const y=(a==null?void 0:a.players.find(I=>I.id===M))??L,P=y?Math.floor(y.size):0,_=Math.min(P,mi),O=(y==null?void 0:y.petsInside.length)??0,J=(a==null?void 0:a.pets.filter(I=>I.insideShelterId===null).length)??0;Aa.textContent=y!=null&&y.eliminated?"Observer Mode":`Size: ${P}`,Ra.textContent=y!=null&&y.eliminated?"WASD to pan | Drag to move":`Pets: ${O}/${_}`;const G=!!(y!=null&&y.shelterId),ie=!!(y!=null&&y.eliminated),fe=(y==null?void 0:y.money)??0,A=y&&y.size>=50&&!G&&!ie&&Q==="playing";Qa.textContent=`${fe} RT`;const U=y&&!ie&&Q==="playing";U?(pn.classList.remove("hidden"),pn.disabled=!1,pn.textContent="Menu [E]"):pn.classList.add("hidden"),Jt&&(U?Rt():(Jt=!1,ss.classList.add("hidden"))),Ks.classList.add("hidden");const F=(y==null?void 0:y.portCharges)??0;y&&F>0&&!ie&&Q==="playing"?(Gn.textContent=`Random [P] (${F})`,Gn.classList.remove("hidden")):Gn.classList.add("hidden");const K=Math.max((y==null?void 0:y.shelterPortCharges)??0,fn);y&&K>0&&!ie?(G?(pe.textContent=`Home [H] (${K})`,pe.disabled=!1,pe.setAttribute("aria-disabled","false"),pe.style.opacity="1",pe.style.cursor="pointer"):(pe.textContent=`Home [H] (${K}) ðŸ”’`,pe.disabled=!1,pe.setAttribute("aria-disabled","true"),pe.style.opacity="0.6",pe.style.cursor="not-allowed"),pe.classList.remove("hidden")):pe.classList.add("hidden");let j=null;if(y&&y.petsInside.length>0&&!ie&&Q==="playing")for(const I of(a==null?void 0:a.shelters)??[]){if(I.ownerId===M)continue;const E=a==null?void 0:a.players.find(W=>W.id===I.ownerId);if(!(((n=y.allies)==null?void 0:n.includes(I.ownerId))||!1))continue;const w=((L==null?void 0:L.x)??y.x)-I.x,C=((L==null?void 0:L.y)??y.y)-I.y,B=Math.hypot(w,C),N=Math.min(I.size,1e3),Z=wt+N*St+100;if(B<=Z){j=I;break}}j?(pt.textContent="Transfer [T] ðŸ¤",pt.classList.remove("hidden"),pt.dataset.targetShelterId=j.id):(pt.classList.add("hidden"),delete pt.dataset.targetShelterId);const Y=Math.abs(Bt)>50||Math.abs(Pt)>50,V=y!=null&&y.shelterId?((o=a==null?void 0:a.shelters)==null?void 0:o.find(I=>I.id===y.shelterId))??null:null;y&&!ie&&Q==="playing"&&Y?os.classList.remove("hidden"):os.classList.add("hidden"),y&&!ie&&Q==="playing"&&V&&Math.hypot(V.x-((L==null?void 0:L.x)??0)-Bt,V.y-((L==null?void 0:L.y)??0)-Pt)>100?wn.classList.remove("hidden"):wn.classList.add("hidden");const ne=(a==null?void 0:a.tick)??0,me=hi,Qe=y&&(y.speedBoostUntil??0)>ne?((y.speedBoostUntil-ne)/me).toFixed(1):"";No&&(No.textContent=y?`Adoptions: ${y.totalAdoptions}  â€¢  Strays: ${J}${Qe?`  â€¢  Speed: ${Qe}s`:""}`:"");const ct=(a==null?void 0:a.matchEndAt)??0,et=Math.max(0,ct-ne)/me,We=(a==null?void 0:a.shelters)??[],$t=te*le,Me=We.reduce((I,E)=>!I||E.size>I.size?E:I,null),Nt=Math.min((Me==null?void 0:Me.size)??0,1e4),dt=Me?wt+Nt*St:0,Ot=Math.PI*dt*dt,Lo=$t>0?Math.min(100,Math.floor(Ot/$t*100)):0,Bn=a==null?void 0:a.players.find(I=>I.shelterId===(Me==null?void 0:Me.id)),Pn=(y==null?void 0:y.totalAdoptions)??0;$a.textContent=Q==="playing"?`Points: ${Pn}`:"";const Ss=(a==null?void 0:a.matchDurationMs)??0,Dt=Math.floor(Ss/1e3),An=Math.floor(Dt/3600),Is=Math.floor(Dt%3600/60),xs=Dt%60;Na.textContent=`${An.toString().padStart(2,"0")}:${Is.toString().padStart(2,"0")}:${xs.toString().padStart(2,"0")}`;const tt=(a==null?void 0:a.adoptionEvents)??[],_t=a;if(Ps&&$o)if(tt.length>0&&Q==="playing"&&_t){const I={[Fe]:"Cats",[ro]:"Dogs",[lo]:"Birds",[co]:"Rabbits",[gs]:"Special"};$o.innerHTML=tt.map(E=>{const v=E.type.replace(/_/g," ").replace(/\b\w/g,N=>N.toUpperCase()),w=Math.max(0,E.startTick+E.durationTicks-_t.tick),C=Math.ceil(w/25),B=E.requirements.map(N=>`${N.count} ${I[N.petType]??"Pets"}`).join(", ");return`<div class="event-item"><div class="event-name">${Ze(v)}</div><div class="event-reqs">Need: ${Ze(B)}</div><div class="event-time">${C}s left</div></div>`}).join(""),Ps.classList.remove("hidden")}else Ps.classList.add("hidden");const He=!!(y!=null&&y.eliminated);if((et<=0||He)&&(a!=null&&a.players.length)){p.active&&Cn(!1),it||(it=!0,xa()),Ae.classList.add("show");const I=et<=0&&!(a!=null&&a.matchEndedEarly),E=[...a.players].sort((D,z)=>I?z.size-D.size||z.totalAdoptions-D.totalAdoptions:D.eliminated!==z.eliminated?(D.eliminated?1:0)-(z.eliminated?1:0):D.eliminated?D.totalAdoptions-z.totalAdoptions:z.size-D.size||z.totalAdoptions-D.totalAdoptions),v=!!(a!=null&&a.strayLoss),w=E.find(D=>D.id===M),C=w&&!w.eliminated?Math.floor(w.size):0,B=[100,50,25],N=w?E.findIndex(D=>D.id===M)+1:0,se=N>0&&N<=B.length&&!He&&!v?B[N-1]:0,Z=v||He?0:C+se,W=it&&!It?Ce()+Z:Ce();It||(Mt(W),It=!0);const Be=N===1?"Win bonus":N===2?"2nd place":N===3?"3rd place":N>0?`${N}th place`:"",q=Z>0?`<br><br><strong>Total: ${W.toLocaleString()} RT</strong>${Be?`<br>${Be}: +${se} RT`:""}`:v?`<br><br>No RT â€” too many strays! <strong>Total: ${Ce().toLocaleString()} RT</strong>`:He?`<br><br><strong>Total: ${Ce().toLocaleString()} RT</strong>`:"";let ye="Match over";if(a!=null&&a.strayLoss)ye="Match lost â€” too many strays!";else if(He)ye="You were consumed";else if(a&&a.winnerId){const D=a.winnerId,z=a.players.find(Ls=>Ls.id===D);ye=`${(z==null?void 0:z.id)===M?"You":(z==null?void 0:z.displayName)??"Someone"} won!`}const Se=`
      <div class="match-ads">
        <div class="match-ad-slot">
          <h4>Sponsored</h4>
          <div id="match-ad-slot" class="match-ad-placeholder">Ad placeholder</div>
        </div>
        <div class="match-self-promo">
          <h4>Boost your shelter</h4>
          <p>Earn Rescue Tokens each match to buy boosts. Invite friends with your referral link. For every 5 confirmed signups, unlock a special shelter skin.</p>
        </div>
      </div>
    `,ze=D=>D.eliminated?"â€”":`${Math.floor(D.size)}`;Ae.innerHTML=`<strong>${ye}</strong><br><br>`+E.map((D,z)=>`${z+1}. ${D.id===M?"You":D.displayName??D.id}: size ${ze(D)} (${D.totalAdoptions} adoptions)`).join("<br>")+q+Se+'<button type="button" id="play-again-btn" class="fight-ally-btn ally-btn" style="margin-right:8px">Play again</button><button type="button" id="lobby-btn" class="fight-ally-btn fight-btn">Back to lobby</button>'}else Ae.classList.remove("show")}catch(i){console.error("Render error:",i),s.save(),s.setTransform(1,0,0,1,0,0),s.fillStyle="#3d6b3d",s.fillRect(0,0,T.width,T.height),s.restore()}}let Fs=!1;function So(e){Fs||(Fs=!0,setTimeout(()=>{Fs=!1},500),e.id==="play-again-btn"?(d&&(d.close(),d=null),Ae.classList.remove("show"),it=!1,so=!1,a=null,ee.classList.remove("hidden"),ee.innerHTML=H==="ffa"?"<h2>Connectingâ€¦</h2><p>Joining FFA lobbyâ€¦</p>":"<h2>Connectingâ€¦</h2><p>Starting new match.</p>",we.classList.add("hidden"),vo({mode:H}).then(()=>{ee.classList.add("hidden"),ee.innerHTML="",Tt.classList.add("visible"),requestAnimationFrame(Eo)}).catch(t=>bo(t.message||"Connection failed."))):e.id==="lobby-btn"&&(d&&(d.close(),d=null),Ae.classList.remove("show"),it=!1,It=!1,a=null,Lt=null,Tt.classList.remove("visible"),en.classList.remove("hidden"),we.classList.remove("hidden"),Te(),nn(),Re=!1,Gt(null),$e(),jt(),sn(),At()))}Ae.addEventListener("click",e=>{const n=e.target.closest("button");n&&(e.preventDefault(),e.stopPropagation(),So(n))},!0);Ae.addEventListener("mouseup",e=>{const n=e.target.closest("button");n&&e.button===0&&(e.preventDefault(),e.stopPropagation(),So(n))},!0);Ae.addEventListener("touchend",e=>{const n=e.target.closest("button");n&&(e.preventDefault(),e.stopPropagation(),So(n))},{passive:!1,capture:!0});Yt.addEventListener("click",()=>{ls||Q!=="countdown"||!d||d.readyState!==WebSocket.OPEN||(ls=!0,d.send(JSON.stringify({type:"ready"})),Yt.textContent="Ready!",js.textContent="You're ready! Waiting for other player(s)â€¦")});er.addEventListener("click",()=>{d&&(d.close(),d=null),Ft.classList.add("hidden"),Tt.classList.remove("visible"),en.classList.remove("hidden"),we.classList.remove("hidden"),Te(),nn(),sn(),At()});function ea(e){!bt||!d||d.readyState!==WebSocket.OPEN||(d.send(JSON.stringify({type:"fightAlly",targetId:bt,choice:e})),Vs.add(bt),un.classList.add("hidden"),bt=null)}Xa.addEventListener("click",()=>ea("fight"));Ga.addEventListener("click",()=>ea("ally"));Ks.addEventListener("click",()=>{!d||d.readyState!==WebSocket.OPEN||(d.send(JSON.stringify({type:"ground"})),Ks.classList.add("hidden"))});Gn.addEventListener("click",()=>{p.active||!d||d.readyState!==WebSocket.OPEN||d.send(JSON.stringify({type:"usePort"}))});pe.addEventListener("click",()=>{if(p.active||!d||d.readyState!==WebSocket.OPEN)return;const e=a==null?void 0:a.players.find(t=>t.id===M);if(e&&!((e.shelterPortCharges??0)<=0)){if(!e.shelterId){X("Build a shelter first!","info");return}e.eliminated||Q!=="playing"||d.send(JSON.stringify({type:"useShelterPort"}))}});pt.addEventListener("click",()=>{if(p.active||!d||d.readyState!==WebSocket.OPEN)return;const e=pt.dataset.targetShelterId;e&&d.send(JSON.stringify({type:"transferPets",targetShelterId:e}))});os.addEventListener("click",()=>{Bt=0,Pt=0,os.classList.add("hidden")});wn.addEventListener("click",()=>{var n;const e=a==null?void 0:a.players.find(o=>o.id===M),t=e!=null&&e.shelterId?(n=a==null?void 0:a.shelters)==null?void 0:n.find(o=>o.id===e.shelterId):null;t&&L&&(Bt=t.x-L.x,Pt=t.y-L.y),wn.classList.add("hidden")});pn.addEventListener("click",()=>{ta()});let Jt=!1;function ta(){if(Q!=="playing")return;const e=a==null?void 0:a.players.find(t=>t.id===M);!e||e.eliminated||(Jt=!Jt,Jt?(ss.classList.remove("hidden"),Rt()):ss.classList.add("hidden"))}function jr(){var n;if(!a)return null;const e=a.players.find(o=>o.id===M);return e!=null&&e.shelterId?((n=a.shelters)==null?void 0:n.find(o=>o.id===e.shelterId))??null:null}function Rt(){const e=a==null?void 0:a.players.find(u=>u.id===M);if(!e)return;const t=Math.floor(e.size),n=e.money??0,o=!!e.shelterId,i=jr(),r=!!e.vanSpeedUpgrade;o?(Oo.classList.add("hidden"),On.classList.remove("hidden"),Dn.classList.remove("hidden"),_n.classList.remove("hidden")):(Oo.classList.remove("hidden"),On.classList.add("hidden"),Dn.classList.add("hidden"),_n.classList.add("hidden"));const c=Math.min(100,t/50*100),l=Math.min(100,n/250*100);ja.textContent=`${t}/50`,Ja.style.width=`${c}%`,Va.textContent=`${n}/250 RT`,Za.style.width=`${l}%`;const f=t>=50&&n>=250&&!o;if(ot.disabled=!f,f)ot.textContent="Build Shelter",ot.classList.add("ready");else if(o)ot.textContent="Already Built",ot.classList.remove("ready");else{const u=[];t<50&&u.push(`Size ${t}/50`),n<250&&u.push(`${n}/250 RT`),ot.textContent=`Need: ${u.join(" & ")}`,ot.classList.remove("ready")}const g=o&&!(i!=null&&i.hasAdoptionCenter)&&n>=250,m=o&&!(i!=null&&i.hasGravity)&&n>=300,x=o&&!(i!=null&&i.hasAdvertising)&&n>=200,R=!r&&n>=150;hn.disabled=!g,hn.textContent=i!=null&&i.hasAdoptionCenter?"Owned":"Buy",g?hn.classList.add("ready"):hn.classList.remove("ready"),i!=null&&i.hasAdoptionCenter?On.classList.add("owned"):On.classList.remove("owned"),mn.disabled=!m,mn.textContent=i!=null&&i.hasGravity?"Owned":"Buy",m?mn.classList.add("ready"):mn.classList.remove("ready"),i!=null&&i.hasGravity?Dn.classList.add("owned"):Dn.classList.remove("owned"),yn.disabled=!x,yn.textContent=i!=null&&i.hasAdvertising?"Owned":"Buy",x?yn.classList.add("ready"):yn.classList.remove("ready"),i!=null&&i.hasAdvertising?_n.classList.add("owned"):_n.classList.remove("owned"),gn.disabled=!R,gn.textContent=r?"Owned":"Buy",R?gn.classList.add("ready"):gn.classList.remove("ready"),r?Do.classList.add("owned"):Do.classList.remove("owned")}document.addEventListener("keydown",e=>{if((e.key==="e"||e.key==="E")&&ta(),e.key==="p"||e.key==="P"){if(p.active)return;if(d&&d.readyState===WebSocket.OPEN){const t=a==null?void 0:a.players.find(n=>n.id===M);t&&(t.portCharges??0)>0&&!t.eliminated&&Q==="playing"&&d.send(JSON.stringify({type:"usePort"}))}}if(e.key==="h"||e.key==="H"){if(p.active)return;if(d&&d.readyState===WebSocket.OPEN){const t=a==null?void 0:a.players.find(n=>n.id===M);if(!t||(t.shelterPortCharges??0)<=0)return;if(!t.shelterId){X("Build a shelter first!","info");return}if(t.eliminated||Q!=="playing")return;d.send(JSON.stringify({type:"useShelterPort"}))}}});Ka.addEventListener("click",()=>{Jt=!1,ss.classList.add("hidden")});ot.addEventListener("click",()=>{if(!d||d.readyState!==WebSocket.OPEN)return;const e=a==null?void 0:a.players.find(t=>t.id===M);!e||e.eliminated||e.shelterId||e.size<50||(e.money??0)<250||(d.send(JSON.stringify({type:"buildShelter"})),Rt())});hn.addEventListener("click",()=>{!d||d.readyState!==WebSocket.OPEN||(d.send(JSON.stringify({type:"buyAdoptionCenter"})),Rt())});mn.addEventListener("click",()=>{!d||d.readyState!==WebSocket.OPEN||(d.send(JSON.stringify({type:"buyGravity"})),Rt())});yn.addEventListener("click",()=>{!d||d.readyState!==WebSocket.OPEN||(d.send(JSON.stringify({type:"buyAdvertising"})),Rt())});gn.addEventListener("click",()=>{!d||d.readyState!==WebSocket.OPEN||(d.send(JSON.stringify({type:"buyVanSpeed"})),Rt())});zt.checked=Qt();Xs.checked=Li();zt.addEventListener("change",()=>{xi(zt.checked),zt.checked&&Tn()});Xs.addEventListener("change",()=>va(Xs.checked));Da.addEventListener("click",()=>fo.classList.toggle("hidden"));Ua.addEventListener("click",()=>fo.classList.add("hidden"));_a.addEventListener("click",async()=>{var t;const e=(d==null?void 0:d.readyState)===WebSocket.OPEN;if(e){if(H==="solo")X("Your match has been saved.","success");else if(H==="ffa"||H==="teams"){const n=a==null?void 0:a.players.find(i=>i.id===M),o=n!=null&&n.shelterId?(t=a==null?void 0:a.shelters)==null?void 0:t.find(i=>i.id===n.shelterId):null;X(o?"Your van will stop but your shelter continues. Return to rejoin!":"Your van will stop. Return to rejoin the match!","info")}}fo.classList.add("hidden"),d&&(d.close(),d=null),M=null,a=null,Ae.classList.remove("show"),it=!1,It=!1,to(),Tt.classList.remove("visible"),en.classList.remove("hidden"),we.classList.remove("hidden"),Te(),nn(),H==="solo"&&e?(Re=!0,$e()):(H==="ffa"||H==="teams")&&Lt&&de?(Gt({matchId:Lt,mode:H}),$e()):jt(),Lt=null,sn(),At(),Io()});Ya.addEventListener("click",()=>{d&&(d.close(),d=null),ee.classList.remove("hidden"),ee.innerHTML="<h2>Switching serverâ€¦</h2><p>Reconnecting to a closer server.</p>",we.classList.add("hidden"),vo({latency:zs,mode:H}).then(()=>{ee.classList.add("hidden"),ee.innerHTML=""}).catch(e=>{bo(e.message||"Switch failed."),we.classList.remove("hidden")})});function nn(){document.querySelectorAll(".mode-option").forEach(e=>{e.dataset.mode===H?e.classList.add("selected"):e.classList.remove("selected")})}const Hn=localStorage.getItem(Oi);(Hn==="ffa"||Hn==="teams"||Hn==="solo")&&(H=Hn);nn();const Ys=document.getElementById("solo-options"),li=document.getElementById("cpu-shutdown-breeders");function na(){Ys&&(H==="solo"?Ys.classList.remove("hidden"):Ys.classList.add("hidden"))}document.querySelectorAll(".mode-option").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".mode-option").forEach(t=>t.classList.remove("selected")),e.classList.add("selected"),H=e.dataset.mode,localStorage.setItem(Oi,H),na(),$e()})});na();Gs.addEventListener("click",async()=>{if(!Ee||!Ee.referralCode)return;const e=Xi(Ee.referralCode);try{await navigator.clipboard.writeText(e),xt.textContent="Referral link copied."}catch{const t=document.createElement("input");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),xt.textContent="Referral link copied."}});Xn.addEventListener("click",async()=>{try{const t=await(await fetch("/referrals/claim",{method:"POST",credentials:"include"})).json();if(t.ok){const n=typeof t.moneyBonus=="number"?t.moneyBonus:0;n>0&&Mt(Ce()+n),localStorage.setItem(pr,"1"),xt.textContent="Reward claimed. Special skin unlocked.",await Gi(),Ki(),Te()}else xt.textContent="Reward not available yet."}catch{xt.textContent="Unable to claim reward. Try again."}});function Sn(e){Tn(),Il(),en.classList.add("hidden"),ee.classList.remove("hidden"),ee.innerHTML=e.resume?"<h2>Resumingâ€¦</h2><p>Loading your saved match.</p>":"<h2>Connectingâ€¦</h2><p>Waiting for game server.</p>",we.classList.add("hidden"),vo({mode:e.mode,abandon:e.abandon}).then(()=>{ee.classList.add("hidden"),Tt.classList.add("visible"),zt&&(zt.checked=Qt()),requestAnimationFrame(Eo)}).catch(t=>{bo(t.message||"Connection failed."),we.classList.remove("hidden")})}const ci=document.getElementById("resume-match-btn");ci&&ci.addEventListener("click",()=>{if(H==="solo"&&Re){Sn({mode:"solo",resume:!0});return}if(Ne&&H===Ne.mode){Sn({mode:H});return}});Wa.addEventListener("click",()=>{if(H==="solo"&&Re){ei(()=>{fetch("/api/saved-match",{method:"DELETE",credentials:"include"}).then(()=>{Re=!1,$e(),Sn({mode:"solo",abandon:!0})}).catch(()=>X("Failed to abandon saved match.","error"))});return}if(Ne&&H===Ne.mode){ei(()=>{Gt(null),$e(),Sn({mode:H})});return}Sn({mode:H})});localStorage.getItem(ho)||uo.classList.remove("hidden");Ha.addEventListener("click",()=>{localStorage.setItem(ho,"full"),uo.classList.add("hidden")});za.addEventListener("click",()=>{localStorage.setItem(ho,"essential"),uo.classList.add("hidden")});Te();document.querySelectorAll(".landing-buy").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.boost;if(!t||!(t in cs))return;const n=cs[t],o=Ce();o<n||(Mt(o-n),t==="size"?ge.sizeBonus+=1:t==="speed"?ge.speedBoost=!0:t==="adoptSpeed"&&(ge.adoptSpeed=!0),Te())})});kt();document.querySelectorAll(".color-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.color;t&&(tn(t),kt())})});document.querySelectorAll(".preset-color").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.color;t&&Es().preset&&(tn(t),kt())})});const ke=document.getElementById("color-picker-modal"),Ut=document.getElementById("color-picker-input"),vt=document.getElementById("color-picker-input2"),zn=document.getElementById("color-picker-title"),Ws=document.getElementById("color-picker-cancel"),Hs=document.getElementById("color-picker-confirm");let ao="custom";document.querySelectorAll(".color-buy").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.color,n=ds[t],o=Es(),i=Ce();if(t==="preset"){if(o.preset||i<n)return;Mt(i-n),eo({...o,preset:!0}),Te(),kt()}else if(t==="custom"){if(o.custom){tn(o.custom),kt();return}if(i<n)return;ao="custom",zn&&(zn.textContent="Pick Your Custom Color"),vt&&(vt.style.display="none"),ke==null||ke.classList.remove("hidden")}else if(t==="gradient"){if(o.gradient){tn(o.gradient),kt();return}if(i<n)return;ao="gradient",zn&&(zn.textContent="Pick Gradient Colors"),vt&&(vt.style.display="block"),ke==null||ke.classList.remove("hidden")}})});Ws==null||Ws.addEventListener("click",()=>{ke==null||ke.classList.add("hidden")});Hs==null||Hs.addEventListener("click",()=>{const e=Es(),t=Ce();if(ao==="custom"){const n=(Ut==null?void 0:Ut.value)||"#ff5500";Mt(t-ds.custom),eo({...e,custom:n}),tn(n)}else{const n=(Ut==null?void 0:Ut.value)||"#ff5500",o=(vt==null?void 0:vt.value)||"#00aaff",i=`gradient:${n}:${o}`;Mt(t-ds.gradient),eo({...e,gradient:i}),tn(i)}ke==null||ke.classList.add("hidden"),Te(),kt()});ln&&(ln.checked=Qt(),ln.addEventListener("change",()=>{xi(ln.checked),ln.checked&&Tn()}));Qt()&&Tn();function Jr(e){return e<=5?15:e<=9?30:e<=14?40:45}function Vr(e,t=1,n={}){p.active=!0,$(Oe,!1),$(De,!1),$(_e,!1),$(Ue,!1),go(),p.pets=[],p.selectedPetIndex=null,p.timeLeft=typeof n.timeLimitSeconds=="number"?n.timeLimitSeconds:Jr(t),p.totalPets=e,p.rescuedCount=0,p.level=t,p.selectedIngredients=[],p.isMill=!!n.isMill;const o=["dog","cat","horse","bird","rabbit"];for(let f=0;f<e;f++){const g=o[Math.floor(Math.random()*o.length)];p.pets.push({type:g,rescued:!1})}el(t),kn(),Vt(),Et(),Pi.classList.add("hidden"),rt.style.display="flex",Js.classList.add("show");const i=Js.querySelector(".breeder-title");i&&(i.textContent=p.isMill?"ðŸ›‘ Stop the Mill!":`ðŸš¨ Stop Level ${t} Breeders!`);const r=document.getElementById("breeder-instruction-1"),c=document.getElementById("breeder-instruction-2"),l=an(t);r&&c&&(l===1?(r.textContent="1. Click a pet to select it",c.textContent="2. Click the matching food to rescue it!"):(r.textContent=`1. Click ${l} ingredients to make a meal`,c.textContent="2. Select a pet - if the meal matches, they're rescued!")),Zr(),p.timerInterval=setInterval(()=>{p.timeLeft--,tr.textContent=`${p.timeLeft}s`,p.timeLeft<=0&&Cn(!1)},1e3)}function sa(){const e=p.pets.filter(o=>!o.rescued).length,t=an(p.level);let n=8;return p.level>=10?n=12:p.level>=6&&(n=10),e*t*n}function Zr(){var f,g;const e=document.getElementById("instant-rescue-btn");if(!e)return;const t=a==null?void 0:a.players.find(m=>m.id===M),n=(f=a==null?void 0:a.shelters)==null?void 0:f.find(m=>m.ownerId===M);if(((n==null?void 0:n.tier)??0)<3){e.classList.add("hidden");return}const i=sa(),c=((t==null?void 0:t.money)??0)>=i;e.textContent=`âš¡ Instant Rescue (${i} RT)`,e.disabled=!c,e.classList.remove("hidden");const l=e.cloneNode(!0);(g=e.parentNode)==null||g.replaceChild(l,e),l.addEventListener("click",()=>{if(!c){X(`Not enough RT! Need ${i}`,"error");return}Qr()})}function Qr(){if(!d||d.readyState!==WebSocket.OPEN)return;const e=sa();d.send(JSON.stringify({type:"instantRescue",cost:e,totalPets:p.totalPets,level:p.level,isMill:p.isMill})),p.rescuedCount=p.totalPets,p.pets.forEach(t=>t.rescued=!0),Cn(!0)}function el(e){const t=rt.querySelector('[data-food="water"]'),n=rt.querySelector('[data-food="bowl"]');t&&(t.style.display=e>=6?"flex":"none"),n&&(n.style.display=e>=10?"flex":"none")}function Et(){var r;const e=an(p.level);let t=document.getElementById("breeder-selected-ingredients");if(t||(t=document.createElement("div"),t.id="breeder-selected-ingredients",t.className="breeder-ingredients",(r=rt.parentNode)==null||r.insertBefore(t,rt)),e<=1){t.style.display="none";return}t.style.display="flex";const n={apple:"ðŸŽ",carrot:"ðŸ¥•",chicken:"ðŸ—",seeds:"ðŸŒ»",water:"ðŸ’§",bowl:"ðŸ¥£"},o=[];for(let c=0;c<e;c++)if(c<p.selectedIngredients.length){const l=p.selectedIngredients[c];o.push(`<div class="ingredient-slot filled">${n[l]}</div>`)}else o.push('<div class="ingredient-slot empty">?</div>');t.innerHTML=`
    <span class="ingredients-label">Building meal (${p.selectedIngredients.length}/${e}):</span>
    <div class="ingredient-slots">${o.join("")}</div>
    ${p.selectedIngredients.length>0?'<button type="button" class="clear-ingredients-btn" id="clear-ingredients">Clear</button>':""}
  `;const i=document.getElementById("clear-ingredients");i&&i.addEventListener("click",()=>{p.selectedIngredients=[],Et(),Vt()})}function kn(){_o.innerHTML=p.pets.map((e,t)=>`
    <div class="breeder-pet${e.rescued?" rescued":""}${p.selectedPetIndex===t?" selected":""}" 
         data-index="${t}">
      <span>${gr[e.type]}</span>
      <span class="breeder-pet-label">${e.type}</span>
    </div>
  `).join(""),_o.querySelectorAll(".breeder-pet:not(.rescued)").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.index??"-1",10);t>=0&&!p.pets[t].rescued&&(p.selectedPetIndex=t,kn(),Vt())})})}function Vt(){const e=a==null?void 0:a.players.find(o=>o.id===M),t=(e==null?void 0:e.money)??0;nr.textContent=`Your Tokens: ${t} RT`;const n=an(p.level);rt.querySelectorAll(".breeder-food-btn").forEach(o=>{const i=o.dataset.food,r=Ni[i],c=t>=r,l=p.selectedIngredients.includes(i);n===1?o.disabled=!c||p.selectedPetIndex===null:o.disabled=!c||l})}function tl(e,t){const n=an(p.level),o=yr[n];if(!o)return!1;const i=[...e].sort();for(const r of o){if(!r.worksOn.includes(t))continue;const c=[...r.ingredients].sort();if(i.length!==c.length)continue;let l=!0;for(let f=0;f<i.length;f++)if(i[f]!==c[f]){l=!1;break}if(l)return!0}return!1}function nl(e){const t=Ni[e],n=a==null?void 0:a.players.find(r=>r.id===M);if(((n==null?void 0:n.money)??0)<t)return;const i=an(p.level);if(i===1){if(p.selectedPetIndex===null)return;const r=p.pets[p.selectedPetIndex];if(!r||r.rescued)return;if((d==null?void 0:d.readyState)===WebSocket.OPEN){const l=mr[e].includes(r.type);d.send(JSON.stringify({type:"breederUseFood",food:e,petIndex:p.selectedPetIndex,petType:r.type,success:l})),l?(r.rescued=!0,p.rescuedCount++,p.selectedPetIndex=null,Vn(),p.rescuedCount>=p.totalPets?Cn(!0):kn()):Zn(),Vt()}return}if(p.selectedIngredients.includes(e)){X("Already added to meal!");return}if((d==null?void 0:d.readyState)===WebSocket.OPEN&&d.send(JSON.stringify({type:"breederUseFood",food:e,petIndex:-1,petType:"ingredient",success:!1})),p.selectedIngredients.push(e),Et(),Vt(),p.selectedIngredients.length>=i){if(p.selectedPetIndex===null){X("Select a pet to feed this meal to!");return}const r=p.pets[p.selectedPetIndex];if(!r||r.rescued){p.selectedIngredients=[],Et();return}tl(p.selectedIngredients,r.type)?(r.rescued=!0,p.rescuedCount++,p.selectedPetIndex=null,p.selectedIngredients=[],Vn(),X("Meal complete! Pet rescued!","success"),p.rescuedCount>=p.totalPets?Cn(!0):(kn(),Et())):(p.selectedIngredients=[],Zn(),X("Wrong meal! Try again.","error"),Et()),Vt()}}function Cn(e){p.timerInterval&&(clearInterval(p.timerInterval),p.timerInterval=null),(d==null?void 0:d.readyState)===WebSocket.OPEN&&d.send(JSON.stringify({type:"breederComplete",rescuedCount:p.rescuedCount,totalPets:p.totalPets,level:p.level})),rt.style.display="none",Pi.classList.remove("hidden"),sr.textContent=e?"All Pets Rescued!":`Time's Up! (${p.rescuedCount}/${p.totalPets})`,Ai.innerHTML='<p style="color:rgba(255,255,255,0.7)">Calculating rewards...</p>'}function sl(e,t){const n=t.some(f=>f.type==="penalty"),o=e>0||t.some(f=>f.type!=="penalty"),i=[],r=t.find(f=>f.type==="penalty");r&&i.push(`<div class="breeder-reward-item" style="color:#ff6b6b;">-${r.amount} Size (pets escaped!)</div>`),e>0&&i.push(`<div class="breeder-reward-item">+${e} RT</div>`),t.forEach(f=>{f.type==="size"&&i.push(`<div class="breeder-reward-item">+${f.amount} Size</div>`),f.type==="speed"&&i.push('<div class="breeder-reward-item">Speed Boost!</div>'),f.type==="port"&&i.push(`<div class="breeder-reward-item">+${f.amount} Port Charge</div>`),f.type==="shelterPort"&&i.push(`<div class="breeder-reward-item">+${f.amount} Home Port ðŸ </div>`)});const c=o?"ðŸŽ Rescue Chest":n?"âŒ Breeder Escape!":"No Rewards",l=o?"#ffd93d":"#ff6b6b";Ai.innerHTML=`
    <div class="breeder-result-title" style="color:${l};margin-bottom:8px;">${c}</div>
    ${i.join("")}
  `}function ol(){p.active=!1,Js.classList.remove("show")}rt.querySelectorAll(".breeder-food-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.food;t&&nl(t)})});or.addEventListener("click",ol);let he=null;function oa(e){const t=[];return e.tokens>0&&t.push(`${e.tokens} RT`),e.sizeBonus&&t.push(`+${e.sizeBonus} Size`),e.speedBoost&&t.push("Speed"),e.portCharge&&t.push("Random Port"),t.join(" + ")}function ia(){if(!he)return;const{currentDay:e,canClaimToday:t,rewards:n}=he;let o="";const i=!de;for(let r=0;r<7;r++){const c=r+1,l=n[r];let f=!1,g=!1,m=!0;i||(f=c===e&&t,g=c<e,m=c>e||c===e&&!t);const x=["daily-gift-day",f?"current":"",g?"claimed":"",m||i?"locked":"",c===7?"daily-gift-day7":""].filter(Boolean).join(" ");o+=`
      <div class="${x}">
        <div class="daily-gift-day-label">Day ${c}</div>
        <div class="daily-gift-day-icon">${g?"âœ“":f?"ðŸ”“":"ðŸ”’"}</div>
        <div class="daily-gift-day-reward">${oa(l)}</div>
      </div>
    `}de?(Uo.innerHTML=o,mt.classList.remove("hidden"),t?(mt.disabled=!1,mt.textContent=`Claim Day ${e} Gift`,Ds.textContent="Play to unlock today's gift!"):(mt.disabled=!0,mt.textContent="Come back tomorrow!",Ds.textContent=`Next gift: Day ${e>7?1:e}`)):(o=`
      <div class="daily-gift-signin-overlay">
        <div class="daily-gift-signin-message">Sign in for daily gifts!</div>
        <div class="daily-gift-signin-buttons">
          <a href="${vn("/auth/google")}" class="daily-gift-signin-btn google">Sign in with Google</a>
        </div>
      </div>
      <div class="daily-gift-grid-greyed">${o}</div>
    `,Uo.innerHTML=o,mt.classList.add("hidden"),Ds.textContent="")}async function aa(){if(yt.classList.remove("hidden"),!de){he={currentDay:1,canClaimToday:!0,lastClaimDate:null,totalClaims:0,rewards:[{tokens:15},{tokens:25,speedBoost:!0},{tokens:40},{tokens:50,sizeBonus:3},{tokens:75,speedBoost:!0},{tokens:100,portCharge:!0},{tokens:150,sizeBonus:5,speedBoost:!0}]},yt.classList.add("has-gift");return}try{const e=await fetch("/api/daily-gift",{credentials:"include"});if(!e.ok){he={currentDay:1,canClaimToday:!0,lastClaimDate:null,totalClaims:0,rewards:[{tokens:15},{tokens:25,speedBoost:!0},{tokens:40},{tokens:50,sizeBonus:3},{tokens:75,speedBoost:!0},{tokens:100,portCharge:!0},{tokens:150,sizeBonus:5,speedBoost:!0}]},yt.classList.add("has-gift");return}he=await e.json(),he!=null&&he.canClaimToday?yt.classList.add("has-gift"):yt.classList.remove("has-gift")}catch{he={currentDay:1,canClaimToday:!0,lastClaimDate:null,totalClaims:0,rewards:[{tokens:15},{tokens:25,speedBoost:!0},{tokens:40},{tokens:50,sizeBonus:3},{tokens:75,speedBoost:!0},{tokens:100,portCharge:!0},{tokens:150,sizeBonus:5,speedBoost:!0}]},yt.classList.add("has-gift")}Sl()}function ra(){he&&(ia(),Ri.classList.add("show"))}function la(){Ri.classList.remove("show")}async function il(){var e;if(!de){X("Sign in to collect daily rewards!"),la();return}if(he!=null&&he.canClaimToday)try{const t=await fetch("/api/daily-gift/claim",{method:"POST",credentials:"include"});if(!t.ok){const i=await t.json();X(i.error||"Failed to claim gift");return}const n=await t.json();(e=n.reward)!=null&&e.tokens&&(Mt(Ce()+n.reward.tokens),Te()),await aa(),ia();const o=oa(n.reward);X(`Gift claimed: ${o}`,"success")}catch{X("Failed to claim gift")}}yt.addEventListener("click",ra);ir.addEventListener("click",la);mt.addEventListener("click",il);bn.addEventListener("click",ra);function al(e){if(!Pe)return;if(e.length===0){Pe.innerHTML='<div class="lobby-leaderboard-loading">No scores yet. Play to appear!</div>';return}const t=vs??"";Pe.innerHTML=e.map(n=>{const o=n.adoptionScore??n.rtEarned??0,i=n.userId===t?" highlight":"",r=n.rank===1?"gold":n.rank===2?"silver":n.rank===3?"bronze":"",c=n.shelterColor?`<span class="leaderboard-color" style="background:${Ze(n.shelterColor)}"></span>`:"";return`<div class="lobby-leaderboard-entry${i}">
      <span class="lobby-leaderboard-rank ${r}">#${n.rank}</span>
      ${c}
      <span class="lobby-leaderboard-name">${Ze(n.displayName)}</span>
      <span class="lobby-leaderboard-score">${o}</span>
    </div>`}).join("")}function At(){if(!Pe||(xe==null?void 0:xe.readyState)===WebSocket.OPEN)return;if(xe){try{xe.close()}catch{}xe=null}at&&(clearTimeout(at),at=null),Pe.innerHTML='<div class="lobby-leaderboard-loading">Connectingâ€¦</div>';const e=new WebSocket(Ti);xe=e,e.onopen=()=>{as=0,e.send(JSON.stringify({type:"subscribeLeaderboard"}))},e.onmessage=t=>{try{const n=JSON.parse(t.data);n.type==="leaderboardUpdate"&&Array.isArray(n.entries)&&al(n.entries)}catch{}},e.onerror=()=>{Pe&&(Pe.innerHTML='<div class="lobby-leaderboard-loading">Connection error</div>')},e.onclose=()=>{xe===e&&(xe=null,rl())}}function rl(){const e=document.getElementById("landing");if(!e||e.style.display==="none")return;as++;const t=Math.min(1e3*Math.pow(2,as-1),cr);Pe&&(Pe.innerHTML=`<div class="lobby-leaderboard-loading">Reconnecting in ${Math.round(t/1e3)}sâ€¦</div>`),at=setTimeout(()=>{at=null,At()},t)}function ll(){if(at&&(clearTimeout(at),at=null),as=0,xe){try{xe.close()}catch{}xe=null}Pe&&(Pe.innerHTML='<div class="lobby-leaderboard-loading">Connectingâ€¦</div>')}const ys=document.getElementById("game-stats-content");let In=null;async function di(){if(ys)try{const e=await fetch("/api/game-stats",{credentials:"include"});if(!e.ok)throw new Error("Failed to fetch stats");const t=await e.json();cl(t)}catch{ys.innerHTML='<div style="color:rgba(255,255,255,0.6)">Stats unavailable</div>'}}function cl(e){if(!ys)return;const{realtime:t,historical:n}=e,o=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px 12px;margin-bottom:8px">
      <div><span style="color:#7bed9f;font-weight:700">${t.onlinePlayers}</span> online now</div>
      <div><span style="color:#ffd93d;font-weight:700">${t.ffaWaiting}</span> in FFA queue</div>
      <div><span style="color:#70a3ff">${t.playingSolo}</span> playing Solo</div>
      <div><span style="color:#c77dff">${t.playingFfa}</span> playing FFA</div>
      <div><span style="color:#ff9f43">${t.playingTeams}</span> playing Teams</div>
    </div>
    <div style="border-top:1px solid rgba(255,255,255,0.15);padding-top:6px;margin-top:4px">
      <div><span style="font-weight:700">${n.totalGamesPlayed.toLocaleString()}</span> total games played</div>
      <div>Popular mode: <span style="color:#7bed9f;font-weight:600">${n.mostPopularMode??"N/A"}</span></div>
      <div><span style="color:#5eead4">${n.newUsersToday}</span> new players today</div>
    </div>
  `;ys.innerHTML=o}function Io(){In||(di(),In=setInterval(di,1e4))}function dl(){In&&(clearInterval(In),In=null)}let gt="alltime",Jn="score";const Zt=document.getElementById("leaderboard-sort");async function fl(e){try{const t=e?`?limit=${e}`:"",n=await fetch(`/api/match-history${t}`,{credentials:"include"});return n.ok?(await n.json()).matches??[]:[]}catch{return[]}}async function ul(e,t){try{const n=(e==="alltime"||e==="games")&&t?`&sort=${t}`:"",o=await fetch(`/api/leaderboard?type=${e}${n}`,{credentials:"include"});return o.ok?(await o.json()).entries??[]:[]}catch{return[]}}async function hl(){try{const e=await fetch("/api/leaderboard/my-rank",{credentials:"include"});return e.ok?await e.json():{alltime:{rank:0},daily:{rank:0}}}catch{return{alltime:{rank:0},daily:{rank:0}}}}function ml(e){const t=new Date(e),o=Date.now()-e;return o<6e4?"Just now":o<36e5?`${Math.floor(o/6e4)}m ago`:o<864e5?`${Math.floor(o/36e5)}h ago`:t.toLocaleDateString(void 0,{month:"short",day:"numeric",year:t.getFullYear()!==new Date().getFullYear()?"numeric":void 0})}function yl(e){if(e<60)return`${e}s`;const t=Math.floor(e/60),n=e%60;return n?`${t}m ${n}s`:`${t}m`}function gl(e){if(e.length===0){is.innerHTML='<div class="leaderboard-empty">No match history yet. Play matches to see them here!</div>',Wt.innerHTML=de?"Your recent matches":"Sign in to see your match history";return}const t={win:"Win",loss:"Loss",stray_loss:"Stray loss",quit:"Quit"};is.innerHTML=e.map(n=>{const o=t[n.result]??n.result;return`
      <div class="match-history-entry">
        <span class="match-history-result ${n.result==="win"?"history-win":n.result==="stray_loss"?"history-stray":n.result==="quit"?"history-quit":"history-loss"}">${o}</span>
        <span class="match-history-mode">${Ze(n.mode)}</span>
        <span class="match-history-rt">${n.rt_earned} RT</span>
        <span class="match-history-adopt">${n.adoptions} adoptions</span>
        <span class="match-history-dur">${yl(n.duration_seconds)}</span>
        <span class="match-history-date">${ml(n.played_at)}</span>
      </div>
    `}).join(""),Wt.innerHTML=`Your last ${e.length} matches`}function pl(e,t){if(e.length===0){is.innerHTML='<div class="leaderboard-empty">No rankings yet. Play to be the first!</div>',Wt.innerHTML="";return}is.innerHTML=e.map(n=>{const o=n.rank===1?"gold":n.rank===2?"silver":n.rank===3?"bronze":"",i=n.displayName===Le?"highlight":"",r=n.shelterColor?`<span class="leaderboard-color" style="background:${n.shelterColor}"></span>`:"";return`
      <div class="leaderboard-entry ${i}">
        <div class="leaderboard-rank ${o}">#${n.rank}</div>
        ${r}
        <div class="leaderboard-name">${Ze(n.displayName)}</div>
        <div class="leaderboard-stats">
          <span class="wins">${n.wins} wins</span>${typeof n.gamesPlayed=="number"?` Â· ${n.gamesPlayed} games`:""}${typeof n.losses=="number"?` Â· ${n.losses} losses`:""}<br>
          ${n.rtEarned} RT
        </div>
      </div>
    `}).join(""),t>0&&t<=10?Wt.innerHTML=`Your rank: <strong>#${t}</strong> (Top 10 gets daily rewards!)`:t>10?Wt.innerHTML=`Your rank: <strong>#${t}</strong> - Get into top 10 for daily rewards!`:Wt.innerHTML="Win matches to appear on the leaderboard!"}async function bl(){$i.classList.add("show"),await xo()}function vl(){$i.classList.remove("show")}async function xo(){const e=Zt==null?void 0:Zt.closest(".leaderboard-sort");if(gt==="history"){e==null||e.classList.add("hidden");const i=await fl(50);gl(i);return}e==null||e.classList.remove("hidden");const n=await ul(gt,gt==="games"&&Jn==="score"?"games":Jn);let o;if(gt==="alltime"||gt==="daily"){const i=await hl();o=gt==="alltime"?i.alltime.rank:i.daily.rank}else{const i=n.find(r=>r.displayName===Le);o=i?i.rank:0}pl(n,o)}document.querySelectorAll(".leaderboard-tab").forEach(e=>{e.addEventListener("click",async()=>{document.querySelectorAll(".leaderboard-tab").forEach(t=>t.classList.remove("active")),e.classList.add("active"),gt=e.dataset.type,await xo()})});Zt&&Zt.addEventListener("change",async()=>{Jn=Zt.value,await xo()});lr.addEventListener("click",bl);rr.addEventListener("click",vl);async function El(){try{const e=await fetch("/api/inventory",{credentials:"include"});if(!e.ok)return;Ge=await e.json(),ca()}catch{}}function ca(){dr.textContent=String(Ge.storedRt),fr.textContent=String(Ge.portCharges),ur.textContent=String(Ge.speedBoosts),hr.textContent=String(Ge.sizeBoosts),Ge.signedIn?(Ge.storedRt>0||Ge.portCharges>0?cn.textContent="Items will be used next match":cn.textContent="Earn items by winning matches!",cn.classList.add("signed-in")):(cn.textContent="Sign in to save equipment",cn.classList.remove("signed-in"))}async function wl(){if(!de)return{rt:0,ports:0};try{const e=await fetch("/api/inventory/withdraw",{method:"POST",credentials:"include"});if(!e.ok)return{rt:0,ports:0};const t=await e.json();return Ge={storedRt:0,portCharges:0,speedBoosts:0,sizeBoosts:0,signedIn:!0},ca(),{rt:t.storedRt??0,ports:t.portCharges??0}}catch{return{rt:0,ports:0}}}function Sl(){he?(bn.classList.remove("hidden"),he.canClaimToday||!de?bn.classList.add("has-gift"):bn.classList.remove("has-gift")):bn.classList.add("hidden")}async function fi(){try{const e=await fetch("/api/server-time",{credentials:"include"});if(!e.ok)return;const t=await e.json();typeof t.nextMidnightUtc=="string"&&(qs=t.nextMidnightUtc)}catch{}}function ui(){const e=new Date,t=e.getUTCHours(),n=e.getUTCMinutes(),o=e.getUTCSeconds();if(ar.textContent=`${String(t).padStart(2,"0")}:${String(n).padStart(2,"0")}:${String(o).padStart(2,"0")} UTC`,qs){const i=new Date(qs).getTime();let r=Math.max(0,i-Date.now());const c=Math.floor(r/36e5);r%=36e5;const l=Math.floor(r/6e4);Fo.textContent=`Next daily gift: in ${c}h ${l}m`}else Fo.textContent="Next daily gift: at 00:00 UTC"}function sn(){En||(fi(),ui(),En=setInterval(()=>{ui()},1e3),setInterval(()=>fi(),3e4),At(),Io())}function Il(){En&&(clearInterval(En),En=null)}kr();Tr().then(()=>El());Te();sn();window.addEventListener("resize",Ji);Ji();
