(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const l of c.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function n(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function i(o){if(o.ep)return;o.ep=!0;const c=n(o);fetch(o.href,c)}})();const Rt=25,en=1e3/Rt,F=2400,K=2400,ht=280,de=32,ue=2.5,mt=16,gt=4,pt=18,tn=1.5,ne=1,oe=2,se=4,ie=8,Pt=0,nn=1,Dt=2;function Ot(e,t){const n=new ArrayBuffer(4),i=new DataView(n);return i.setUint8(0,nn),i.setUint16(1,e,!0),i.setUint8(3,t&255),n}function ee(e,t){const n=e.getUint8(t);if(n===0)return{s:"",next:t+1};const i=e.buffer.byteLength-(t+1);if(n>i||n<0)throw new RangeError(`Snapshot string length ${n} exceeds buffer (${i} bytes left)`);const o=new Uint8Array(e.buffer,t+1,n);return{s:new TextDecoder().decode(o),next:t+1+n}}function on(e){const t=new DataView(e);let n=0;if(t.getUint8(n++)!==Dt)throw new Error("Invalid snapshot message");const i=t.getUint32(n,!0);n+=4;const o=t.getUint32(n,!0);n+=4;const c=t.getUint8(n++),l=[];for(let g=0;g<c;g++){const{s:x,next:L}=ee(t,n);n=L;const{s:N,next:k}=ee(t,n);n=k;const R=t.getFloat32(n,!0);n+=4;const ce=t.getFloat32(n,!0);n+=4;const Y=t.getFloat32(n,!0);n+=4;const V=t.getFloat32(n,!0);n+=4;const a=t.getFloat32(n,!0);n+=4;const m=t.getUint32(n,!0);n+=4;const A=t.getUint8(n++),I=[];for(let O=0;O<A;O++){const{s:Q,next:M}=ee(t,n);n=M,I.push(Q)}const E=t.getUint32(n,!0);n+=4;const he=t.getUint8(n++),me=t.getUint8(n++)!==0,ae=t.getUint8(n++),q=[];for(let O=0;O<ae;O++){const{s:Q,next:M}=ee(t,n);n=M,q.push(Q)}l.push({id:x,displayName:N||x,x:R,y:ce,vx:Y,vy:V,size:a,totalAdoptions:m,petsInside:I,speedBoostUntil:E,inputSeq:he,...q.length?{allies:q}:{},...me?{eliminated:!0}:{}})}const h=t.getUint8(n++),b=[];for(let g=0;g<h;g++){const{s:x,next:L}=ee(t,n);n=L;const N=t.getFloat32(n,!0);n+=4;const k=t.getFloat32(n,!0);n+=4;const R=t.getFloat32(n,!0);n+=4;const ce=t.getFloat32(n,!0);n+=4;const{s:Y,next:V}=ee(t,n);n=V;const a=Y===""?null:Y;b.push({id:x,x:N,y:k,vx:R,vy:ce,insideShelterId:a})}const w=t.getUint8(n++),y=[];for(let g=0;g<w;g++){const{s:x,next:L}=ee(t,n);n=L;const N=t.getFloat32(n,!0);n+=4;const k=t.getFloat32(n,!0);n+=4;const R=t.getFloat32(n,!0);n+=4,y.push({id:x,x:N,y:k,radius:R})}const u=t.getUint8(n++),v=[];for(let g=0;g<u;g++){const{s:x,next:L}=ee(t,n);n=L;const N=t.getFloat32(n,!0);n+=4;const k=t.getFloat32(n,!0);n+=4;const R=t.getUint8(n++);v.push({id:x,x:N,y:k,type:R})}return{tick:i,matchEndAt:o,players:l,pets:b,adoptionZones:y,pickups:v}}const Ut="rescueworld_music",_t="rescueworld_sfx";function Ft(e,t){try{const n=localStorage.getItem(e);if(n==="0"||n==="false")return!1;if(n==="1"||n==="true")return!0}catch{}return t}function Yt(e,t){try{localStorage.setItem(e,t?"1":"0")}catch{}}function we(){return Ft(Ut,!0)}function $t(e){Yt(Ut,e),B&&(B.volume=e?1:0),!e&&B&&B.pause()}function zt(){return Ft(_t,!0)}function sn(e){Yt(_t,e)}let Me=null;function ln(){if(Me)return Me;try{Me=new(window.AudioContext||window.webkitAudioContext)}catch{return null}return Me}function C(e,t,n="sine",i=.3){if(!zt())return;const o=ln();if(o)try{const c=o.createOscillator(),l=o.createGain();c.connect(l),l.connect(o.destination),c.frequency.value=e,c.type=n,l.gain.setValueAtTime(i,o.currentTime),l.gain.exponentialRampToValueAtTime(.001,o.currentTime+t),c.start(o.currentTime),c.stop(o.currentTime+t)}catch{}}function cn(){C(523,.12,"sine",.25),setTimeout(()=>C(659,.1,"sine",.2),80)}function an(){C(440,.08,"square",.2),setTimeout(()=>C(880,.08,"square",.15),60)}function rn(){C(392,.1,"sine",.25),setTimeout(()=>C(523,.12,"sine",.22),70),setTimeout(()=>C(659,.15,"sine",.2),140)}function dn(){C(330,.06,"sine",.18)}function un(){C(523,.15,"sine",.25),setTimeout(()=>C(659,.15,"sine",.22),120),setTimeout(()=>C(784,.2,"sine",.2),240)}function fn(){C(440,.08,"sine",.2),setTimeout(()=>C(554,.08,"sine",.18),80),setTimeout(()=>C(659,.12,"sine",.2),160)}function vt(){C(220,.15,"sawtooth",.35),setTimeout(()=>C(180,.12,"sawtooth",.3),100),setTimeout(()=>C(220,.1,"sawtooth",.25),200)}let B=null;function yn(){var i;const e=import.meta;let t=typeof((i=e.env)==null?void 0:i.BASE_URL)=="string"?e.env.BASE_URL:"";if(!t||t==="/"){const o=typeof window<"u"?window.location.pathname:"";if(o.includes("rescueworld"))t="/rescueworld/";else{const c=o.lastIndexOf("/");t=c<=0?"/":o.slice(0,c+1)}}return t.endsWith("/")?`${t}music.mp3`:`${t}/music.mp3`}function ke(){if(we())try{if(!B){B=new Audio,B.loop=!0,B.volume=1,B.preload="auto",B.src=yn();let t=!1;B.addEventListener("error",()=>{!B||t||(t=!0,B.src="/rescueworld/music.mp3",B.play().catch(()=>{}))}),B.load()}B.volume=we()?1:0;const e=B.play();e&&typeof e.catch=="function"&&e.catch(()=>{})}catch{}}const hn=(()=>{const{protocol:e,host:t}=window.location;return`${e==="https:"?"wss:":"ws:"}//${t}/ws-signaling`})();let Ie=0,Ht=0;const z={};let Ee=!1,Fe=0,Ye=0,Ge=0,qe=0;const mn=15,bt=60;let f=null,_=null,r=null;const $e=new Map,ze=new Map,gn=100;let d=null,wt=0,Et=0,St=0,xt=0,He=!1,Wt=0,et=0,Je=0,Be=null;const pn=200,S=document.getElementById("game"),s=S.getContext("2d"),G=document.getElementById("minimap"),T=G.getContext("2d"),vn=document.getElementById("score"),bn=document.getElementById("carried"),Lt=document.getElementById("tag-cooldown"),wn=document.getElementById("timer"),ye=document.getElementById("leaderboard"),D=document.getElementById("connection-overlay"),It=document.getElementById("how-to-play"),En=document.getElementById("settings-btn"),Kt=document.getElementById("settings-panel"),be=document.getElementById("music-toggle"),tt=document.getElementById("sfx-toggle"),Sn=document.getElementById("settings-close");document.getElementById("ping");const xn=document.getElementById("switch-server"),Ln=document.getElementById("switch-server-btn"),X=document.getElementById("auth-area"),it=document.getElementById("landing"),We=document.getElementById("game-wrap"),In=document.getElementById("landing-play"),$=document.getElementById("landing-nick"),xe=document.getElementById("landing-music-toggle"),Oe=document.getElementById("landing-profile-name"),Ue=document.getElementById("landing-profile-avatar"),Ze=document.getElementById("landing-profile-actions"),_e=document.getElementById("landing-auth-buttons"),lt=document.getElementById("cookie-banner"),Tn=document.getElementById("cookie-accept"),kn=document.getElementById("cookie-essential"),Le=document.getElementById("fight-ally-overlay"),An=document.getElementById("fight-ally-name"),Mn=document.getElementById("fight-ally-fight"),Bn=document.getElementById("fight-ally-ally"),Ce=document.getElementById("cpu-warning"),ge=document.getElementById("lobby-overlay"),nt=document.getElementById("lobby-message"),Ve=document.getElementById("lobby-countdown"),pe=document.getElementById("lobby-ready-btn"),Cn=document.getElementById("lobby-back-btn"),ct="cookieConsent",Xt="rescueworld_mode";let fe=null;const ot=new Set;let Ne=0;const Tt=2e3;let te="playing",Qe=0,Nn=0,Ke=!1;const Gt="rescueworld_money",Xe={size:50,speed:30,adoptSpeed:40};let Z="ffa";const P={sizeBonus:0,speedBoost:!1,adoptSpeed:!1};let re=null,kt=!1;function Te(){return parseInt(localStorage.getItem(Gt)||"0",10)}function qt(e){localStorage.setItem(Gt,String(Math.max(0,e)))}function Ae(){const e=document.getElementById("landing-money");e&&(e.textContent=`Money: ${Te()}`);const t=Te();document.querySelectorAll(".landing-buy").forEach(n=>{const i=n.dataset.boost;if(!i||!(i in Xe))return;const o=Xe[i];n.disabled=t<o||i==="speed"&&P.speedBoost||i==="adoptSpeed"&&P.adoptSpeed})}async function Rn(){try{const t=await(await fetch("/auth/me",{credentials:"include"})).json(),{displayName:n,signedIn:i}=t,o=n??"";if(re=o||null,kt=i,i&&o)X.innerHTML=`
        <span class="auth-profile">${At(o)}</span>
        <a href="/auth/signout" class="auth-link">Sign out</a>
      `,Oe.textContent=o,Ue.textContent=o.charAt(0).toUpperCase(),Ze.innerHTML='<a href="/auth/signout" class="auth-link" style="font-size:12px">Sign out</a>',_e.innerHTML='<a href="/auth/google" class="auth-link" style="display:inline-block">Sign in with Google</a> <a href="#" id="landing-facebook" style="opacity:0.7">Sign in with Facebook</a>',$&&($.placeholder=o);else{const c=o?`${At(o)}`:"Guest";X.innerHTML=`
        <a href="/auth/google" class="auth-link">Sign in with Google</a>
        <span class="auth-guest">${c}</span>
      `,Oe.textContent=o||"Guest",Ue.textContent=o?o.charAt(0).toUpperCase():"?",Ze.innerHTML="",_e.innerHTML=`
        <a href="/auth/google">Sign in with Google</a>
        <a href="#" id="landing-facebook" style="opacity:0.7">Sign in with Facebook</a>
      `,$&&($.placeholder=o||"Nickname")}$&&o&&($.value=o)}catch{re=null,kt=!1,X.innerHTML=`
      <a href="/auth/google" class="auth-link">Sign in with Google</a>
      <span class="auth-guest">Guest</span>
    `,Oe.textContent="Guest",Ue.textContent="?",Ze.innerHTML="",_e.innerHTML='<a href="/auth/google">Sign in with Google</a> <a href="#" id="landing-facebook" style="opacity:0.7">Sign in with Facebook</a>',$&&($.placeholder="Nickname")}}async function Pn(){var n;const e=(n=$==null?void 0:$.value)==null?void 0:n.trim();if(e)return re=e,e;if(re)return re;try{const o=await(await fetch("/auth/guest",{method:"POST",credentials:"include"})).json();if(o.displayName)return re=o.displayName,Oe.textContent=o.displayName,Ue.textContent=o.displayName.charAt(0).toUpperCase(),o.displayName}catch{}const t=`rescue${Date.now().toString(36)}`;return re=t,t}function At(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function jt(){const e=window.innerWidth,t=window.innerHeight;S.width=e,S.height=t}function p(e,t){t?Ie|=e:Ie&=~e}function Dn(e){z[e.code]=!0,(e.code==="KeyW"||e.code==="ArrowUp")&&p(se,!0),(e.code==="KeyS"||e.code==="ArrowDown")&&p(ie,!0),(e.code==="KeyA"||e.code==="ArrowLeft")&&p(ne,!0),(e.code==="KeyD"||e.code==="ArrowRight")&&p(oe,!0),e.preventDefault()}function On(e){z[e.code]=!1,(e.code==="KeyW"||e.code==="ArrowUp")&&p(se,!1),(e.code==="KeyS"||e.code==="ArrowDown")&&p(ie,!1),(e.code==="KeyA"||e.code==="ArrowLeft")&&p(ne,!1),(e.code==="KeyD"||e.code==="ArrowRight")&&p(oe,!1),e.preventDefault()}function Un(){return!!(z.KeyW||z.KeyS||z.KeyA||z.KeyD||z.ArrowUp||z.ArrowDown||z.ArrowLeft||z.ArrowRight)}function _n(){if(Un())return;if(!Ee){p(ne,!1),p(oe,!1),p(se,!1),p(ie,!1);return}const e=Ge-Fe,t=qe-Ye,n=Math.hypot(e,t);if(n<mn){p(ne,!1),p(oe,!1),p(se,!1),p(ie,!1);return}const i=e/n,o=t/n;p(ne,i<-.3),p(oe,i>.3),p(se,o<-.3),p(ie,o>.3)}S.addEventListener("touchstart",e=>{e.preventDefault(),e.touches.length&&(Ee=!0,Fe=e.touches[0].clientX,Ye=e.touches[0].clientY,Ge=Fe,qe=Ye)},{passive:!1});S.addEventListener("touchmove",e=>{e.preventDefault(),e.touches.length&&Ee&&(Ge=e.touches[0].clientX,qe=e.touches[0].clientY)},{passive:!1});function Jt(){if((f==null?void 0:f.readyState)===WebSocket.OPEN){const e=Ot(Ie,Ht++);f.send(e)}}S.addEventListener("touchend",e=>{e.preventDefault(),e.touches.length===0&&(Ee=!1,p(ne,!1),p(oe,!1),p(se,!1),p(ie,!1),Jt())},{passive:!1});S.addEventListener("touchcancel",e=>{e.preventDefault(),Ee=!1,p(ne,!1),p(oe,!1),p(se,!1),p(ie,!1),Jt()},{passive:!1});S.addEventListener("mousedown",e=>{e.preventDefault()});S.addEventListener("mousemove",e=>{e.preventDefault()});S.addEventListener("mouseup",e=>{e.preventDefault()});S.addEventListener("contextmenu",e=>{e.preventDefault()});window.addEventListener("keydown",Dn);window.addEventListener("keyup",On);let le=!1;function je(e,t){const n=G.getBoundingClientRect(),i=e-n.left,o=t-n.top,c=F/120,l=i*c,h=o*c,b=(d==null?void 0:d.x)??F/2,w=(d==null?void 0:d.y)??K/2;at=l-b,rt=h-w}G.addEventListener("mousedown",e=>{e.preventDefault(),le=!0,je(e.clientX,e.clientY)});G.addEventListener("mousemove",e=>{le&&je(e.clientX,e.clientY)});G.addEventListener("mouseup",()=>{le=!1});G.addEventListener("mouseleave",()=>{le=!1});G.addEventListener("touchstart",e=>{e.preventDefault(),le=!0,e.touches.length>0&&je(e.touches[0].clientX,e.touches[0].clientY)},{passive:!1});G.addEventListener("touchmove",e=>{le&&e.touches.length>0&&(e.preventDefault(),je(e.touches[0].clientX,e.touches[0].clientY))},{passive:!1});G.addEventListener("touchend",()=>{le=!1});G.addEventListener("touchcancel",()=>{le=!1});let j=null,J=null;const Mt=.22;let at=0,rt=0,H=null,W=null;const Bt=.28;function Fn(){const e=S.width,t=S.height;let n=(d==null?void 0:d.x)??F/2,i=(d==null?void 0:d.y)??K/2;(!Number.isFinite(n)||!Number.isFinite(i))&&(n=F/2,i=K/2);let o=n-e/2+at,c=i-t/2+rt;if(o=Math.max(0,Math.min(F-e,o)),c=Math.max(0,Math.min(K-t,c)),d==null)return j=null,J=null,{x:o,y:c,w:e,h:t};j==null||J==null||!Number.isFinite(j)||!Number.isFinite(J)?(j=o,J=c):(j+=(o-j)*Mt,J+=(c-J)*Mt);let l=j,h=J;return(!Number.isFinite(l)||!Number.isFinite(h))&&(l=o,h=c,j=l,J=h),l=Math.max(0,Math.min(F-e,l)),h=Math.max(0,Math.min(K-t,h)),{x:l,y:h,w:e,h:t}}function Yn(e,t,n){let i=0,o=0;t&ne&&(i-=1),t&oe&&(i+=1),t&se&&(o-=1),t&ie&&(o+=1);let c=0,l=0;if(i!==0||o!==0){const y=Math.hypot(i,o)||1,v=((e.speedBoostUntil??0)>0?ht*tn:ht)*n;c=i/y*v,l=o/y*v}const h=de+e.size*ue;let b=e.x+c,w=e.y+l;return b=Math.max(h,Math.min(F-h,b)),w=Math.max(h,Math.min(K-h,w)),{...e,x:b,y:w,vx:c,vy:l,petsInside:[...e.petsInside],speedBoostUntil:e.speedBoostUntil??0}}const Ct=1e4;function dt(e){D.classList.remove("hidden"),D.innerHTML=`
    <h2>Could not connect</h2>
    <p class="error">${e}</p>
    <p>The game server is not running or not reachable.</p>
    <p><strong>To start the game:</strong></p>
    <p>From the project root folder, run: <code>npm run dev</code></p>
    <p>That starts both the server (ports 4000, 4001) and the client. Wait a few seconds, then refresh this page.</p>
    <p>Or run in two terminals: first <code>npm run dev:server</code>, then <code>npm run dev:client</code>.</p>
  `}async function ut(e){Be&&(clearInterval(Be),Be=null),xn.classList.add("hidden");const t=l=>/^wss?:\/\/localhost(\b|:|\/|$)/i.test(l)||/^wss?:\/\/127\.0\.0\.1(\b|:|\/|$)/i.test(l),n=()=>{const{protocol:l,host:h}=window.location;return`${l==="https:"?"wss:":"ws:"}//${h}/ws-game`};let i=t(window.location.href)?"ws://localhost:4001":n();const o=new WebSocket(hn);await new Promise((l,h)=>{const b=setTimeout(()=>{o.close(),h(new Error("Connection timeout. Is the server running? Run: npm run dev"))},Ct);o.onopen=()=>{o.send(JSON.stringify({type:"join",latency:e==null?void 0:e.latency,mode:(e==null?void 0:e.mode)??"ffa"}))},o.onmessage=w=>{try{const y=JSON.parse(w.data);y.type==="joined"&&y.gameUrl&&(clearTimeout(b),i=y.gameUrl,!t(window.location.href)&&t(i)&&(i=n()),l())}catch{}},o.onerror=()=>{clearTimeout(b),h(new Error("WebSocket error. Server not running?"))},o.onclose=()=>{clearTimeout(b),o.readyState!==WebSocket.OPEN&&h(new Error("Signaling connection closed. Run: npm run dev"))}});const c=new WebSocket(i);c.binaryType="arraybuffer",c.onopen=async()=>{f=c;const l=await Pn();f.send(JSON.stringify({type:"mode",mode:(e==null?void 0:e.mode)??"ffa",displayName:l})),(P.sizeBonus>0||P.speedBoost||P.adoptSpeed)&&(f.send(JSON.stringify({type:"startingBoosts",sizeBonus:P.sizeBonus,speedBoost:P.speedBoost,adoptSpeed:P.adoptSpeed})),P.sizeBonus=0,P.speedBoost=!1,P.adoptSpeed=!1)},c.onmessage=l=>{var b,w;if(typeof l.data=="string"){try{const y=JSON.parse(l.data);y.type==="welcome"&&y.playerId&&(_=y.playerId,fn()),y.type==="matchState"&&typeof y.phase=="string"&&(te=y.phase,Qe=typeof y.countdownRemainingSec=="number"?y.countdownRemainingSec:0,Nn=typeof y.readyCount=="number"?y.readyCount:0,te==="lobby"?Z==="solo"?ge.classList.add("hidden"):(ge.classList.remove("hidden"),nt.textContent="Waiting for another player…",Ve.classList.add("hidden"),pe.classList.add("hidden")):te==="countdown"?(ge.classList.remove("hidden"),nt.textContent="Match starting soon",Ve.classList.remove("hidden"),Ve.textContent=Qe>0?`Starting in ${Qe}s…`:"Starting…",pe.classList.remove("hidden"),Ke?pe.textContent="Ready!":pe.textContent="Ready"):ge.classList.add("hidden")),y.type==="pong"&&typeof y.ts=="number"&&(et=Math.round(Date.now()-y.ts),et>pn?Je=Je||Date.now():Je=0)}catch{}return}const h=l.data;if(!(h.byteLength<1)&&new DataView(h).getUint8(0)===Dt){const y=on(h);r=y,te!=="playing"&&(te="playing",ge.classList.add("hidden"));for(const v of y.players){const g=((b=$e.get(v.id))==null?void 0:b.next)??v;$e.set(v.id,{prev:g,next:{...v},t:0})}for(const v of y.pets){const g=((w=ze.get(v.id))==null?void 0:w.next)??v;ze.set(v.id,{prev:g,next:{...v},t:0})}const u=y.players.find(v=>v.id===_);if(u){u.size>wt&&(Wt=Date.now()+1500,cn()),(u.speedBoostUntil??0)>xt&&an(),xt=u.speedBoostUntil??0,u.totalAdoptions>Et&&rn(),Et=u.totalAdoptions,u.petsInside.length>St&&dn(),St=u.petsInside.length,wt=u.size;const v=(d==null?void 0:d.x)??u.x,g=(d==null?void 0:d.y)??u.y;d={...u,petsInside:[...u.petsInside]},u.inputSeq,Math.hypot(u.x-v,u.y-g)>300&&(j=null,J=null,at=0,rt=0,H=u.x,W=u.y)}}},c.onclose=()=>{f=null,_=null,r=null,d=null,te="playing",Ke=!1},await new Promise((l,h)=>{const b=Date.now()+Ct,w=()=>{(f==null?void 0:f.readyState)===WebSocket.OPEN?l():Date.now()>b?h(new Error("Game server connection timeout")):setTimeout(w,50)};w()}),D.classList.add("hidden"),It.classList.remove("hidden"),setTimeout(()=>It.classList.add("hidden"),12e3),ke(),Be=setInterval(()=>{(f==null?void 0:f.readyState)===WebSocket.OPEN&&f.send(JSON.stringify({type:"ping",ts:Date.now()}))},2e3)}let Re=0,Nt=0;function ft(e){Re||(Re=e);const t=Math.min((e-Re)/1e3,.1);Re=e,_n();const n=r!=null&&r.matchEndAt>0&&r.tick>=r.matchEndAt,i=r==null?void 0:r.players.find(l=>l.id===_),o=te==="playing"&&!n&&!(i!=null&&i.eliminated);if(o&&(f==null?void 0:f.readyState)===WebSocket.OPEN&&e-Nt>=en){Nt=e;const l=Ot(Ie,Ht++);f.send(l)}if(o&&d&&_){const l=d.x,h=d.y;d=Yn(d,Ie,t);const b=de+d.size*ue;if(r)for(const g of r.players){if(g.id===_)continue;const x=st(g.id)??g,L=de+x.size*ue;if(Math.abs(d.x-x.x)<=b+L&&Math.abs(d.y-x.y)<=b+L){d={...d,x:l,y:h};break}}let w=d.x,y=d.y;(!Number.isFinite(w)||!Number.isFinite(y))&&(w=F/2,y=K/2),H==null||W==null?(H=w,W=y):(H+=(w-H)*Bt,W+=(y-W)*Bt),(!Number.isFinite(H)||!Number.isFinite(W))&&(H=w,W=y);let u=null,v=!1;if(r){const g=H??d.x,x=W??d.y,L=d.size,N=de+L*ue;for(const k of r.players){if(k.id===_)continue;const R=st(k.id)??k,ce=de+R.size*ue;if(Math.abs(g-R.x)<=N+ce&&Math.abs(x-R.y)<=N+ce&&!(L<gt||R.size<gt)){if(k.id.startsWith("cpu-")){v=!0;continue}if(!ot.has(k.id)){u=k.id;break}}}}if(u){const g=r.players.find(L=>L.id===u);fe=u,An.textContent=(g==null?void 0:g.displayName)??u;const x=Le.classList.contains("hidden");Le.classList.remove("hidden"),x&&Date.now()-Ne>Tt&&(Ne=Date.now(),vt())}else Le.classList.add("hidden"),fe=null,ot.clear();if(v){const g=Ce.classList.contains("hidden");Ce.classList.remove("hidden"),g&&Date.now()-Ne>Tt&&(Ne=Date.now(),vt())}else Ce.classList.add("hidden")}else H=null,W=null,Le.classList.add("hidden"),fe=null,Ce.classList.add("hidden");const c=t*(1e3/gn);for(const l of $e.values())l.t=Math.min(1,l.t+c);for(const l of ze.values())l.t=Math.min(1,l.t+c);Gn(),requestAnimationFrame(ft)}function ve(e,t,n){return e+(t-e)*n}function st(e){const t=$e.get(e);if(!t)return null;const n=t.t;return{...t.next,x:ve(t.prev.x,t.next.x,n),y:ve(t.prev.y,t.next.y,n),vx:ve(t.prev.vx,t.next.vx,n),vy:ve(t.prev.vy,t.next.vy,n)}}function $n(e){const t=ze.get(e);if(!t)return null;const n=t.t;return{...t.next,x:ve(t.prev.x,t.next.x,n),y:ve(t.prev.y,t.next.y,n)}}const U=36,Pe=1.8;function Zt(e){let t=0;for(let i=0;i<e.length;i++)t=t*31+e.charCodeAt(i)>>>0;return`hsl(${t%360}, 72%, 58%)`}function zn(e){const t=U*2,n=Math.floor((e.x-t)/U)*U,i=Math.floor((e.y-t)/U)*U,o=Math.ceil((e.x+e.w+t)/U)*U,c=Math.ceil((e.y+e.h+t)/U)*U;s.fillStyle="#3d6b3d",s.fillRect(e.x,e.y,e.w,e.h),s.fillStyle="rgba(255,255,255,0.35)";for(let l=i;l<=c;l+=U)for(let h=n;h<=o;h+=U)s.fillRect(h-Pe,l-Pe,Pe*2,Pe*2)}function Hn(e){const t=e.x,n=e.y,i=e.radius;s.save(),s.strokeStyle="rgba(123, 237, 159, 0.6)",s.lineWidth=4,s.setLineDash([8,8]),s.strokeRect(t-i,n-i,i*2,i*2),s.setLineDash([]),s.fillStyle="rgba(74, 124, 89, 0.2)",s.fillRect(t-i,n-i,i*2,i*2),s.fillStyle="#7bed9f",s.font="bold 14px Rubik, sans-serif",s.textAlign="center",s.fillText("ADOPTION CENTER",t,n-i-8),s.fillText("Bring pets here to adopt out",t,n),s.restore()}function Wn(e,t){const n=de+e.size*ue,i=e.x,o=e.y;s.save(),s.shadowColor="rgba(0,0,0,0.4)",s.shadowBlur=10;const c=t?"#7bed9f":Zt(e.id);s.fillStyle=c,s.fillRect(i-n,o-n,n*2,n*2),s.strokeStyle=t?"rgba(255,255,255,0.9)":"rgba(255,255,255,0.5)",s.lineWidth=t?3:2,s.strokeRect(i-n,o-n,n*2,n*2),s.fillStyle="#2d2d2d",s.font="bold 12px Rubik, sans-serif",s.textAlign="center";const l=t?"You":e.displayName??e.id;s.fillText(l,i,o-n-6),s.fillText(`Pets: ${e.petsInside.length}/${Math.floor(e.size)}`,i,o+4),s.restore()}function Kn(e,t){s.save(),s.fillStyle="#c9a86c",s.beginPath(),s.arc(e,t,mt,0,Math.PI*2),s.fill(),s.strokeStyle="#8B4513",s.lineWidth=1.5,s.stroke(),s.font="10px Rubik, sans-serif",s.fillStyle="#333",s.textAlign="center",s.fillText("Stray",e,t+mt+10),s.restore()}function Xn(e){const t=e.type===Pt,n=pt;s.save(),s.fillStyle=t?"#7bed9f":"#70a3ff",s.fillRect(e.x-n,e.y-n,n*2,n*2),s.strokeStyle=t?"#2d5a38":"#2d4a6e",s.lineWidth=2,s.strokeRect(e.x-n,e.y-n,n*2,n*2),s.fillStyle="#333",s.font="10px Rubik, sans-serif",s.textAlign="center",s.fillText(t?"+Size":"Speed",e.x,e.y+pt+10),s.restore()}function Gn(e){try{const t=Fn(),n=Number.isFinite(t.x)?Math.max(0,Math.min(F-t.w,t.x)):0,i=Number.isFinite(t.y)?Math.max(0,Math.min(K-t.h,t.y)):0,o={x:n,y:i,w:t.w,h:t.h};if(s.save(),s.translate(-o.x,-o.y),zn(o),r){for(const a of r.adoptionZones)Hn(a);for(const a of r.pickups??[])Xn(a)}for(const a of(r==null?void 0:r.pets)??[]){if(a.insideShelterId!==null)continue;const m=$n(a.id)??a;!Number.isFinite(m.x)||!Number.isFinite(m.y)||Kn(m.x,m.y)}const c=[...(r==null?void 0:r.players)??[]].sort((a,m)=>a.size-m.size);for(const a of c){const m=a.id===_;let A;if(m&&d){let I=H??d.x,E=W??d.y;(!Number.isFinite(I)||!Number.isFinite(E))&&(I=d.x,E=d.y),(!Number.isFinite(I)||!Number.isFinite(E))&&(I=F/2,E=K/2),A={...d,x:I,y:E}}else A=st(a.id)??a;if(!(!Number.isFinite(A.x)||!Number.isFinite(A.y))&&(Wn(A,m),m&&Wt>Date.now())){s.save(),s.setTransform(1,0,0,1,0,0);const I=S.width/2,E=S.height/2-60;s.fillStyle="#7bed9f",s.font="bold 28px Rubik, sans-serif",s.textAlign="center",s.fillText("+1 Size!",I,E),s.restore()}}s.restore();const l=120/F;T.fillStyle="#2d4a2d",T.fillRect(0,0,120,120);for(let a=0;a<=K;a+=U*3)for(let m=0;m<=F;m+=U*3)T.fillStyle="rgba(255,255,255,0.15)",T.fillRect(m*l-.8,a*l-.8,1.6,1.6);if(r){for(const a of r.adoptionZones){const m=a.radius*l|0;T.fillStyle="rgba(123, 237, 159, 0.6)",T.fillRect(a.x*l-m,a.y*l-m,m*2,m*2)}for(const a of r.pets)a.insideShelterId===null&&(T.fillStyle="#c9a86c",T.fillRect(a.x*l-2,a.y*l-2,4,4));for(const a of r.pickups??[])T.fillStyle=a.type===Pt?"#7bed9f":"#70a3ff",T.fillRect(a.x*l-2,a.y*l-2,4,4);for(const a of r.players){T.fillStyle=a.id===_?"#7bed9f":Zt(a.id);const m=(de+a.size*ue)*l,A=Math.max(2,m);T.fillRect(a.x*l-A,a.y*l-A,A*2,A*2)}}const h=o.x*l,b=o.y*l,w=o.w*l,y=o.h*l;if(T.strokeStyle="rgba(255,255,255,0.6)",T.lineWidth=1.5,T.strokeRect(h,b,w,y),T.strokeStyle="rgba(255,255,255,0.2)",T.lineWidth=1,T.strokeRect(.5,.5,119,119),Ee){const a=S.getBoundingClientRect(),m=S.width/a.width,A=S.height/a.height,I=(Fe-a.left)*m,E=(Ye-a.top)*A,he=(Ge-a.left)*m,me=(qe-a.top)*A,ae=he-I,q=me-E,O=Math.hypot(ae,q),Q=Math.min(O,bt*m),M=O>0?I+ae/O*Q:I,Se=O>0?E+q/O*Q:E;s.save(),s.globalAlpha=.3,s.strokeStyle="#fff",s.lineWidth=3,s.beginPath(),s.arc(I,E,bt*m,0,Math.PI*2),s.stroke(),s.fillStyle="rgba(255,255,255,0.1)",s.fill(),s.globalAlpha=.6,s.fillStyle="#7bed9f",s.beginPath(),s.arc(M,Se,20*m,0,Math.PI*2),s.fill(),s.strokeStyle="#fff",s.lineWidth=2,s.stroke(),s.restore()}const u=(r==null?void 0:r.players.find(a=>a.id===_))??d,v=u?Math.floor(u.size):0,g=(u==null?void 0:u.petsInside.length)??0,x=(r==null?void 0:r.pets.filter(a=>a.insideShelterId===null).length)??0;vn.textContent=`Size: ${v}`,bn.textContent=`Pets: ${g}/${v}`;const L=(r==null?void 0:r.tick)??0,N=Rt,k=u&&(u.speedBoostUntil??0)>L?((u.speedBoostUntil-L)/N).toFixed(1):"";Lt&&(Lt.textContent=u?`Adoptions: ${u.totalAdoptions}  •  Strays: ${x}${k?`  •  Speed: ${k}s`:""}`:"");const R=(r==null?void 0:r.matchEndAt)??0,Y=Math.max(0,R-L)/N;wn.textContent=Y>0?`${Math.floor(Y/60)}:${String(Math.floor(Y%60)).padStart(2,"0")}`:"0:00";const V=!!(u!=null&&u.eliminated);if((Y<=0||V)&&(r!=null&&r.players.length)){He||(He=!0,un()),ye.classList.add("show");const a=[...r.players].sort((M,Se)=>Se.size-M.size),m=a.find(M=>M.id===_),A=m?Math.floor(m.size):0,I=[100,50,25],E=m?a.findIndex(M=>M.id===_)+1:0,he=E>0&&E<=I.length?I[E-1]:0,me=V?0:A+he,ae=Te()+me;Y<=0&&qt(ae);const q=E===1?"Win bonus":E===2?"2nd place":E===3?"3rd place":E>0?`${E}th place`:"",O=me>0?`<br><br><strong>Total: ${ae.toLocaleString()}</strong>${q?`<br>${q}: +${he}`:""}`:V?`<br><br><strong>Total: ${Te().toLocaleString()}</strong>`:"",Q=V?"You were consumed":"Match over";ye.innerHTML=`<strong>${Q}</strong><br><br>`+a.map((M,Se)=>`${Se+1}. ${M.id===_?"You":M.displayName??M.id}: size ${Math.floor(M.size)} (${M.totalAdoptions} adoptions)`).join("<br>")+O+'<br><br><button type="button" id="play-again-btn" class="fight-ally-btn ally-btn" style="margin-right:8px">Play again</button><button type="button" id="lobby-btn" class="fight-ally-btn fight-btn">Back to lobby</button>'}else ye.classList.remove("show")}catch(t){console.error("Render error:",t),s.save(),s.setTransform(1,0,0,1,0,0),s.fillStyle="#3d6b3d",s.fillRect(0,0,S.width,S.height),s.restore()}}function Vt(e){e.id==="play-again-btn"?(f&&(f.close(),f=null),ye.classList.remove("show"),He=!1,r=null,D.classList.remove("hidden"),D.innerHTML=Z==="ffa"?"<h2>Connecting…</h2><p>Joining FFA lobby…</p>":"<h2>Connecting…</h2><p>Starting new match.</p>",X.classList.add("hidden"),ut({mode:Z}).then(()=>{D.classList.add("hidden"),D.innerHTML="",We.classList.add("visible"),requestAnimationFrame(ft)}).catch(t=>dt(t.message||"Connection failed."))):e.id==="lobby-btn"&&(f&&(f.close(),f=null),ye.classList.remove("show"),He=!1,r=null,We.classList.remove("visible"),it.classList.remove("hidden"),X.classList.remove("hidden"),Ae(),yt())}ye.addEventListener("click",e=>{const n=e.target.closest("button");n&&(e.preventDefault(),e.stopPropagation(),Vt(n))});ye.addEventListener("touchend",e=>{const n=e.target.closest("button");n&&(e.preventDefault(),e.stopPropagation(),Vt(n))},{passive:!1});pe.addEventListener("click",()=>{Ke||te!=="countdown"||!f||f.readyState!==WebSocket.OPEN||(Ke=!0,f.send(JSON.stringify({type:"ready"})),pe.textContent="Ready!",nt.textContent="You're ready! Waiting for other player(s)…")});Cn.addEventListener("click",()=>{f&&(f.close(),f=null),ge.classList.add("hidden"),We.classList.remove("visible"),it.classList.remove("hidden"),X.classList.remove("hidden"),Ae(),yt()});function Qt(e){!fe||!f||f.readyState!==WebSocket.OPEN||(f.send(JSON.stringify({type:"fightAlly",targetId:fe,choice:e})),ot.add(fe),Le.classList.add("hidden"),fe=null)}Mn.addEventListener("click",()=>Qt("fight"));Bn.addEventListener("click",()=>Qt("ally"));be.checked=we();tt.checked=zt();be.addEventListener("change",()=>{$t(be.checked),be.checked&&ke()});tt.addEventListener("change",()=>sn(tt.checked));En.addEventListener("click",()=>Kt.classList.toggle("hidden"));Sn.addEventListener("click",()=>Kt.classList.add("hidden"));Ln.addEventListener("click",()=>{f&&(f.close(),f=null),D.classList.remove("hidden"),D.innerHTML="<h2>Switching server…</h2><p>Reconnecting to a closer server.</p>",X.classList.add("hidden"),ut({latency:et,mode:Z}).then(()=>{D.classList.add("hidden"),D.innerHTML=""}).catch(e=>{dt(e.message||"Switch failed."),X.classList.remove("hidden")})});function yt(){document.querySelectorAll(".mode-option").forEach(e=>{e.dataset.mode===Z?e.classList.add("selected"):e.classList.remove("selected")})}const De=localStorage.getItem(Xt);(De==="ffa"||De==="teams"||De==="solo")&&(Z=De);yt();document.querySelectorAll(".mode-option").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".mode-option").forEach(t=>t.classList.remove("selected")),e.classList.add("selected"),Z=e.dataset.mode,localStorage.setItem(Xt,Z)})});_e.addEventListener("click",e=>{e.target.closest('a[href="#"]')&&e.preventDefault()});In.addEventListener("click",()=>{ke(),it.classList.add("hidden"),D.classList.remove("hidden"),D.innerHTML="<h2>Connecting…</h2><p>Waiting for game server.</p>",X.classList.add("hidden"),ut({mode:Z}).then(()=>{D.classList.add("hidden"),We.classList.add("visible"),be&&(be.checked=we()),requestAnimationFrame(ft)}).catch(e=>{dt(e.message||"Connection failed."),X.classList.remove("hidden")})});localStorage.getItem(ct)||lt.classList.remove("hidden");Tn.addEventListener("click",()=>{localStorage.setItem(ct,"full"),lt.classList.add("hidden")});kn.addEventListener("click",()=>{localStorage.setItem(ct,"essential"),lt.classList.add("hidden")});Ae();document.querySelectorAll(".landing-buy").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.boost;if(!t||!(t in Xe))return;const n=Xe[t],i=Te();i<n||(qt(i-n),t==="size"?P.sizeBonus+=1:t==="speed"?P.speedBoost=!0:t==="adoptSpeed"&&(P.adoptSpeed=!0),Ae())})});xe&&(xe.checked=we(),xe.addEventListener("change",()=>{$t(xe.checked),xe.checked&&ke()}));we()&&ke();Rn();Ae();window.addEventListener("resize",jt);jt();
