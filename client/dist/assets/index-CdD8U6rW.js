(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const d of a.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&i(d)}).observe(document,{childList:!0,subtree:!0});function s(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(o){if(o.ep)return;o.ep=!0;const a=s(o);fetch(o.href,a)}})();const Hs=25,_o=1e3/Hs,G=4800,Z=4800,vs=280,yt=32,ht=2.5,Es=16,ws=10,Ss=18,Fo=1.5,Gs=50,Te=1,Be=2,Me=4,Ae=8,zo=0,Wo=1,Xs=2,qs=3,Yo=1,Ks=2;function js(e,t){const s=new ArrayBuffer(4),i=new DataView(s);return i.setUint8(0,Yo),i.setUint16(1,e,!0),i.setUint8(3,t&255),s}function te(e,t){const s=e.getUint8(t);if(s===0)return{s:"",next:t+1};const i=e.buffer.byteLength-(t+1);if(s>i||s<0)throw new RangeError(`Snapshot string length ${s} exceeds buffer (${i} bytes left)`);const o=new Uint8Array(e.buffer,t+1,s);return{s:new TextDecoder().decode(o),next:t+1+s}}function Ho(e){const t=new DataView(e);let s=0;if(t.getUint8(s++)!==Ks)throw new Error("Invalid snapshot message");const i=t.getUint32(s,!0);s+=4;const o=t.getUint32(s,!0);s+=4;const a=t.getUint8(s++)!==0,{s:d,next:r}=te(t,s);s=r;const l=t.getUint32(s,!0);s+=4;const m=t.getUint8(s++),b=t.getUint32(s,!0);s+=4;const w=t.getUint8(s++),h=[];for(let _=0;_<w;_++){const{s:D,next:z}=te(t,s);s=z;const{s:W,next:$}=te(t,s);s=$;const F=t.getFloat32(s,!0);s+=4;const q=t.getFloat32(s,!0);s+=4;const oe=t.getFloat32(s,!0);s+=4;const Ee=t.getFloat32(s,!0);s+=4;const re=t.getFloat32(s,!0);s+=4;const we=t.getUint32(s,!0);s+=4;const We=t.getUint8(s++),ce=[];for(let ue=0;ue<We;ue++){const{s:v,next:u}=te(t,s);s=u,ce.push(v)}const Se=t.getUint32(s,!0);s+=4;const Qe=t.getUint8(s++),et=t.getUint8(s++)!==0,Et=t.getUint8(s++)!==0,Ne=t.getUint8(s++),kn=t.getUint8(s++),tt=[];for(let ue=0;ue<kn;ue++){const{s:v,next:u}=te(t,s);s=u,tt.push(v)}const{s:Ut,next:Ln}=te(t,s);s=Ln;const nt=t.getUint16(s,!0);s+=2;const{s:_t,next:Cn}=te(t,s);s=Cn;const Tn=t.getUint8(s++)!==0;h.push({id:D,displayName:W||D,x:F,y:q,vx:oe,vy:Ee,size:re,totalAdoptions:we,petsInside:ce,speedBoostUntil:Se,inputSeq:Qe,...tt.length?{allies:tt}:{},...et?{eliminated:!0}:{},...Et?{grounded:!0}:{},...Ne>0?{portCharges:Ne}:{},...Ut?{shelterColor:Ut}:{},...nt>0?{money:nt}:{},..._t?{shelterId:_t}:{},...Tn?{vanSpeedUpgrade:!0}:{}})}const f=t.getUint16(s,!0);s+=2;const g=[];for(let _=0;_<f;_++){const{s:D,next:z}=te(t,s);s=z;const W=t.getFloat32(s,!0);s+=4;const $=t.getFloat32(s,!0);s+=4;const F=t.getFloat32(s,!0);s+=4;const q=t.getFloat32(s,!0);s+=4;const{s:oe,next:Ee}=te(t,s);s=Ee;const re=oe===""?null:oe;g.push({id:D,x:W,y:$,vx:F,vy:q,insideShelterId:re})}const k=t.getUint8(s++),T=[];for(let _=0;_<k;_++){const{s:D,next:z}=te(t,s);s=z;const W=t.getFloat32(s,!0);s+=4;const $=t.getFloat32(s,!0);s+=4;const F=t.getFloat32(s,!0);s+=4,T.push({id:D,x:W,y:$,radius:F})}const N=t.getUint8(s++),A=[];for(let _=0;_<N;_++){const{s:D,next:z}=te(t,s);s=z;const W=t.getFloat32(s,!0);s+=4;const $=t.getFloat32(s,!0);s+=4;const F=t.getUint8(s++),q=t.getUint8(s++);A.push({id:D,x:W,y:$,type:F,level:q>0?q:void 0})}const L=t.getUint8(s++),P=[];for(let _=0;_<L;_++){const{s:D,next:z}=te(t,s);s=z;const{s:W,next:$}=te(t,s);s=$;const F=t.getFloat32(s,!0);s+=4;const q=t.getFloat32(s,!0);s+=4;const oe=t.getUint8(s++),Ee=(oe&1)!==0,re=(oe&2)!==0,we=(oe&4)!==0,We=t.getUint8(s++),ce=[];for(let et=0;et<We;et++){const{s:Et,next:Ne}=te(t,s);s=Ne,ce.push(Et)}const Se=t.getFloat32(s,!0);s+=4;const Qe=t.getUint32(s,!0);s+=4,P.push({id:D,ownerId:W,x:F,y:q,hasAdoptionCenter:Ee,hasGravity:re,hasAdvertising:we,petsInside:ce,size:Se,totalAdoptions:Qe})}return{tick:i,matchEndAt:o,matchEndedEarly:a||void 0,winnerId:d||void 0,totalMatchAdoptions:l,scarcityLevel:m>0?m:void 0,matchDurationMs:b,players:h,pets:g,adoptionZones:T,pickups:A,shelters:P.length>0?P:void 0}}const Js="rescueworld_music",Vs="rescueworld_sfx";function Zs(e,t){try{const s=localStorage.getItem(e);if(s==="0"||s==="false")return!1;if(s==="1"||s==="true")return!0}catch{}return t}function Qs(e,t){try{localStorage.setItem(e,t?"1":"0")}catch{}}function gt(){return Zs(Js,!0)}function eo(e){Qs(Js,e),H&&(H.volume=e?1:0),!e&&H&&H.pause()}function to(){return Zs(Vs,!0)}function Go(e){Qs(Vs,e)}let zt=null;function Xo(){if(zt)return zt;try{zt=new(window.AudioContext||window.webkitAudioContext)}catch{return null}return zt}function X(e,t,s="sine",i=.3){if(!to())return;const o=Xo();if(o)try{const a=o.createOscillator(),d=o.createGain();a.connect(d),d.connect(o.destination),a.frequency.value=e,a.type=s,d.gain.setValueAtTime(i,o.currentTime),d.gain.exponentialRampToValueAtTime(.001,o.currentTime+t),a.start(o.currentTime),a.stop(o.currentTime+t)}catch{}}function ln(){X(523,.12,"sine",.25),setTimeout(()=>X(659,.1,"sine",.2),80)}function qo(){X(440,.08,"square",.2),setTimeout(()=>X(880,.08,"square",.15),60)}function Ko(){X(392,.1,"sine",.25),setTimeout(()=>X(523,.12,"sine",.22),70),setTimeout(()=>X(659,.15,"sine",.2),140)}function jo(){X(330,.06,"sine",.18)}function Jo(){X(523,.15,"sine",.25),setTimeout(()=>X(659,.15,"sine",.22),120),setTimeout(()=>X(784,.2,"sine",.2),240)}function Vo(){X(440,.08,"sine",.2),setTimeout(()=>X(554,.08,"sine",.18),80),setTimeout(()=>X(659,.12,"sine",.2),160)}function an(){X(220,.15,"sawtooth",.35),setTimeout(()=>X(180,.12,"sawtooth",.3),100),setTimeout(()=>X(220,.1,"sawtooth",.25),200)}let H=null;function Zo(){var i;const e=import.meta;let t=typeof((i=e.env)==null?void 0:i.BASE_URL)=="string"?e.env.BASE_URL:"";if(!t||t==="/"){const o=typeof window<"u"?window.location.pathname:"";if(o.includes("rescueworld"))t="/rescueworld/";else{const a=o.lastIndexOf("/");t=a<=0?"/":o.slice(0,a+1)}}return t.endsWith("/")?`${t}music.mp3`:`${t}/music.mp3`}function $t(){if(gt())try{if(!H){H=new Audio,H.loop=!0,H.volume=1,H.preload="auto",H.src=Zo();let t=!1;H.addEventListener("error",()=>{!H||t||(t=!0,H.src="/rescueworld/music.mp3",H.play().catch(()=>{}))}),H.load()}H.volume=gt()?1:0;const e=H.play();e&&typeof e.catch=="function"&&e.catch(()=>{})}catch{}}const as=new Image;as.src="/breeder-mill.png";let no=!1;as.onload=()=>{no=!0};const Qo=(()=>{const{protocol:e,host:t}=window.location;return`${e==="https:"?"wss:":"ws:"}//${t}/ws-signaling`})();let Ot=0,so=0;const Y={};let bt=!1,rn=0,cn=0,wn=0,Sn=0;const ei=15,xs=60;let y=null,R=null,c=null;const dn=new Map,fn=new Map,ti=100;let I=null,Mn=0,An=0,Is=0,ks=0,Pt=!1,en=!1,oo=0,Xn=0,Pn=0,Wt=null;const ni=200,M=document.getElementById("game"),n=M.getContext("2d"),ve=document.getElementById("minimap"),E=ve.getContext("2d"),si=document.getElementById("score"),oi=document.getElementById("carried"),Ls=document.getElementById("tag-cooldown"),ii=document.getElementById("timer"),li=document.getElementById("game-clock"),_e=document.getElementById("leaderboard"),se=document.getElementById("connection-overlay"),ai=document.getElementById("how-to-play"),ri=document.getElementById("settings-btn"),io=document.getElementById("settings-panel"),ct=document.getElementById("music-toggle"),qn=document.getElementById("sfx-toggle"),ci=document.getElementById("settings-close");document.getElementById("ping");const di=document.getElementById("switch-server"),fi=document.getElementById("switch-server-btn"),pe=document.getElementById("auth-area"),rs=document.getElementById("landing"),un=document.getElementById("game-wrap"),ui=document.getElementById("landing-play"),j=document.getElementById("landing-nick"),de=document.getElementById("nick-save-btn"),De=document.getElementById("nick-hint"),xt=document.getElementById("landing-music-toggle"),dt=document.getElementById("landing-profile-name"),ft=document.getElementById("landing-profile-avatar"),Rn=document.getElementById("landing-profile-actions"),On=document.getElementById("landing-auth-buttons"),qe=document.getElementById("referral-status"),Nn=document.getElementById("referral-link"),Kn=document.getElementById("referral-copy-btn"),tn=document.getElementById("referral-claim-btn"),cs=document.getElementById("cookie-banner"),mi=document.getElementById("cookie-accept"),yi=document.getElementById("cookie-essential"),kt=document.getElementById("fight-ally-overlay"),hi=document.getElementById("fight-ally-name"),gi=document.getElementById("fight-ally-fight"),pi=document.getElementById("fight-ally-ally"),Yt=document.getElementById("cpu-warning"),mn=document.getElementById("action-menu"),bi=document.getElementById("action-menu-close"),vi=document.getElementById("action-size-text"),Ei=document.getElementById("action-size-bar"),wi=document.getElementById("action-tokens-text"),Si=document.getElementById("action-tokens-bar"),Ue=document.getElementById("action-build-btn"),Cs=document.getElementById("action-build-shelter"),Ht=document.getElementById("action-adoption-center"),Gt=document.getElementById("action-gravity"),Xt=document.getElementById("action-advertising"),Ts=document.getElementById("action-van-speed"),Lt=document.getElementById("action-adoption-btn"),Ct=document.getElementById("action-gravity-btn"),Tt=document.getElementById("action-advertising-btn"),Bt=document.getElementById("action-van-speed-btn"),jn=document.getElementById("ground-btn"),nn=document.getElementById("port-btn"),Mt=document.getElementById("build-shelter-btn"),yn=document.getElementById("center-van-btn"),Rt=document.getElementById("center-shelter-btn"),xi=document.getElementById("game-tokens"),ot=document.getElementById("lobby-overlay"),Jn=document.getElementById("lobby-message"),$n=document.getElementById("lobby-player-list"),Dn=document.getElementById("lobby-countdown"),lt=document.getElementById("lobby-ready-btn"),Ii=document.getElementById("lobby-back-btn"),At=document.getElementById("lobby-gift-btn"),Vn=document.getElementById("breeder-minigame"),ki=document.getElementById("breeder-timer"),Li=document.getElementById("breeder-tokens"),Bs=document.getElementById("breeder-pets"),Fe=document.getElementById("breeder-foods"),lo=document.getElementById("breeder-result"),Ci=document.getElementById("breeder-result-title"),ao=document.getElementById("breeder-rewards"),Ti=document.getElementById("breeder-close-btn"),ro=document.getElementById("daily-gift-modal"),Bi=document.getElementById("daily-gift-close"),Un=document.getElementById("daily-gift-subtitle"),Ms=document.getElementById("daily-gift-grid"),Ye=document.getElementById("daily-gift-claim-btn"),He=document.getElementById("daily-gift-btn"),co=document.getElementById("leaderboard-modal"),Mi=document.getElementById("leaderboard-close"),As=document.getElementById("leaderboard-content"),qt=document.getElementById("leaderboard-my-rank"),Ai=document.getElementById("leaderboard-btn"),Pi=document.getElementById("equip-rt"),Ri=document.getElementById("equip-ports"),Oi=document.getElementById("equip-speed"),Ni=document.getElementById("equip-size"),It=document.getElementById("equip-note");let ke={storedRt:0,portCharges:0,speedBoosts:0,sizeBoosts:0,signedIn:!1};const p={active:!1,pets:[],selectedPetIndex:null,timeLeft:30,timerInterval:null,totalPets:0,rescuedCount:0,level:1,selectedIngredients:[]},fo={apple:5,carrot:8,chicken:15,seeds:5,water:20,bowl:20},$i={apple:["horse"],carrot:["horse","bird"],chicken:["dog","cat"],seeds:["bird"],water:[],bowl:[]},Di={2:[{ingredients:["chicken","carrot"],worksOn:["dog","cat"]},{ingredients:["seeds","apple"],worksOn:["bird"]},{ingredients:["apple","carrot"],worksOn:["horse"]}],3:[{ingredients:["water","chicken","carrot"],worksOn:["dog","cat"]},{ingredients:["water","seeds","apple"],worksOn:["bird"]},{ingredients:["water","apple","carrot"],worksOn:["horse"]}],4:[{ingredients:["bowl","water","chicken","carrot"],worksOn:["dog","cat"]},{ingredients:["bowl","water","seeds","apple"],worksOn:["bird"]},{ingredients:["bowl","water","apple","carrot"],worksOn:["horse"]}]};function Dt(e){return e<=2?1:e<=5?2:e<=9?3:4}const Ui={dog:"ðŸ•",cat:"ðŸ±",horse:"ðŸ´",bird:"ðŸ¦"},ds="cookieConsent",uo="rescueworld_mode",mo="rescueworld_ref",_i="rescueworld_skin_unlocked";let Ge=null;const Zn=new Set,hn=new Set;let Kt=0;const Ps=2e3,Rs=new Map,Nt=new Map,Qn=400,Os=new Map,sn=[],Ns=800,Fi={dog:"ðŸ•",cat:"ðŸˆ",horse:"ðŸ´",bird:"ðŸ¦"};let zi=0;function $s(e,t,s,i,o){const a=["dog","cat","horse","bird"],d=Date.now();for(let r=0;r<o;r++){const l=a[Math.floor(Math.random()*a.length)],m=r*100,b=(Math.random()-.5)*30,w=(Math.random()-.5)*30;sn.push({id:`adopt-${zi++}`,startTime:d+m,fromX:e+b,fromY:t+w,toX:s,toY:i,petType:l})}}let J="playing",_n=0,Wi=0,gn=!1;const yo="rescueworld_tokens",fs="rescueworld_color",ho="rescueworld_unlocked_colors",pn={size:50,speed:30,adoptSpeed:40},bn={preset:50,custom:200,gradient:500};let be="ffa";const ne={sizeBonus:0,speedBoost:!1,adoptSpeed:!1};let me=null,Q=!1,go=null,Yi=null;function he(){return parseInt(localStorage.getItem(yo)||"0",10)}function je(e){localStorage.setItem(yo,String(Math.max(0,e)))}function Oe(){const e=document.getElementById("landing-tokens");e&&(e.textContent=`Tokens: ${he()} RT`);const t=he();document.querySelectorAll(".landing-buy").forEach(s=>{const i=s.dataset.boost;if(!i||!(i in pn))return;const o=pn[i];s.disabled=t<o||i==="speed"&&ne.speedBoost||i==="adoptSpeed"&&ne.adoptSpeed})}function po(){return localStorage.getItem(fs)||"#7bed9f"}function pt(e){localStorage.setItem(fs,e),Q&&fetch("/auth/profile",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({shelterColor:e})}).catch(()=>{})}function xn(){try{const e=localStorage.getItem(ho);if(e)return JSON.parse(e)}catch{}return{preset:!1,custom:null,gradient:null}}function es(e){localStorage.setItem(ho,JSON.stringify(e))}function Ke(){const e=po(),t=xn(),s=he();document.querySelectorAll(".color-btn").forEach(o=>{const a=o.dataset.color;o.classList.toggle("selected",a===e)});const i=document.getElementById("preset-colors-row");i&&(i.style.display=t.preset?"flex":"none",i.querySelectorAll(".preset-color").forEach(o=>{const a=o.dataset.color;o.classList.toggle("selected",a===e)})),document.querySelectorAll(".color-buy").forEach(o=>{const a=o.dataset.color,d=bn[a],r=a==="preset"?t.preset:a==="custom"?!!t.custom:!!t.gradient;o.disabled=r||s<d,o.classList.toggle("unlocked",r),r&&(a==="preset"?o.textContent="Preset Colors Unlocked":a==="custom"?o.textContent="Custom Color: Click to use":a==="gradient"&&(o.textContent="Gradient: Click to use"))})}let Fn=null;function ye(e,t="info"){let s=document.getElementById("toast");s||(s=document.createElement("div"),s.id="toast",s.className="toast",document.body.appendChild(s)),s.textContent=e,s.classList.remove("toast-success","toast-error","toast-info"),s.classList.add(`toast-${t}`),t==="success"?s.style.background="linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)":t==="error"?s.style.background="linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)":s.style.background="linear-gradient(135deg, #3498db 0%, #2980b9 100%)",s.classList.add("show"),Fn&&clearTimeout(Fn),Fn=setTimeout(()=>{s.classList.remove("show")},3e3)}const on=[];let ge=null,zn=!1;function Hi(e){on.push(...e),bo()}function bo(){if(zn||on.length===0)return;const e=on.shift();zn=!0;const t=["rescued","shut down","destroyed","saved","stopped","is shutting down"],s=["arrived","appeared","failed","formed","expanding","breeding"],i=e.toLowerCase(),o=t.some(w=>i.includes(w)),a=s.some(w=>i.includes(w)),d=o&&!a,r=d?"rgba(46,204,113,":"rgba(255,107,107,",l=d?"rgba(46,204,113,0.8)":"rgba(255,107,107,0.8)",m=d?"âœ…":"âš ï¸";ge||(ge=document.createElement("div"),ge.id="announcement-bar",document.body.appendChild(ge)),ge.style.cssText=`
    position: fixed;
    top: 60px;
    left: 0;
    width: 100%;
    height: 40px;
    background: linear-gradient(90deg, ${r}0) 0%, ${r}0.9) 15%, ${r}0.9) 85%, ${r}0) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    z-index: 150;
    pointer-events: none;
  `;const b=document.createElement("div");if(b.style.cssText=`
    white-space: nowrap;
    font: bold 18px 'Rubik', sans-serif;
    color: #fff;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 10px ${l};
    animation: announcementScroll 9s linear forwards;
  `,b.textContent=`${m} ${e} ${m}`,!document.getElementById("announcement-keyframes")){const w=document.createElement("style");w.id="announcement-keyframes",w.textContent=`
      @keyframes announcementScroll {
        0% { transform: translateX(100vw); opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { transform: translateX(-100vw); opacity: 0; }
      }
    `,document.head.appendChild(w)}ge.style.display="flex",ge.innerHTML="",ge.appendChild(b),b.addEventListener("animationend",()=>{zn=!1,on.length===0&&ge&&(ge.style.display="none"),bo()})}function Gi(){const e=window.location.pathname;if(e.includes("rescueworld"))return"/rescueworld/";const t=e.lastIndexOf("/");return t<=0?"/":e.slice(0,t+1)}function Xi(){try{const e=new URL(window.location.href),t=e.searchParams.get("ref");t&&(localStorage.setItem(mo,t),e.searchParams.delete("ref"),window.history.replaceState({},document.title,e.toString()))}catch{}}function qi(){try{const e=localStorage.getItem(mo);return e&&e.length?e:null}catch{return null}}function it(e){const t=qi();return t?`${e}?ref=${encodeURIComponent(t)}`:e}function vo(e){const t=Gi();return`${window.location.origin}${t}?ref=${encodeURIComponent(e)}`}let ae=null;async function Eo(){if(!Q){ae=null;return}try{const e=await fetch("/referrals/me",{credentials:"include"});if(!e.ok){ae=null;return}ae=await e.json()}catch{ae=null}}function wo(){if(!Q||!ae){qe.textContent="Sign in to get your referral link.",Nn.classList.add("referral-hidden"),Kn.classList.add("referral-hidden"),tn.classList.add("referral-hidden");return}const e=vo(ae.referralCode);qe.textContent=`Referrals: ${ae.referralCount}/${ae.rewardThreshold} (OAuth signups)`,Nn.textContent=e,Nn.classList.remove("referral-hidden"),Kn.classList.remove("referral-hidden"),ae.rewardEligible&&!ae.rewardClaimed?tn.classList.remove("referral-hidden"):tn.classList.add("referral-hidden")}async function Ki(){try{const s=await(await fetch("/auth/me",{credentials:"include"})).json(),{displayName:i,signedIn:o,userId:a,shelterColor:d}=s,r=i??"";if(me=r||null,Q=o,go=a,Yi=d,o&&d&&localStorage.setItem(fs,d),o&&r)pe.innerHTML=`
        <span class="auth-profile">${vn(r)}</span>
        <a href="/auth/signout" class="auth-link">Sign out</a>
      `,dt.textContent=r,ft.textContent=r.charAt(0).toUpperCase(),Rn.innerHTML='<a href="/auth/signout" class="auth-link" style="font-size:12px">Sign out</a>',On.innerHTML=`<a href="${it("/auth/google")}" class="auth-link" style="display:inline-block">Sign in with Google</a>`,j&&(j.placeholder=r);else{const l=r?`${vn(r)}`:"Guest";pe.innerHTML=`
        <a href="${it("/auth/google")}" class="auth-link">Sign in with Google</a>
        <span class="auth-guest">${l}</span>
      `,dt.textContent=r||"Guest",ft.textContent=r?r.charAt(0).toUpperCase():"?",Rn.innerHTML="",On.innerHTML=`
        <a href="${it("/auth/google")}">Sign in with Google</a>
      `,j&&(j.placeholder=r||"Nickname")}j&&r&&(j.value=r)}catch{me=null,Q=!1,pe.innerHTML=`
      <a href="${it("/auth/google")}" class="auth-link">Sign in with Google</a>
      <span class="auth-guest">Guest</span>
    `,dt.textContent="Guest",ft.textContent="?",Rn.innerHTML="",On.innerHTML=`<a href="${it("/auth/google")}">Sign in with Google</a>`,j&&(j.placeholder="Nickname")}await Eo(),wo(),await Ao(),new URLSearchParams(window.location.search).get("registered")==="1"&&Q&&setTimeout(()=>{ye("Welcome! Registration gift: 50 RT + Day 1 gift claimed!","success"),window.history.replaceState({},"",window.location.pathname)},500)}async function So(){var t;const e=(t=j==null?void 0:j.value)==null?void 0:t.trim();if(!e||e.length<1){De&&(De.textContent="Enter a nickname first!");return}if(Q)try{const i=await(await fetch("/auth/profile",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({nickname:e})})).json();i.success&&(me=i.displayName,dt.textContent=i.displayName,ft.textContent=i.displayName.charAt(0).toUpperCase(),de&&(de.textContent="Saved!",de.classList.add("saved"),setTimeout(()=>{de.textContent="Save",de.classList.remove("saved")},2e3)),De&&(De.textContent=""))}catch{De&&(De.textContent="Failed to save")}else me=e,dt.textContent=e,ft.textContent=e.charAt(0).toUpperCase(),de&&(de.textContent="Saved!",de.classList.add("saved"),setTimeout(()=>{de.textContent="Save",de.classList.remove("saved")},2e3)),De&&(De.textContent="Sign in to save permanently")}de&&de.addEventListener("click",So);j&&j.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),So())});async function ji(){var s;const e=(s=j==null?void 0:j.value)==null?void 0:s.trim();if(e){if(Q&&e!==me)try{await fetch("/auth/profile",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({nickname:e})})}catch{}return me=e,e}if(me)return me;try{const o=await(await fetch("/auth/guest",{method:"POST",credentials:"include"})).json();if(o.displayName)return me=o.displayName,dt.textContent=o.displayName,ft.textContent=o.displayName.charAt(0).toUpperCase(),o.displayName}catch{}const t=`rescue${Date.now().toString(36)}`;return me=t,t}function vn(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function xo(){const e=window.innerWidth,t=window.innerHeight;M.width=e,M.height=t}function B(e,t){t?Ot|=e:Ot&=~e}let ts=!1;function vt(){const e=c==null?void 0:c.players.find(t=>t.id===R);return(e==null?void 0:e.eliminated)===!0}function Ji(){const e=vt();if(e&&!ts){const t=c==null?void 0:c.players.find(s=>s.id===R);t&&(Pe=t.x,Re=t.y)}ts=e}function Vi(e){const t=e.target;if(!(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable)){if(Y[e.code]=!0,p.active){e.preventDefault();return}if(vt()){e.preventDefault();return}(e.code==="KeyW"||e.code==="ArrowUp")&&B(Me,!0),(e.code==="KeyS"||e.code==="ArrowDown")&&B(Ae,!0),(e.code==="KeyA"||e.code==="ArrowLeft")&&B(Te,!0),(e.code==="KeyD"||e.code==="ArrowRight")&&B(Be,!0),e.preventDefault()}}function Zi(e){if(Y[e.code]=!1,p.active){e.preventDefault();return}if(vt()){e.preventDefault();return}(e.code==="KeyW"||e.code==="ArrowUp")&&B(Me,!1),(e.code==="KeyS"||e.code==="ArrowDown")&&B(Ae,!1),(e.code==="KeyA"||e.code==="ArrowLeft")&&B(Te,!1),(e.code==="KeyD"||e.code==="ArrowRight")&&B(Be,!1),e.preventDefault()}function Qi(){return!!(Y.KeyW||Y.KeyS||Y.KeyA||Y.KeyD||Y.ArrowUp||Y.ArrowDown||Y.ArrowLeft||Y.ArrowRight)}function el(){if(Qi())return;if(p.active){B(Te,!1),B(Be,!1),B(Me,!1),B(Ae,!1);return}if(!bt){B(Te,!1),B(Be,!1),B(Me,!1),B(Ae,!1);return}const e=wn-rn,t=Sn-cn,s=Math.hypot(e,t);if(s<ei){B(Te,!1),B(Be,!1),B(Me,!1),B(Ae,!1);return}const i=e/s,o=t/s;B(Te,i<-.3),B(Be,i>.3),B(Me,o<-.3),B(Ae,o>.3)}M.addEventListener("touchstart",e=>{e.preventDefault(),e.touches.length&&(bt=!0,rn=e.touches[0].clientX,cn=e.touches[0].clientY,wn=rn,Sn=cn)},{passive:!1});M.addEventListener("touchmove",e=>{e.preventDefault(),e.touches.length&&bt&&(wn=e.touches[0].clientX,Sn=e.touches[0].clientY)},{passive:!1});function Io(){if((y==null?void 0:y.readyState)===WebSocket.OPEN){const e=js(Ot,so++);y.send(e)}}M.addEventListener("touchend",e=>{e.preventDefault(),e.touches.length===0&&(bt=!1,B(Te,!1),B(Be,!1),B(Me,!1),B(Ae,!1),Io())},{passive:!1});M.addEventListener("touchcancel",e=>{e.preventDefault(),bt=!1,B(Te,!1),B(Be,!1),B(Me,!1),B(Ae,!1),Io()},{passive:!1});let us=!1,ns=0,ss=0;M.addEventListener("mousedown",e=>{e.preventDefault(),vt()&&(us=!0,ns=e.clientX,ss=e.clientY)});M.addEventListener("mousemove",e=>{if(e.preventDefault(),vt()&&us){const t=e.clientX-ns,s=e.clientY-ss;Pe-=t,Re-=s,Pe=Math.max(M.width/2,Math.min(G-M.width/2,Pe)),Re=Math.max(M.height/2,Math.min(Z-M.height/2,Re)),ns=e.clientX,ss=e.clientY}});M.addEventListener("mouseup",e=>{e.preventDefault(),us=!1});M.addEventListener("contextmenu",e=>{e.preventDefault()});M.addEventListener("click",e=>{if(!c||!R||!y||y.readyState!==WebSocket.OPEN)return;const t=M.getBoundingClientRect(),s=M.width/t.width,i=M.height/t.height,o=(e.clientX-t.left)*s,a=(e.clientY-t.top)*i,d=ko(),r=o+d.x,l=a+d.y;for(const m of c.players){if(m.id===R||m.eliminated)continue;const b=yt+m.size*ht;if(r>=m.x-b&&r<=m.x+b&&l>=m.y-b&&l<=m.y+b){hn.has(m.id)||(y.send(JSON.stringify({type:"allyRequest",targetId:m.id})),hn.add(m.id));break}}});window.addEventListener("keydown",Vi);window.addEventListener("keyup",Zi);let ze=!1;function In(e,t){const s=ve.getBoundingClientRect(),i=e-s.left,o=t-s.top,a=G/120,d=i*a,r=o*a,l=(I==null?void 0:I.x)??G/2,m=(I==null?void 0:I.y)??Z/2;Je=d-l,Ve=r-m}ve.addEventListener("mousedown",e=>{e.preventDefault(),ze=!0,In(e.clientX,e.clientY)});ve.addEventListener("mousemove",e=>{ze&&In(e.clientX,e.clientY)});ve.addEventListener("mouseup",()=>{ze=!1});ve.addEventListener("mouseleave",()=>{ze=!1});ve.addEventListener("touchstart",e=>{e.preventDefault(),ze=!0,e.touches.length>0&&In(e.touches[0].clientX,e.touches[0].clientY)},{passive:!1});ve.addEventListener("touchmove",e=>{ze&&e.touches.length>0&&(e.preventDefault(),In(e.touches[0].clientX,e.touches[0].clientY))},{passive:!1});ve.addEventListener("touchend",()=>{ze=!1});ve.addEventListener("touchcancel",()=>{ze=!1});let xe=null,Ie=null;const Ds=.22;let Je=0,Ve=0,Pe=G/2,Re=Z/2;const jt=15;let Le=null,Ce=null;const Us=.28;function ko(){const e=M.width,t=M.height,s=c==null?void 0:c.players.find(b=>b.id===R);if((s==null?void 0:s.eliminated)===!0){const b=Math.max(0,Math.min(G-e,Pe-e/2)),w=Math.max(0,Math.min(Z-t,Re-t/2));return{x:b,y:w,w:e,h:t}}let o=(I==null?void 0:I.x)??G/2,a=(I==null?void 0:I.y)??Z/2;(!Number.isFinite(o)||!Number.isFinite(a))&&(o=G/2,a=Z/2);let d=o-e/2+Je,r=a-t/2+Ve;if(d=Math.max(0,Math.min(G-e,d)),r=Math.max(0,Math.min(Z-t,r)),I==null)return xe=null,Ie=null,{x:d,y:r,w:e,h:t};xe==null||Ie==null||!Number.isFinite(xe)||!Number.isFinite(Ie)?(xe=d,Ie=r):(xe+=(d-xe)*Ds,Ie+=(r-Ie)*Ds);let l=xe,m=Ie;return(!Number.isFinite(l)||!Number.isFinite(m))&&(l=d,m=r,xe=l,Ie=m),l=Math.max(0,Math.min(G-e,l)),m=Math.max(0,Math.min(Z-t,m)),{x:l,y:m,w:e,h:t}}const tl=30;function nl(e,t,s){let i=0,o=0;t&Te&&(i-=1),t&Be&&(i+=1),t&Me&&(o-=1),t&Ae&&(o+=1);let a=0,d=0;if(i!==0||o!==0){const b=Math.hypot(i,o)||1,h=((e.speedBoostUntil??0)>0?vs*Fo:vs)*s;a=i/b*h,d=o/b*h}const r=tl;let l=e.x+a,m=e.y+d;return l=Math.max(r,Math.min(G-r,l)),m=Math.max(r,Math.min(Z-r,m)),{...e,x:l,y:m,vx:a,vy:d,petsInside:[...e.petsInside],speedBoostUntil:e.speedBoostUntil??0}}const _s=1e4;function ms(e){se.classList.remove("hidden"),se.innerHTML=`
    <h2>Could not connect</h2>
    <p class="error">${e}</p>
    <p>The game server is not running or not reachable.</p>
    <p><strong>To start the game:</strong></p>
    <p>From the project root folder, run: <code>npm run dev</code></p>
    <p>That starts both the server (ports 4000, 4001) and the client. Wait a few seconds, then refresh this page.</p>
    <p>Or run in two terminals: first <code>npm run dev:server</code>, then <code>npm run dev:client</code>.</p>
  `}async function ys(e){Wt&&(clearInterval(Wt),Wt=null),di.classList.add("hidden");const t=d=>/^wss?:\/\/localhost(\b|:|\/|$)/i.test(d)||/^wss?:\/\/127\.0\.0\.1(\b|:|\/|$)/i.test(d),s=()=>{const{protocol:d,host:r}=window.location;return`${d==="https:"?"wss:":"ws:"}//${r}/ws-game`};let i=t(window.location.href)?"ws://localhost:4001":s();const o=new WebSocket(Qo);await new Promise((d,r)=>{const l=setTimeout(()=>{o.close(),r(new Error("Connection timeout. Is the server running? Run: npm run dev"))},_s);o.onopen=()=>{o.send(JSON.stringify({type:"join",latency:e==null?void 0:e.latency,mode:(e==null?void 0:e.mode)??"ffa"}))},o.onmessage=m=>{try{const b=JSON.parse(m.data);b.type==="joined"&&b.gameUrl&&(clearTimeout(l),i=b.gameUrl,!t(window.location.href)&&t(i)&&(i=s()),d())}catch{}},o.onerror=()=>{clearTimeout(l),r(new Error("WebSocket error. Server not running?"))},o.onclose=()=>{clearTimeout(l),o.readyState!==WebSocket.OPEN&&r(new Error("Signaling connection closed. Run: npm run dev"))}});const a=new WebSocket(i);a.binaryType="arraybuffer",a.onopen=async()=>{y=a;const d=await ji(),r=await Cl(),l=r.rt,m=r.ports;l>0&&ye(`Starting with ${l} RT from chest!`,"success"),y.send(JSON.stringify({type:"mode",mode:(e==null?void 0:e.mode)??"ffa",displayName:d,startingRT:l,startingPorts:m,userId:go})),(ne.sizeBonus>0||ne.speedBoost||ne.adoptSpeed)&&(y.send(JSON.stringify({type:"startingBoosts",sizeBonus:ne.sizeBonus,speedBoost:ne.speedBoost,adoptSpeed:ne.adoptSpeed})),ne.sizeBonus=0,ne.speedBoost=!1,ne.adoptSpeed=!1);const b=po();y.send(JSON.stringify({type:"setColor",color:b})),(e==null?void 0:e.mode)==="solo"&&Ys&&y.send(JSON.stringify({type:"setCpuBreederBehavior",canShutdown:Ys.checked}))},a.onmessage=d=>{var l,m,b,w;if(typeof d.data=="string"){try{const h=JSON.parse(d.data);if(h.type==="welcome"&&h.playerId&&(R=h.playerId,Vo()),h.type==="matchState"&&typeof h.phase=="string"&&(J=h.phase,_n=typeof h.countdownRemainingSec=="number"?h.countdownRemainingSec:0,Wi=typeof h.readyCount=="number"?h.readyCount:0,Array.isArray(h.players)&&h.players.length>0?$n.innerHTML=h.players.map(f=>`<div class="lobby-player">${vn(f.displayName)}</div>`).join(""):$n.innerHTML="",J==="lobby"?be==="solo"?ot.classList.add("hidden"):(ot.classList.remove("hidden"),Jn.textContent="Waiting for another playerâ€¦",Dn.classList.add("hidden"),lt.classList.add("hidden")):J==="countdown"?(ot.classList.remove("hidden"),Jn.textContent="Match starting soon",Dn.classList.remove("hidden"),Dn.textContent=_n>0?`Starting in ${_n}sâ€¦`:"Startingâ€¦",lt.classList.remove("hidden"),gn?lt.textContent="Ready!":lt.textContent="Ready"):(ot.classList.add("hidden"),$n.innerHTML="")),h.type==="pong"&&typeof h.ts=="number"&&(Xn=Math.round(Date.now()-h.ts),Xn>ni?Pn=Pn||Date.now():Pn=0),h.type==="groundFailed"&&typeof h.reason=="string"&&ye(h.reason),h.type==="breederStart"&&typeof h.petCount=="number"){const f=typeof h.level=="number"?h.level:1;hl(h.petCount,f)}if(h.type==="breederRewards"){const f=typeof h.tokenBonus=="number"?h.tokenBonus:0,g=Array.isArray(h.rewards)?h.rewards:[];vl(f,g)}h.type==="announcement"&&Array.isArray(h.messages)&&Hi(h.messages)}catch{}return}const r=d.data;if(!(r.byteLength<1)&&new DataView(r).getUint8(0)===Ks){const h=Ho(r);c=h,J!=="playing"&&(J="playing",ot.classList.add("hidden"));for(const g of h.players){const k=((l=dn.get(g.id))==null?void 0:l.next)??g;dn.set(g.id,{prev:k,next:{...g},t:0});const T=Os.get(g.id);if(T){const N=g.x-T.x,A=g.y-T.y;Math.hypot(N,A)>200&&!Nt.has(g.id)&&Nt.set(g.id,{startTime:Date.now(),fromX:T.x,fromY:T.y,toX:g.x,toY:g.y,phase:"fadeIn"})}Os.set(g.id,{x:g.x,y:g.y})}for(const g of h.pets){const k=((m=fn.get(g.id))==null?void 0:m.next)??g;fn.set(g.id,{prev:k,next:{...g},t:0})}const f=h.players.find(g=>g.id===R);if(f){const g=!!f.shelterId;if(f.size>Mn&&!g&&f.size<50?(oo=Date.now()+1500,ln()):f.size>Mn&&ln(),(f.speedBoostUntil??0)>ks&&qo(),ks=f.speedBoostUntil??0,f.totalAdoptions>An){Ko();const A=f.totalAdoptions-An,L=(b=c==null?void 0:c.shelters)==null?void 0:b.find(P=>P.ownerId===R);if(L!=null&&L.hasAdoptionCenter)$s(L.x,L.y,L.x,L.y-100,A);else{const P=(w=c==null?void 0:c.adoptionZones)==null?void 0:w[0];P&&$s(f.x,f.y,P.x,P.y,A)}}An=f.totalAdoptions,f.petsInside.length>Is&&jo(),Is=f.petsInside.length,Mn=f.size;const k=(I==null?void 0:I.x)??f.x,T=(I==null?void 0:I.y)??f.y;I={...f,petsInside:[...f.petsInside]},f.inputSeq,Math.hypot(f.x-k,f.y-T)>300&&(xe=null,Ie=null,Je=0,Ve=0,Le=f.x,Ce=f.y)}}},a.onclose=()=>{y=null,R=null,c=null,I=null,J="playing",hn.clear(),gn=!1},await new Promise((d,r)=>{const l=Date.now()+_s,m=()=>{(y==null?void 0:y.readyState)===WebSocket.OPEN?d():Date.now()>l?r(new Error("Game server connection timeout")):setTimeout(m,50)};m()}),se.classList.add("hidden"),ai.classList.add("hidden"),$t(),Wt=setInterval(()=>{(y==null?void 0:y.readyState)===WebSocket.OPEN&&y.send(JSON.stringify({type:"ping",ts:Date.now()}))},2e3)}let Jt=0,Fs=0;function hs(e){var d,r;Jt||(Jt=e);const t=Math.min((e-Jt)/1e3,.1);Jt=e,el(),Ji(),vt()&&((Y.KeyW||Y.ArrowUp)&&(Re-=jt),(Y.KeyS||Y.ArrowDown)&&(Re+=jt),(Y.KeyA||Y.ArrowLeft)&&(Pe-=jt),(Y.KeyD||Y.ArrowRight)&&(Pe+=jt),Pe=Math.max(M.width/2,Math.min(G-M.width/2,Pe)),Re=Math.max(M.height/2,Math.min(Z-M.height/2,Re)));const s=c!=null&&c.matchEndAt>0&&c.tick>=c.matchEndAt,i=c==null?void 0:c.players.find(l=>l.id===R),o=J==="playing"&&!s&&!(i!=null&&i.eliminated);if(o&&(y==null?void 0:y.readyState)===WebSocket.OPEN&&e-Fs>=_o){Fs=e;const l=js(Ot,so++);y.send(l)}if(o&&I&&R){I.x,I.y,I=nl(I,Ot,t);let l=I.x,m=I.y;(!Number.isFinite(l)||!Number.isFinite(m))&&(l=G/2,m=Z/2),Le==null||Ce==null?(Le=l,Ce=m):(Le+=(l-Le)*Us,Ce+=(m-Ce)*Us),(!Number.isFinite(Le)||!Number.isFinite(Ce))&&(Le=l,Ce=m);let b=null,w=!1;if(c){const h=c.players.find(g=>g.id===R),f=h!=null&&h.shelterId?(d=c.shelters)==null?void 0:d.find(g=>g.id===h.shelterId):null;if(f){const g=yt+f.size*ht;for(const k of c.players){if(k.id===R)continue;const T=k.shelterId?(r=c.shelters)==null?void 0:r.find(L=>L.id===k.shelterId):null;if(!T)continue;const N=yt+T.size*ht;if(Math.abs(f.x-T.x)<=g+N&&Math.abs(f.y-T.y)<=g+N&&!(f.size<ws||T.size<ws)){if(k.id.startsWith("cpu-")){w=!0;continue}if(!Zn.has(k.id)){b=k.id;break}}}}}if(b){const h=c.players.find(g=>g.id===b);Ge=b,hi.textContent=(h==null?void 0:h.displayName)??b;const f=kt.classList.contains("hidden");kt.classList.remove("hidden"),f&&Date.now()-Kt>Ps&&(Kt=Date.now(),an())}else kt.classList.add("hidden"),Ge=null,Zn.clear();if(w){const h=Yt.classList.contains("hidden");Yt.classList.remove("hidden"),h&&Date.now()-Kt>Ps&&(Kt=Date.now(),an())}else Yt.classList.add("hidden")}else Le=null,Ce=null,kt.classList.add("hidden"),Ge=null,Yt.classList.add("hidden");const a=t*(1e3/ti);for(const l of dn.values())l.t=Math.min(1,l.t+a);for(const l of fn.values())l.t=Math.min(1,l.t+a);ml(),requestAnimationFrame(hs)}function at(e,t,s){return e+(t-e)*s}function sl(e){const t=dn.get(e);if(!t)return null;const s=t.t;return{...t.next,x:at(t.prev.x,t.next.x,s),y:at(t.prev.y,t.next.y,s),vx:at(t.prev.vx,t.next.vx,s),vy:at(t.prev.vy,t.next.vy,s)}}function ol(e){const t=fn.get(e);if(!t)return null;const s=t.t;return{...t.next,x:at(t.prev.x,t.next.x,s),y:at(t.prev.y,t.next.y,s)}}const le=36,Vt=1.8;function gs(e){let t=0;for(let i=0;i<e.length;i++)t=t*31+e.charCodeAt(i)>>>0;return`hsl(${t%360}, 72%, 58%)`}function il(e){const t=le*2,s=Math.floor((e.x-t)/le)*le,i=Math.floor((e.y-t)/le)*le,o=Math.ceil((e.x+e.w+t)/le)*le,a=Math.ceil((e.y+e.h+t)/le)*le;n.fillStyle="#3d6b3d",n.fillRect(e.x,e.y,e.w,e.h),n.fillStyle="rgba(255,255,255,0.35)";for(let d=i;d<=a;d+=le)for(let r=s;r<=o;r+=le)n.fillRect(r-Vt,d-Vt,Vt*2,Vt*2)}function ll(e){const t=e.x,s=e.y,i=e.radius;n.save(),n.strokeStyle="rgba(123, 237, 159, 0.6)",n.lineWidth=4,n.setLineDash([8,8]),n.strokeRect(t-i,s-i,i*2,i*2),n.setLineDash([]),n.fillStyle="rgba(74, 124, 89, 0.2)",n.fillRect(t-i,s-i,i*2,i*2),n.fillStyle="#7bed9f",n.font="bold 14px Rubik, sans-serif",n.textAlign="center",n.fillText("ADOPTION CENTER",t,s-i-8),n.fillText("Bring pets here to adopt out",t,s),n.restore()}function zs(e,t,s,i){n.save();const o=60,a=i?s:1-s,d=i?.5+s*.5:1+s*.5;n.translate(e,t),n.scale(d,d),n.beginPath(),n.arc(0,0,o,0,Math.PI*2),n.strokeStyle=`rgba(200, 150, 255, ${a*.8})`,n.lineWidth=4,n.stroke();const r=n.createRadialGradient(0,0,0,0,0,o);r.addColorStop(0,`rgba(180, 120, 255, ${a*.6})`),r.addColorStop(.5,`rgba(140, 80, 220, ${a*.3})`),r.addColorStop(1,"rgba(100, 50, 180, 0)"),n.fillStyle=r,n.beginPath(),n.arc(0,0,o,0,Math.PI*2),n.fill();const l=8,m=Date.now()/100;for(let b=0;b<l;b++){const w=b/l*Math.PI*2+m*.5,h=o*.6*(.8+Math.sin(m+b)*.2),f=Math.cos(w)*h,g=Math.sin(w)*h,k=3+Math.sin(m*2+b)*1.5;n.beginPath(),n.arc(f,g,k,0,Math.PI*2),n.fillStyle=`rgba(255, 255, 255, ${a*.9})`,n.fill()}n.restore()}function Ws(e,t,s,i,o="large"){n.save();const a=o==="small"?.5:1,d=o==="small"?.6:1,r=e-i*(s+8*a),l=t,m=Date.now()/100,b=Math.sin(m*3)*.3+.7,w=Math.cos(m*4)*.2+.8,h=25*a,f=n.createRadialGradient(r,l,0,r,l,h);f.addColorStop(0,`rgba(255, 200, 50, ${.6*b*d})`),f.addColorStop(.5,`rgba(255, 100, 20, ${.4*b*d})`),f.addColorStop(1,"rgba(255, 50, 0, 0)"),n.fillStyle=f,n.beginPath(),n.arc(r,l,h,0,Math.PI*2),n.fill();const g=18*a,k=10*a,T=g+Math.sin(m*5)*4*a,N=k+Math.cos(m*6)*2*a;n.beginPath(),n.moveTo(r+i*5,l-N/2),n.quadraticCurveTo(r-i*T*.6,l-N*.3*w,r-i*T,l),n.quadraticCurveTo(r-i*T*.6,l+N*.3*w,r+i*5,l+N/2),n.closePath();const A=n.createLinearGradient(r+i*5,l,r-i*T,l);A.addColorStop(0,"#FFD700"),A.addColorStop(.3,"#FF8C00"),A.addColorStop(.7,"#FF4500"),A.addColorStop(1,"rgba(255, 69, 0, 0.3)"),n.fillStyle=A,n.fill();const L=T*.6,P=N*.5;n.beginPath(),n.moveTo(r+i*5,l-P/2),n.quadraticCurveTo(r-i*L*.5,l-P*.2,r-i*L,l),n.quadraticCurveTo(r-i*L*.5,l+P*.2,r+i*5,l+P/2),n.closePath(),n.fillStyle="#FFFF80",n.fill(),n.restore()}function al(e,t){const o=e.x,a=e.y,d=Nt.get(e.id);let r=1;if(d){const re=Date.now()-d.startTime;d.phase==="fadeIn"&&(r=Math.min(1,re/Qn),re>=Qn&&(Nt.delete(e.id),r=1))}Math.abs(e.vx)>.01&&Rs.set(e.id,e.vx>0?1:-1);const l=Rs.get(e.id)??1;n.save(),n.globalAlpha=r,n.shadowColor="rgba(0,0,0,0.4)",n.shadowBlur=10;const m=(c==null?void 0:c.tick)??0,b=(e.speedBoostUntil??0)>m,w=!!e.vanSpeedUpgrade;e.eliminated||(b?Ws(o,a,50,l,"large"):w&&Ws(o,a,50,l,"small"));let h,f=t?"#7bed9f":gs(e.id);if(e.eliminated)h="rgba(100,100,100,0.5)",f="#666";else if(e.shelterColor)if(e.shelterColor.startsWith("gradient:")){const re=e.shelterColor.split(":"),we=re[1]||"#ff5500",We=re[2]||"#00aaff",ce=n.createLinearGradient(o-50,a-50*.6,o+50,a+50*.6);ce.addColorStop(0,we),ce.addColorStop(1,We),h=ce,f=we}else h=e.shelterColor,f=e.shelterColor;else h=f;const g=50*2,k=50*1.2,T=o-50,N=a-k*.5,A=Math.min(12,50*.3),L=Math.min(10,50*.25);n.translate(o,a),l<0&&n.scale(-1,1),n.fillStyle=h,n.beginPath(),n.roundRect(-50,-k*.5,g,k,A),n.fill();const P=g*.3;n.fillStyle="rgba(0,0,0,0.15)",n.beginPath(),n.roundRect(-50+g-P,-k*.5,P,k,[0,A,A,0]),n.fill();const _=4,D=P-_*2,z=k*.4;n.fillStyle="rgba(135,206,250,0.7)",n.beginPath(),n.roundRect(-50+g-P+_,-k*.5+_,D,z,4),n.fill();const W=!t&&hn.has(e.id);W?(n.strokeStyle="#7bed9f",n.lineWidth=3,n.setLineDash([6,4])):(n.strokeStyle=t?"rgba(255,255,255,0.9)":"rgba(255,255,255,0.5)",n.lineWidth=t?3:2),n.beginPath(),n.roundRect(-50,-k*.5,g,k,A),n.stroke(),n.setLineDash([]),l<0&&n.scale(-1,1),n.translate(-o,-a),n.fillStyle="#333";const $=N+k+L*.3,F=T+g*.2,q=T+g*.7;n.beginPath(),n.arc(F,$,L,0,Math.PI*2),n.fill(),n.beginPath(),n.arc(q,$,L,0,Math.PI*2),n.fill(),n.fillStyle="#888",n.beginPath(),n.arc(F,$,L*.4,0,Math.PI*2),n.fill(),n.beginPath(),n.arc(q,$,L*.4,0,Math.PI*2),n.fill(),n.fillStyle="#2d2d2d",n.font="bold 12px Rubik, sans-serif",n.textAlign="center";const oe=t?"You":e.displayName??e.id;n.fillText(oe,o,N-6),W&&(n.fillStyle="#7bed9f",n.fillText("ðŸ¤",o+50+10,N+10),n.fillStyle="#2d2d2d"),e.eliminated&&(n.font="18px sans-serif",n.fillText("ðŸ‘»",o-50*.3,a),n.font="bold 12px Rubik, sans-serif");const Ee=Math.min(Math.floor(e.size),Gs);n.fillStyle="#fff",n.fillText(`Pets: ${e.petsInside.length}/${Ee}`,o,a+4),n.restore()}function rl(e,t,s){const i=e.x,o=e.y,a=yt+e.size*ht,d=Math.max(40,a);n.save(),n.shadowColor="rgba(0,0,0,0.4)",n.shadowBlur=12;let r;if(s!=null&&s.startsWith("gradient:")){const D=s.split(":"),z=D[1]||"#7bed9f",W=D[2]||"#3cb371",$=n.createLinearGradient(i-d,o,i+d,o);$.addColorStop(0,z),$.addColorStop(1,W),r=$}else s?r=s:r=t?"#7bed9f":gs(e.ownerId);n.fillStyle=r;const l=d*2,m=d*1.4,b=i-d,w=o-m*.4;n.beginPath(),n.roundRect(b,w,l,m,6),n.fill(),n.fillStyle="#8B4513",n.beginPath(),n.moveTo(b-10,w),n.lineTo(i,w-d*.5),n.lineTo(b+l+10,w),n.closePath(),n.fill(),n.strokeStyle="#654321",n.lineWidth=2,n.stroke();const h=l*.2,f=m*.5;n.fillStyle="#654321",n.fillRect(i-h/2,w+m-f,h,f);const g=12,k=4,T=Math.floor((l-40)/(g+k)),N=Math.min(e.petsInside.length+2,T*2);for(let D=0;D<N;D++){const z=Math.floor(D/T),W=D%T,$=b+20+W*(g+k),F=w+15+z*(g+k),q=D<e.petsInside.length;n.fillStyle=q?"#c9a86c":"#aaa",n.fillRect($,F,g,g),n.strokeStyle="#666",n.lineWidth=1,n.strokeRect($,F,g,g)}n.setLineDash([5,5]),n.strokeStyle=t?"#7bed9f":"rgba(255,255,255,0.5)",n.lineWidth=2;const A=15;n.strokeRect(b-A,w-d*.5-A,l+A*2,m+d*.5+A*2),n.setLineDash([]);const L=w-d*.5-25;let P=i-30;n.font="14px sans-serif",n.textAlign="center",e.hasAdoptionCenter&&(n.fillText("ðŸ¾",P,L),P+=20),e.hasGravity&&(n.fillText("ðŸ§²",P,L),P+=20),e.hasAdvertising&&(n.fillText("ðŸ“¢",P,L),P+=20),n.fillStyle="#333",n.font="bold 11px Rubik, sans-serif",n.textAlign="center";const _=t?"Your Shelter":"Shelter";n.fillText(_,i,w-d*.5-8),n.fillStyle="#fff",n.font="10px Rubik, sans-serif",n.fillText(`Pets: ${e.petsInside.length}`,i,w+m+12),n.fillStyle="#7bed9f",n.fillText(`Adoptions: ${e.totalAdoptions}`,i,w+m+24),n.restore()}function cl(e){const t=e.x,s=e.y,i=80+e.size*.8;n.save();const o=.5+.5*Math.sin(Date.now()/200);if(n.shadowColor=`rgba(255, 0, 0, ${.4+o*.3})`,n.shadowBlur=20+o*10,no){const a=i*1.5,d=i*1.2;n.drawImage(as,t-a/2,s-d/2,a,d)}else n.fillStyle="#4a1a1a",n.beginPath(),n.roundRect(t-i/2,s-i/2.5,i,i*.8,6),n.fill(),n.strokeStyle=`rgba(255, 68, 68, ${.6+o*.4})`,n.lineWidth=3,n.stroke();n.shadowBlur=0,n.fillStyle="#ff4444",n.font="bold 12px Rubik, sans-serif",n.textAlign="center",n.textBaseline="bottom",n.fillText(`Breeder Mill Lv${e.level}`,t,s-i/2-5),n.fillStyle="#ffaa00",n.font="10px Rubik, sans-serif",n.textBaseline="top",n.fillText("Spawning wild strays!",t,s+i/2.5+5),n.restore()}function dl(e,t){n.save(),n.fillStyle="#c9a86c",n.beginPath(),n.arc(e,t,Es,0,Math.PI*2),n.fill(),n.strokeStyle="#8B4513",n.lineWidth=1.5,n.stroke(),n.font="10px Rubik, sans-serif",n.fillStyle="#333",n.textAlign="center",n.fillText("Stray",e,t+Es+10),n.restore()}function fl(e,t,s=1){n.save(),n.translate(e,t),n.beginPath(),n.arc(0,0,31,0,Math.PI*2),n.fillStyle="#5a4a3a",n.fill(),n.fillStyle="#8B4513",n.strokeStyle="#5a3810",n.lineWidth=1;for(let N=0;N<12;N++){const A=N/12*Math.PI*2,L=Math.cos(A)*33,P=Math.sin(A)*33;n.save(),n.translate(L,P),n.rotate(A+Math.PI/2),n.beginPath(),n.moveTo(-5/2,18/2),n.lineTo(-5/2,-18/2+3),n.lineTo(0,-18/2-3),n.lineTo(5/2,-18/2+3),n.lineTo(5/2,18/2),n.closePath(),n.fill(),n.stroke(),n.restore()}n.beginPath(),n.moveTo(-12,8),n.lineTo(0,-10),n.lineTo(12,8),n.closePath(),n.fillStyle="#D2B48C",n.fill(),n.strokeStyle="#8B7355",n.lineWidth=1.5,n.stroke(),n.beginPath(),n.moveTo(-4,8),n.lineTo(0,2),n.lineTo(4,8),n.fillStyle="#4a3a2a",n.fill();const r=16,l=4,m=n.createRadialGradient(r,l,0,r,l,12);m.addColorStop(0,"rgba(255, 107, 53, 0.6)"),m.addColorStop(.5,"rgba(255, 165, 0, 0.3)"),m.addColorStop(1,"rgba(255, 69, 0, 0)"),n.beginPath(),n.arc(r,l,12,0,Math.PI*2),n.fillStyle=m,n.fill(),n.fillStyle="#5a4a3a",n.fillRect(r-6,l+2,12,3),n.fillRect(r-4,l+1,8,3),n.beginPath(),n.moveTo(r-4,l+2),n.quadraticCurveTo(r-2,l-6,r,l-8),n.quadraticCurveTo(r+2,l-6,r+4,l+2),n.fillStyle="#FF6B35",n.fill(),n.beginPath(),n.moveTo(r-2,l+1),n.quadraticCurveTo(r,l-4,r+2,l+1),n.fillStyle="#FFD700",n.fill(),n.restore();const b=e+35-10,w=t-35+5;n.fillStyle="#fff",n.beginPath(),n.roundRect(b-10,w-8,20,16,3),n.fill(),n.strokeStyle="#333",n.lineWidth=1,n.stroke(),n.fillStyle="#000",n.font="bold 11px sans-serif",n.textAlign="center",n.textBaseline="middle",n.fillText(`${s}`,b,w);const h=3+Math.min(2,Math.floor(s/2)),f=Math.min(h+Math.floor(s/2),8);let g=1,k=8;s>=10?(g=4,k=13):s>=6?(g=3,k=11):s>=3&&(g=2);const T=f*g*k;n.font="bold 10px Rubik, sans-serif",n.fillStyle="#ff6b6b",n.textAlign="center",n.textBaseline="alphabetic",n.fillText(`Lv${s} ~${T}RT`,e,t+35+12)}function ul(e){const t=Ss;if(n.save(),e.type===qs){fl(e.x,e.y,e.level??1),n.restore();return}let s="#7bed9f",i="#2d5a38",o="+Size";e.type===Wo?(s="#70a3ff",i="#2d4a6e",o="Speed"):e.type===Xs&&(s="#c77dff",i="#6a3d7a",o="Port"),n.fillStyle=s,n.fillRect(e.x-t,e.y-t,t*2,t*2),n.strokeStyle=i,n.lineWidth=2,n.strokeRect(e.x-t,e.y-t,t*2,t*2),n.fillStyle="#333",n.font="10px Rubik, sans-serif",n.textAlign="center",n.fillText(o,e.x,e.y+Ss+10),n.restore()}function ml(e){var t;try{const s=ko(),i=Number.isFinite(s.x)?Math.max(0,Math.min(G-s.w,s.x)):0,o=Number.isFinite(s.y)?Math.max(0,Math.min(Z-s.h,s.y)):0,a={x:i,y:o,w:s.w,h:s.h};if(n.save(),n.translate(-a.x,-a.y),il(a),c){for(const v of c.adoptionZones)ll(v);for(const v of c.pickups??[])ul(v);for(const v of c.shelters??[]){const u=v.ownerId===R,x=c.players.find(S=>S.id===v.ownerId),C=x==null?void 0:x.shelterColor;rl(v,u,C)}for(const v of c.breederShelters??[])cl(v)}for(const v of(c==null?void 0:c.pets)??[]){if(v.insideShelterId!==null)continue;const u=ol(v.id)??v;!Number.isFinite(u.x)||!Number.isFinite(u.y)||u.x===0&&u.y===0||dl(u.x,u.y)}const d=[...(c==null?void 0:c.players)??[]].sort((v,u)=>v.size-u.size);for(const v of d){const u=v.id===R;let x;if(u&&I){let C=Le??I.x,S=Ce??I.y;(!Number.isFinite(C)||!Number.isFinite(S))&&(C=I.x,S=I.y),(!Number.isFinite(C)||!Number.isFinite(S))&&(C=G/2,S=Z/2),x={...I,x:C,y:S}}else x=sl(v.id)??v;if(!(!Number.isFinite(x.x)||!Number.isFinite(x.y))&&(al(x,u),u&&oo>Date.now())){n.save(),n.setTransform(1,0,0,1,0,0);const C=M.width/2,S=M.height/2-60;n.fillStyle="#7bed9f",n.font="bold 28px Rubik, sans-serif",n.textAlign="center",n.fillText("+1 Size!",C,S),n.restore()}}const r=Date.now();for(let v=sn.length-1;v>=0;v--){const u=sn[v],x=r-u.startTime;if(x<0)continue;if(x>Ns){sn.splice(v,1);continue}const C=x/Ns,S=1-Math.pow(1-C,3),O=u.fromX+(u.toX-u.fromX)*S,ie=u.fromY+(u.toY-u.fromY)*S-Math.sin(C*Math.PI)*50,ee=C<.8?1:1-(C-.8)/.2;n.save(),n.globalAlpha=ee,n.font="bold 32px sans-serif",n.textAlign="center",n.textBaseline="middle",n.fillText(Fi[u.petType],O,ie),n.restore()}for(const[v,u]of Nt){const x=Date.now()-u.startTime,C=Math.min(1,x/Qn);u.phase==="fadeIn"&&(zs(u.toX,u.toY,C,!0),C<.5&&zs(u.fromX,u.fromY,C*2,!1))}n.restore();const l=120/G;E.fillStyle="#2d4a2d",E.fillRect(0,0,120,120);for(let v=0;v<=Z;v+=le*3)for(let u=0;u<=G;u+=le*3)E.fillStyle="rgba(255,255,255,0.15)",E.fillRect(u*l-.8,v*l-.8,1.6,1.6);if(c){for(const u of c.adoptionZones){const x=u.radius*l|0;E.fillStyle="rgba(123, 237, 159, 0.6)",E.fillRect(u.x*l-x,u.y*l-x,x*2,x*2)}for(const u of c.pets)u.insideShelterId===null&&(u.x===0&&u.y===0||(E.fillStyle="#c9a86c",E.fillRect(u.x*l-2,u.y*l-2,4,4)));for(const u of c.pickups??[]){const x=u.x*l,C=u.y*l;if(u.type===qs){const S=.5+.5*Math.sin(Date.now()/200),O=8+S*4;E.save(),E.shadowColor="#ff4444",E.shadowBlur=O,E.fillStyle="#8B4513",E.beginPath(),E.arc(x,C,4,0,Math.PI*2),E.fill(),E.strokeStyle=`rgba(255, 68, 68, ${.7+S*.3})`,E.lineWidth=2,E.stroke(),E.restore()}else E.fillStyle=u.type===zo?"#7bed9f":u.type===Xs?"#c77dff":"#70a3ff",E.fillRect(x-2,C-2,4,4)}for(const u of c.shelters??[]){const x=u.ownerId===R;E.fillStyle=x?"#e8d5b7":"#d4c4a8";const C=(yt+u.size*ht)*l,S=Math.max(4,C);if(E.fillRect(u.x*l-S,u.y*l-S,S*2,S*2),E.strokeStyle=x?"#7bed9f":"#8B4513",E.lineWidth=1,E.strokeRect(u.x*l-S,u.y*l-S,S*2,S*2),x){const O=u.x*l,ie=u.y*l;E.fillStyle="#7bed9f",E.beginPath(),E.moveTo(O,ie-S-4),E.lineTo(O-5,ie-S+1),E.lineTo(O+5,ie-S+1),E.closePath(),E.fill(),E.fillRect(O-3,ie-S+1,6,5)}}for(const u of c.breederShelters??[]){const x=u.x*l,C=u.y*l,S=Math.max(6,(40+u.size*.5)*l),O=.5+.5*Math.sin(Date.now()/200);E.save(),E.shadowColor="#ff4444",E.shadowBlur=5+O*5,E.fillStyle="#4a1a1a",E.fillRect(x-S,C-S,S*2,S*2),E.strokeStyle=`rgba(255, 68, 68, ${.7+O*.3})`,E.lineWidth=2,E.strokeRect(x-S,C-S,S*2,S*2),E.restore()}const v=[...c.players].sort((u,x)=>x.totalAdoptions-u.totalAdoptions);for(const u of c.players){let x=u.id===R?"#7bed9f":gs(u.id);u.shelterColor&&(u.shelterColor.startsWith("gradient:")?x=u.shelterColor.split(":")[1]||x:x=u.shelterColor),E.fillStyle=x;const S=50*l,O=v.indexOf(u),ie=O===0?1.5:O<=2?1.2:1,ee=Math.max(2,S)*ie;E.fillRect(u.x*l-ee,u.y*l-ee,ee*2,ee*2),O===0&&c.players.length>1&&(E.fillStyle="#ffd700",E.beginPath(),E.arc(u.x*l,u.y*l-ee-3,3,0,Math.PI*2),E.fill())}}const m=a.x*l,b=a.y*l,w=a.w*l,h=a.h*l;if(E.strokeStyle="rgba(255,255,255,0.6)",E.lineWidth=1.5,E.strokeRect(m,b,w,h),E.strokeStyle="rgba(255,255,255,0.2)",E.lineWidth=1,E.strokeRect(.5,.5,119,119),bt){const v=M.getBoundingClientRect(),u=M.width/v.width,x=M.height/v.height,C=(rn-v.left)*u,S=(cn-v.top)*x,O=(wn-v.left)*u,ie=(Sn-v.top)*x,ee=O-C,wt=ie-S,$e=Math.hypot(ee,wt),Ft=Math.min($e,xs*u),St=$e>0?C+ee/$e*Ft:C,Bn=$e>0?S+wt/$e*Ft:S;n.save(),n.globalAlpha=.3,n.strokeStyle="#fff",n.lineWidth=3,n.beginPath(),n.arc(C,S,xs*u,0,Math.PI*2),n.stroke(),n.fillStyle="rgba(255,255,255,0.1)",n.fill(),n.globalAlpha=.6,n.fillStyle="#7bed9f",n.beginPath(),n.arc(St,Bn,20*u,0,Math.PI*2),n.fill(),n.strokeStyle="#fff",n.lineWidth=2,n.stroke(),n.restore()}const f=(c==null?void 0:c.players.find(v=>v.id===R))??I,g=f?Math.floor(f.size):0,k=Math.min(g,Gs),T=(f==null?void 0:f.petsInside.length)??0,N=(c==null?void 0:c.pets.filter(v=>v.insideShelterId===null).length)??0;si.textContent=f!=null&&f.eliminated?"Observer Mode":`Size: ${g}`,oi.textContent=f!=null&&f.eliminated?"WASD to pan | Drag to move":`Pets: ${T}/${k}`;const A=!!(f!=null&&f.shelterId),L=!!(f!=null&&f.eliminated),P=(f==null?void 0:f.money)??0,_=f&&f.size>=50&&!A&&!L&&J==="playing";xi.textContent=`${P} RT`;const D=f&&!L&&J==="playing";D?(Mt.classList.remove("hidden"),Mt.disabled=!1,Mt.textContent="Menu [E]"):Mt.classList.add("hidden"),ut&&(D?Ze():(ut=!1,mn.classList.add("hidden"))),jn.classList.add("hidden");const z=(f==null?void 0:f.portCharges)??0;f&&z>0&&!L&&J==="playing"?(nn.textContent=`Port [P] (${z})`,nn.classList.remove("hidden")):nn.classList.add("hidden");const W=Math.abs(Je)>50||Math.abs(Ve)>50,$=f!=null&&f.shelterId?((t=c==null?void 0:c.shelters)==null?void 0:t.find(v=>v.id===f.shelterId))??null:null;f&&!L&&J==="playing"&&W?yn.classList.remove("hidden"):yn.classList.add("hidden"),f&&!L&&J==="playing"&&$&&Math.hypot($.x-((I==null?void 0:I.x)??0)-Je,$.y-((I==null?void 0:I.y)??0)-Ve)>100?Rt.classList.remove("hidden"):Rt.classList.add("hidden");const F=(c==null?void 0:c.tick)??0,q=Hs,oe=f&&(f.speedBoostUntil??0)>F?((f.speedBoostUntil-F)/q).toFixed(1):"";Ls&&(Ls.textContent=f?`Adoptions: ${f.totalAdoptions}  â€¢  Strays: ${N}${oe?`  â€¢  Speed: ${oe}s`:""}`:"");const Ee=(c==null?void 0:c.matchEndAt)??0,we=Math.max(0,Ee-F)/q,We=(c==null?void 0:c.shelters)??[],ce=G*Z,Se=We.reduce((v,u)=>!v||u.size>v.size?u:v,null),Qe=Se?yt+Se.size*ht:0,et=Math.PI*Qe*Qe,Et=ce>0?Math.floor(et/ce*100):0,Ne=c==null?void 0:c.players.find(v=>v.shelterId===(Se==null?void 0:Se.id)),kn=(Ne==null?void 0:Ne.displayName)??"None",tt=(c==null?void 0:c.scarcityLevel)??0,Ut=tt>0?` [Scarcity ${tt}]`:"";ii.textContent=J==="playing"?`Goal: 51% | ${kn}: ${Et}%${Ut}`:"";const Ln=(c==null?void 0:c.matchDurationMs)??0,nt=Math.floor(Ln/1e3),_t=Math.floor(nt/3600),Cn=Math.floor(nt%3600/60),Tn=nt%60;li.textContent=`${_t.toString().padStart(2,"0")}:${Cn.toString().padStart(2,"0")}:${Tn.toString().padStart(2,"0")}`;const ue=!!(f!=null&&f.eliminated);if((we<=0||ue)&&(c!=null&&c.players.length)){Pt||(Pt=!0,Jo()),_e.classList.add("show");const v=we<=0&&!(c!=null&&c.matchEndedEarly),u=[...c.players].sort((U,K)=>v?K.size-U.size||K.totalAdoptions-U.totalAdoptions:U.eliminated!==K.eliminated?(U.eliminated?1:0)-(K.eliminated?1:0):U.eliminated?U.totalAdoptions-K.totalAdoptions:K.size-U.size||K.totalAdoptions-U.totalAdoptions),x=u.find(U=>U.id===R),C=x&&!x.eliminated?Math.floor(x.size):0,S=[100,50,25],O=x?u.findIndex(U=>U.id===R)+1:0,ie=O>0&&O<=S.length&&!ue?S[O-1]:0,ee=ue?0:C+ie,wt=Pt&&!en?he()+ee:he();en||(je(wt),en=!0,Tl(ee,0,O===1));const $e=O===1?"Win bonus":O===2?"2nd place":O===3?"3rd place":O>0?`${O}th place`:"",Ft=ee>0?`<br><br><strong>Total: ${wt.toLocaleString()} RT</strong>${$e?`<br>${$e}: +${ie} RT`:""}`:ue?`<br><br><strong>Total: ${he().toLocaleString()} RT</strong>`:"";let St="Match over";if(ue)St="You were consumed";else if(c&&c.winnerId){const U=c.winnerId,K=c.players.find(Uo=>Uo.id===U);St=`${(K==null?void 0:K.id)===R?"You":(K==null?void 0:K.displayName)??"Someone"} achieved 51% domination!`}const Bn=`
      <div class="match-ads">
        <div class="match-ad-slot">
          <h4>Sponsored</h4>
          <div id="match-ad-slot" class="match-ad-placeholder">Ad placeholder</div>
        </div>
        <div class="match-self-promo">
          <h4>Boost your shelter</h4>
          <p>Earn Rescue Tokens each match to buy boosts. Invite friends with your referral link. For every 5 confirmed signups, unlock a special shelter skin.</p>
        </div>
      </div>
    `,Do=U=>U.eliminated?"â€”":`${Math.floor(U.size)}`;_e.innerHTML=`<strong>${St}</strong><br><br>`+u.map((U,K)=>`${K+1}. ${U.id===R?"You":U.displayName??U.id}: size ${Do(U)} (${U.totalAdoptions} adoptions)`).join("<br>")+Ft+Bn+'<button type="button" id="play-again-btn" class="fight-ally-btn ally-btn" style="margin-right:8px">Play again</button><button type="button" id="lobby-btn" class="fight-ally-btn fight-btn">Back to lobby</button>'}else _e.classList.remove("show")}catch(s){console.error("Render error:",s),n.save(),n.setTransform(1,0,0,1,0,0),n.fillStyle="#3d6b3d",n.fillRect(0,0,M.width,M.height),n.restore()}}let Wn=!1;function ps(e){Wn||(Wn=!0,setTimeout(()=>{Wn=!1},500),e.id==="play-again-btn"?(y&&(y.close(),y=null),_e.classList.remove("show"),Pt=!1,ts=!1,c=null,se.classList.remove("hidden"),se.innerHTML=be==="ffa"?"<h2>Connectingâ€¦</h2><p>Joining FFA lobbyâ€¦</p>":"<h2>Connectingâ€¦</h2><p>Starting new match.</p>",pe.classList.add("hidden"),ys({mode:be}).then(()=>{se.classList.add("hidden"),se.innerHTML="",un.classList.add("visible"),requestAnimationFrame(hs)}).catch(t=>ms(t.message||"Connection failed."))):e.id==="lobby-btn"&&(y&&(y.close(),y=null),_e.classList.remove("show"),Pt=!1,en=!1,c=null,un.classList.remove("visible"),rs.classList.remove("hidden"),pe.classList.remove("hidden"),Oe(),bs()))}_e.addEventListener("click",e=>{const s=e.target.closest("button");s&&(e.preventDefault(),e.stopPropagation(),ps(s))},!0);_e.addEventListener("mouseup",e=>{const s=e.target.closest("button");s&&e.button===0&&(e.preventDefault(),e.stopPropagation(),ps(s))},!0);_e.addEventListener("touchend",e=>{const s=e.target.closest("button");s&&(e.preventDefault(),e.stopPropagation(),ps(s))},{passive:!1,capture:!0});lt.addEventListener("click",()=>{gn||J!=="countdown"||!y||y.readyState!==WebSocket.OPEN||(gn=!0,y.send(JSON.stringify({type:"ready"})),lt.textContent="Ready!",Jn.textContent="You're ready! Waiting for other player(s)â€¦")});Ii.addEventListener("click",()=>{y&&(y.close(),y=null),ot.classList.add("hidden"),un.classList.remove("visible"),rs.classList.remove("hidden"),pe.classList.remove("hidden"),Oe(),bs()});function Lo(e){!Ge||!y||y.readyState!==WebSocket.OPEN||(y.send(JSON.stringify({type:"fightAlly",targetId:Ge,choice:e})),Zn.add(Ge),kt.classList.add("hidden"),Ge=null)}gi.addEventListener("click",()=>Lo("fight"));pi.addEventListener("click",()=>Lo("ally"));jn.addEventListener("click",()=>{!y||y.readyState!==WebSocket.OPEN||(y.send(JSON.stringify({type:"ground"})),jn.classList.add("hidden"))});nn.addEventListener("click",()=>{p.active||!y||y.readyState!==WebSocket.OPEN||y.send(JSON.stringify({type:"usePort"}))});yn.addEventListener("click",()=>{Je=0,Ve=0,yn.classList.add("hidden")});Rt.addEventListener("click",()=>{var s;const e=c==null?void 0:c.players.find(i=>i.id===R),t=e!=null&&e.shelterId?(s=c==null?void 0:c.shelters)==null?void 0:s.find(i=>i.id===e.shelterId):null;t&&I&&(Je=t.x-I.x,Ve=t.y-I.y),Rt.classList.add("hidden")});Mt.addEventListener("click",()=>{Co()});let ut=!1;function Co(){if(J!=="playing")return;const e=c==null?void 0:c.players.find(t=>t.id===R);!e||e.eliminated||(ut=!ut,ut?(mn.classList.remove("hidden"),Ze()):mn.classList.add("hidden"))}function yl(){var s;if(!c)return null;const e=c.players.find(i=>i.id===R);return e!=null&&e.shelterId?((s=c.shelters)==null?void 0:s.find(i=>i.id===e.shelterId))??null:null}function Ze(){const e=c==null?void 0:c.players.find(f=>f.id===R);if(!e)return;const t=Math.floor(e.size),s=e.money??0,i=!!e.shelterId,o=yl(),a=!!e.vanSpeedUpgrade;i?(Cs.classList.add("hidden"),Ht.classList.remove("hidden"),Gt.classList.remove("hidden"),Xt.classList.remove("hidden")):(Cs.classList.remove("hidden"),Ht.classList.add("hidden"),Gt.classList.add("hidden"),Xt.classList.add("hidden"));const d=Math.min(100,t/50*100),r=Math.min(100,s/250*100);vi.textContent=`${t}/50`,Ei.style.width=`${d}%`,wi.textContent=`${s}/250 RT`,Si.style.width=`${r}%`;const l=t>=50&&s>=250&&!i;if(Ue.disabled=!l,l)Ue.textContent="Build Shelter",Ue.classList.add("ready");else if(i)Ue.textContent="Already Built",Ue.classList.remove("ready");else{const f=[];t<50&&f.push(`Size ${t}/50`),s<250&&f.push(`${s}/250 RT`),Ue.textContent=`Need: ${f.join(" & ")}`,Ue.classList.remove("ready")}const m=i&&!(o!=null&&o.hasAdoptionCenter)&&s>=250,b=i&&!(o!=null&&o.hasGravity)&&s>=300,w=i&&!(o!=null&&o.hasAdvertising)&&s>=200,h=!a&&s>=150;Lt.disabled=!m,Lt.textContent=o!=null&&o.hasAdoptionCenter?"Owned":"Buy",m?Lt.classList.add("ready"):Lt.classList.remove("ready"),o!=null&&o.hasAdoptionCenter?Ht.classList.add("owned"):Ht.classList.remove("owned"),Ct.disabled=!b,Ct.textContent=o!=null&&o.hasGravity?"Owned":"Buy",b?Ct.classList.add("ready"):Ct.classList.remove("ready"),o!=null&&o.hasGravity?Gt.classList.add("owned"):Gt.classList.remove("owned"),Tt.disabled=!w,Tt.textContent=o!=null&&o.hasAdvertising?"Owned":"Buy",w?Tt.classList.add("ready"):Tt.classList.remove("ready"),o!=null&&o.hasAdvertising?Xt.classList.add("owned"):Xt.classList.remove("owned"),Bt.disabled=!h,Bt.textContent=a?"Owned":"Buy",h?Bt.classList.add("ready"):Bt.classList.remove("ready"),a?Ts.classList.add("owned"):Ts.classList.remove("owned")}document.addEventListener("keydown",e=>{if((e.key==="e"||e.key==="E")&&Co(),e.key==="p"||e.key==="P"){if(p.active)return;if(y&&y.readyState===WebSocket.OPEN){const t=c==null?void 0:c.players.find(s=>s.id===R);t&&(t.portCharges??0)>0&&!t.eliminated&&J==="playing"&&y.send(JSON.stringify({type:"usePort"}))}}});bi.addEventListener("click",()=>{ut=!1,mn.classList.add("hidden")});Ue.addEventListener("click",()=>{if(!y||y.readyState!==WebSocket.OPEN)return;const e=c==null?void 0:c.players.find(t=>t.id===R);!e||e.eliminated||e.shelterId||e.size<50||(e.money??0)<250||(y.send(JSON.stringify({type:"buildShelter"})),Ze())});Lt.addEventListener("click",()=>{!y||y.readyState!==WebSocket.OPEN||(y.send(JSON.stringify({type:"buyAdoptionCenter"})),Ze())});Ct.addEventListener("click",()=>{!y||y.readyState!==WebSocket.OPEN||(y.send(JSON.stringify({type:"buyGravity"})),Ze())});Tt.addEventListener("click",()=>{!y||y.readyState!==WebSocket.OPEN||(y.send(JSON.stringify({type:"buyAdvertising"})),Ze())});Bt.addEventListener("click",()=>{!y||y.readyState!==WebSocket.OPEN||(y.send(JSON.stringify({type:"buyVanSpeed"})),Ze())});ct.checked=gt();qn.checked=to();ct.addEventListener("change",()=>{eo(ct.checked),ct.checked&&$t()});qn.addEventListener("change",()=>Go(qn.checked));ri.addEventListener("click",()=>io.classList.toggle("hidden"));ci.addEventListener("click",()=>io.classList.add("hidden"));fi.addEventListener("click",()=>{y&&(y.close(),y=null),se.classList.remove("hidden"),se.innerHTML="<h2>Switching serverâ€¦</h2><p>Reconnecting to a closer server.</p>",pe.classList.add("hidden"),ys({latency:Xn,mode:be}).then(()=>{se.classList.add("hidden"),se.innerHTML=""}).catch(e=>{ms(e.message||"Switch failed."),pe.classList.remove("hidden")})});function bs(){document.querySelectorAll(".mode-option").forEach(e=>{e.dataset.mode===be?e.classList.add("selected"):e.classList.remove("selected")})}const Zt=localStorage.getItem(uo);(Zt==="ffa"||Zt==="teams"||Zt==="solo")&&(be=Zt);bs();const Yn=document.getElementById("solo-options"),Ys=document.getElementById("cpu-shutdown-breeders");function To(){Yn&&(be==="solo"?Yn.classList.remove("hidden"):Yn.classList.add("hidden"))}document.querySelectorAll(".mode-option").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".mode-option").forEach(t=>t.classList.remove("selected")),e.classList.add("selected"),be=e.dataset.mode,localStorage.setItem(uo,be),To()})});To();Kn.addEventListener("click",async()=>{if(!ae||!ae.referralCode)return;const e=vo(ae.referralCode);try{await navigator.clipboard.writeText(e),qe.textContent="Referral link copied."}catch{const t=document.createElement("input");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),qe.textContent="Referral link copied."}});tn.addEventListener("click",async()=>{try{const t=await(await fetch("/referrals/claim",{method:"POST",credentials:"include"})).json();if(t.ok){const s=typeof t.moneyBonus=="number"?t.moneyBonus:0;s>0&&je(he()+s),localStorage.setItem(_i,"1"),qe.textContent="Reward claimed. Special skin unlocked.",await Eo(),wo(),Oe()}else qe.textContent="Reward not available yet."}catch{qe.textContent="Unable to claim reward. Try again."}});ui.addEventListener("click",()=>{$t(),rs.classList.add("hidden"),se.classList.remove("hidden"),se.innerHTML="<h2>Connectingâ€¦</h2><p>Waiting for game server.</p>",pe.classList.add("hidden"),ys({mode:be}).then(()=>{se.classList.add("hidden"),un.classList.add("visible"),ct&&(ct.checked=gt()),requestAnimationFrame(hs)}).catch(e=>{ms(e.message||"Connection failed."),pe.classList.remove("hidden")})});localStorage.getItem(ds)||cs.classList.remove("hidden");mi.addEventListener("click",()=>{localStorage.setItem(ds,"full"),cs.classList.add("hidden")});yi.addEventListener("click",()=>{localStorage.setItem(ds,"essential"),cs.classList.add("hidden")});Oe();document.querySelectorAll(".landing-buy").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.boost;if(!t||!(t in pn))return;const s=pn[t],i=he();i<s||(je(i-s),t==="size"?ne.sizeBonus+=1:t==="speed"?ne.speedBoost=!0:t==="adoptSpeed"&&(ne.adoptSpeed=!0),Oe())})});Ke();document.querySelectorAll(".color-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.color;t&&(pt(t),Ke())})});document.querySelectorAll(".preset-color").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.color;t&&xn().preset&&(pt(t),Ke())})});const fe=document.getElementById("color-picker-modal"),st=document.getElementById("color-picker-input"),Xe=document.getElementById("color-picker-input2"),Qt=document.getElementById("color-picker-title"),Hn=document.getElementById("color-picker-cancel"),Gn=document.getElementById("color-picker-confirm");let os="custom";document.querySelectorAll(".color-buy").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.color,s=bn[t],i=xn(),o=he();if(t==="preset"){if(i.preset||o<s)return;je(o-s),es({...i,preset:!0}),Oe(),Ke()}else if(t==="custom"){if(i.custom){pt(i.custom),Ke();return}if(o<s)return;os="custom",Qt&&(Qt.textContent="Pick Your Custom Color"),Xe&&(Xe.style.display="none"),fe==null||fe.classList.remove("hidden")}else if(t==="gradient"){if(i.gradient){pt(i.gradient),Ke();return}if(o<s)return;os="gradient",Qt&&(Qt.textContent="Pick Gradient Colors"),Xe&&(Xe.style.display="block"),fe==null||fe.classList.remove("hidden")}})});Hn==null||Hn.addEventListener("click",()=>{fe==null||fe.classList.add("hidden")});Gn==null||Gn.addEventListener("click",()=>{const e=xn(),t=he();if(os==="custom"){const s=(st==null?void 0:st.value)||"#ff5500";je(t-bn.custom),es({...e,custom:s}),pt(s)}else{const s=(st==null?void 0:st.value)||"#ff5500",i=(Xe==null?void 0:Xe.value)||"#00aaff",o=`gradient:${s}:${i}`;je(t-bn.gradient),es({...e,gradient:o}),pt(o)}fe==null||fe.classList.add("hidden"),Oe(),Ke()});xt&&(xt.checked=gt(),xt.addEventListener("change",()=>{eo(xt.checked),xt.checked&&$t()}));gt()&&$t();function hl(e,t=1){p.active=!0,p.pets=[],p.selectedPetIndex=null,p.timeLeft=30+t*5,p.totalPets=e,p.rescuedCount=0,p.level=t,p.selectedIngredients=[];const s=["dog","cat","horse","bird"];for(let r=0;r<e;r++){const l=s[Math.floor(Math.random()*s.length)];p.pets.push({type:l,rescued:!1})}gl(t),En(),mt(),rt(),lo.classList.add("hidden"),Fe.style.display="flex",Vn.classList.add("show");const i=Vn.querySelector(".breeder-title");i&&(i.textContent=`ðŸš¨ Stop Level ${t} Breeders!`);const o=document.getElementById("breeder-instruction-1"),a=document.getElementById("breeder-instruction-2"),d=Dt(t);o&&a&&(d===1?(o.textContent="1. Click a pet to select it",a.textContent="2. Click the matching food to rescue it!"):(o.textContent=`1. Click ${d} ingredients to make a meal`,a.textContent="2. Select a pet - if the meal matches, they're rescued!")),p.timerInterval=setInterval(()=>{p.timeLeft--,ki.textContent=`${p.timeLeft}s`,p.timeLeft<=0&&is(!1)},1e3)}function gl(e){const t=Fe.querySelector('[data-food="water"]'),s=Fe.querySelector('[data-food="bowl"]');t&&(t.style.display=e>=6?"flex":"none"),s&&(s.style.display=e>=10?"flex":"none")}function rt(){var a;const e=Dt(p.level);let t=document.getElementById("breeder-selected-ingredients");if(t||(t=document.createElement("div"),t.id="breeder-selected-ingredients",t.className="breeder-ingredients",(a=Fe.parentNode)==null||a.insertBefore(t,Fe)),e<=1){t.style.display="none";return}t.style.display="flex";const s={apple:"ðŸŽ",carrot:"ðŸ¥•",chicken:"ðŸ—",seeds:"ðŸŒ»",water:"ðŸ’§",bowl:"ðŸ¥£"},i=[];for(let d=0;d<e;d++)if(d<p.selectedIngredients.length){const r=p.selectedIngredients[d];i.push(`<div class="ingredient-slot filled">${s[r]}</div>`)}else i.push('<div class="ingredient-slot empty">?</div>');t.innerHTML=`
    <span class="ingredients-label">Building meal (${p.selectedIngredients.length}/${e}):</span>
    <div class="ingredient-slots">${i.join("")}</div>
    ${p.selectedIngredients.length>0?'<button type="button" class="clear-ingredients-btn" id="clear-ingredients">Clear</button>':""}
  `;const o=document.getElementById("clear-ingredients");o&&o.addEventListener("click",()=>{p.selectedIngredients=[],rt(),mt()})}function En(){Bs.innerHTML=p.pets.map((e,t)=>`
    <div class="breeder-pet${e.rescued?" rescued":""}${p.selectedPetIndex===t?" selected":""}" 
         data-index="${t}">
      <span>${Ui[e.type]}</span>
      <span class="breeder-pet-label">${e.type}</span>
    </div>
  `).join(""),Bs.querySelectorAll(".breeder-pet:not(.rescued)").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.index??"-1",10);t>=0&&!p.pets[t].rescued&&(p.selectedPetIndex=t,En(),mt())})})}function mt(){const e=c==null?void 0:c.players.find(i=>i.id===R),t=(e==null?void 0:e.money)??0;Li.textContent=`Your Tokens: ${t} RT`;const s=Dt(p.level);Fe.querySelectorAll(".breeder-food-btn").forEach(i=>{const o=i.dataset.food,a=fo[o],d=t>=a,r=p.selectedIngredients.includes(o);s===1?i.disabled=!d||p.selectedPetIndex===null:i.disabled=!d||r})}function pl(e,t){const s=Dt(p.level),i=Di[s];if(!i)return!1;const o=[...e].sort();for(const a of i){if(!a.worksOn.includes(t))continue;const d=[...a.ingredients].sort();if(o.length!==d.length)continue;let r=!0;for(let l=0;l<o.length;l++)if(o[l]!==d[l]){r=!1;break}if(r)return!0}return!1}function bl(e){const t=fo[e],s=c==null?void 0:c.players.find(a=>a.id===R);if(((s==null?void 0:s.money)??0)<t)return;const o=Dt(p.level);if(o===1){if(p.selectedPetIndex===null)return;const a=p.pets[p.selectedPetIndex];if(!a||a.rescued)return;if((y==null?void 0:y.readyState)===WebSocket.OPEN){const r=$i[e].includes(a.type);y.send(JSON.stringify({type:"breederUseFood",food:e,petIndex:p.selectedPetIndex,petType:a.type,success:r})),r?(a.rescued=!0,p.rescuedCount++,p.selectedPetIndex=null,ln(),p.rescuedCount>=p.totalPets?is(!0):En()):an(),mt()}return}if(p.selectedIngredients.includes(e)){ye("Already added to meal!");return}if((y==null?void 0:y.readyState)===WebSocket.OPEN&&y.send(JSON.stringify({type:"breederUseFood",food:e,petIndex:-1,petType:"ingredient",success:!1})),p.selectedIngredients.push(e),rt(),mt(),p.selectedIngredients.length>=o){if(p.selectedPetIndex===null){ye("Select a pet to feed this meal to!");return}const a=p.pets[p.selectedPetIndex];if(!a||a.rescued){p.selectedIngredients=[],rt();return}pl(p.selectedIngredients,a.type)?(a.rescued=!0,p.rescuedCount++,p.selectedPetIndex=null,p.selectedIngredients=[],ln(),ye("Meal complete! Pet rescued!","success"),p.rescuedCount>=p.totalPets?is(!0):(En(),rt())):(p.selectedIngredients=[],an(),ye("Wrong meal! Try again.","error"),rt()),mt()}}function is(e){p.timerInterval&&(clearInterval(p.timerInterval),p.timerInterval=null),(y==null?void 0:y.readyState)===WebSocket.OPEN&&y.send(JSON.stringify({type:"breederComplete",rescuedCount:p.rescuedCount,totalPets:p.totalPets,level:p.level})),Fe.style.display="none",lo.classList.remove("hidden"),Ci.textContent=e?"All Pets Rescued!":`Time's Up! (${p.rescuedCount}/${p.totalPets})`,ao.innerHTML='<p style="color:rgba(255,255,255,0.7)">Calculating rewards...</p>'}function vl(e,t){const s=t.some(l=>l.type==="penalty"),i=e>0||t.some(l=>l.type!=="penalty"),o=[],a=t.find(l=>l.type==="penalty");a&&o.push(`<div class="breeder-reward-item" style="color:#ff6b6b;">-${a.amount} Size (pets escaped!)</div>`),e>0&&o.push(`<div class="breeder-reward-item">+${e} RT</div>`),t.forEach(l=>{l.type==="size"&&o.push(`<div class="breeder-reward-item">+${l.amount} Size</div>`),l.type==="speed"&&o.push('<div class="breeder-reward-item">Speed Boost!</div>'),l.type==="port"&&o.push(`<div class="breeder-reward-item">+${l.amount} Port Charge</div>`)});const d=i?"ðŸŽ Rescue Chest":s?"âŒ Breeder Escape!":"No Rewards",r=i?"#ffd93d":"#ff6b6b";ao.innerHTML=`
    <div class="breeder-result-title" style="color:${r};margin-bottom:8px;">${d}</div>
    ${o.join("")}
  `}function El(){p.active=!1,Vn.classList.remove("show")}Fe.querySelectorAll(".breeder-food-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.food;t&&bl(t)})});Ti.addEventListener("click",El);let V=null;function Bo(e){const t=[];return e.tokens>0&&t.push(`${e.tokens} RT`),e.sizeBonus&&t.push(`+${e.sizeBonus} Size`),e.speedBoost&&t.push("Speed"),e.portCharge&&t.push("Port"),t.join(" + ")}function Mo(){if(!V)return;const{currentDay:e,canClaimToday:t,rewards:s}=V;let i="";const o=!Q;for(let a=0;a<7;a++){const d=a+1,r=s[a];let l=!1,m=!1,b=!0;o||(l=d===e&&t,m=d<e,b=d>e||d===e&&!t);const w=["daily-gift-day",l?"current":"",m?"claimed":"",b||o?"locked":"",d===7?"daily-gift-day7":""].filter(Boolean).join(" ");i+=`
      <div class="${w}">
        <div class="daily-gift-day-label">Day ${d}</div>
        <div class="daily-gift-day-icon">${m?"âœ“":l?"ðŸ”“":"ðŸ”’"}</div>
        <div class="daily-gift-day-reward">${Bo(r)}</div>
      </div>
    `}Q?(Ms.innerHTML=i,Ye.classList.remove("hidden"),t?(Ye.disabled=!1,Ye.textContent=`Claim Day ${e} Gift`,Un.textContent="Play to unlock today's gift!"):(Ye.disabled=!0,Ye.textContent="Come back tomorrow!",Un.textContent=`Next gift: Day ${e>7?1:e}`)):(i=`
      <div class="daily-gift-signin-overlay">
        <div class="daily-gift-signin-message">Sign in for daily gifts!</div>
        <div class="daily-gift-signin-buttons">
          <a href="${it("/auth/google")}" class="daily-gift-signin-btn google">Sign in with Google</a>
        </div>
      </div>
      <div class="daily-gift-grid-greyed">${i}</div>
    `,Ms.innerHTML=i,Ye.classList.add("hidden"),Un.textContent="")}async function Ao(){if(He.classList.remove("hidden"),!Q){V={currentDay:1,canClaimToday:!0,lastClaimDate:null,totalClaims:0,rewards:[{tokens:15},{tokens:25,speedBoost:!0},{tokens:40},{tokens:50,sizeBonus:3},{tokens:75,speedBoost:!0},{tokens:100,portCharge:!0},{tokens:150,sizeBonus:5,speedBoost:!0}]},He.classList.add("has-gift");return}try{const e=await fetch("/api/daily-gift",{credentials:"include"});if(!e.ok){V={currentDay:1,canClaimToday:!0,lastClaimDate:null,totalClaims:0,rewards:[{tokens:15},{tokens:25,speedBoost:!0},{tokens:40},{tokens:50,sizeBonus:3},{tokens:75,speedBoost:!0},{tokens:100,portCharge:!0},{tokens:150,sizeBonus:5,speedBoost:!0}]},He.classList.add("has-gift");return}V=await e.json(),V!=null&&V.canClaimToday?He.classList.add("has-gift"):He.classList.remove("has-gift")}catch{V={currentDay:1,canClaimToday:!0,lastClaimDate:null,totalClaims:0,rewards:[{tokens:15},{tokens:25,speedBoost:!0},{tokens:40},{tokens:50,sizeBonus:3},{tokens:75,speedBoost:!0},{tokens:100,portCharge:!0},{tokens:150,sizeBonus:5,speedBoost:!0}]},He.classList.add("has-gift")}Bl()}function Po(){V&&(Mo(),ro.classList.add("show"))}function Ro(){ro.classList.remove("show")}async function wl(){var e;if(!Q){ye("Sign in to collect daily rewards!"),Ro();return}if(V!=null&&V.canClaimToday)try{const t=await fetch("/api/daily-gift/claim",{method:"POST",credentials:"include"});if(!t.ok){const o=await t.json();ye(o.error||"Failed to claim gift");return}const s=await t.json();(e=s.reward)!=null&&e.tokens&&(je(he()+s.reward.tokens),Oe()),await Ao(),Mo();const i=Bo(s.reward);ye(`Gift claimed: ${i}`,"success")}catch{ye("Failed to claim gift")}}He.addEventListener("click",Po);Bi.addEventListener("click",Ro);Ye.addEventListener("click",wl);At.addEventListener("click",Po);let ls="alltime";async function Sl(e){try{const t=await fetch(`/api/leaderboard?type=${e}`,{credentials:"include"});return t.ok?(await t.json()).entries??[]:[]}catch{return[]}}async function xl(){try{const e=await fetch("/api/leaderboard/my-rank",{credentials:"include"});return e.ok?await e.json():{alltime:{rank:0},daily:{rank:0}}}catch{return{alltime:{rank:0},daily:{rank:0}}}}function Il(e,t){if(e.length===0){As.innerHTML='<div class="leaderboard-empty">No rankings yet. Play to be the first!</div>',qt.innerHTML="";return}As.innerHTML=e.map(s=>{const i=s.rank===1?"gold":s.rank===2?"silver":s.rank===3?"bronze":"",o=s.displayName===me?"highlight":"",a=s.shelterColor?`<span class="leaderboard-color" style="background:${s.shelterColor}"></span>`:"";return`
      <div class="leaderboard-entry ${o}">
        <div class="leaderboard-rank ${i}">#${s.rank}</div>
        ${a}
        <div class="leaderboard-name">${vn(s.displayName)}</div>
        <div class="leaderboard-stats">
          <span class="wins">${s.wins} wins</span><br>
          ${s.rtEarned} RT
        </div>
      </div>
    `}).join(""),t>0&&t<=10?qt.innerHTML=`Your rank: <strong>#${t}</strong> (Top 10 gets daily rewards!)`:t>10?qt.innerHTML=`Your rank: <strong>#${t}</strong> - Get into top 10 for daily rewards!`:qt.innerHTML="Win matches to appear on the leaderboard!"}async function kl(){co.classList.add("show"),await Oo()}function Ll(){co.classList.remove("show")}async function Oo(){const e=await Sl(ls),t=await xl(),s=ls==="alltime"?t.alltime.rank:t.daily.rank;Il(e,s)}document.querySelectorAll(".leaderboard-tab").forEach(e=>{e.addEventListener("click",async()=>{document.querySelectorAll(".leaderboard-tab").forEach(t=>t.classList.remove("active")),e.classList.add("active"),ls=e.dataset.type,await Oo()})});Ai.addEventListener("click",kl);Mi.addEventListener("click",Ll);async function No(){try{const e=await fetch("/api/inventory",{credentials:"include"});if(!e.ok)return;ke=await e.json(),$o()}catch{}}function $o(){Pi.textContent=String(ke.storedRt),Ri.textContent=String(ke.portCharges),Oi.textContent=String(ke.speedBoosts),Ni.textContent=String(ke.sizeBoosts),ke.signedIn?(ke.storedRt>0||ke.portCharges>0?It.textContent="Items will be used next match":It.textContent="Earn items by winning matches!",It.classList.add("signed-in")):(It.textContent="Sign in to save equipment",It.classList.remove("signed-in"))}async function Cl(){if(!Q)return{rt:0,ports:0};try{const e=await fetch("/api/inventory/withdraw",{method:"POST",credentials:"include"});if(!e.ok)return{rt:0,ports:0};const t=await e.json();return ke={storedRt:0,portCharges:0,speedBoosts:0,sizeBoosts:0,signedIn:!0},$o(),{rt:t.storedRt??0,ports:t.portCharges??0}}catch{return{rt:0,ports:0}}}async function Tl(e,t=0,s=!1){if(!(!Q||e<=0))try{await fetch("/api/inventory/deposit",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({rt:e,portCharges:t,isWinner:s})}),await No()}catch{}}function Bl(){V?(At.classList.remove("hidden"),V.canClaimToday||!Q?At.classList.add("has-gift"):At.classList.remove("has-gift")):At.classList.add("hidden")}Xi();Ki().then(()=>No());Oe();window.addEventListener("resize",xo);xo();
