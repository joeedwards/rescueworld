(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const d of a.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&i(d)}).observe(document,{childList:!0,subtree:!0});function s(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(o){if(o.ep)return;o.ep=!0;const a=s(o);fetch(o.href,a)}})();const Os=25,xo=1e3/Os,G=4800,V=4800,cs=280,at=32,rt=2.5,ds=16,fs=10,us=18,Io=1.5,Ns=50,ke=1,Le=2,Ce=4,Te=8,ko=0,Lo=1,$s=2,Ds=3,Co=1,Us=2;function _s(e,t){const s=new ArrayBuffer(4),i=new DataView(s);return i.setUint8(0,Co),i.setUint16(1,e,!0),i.setUint8(3,t&255),s}function Z(e,t){const s=e.getUint8(t);if(s===0)return{s:"",next:t+1};const i=e.buffer.byteLength-(t+1);if(s>i||s<0)throw new RangeError(`Snapshot string length ${s} exceeds buffer (${i} bytes left)`);const o=new Uint8Array(e.buffer,t+1,s);return{s:new TextDecoder().decode(o),next:t+1+s}}function To(e){const t=new DataView(e);let s=0;if(t.getUint8(s++)!==Us)throw new Error("Invalid snapshot message");const i=t.getUint32(s,!0);s+=4;const o=t.getUint32(s,!0);s+=4;const a=t.getUint8(s++)!==0,{s:d,next:c}=Z(t,s);s=c;const l=t.getUint32(s,!0);s+=4;const y=t.getUint8(s++),v=t.getUint8(s++),I=[];for(let k=0;k<v;k++){const{s:Y,next:$}=Z(t,s);s=$;const{s:_,next:F}=Z(t,s);s=F;const N=t.getFloat32(s,!0);s+=4;const J=t.getFloat32(s,!0);s+=4;const X=t.getFloat32(s,!0);s+=4;const ce=t.getFloat32(s,!0);s+=4;const ge=t.getFloat32(s,!0);s+=4;const de=t.getUint32(s,!0);s+=4;const pe=t.getUint8(s++),be=[];for(let Fe=0;Fe<pe;Fe++){const{s:Ee,next:b}=Z(t,s);s=b,be.push(Ee)}const fe=t.getUint32(s,!0);s+=4;const ve=t.getUint8(s++),_e=t.getUint8(s++)!==0,ht=t.getUint8(s++)!==0,Ve=t.getUint8(s++),yt=t.getUint8(s++),mt=[];for(let Fe=0;Fe<yt;Fe++){const{s:Ee,next:b}=Z(t,s);s=b,mt.push(Ee)}const{s:gt,next:En}=Z(t,s);s=En;const Ot=t.getUint16(s,!0);s+=2;const{s:Ze,next:wn}=Z(t,s);s=wn;const Sn=t.getUint8(s++)!==0;I.push({id:Y,displayName:_||Y,x:N,y:J,vx:X,vy:ce,size:ge,totalAdoptions:de,petsInside:be,speedBoostUntil:fe,inputSeq:ve,...mt.length?{allies:mt}:{},..._e?{eliminated:!0}:{},...ht?{grounded:!0}:{},...Ve>0?{portCharges:Ve}:{},...gt?{shelterColor:gt}:{},...Ot>0?{money:Ot}:{},...Ze?{shelterId:Ze}:{},...Sn?{vanSpeedUpgrade:!0}:{}})}const m=t.getUint16(s,!0);s+=2;const f=[];for(let k=0;k<m;k++){const{s:Y,next:$}=Z(t,s);s=$;const _=t.getFloat32(s,!0);s+=4;const F=t.getFloat32(s,!0);s+=4;const N=t.getFloat32(s,!0);s+=4;const J=t.getFloat32(s,!0);s+=4;const{s:X,next:ce}=Z(t,s);s=ce;const ge=X===""?null:X;f.push({id:Y,x:_,y:F,vx:N,vy:J,insideShelterId:ge})}const g=t.getUint8(s++),L=[];for(let k=0;k<g;k++){const{s:Y,next:$}=Z(t,s);s=$;const _=t.getFloat32(s,!0);s+=4;const F=t.getFloat32(s,!0);s+=4;const N=t.getFloat32(s,!0);s+=4,L.push({id:Y,x:_,y:F,radius:N})}const M=t.getUint8(s++),U=[];for(let k=0;k<M;k++){const{s:Y,next:$}=Z(t,s);s=$;const _=t.getFloat32(s,!0);s+=4;const F=t.getFloat32(s,!0);s+=4;const N=t.getUint8(s++);U.push({id:Y,x:_,y:F,type:N})}const O=t.getUint8(s++),C=[];for(let k=0;k<O;k++){const{s:Y,next:$}=Z(t,s);s=$;const{s:_,next:F}=Z(t,s);s=F;const N=t.getFloat32(s,!0);s+=4;const J=t.getFloat32(s,!0);s+=4;const X=t.getUint8(s++),ce=(X&1)!==0,ge=(X&2)!==0,de=(X&4)!==0,pe=t.getUint8(s++),be=[];for(let _e=0;_e<pe;_e++){const{s:ht,next:Ve}=Z(t,s);s=Ve,be.push(ht)}const fe=t.getFloat32(s,!0);s+=4;const ve=t.getUint32(s,!0);s+=4,C.push({id:Y,ownerId:_,x:N,y:J,hasAdoptionCenter:ce,hasGravity:ge,hasAdvertising:de,petsInside:be,size:fe,totalAdoptions:ve})}return{tick:i,matchEndAt:o,matchEndedEarly:a||void 0,winnerId:d||void 0,totalMatchAdoptions:l,scarcityLevel:y>0?y:void 0,players:I,pets:f,adoptionZones:L,pickups:U,shelters:C.length>0?C:void 0}}const Fs="rescueworld_music",Ws="rescueworld_sfx";function Ys(e,t){try{const s=localStorage.getItem(e);if(s==="0"||s==="false")return!1;if(s==="1"||s==="true")return!0}catch{}return t}function zs(e,t){try{localStorage.setItem(e,t?"1":"0")}catch{}}function ct(){return Ys(Fs,!0)}function Gs(e){zs(Fs,e),z&&(z.volume=e?1:0),!e&&z&&z.pause()}function Hs(){return Ys(Ws,!0)}function Bo(e){zs(Ws,e)}let $t=null;function Ao(){if($t)return $t;try{$t=new(window.AudioContext||window.webkitAudioContext)}catch{return null}return $t}function H(e,t,s="sine",i=.3){if(!Hs())return;const o=Ao();if(o)try{const a=o.createOscillator(),d=o.createGain();a.connect(d),d.connect(o.destination),a.frequency.value=e,a.type=s,d.gain.setValueAtTime(i,o.currentTime),d.gain.exponentialRampToValueAtTime(.001,o.currentTime+t),a.start(o.currentTime),a.stop(o.currentTime+t)}catch{}}function tn(){H(523,.12,"sine",.25),setTimeout(()=>H(659,.1,"sine",.2),80)}function Mo(){H(440,.08,"square",.2),setTimeout(()=>H(880,.08,"square",.15),60)}function Po(){H(392,.1,"sine",.25),setTimeout(()=>H(523,.12,"sine",.22),70),setTimeout(()=>H(659,.15,"sine",.2),140)}function Ro(){H(330,.06,"sine",.18)}function Oo(){H(523,.15,"sine",.25),setTimeout(()=>H(659,.15,"sine",.22),120),setTimeout(()=>H(784,.2,"sine",.2),240)}function No(){H(440,.08,"sine",.2),setTimeout(()=>H(554,.08,"sine",.18),80),setTimeout(()=>H(659,.12,"sine",.2),160)}function nn(){H(220,.15,"sawtooth",.35),setTimeout(()=>H(180,.12,"sawtooth",.3),100),setTimeout(()=>H(220,.1,"sawtooth",.25),200)}let z=null;function $o(){var i;const e=import.meta;let t=typeof((i=e.env)==null?void 0:i.BASE_URL)=="string"?e.env.BASE_URL:"";if(!t||t==="/"){const o=typeof window<"u"?window.location.pathname:"";if(o.includes("rescueworld"))t="/rescueworld/";else{const a=o.lastIndexOf("/");t=a<=0?"/":o.slice(0,a+1)}}return t.endsWith("/")?`${t}music.mp3`:`${t}/music.mp3`}function Pt(){if(ct())try{if(!z){z=new Audio,z.loop=!0,z.volume=1,z.preload="auto",z.src=$o();let t=!1;z.addEventListener("error",()=>{!z||t||(t=!0,z.src="/rescueworld/music.mp3",z.play().catch(()=>{}))}),z.load()}z.volume=ct()?1:0;const e=z.play();e&&typeof e.catch=="function"&&e.catch(()=>{})}catch{}}const Do=(()=>{const{protocol:e,host:t}=window.location;return`${e==="https:"?"wss:":"ws:"}//${t}/ws-signaling`})();let At=0,Xs=0;const W={};let ft=!1,sn=0,on=0,gn=0,pn=0;const Uo=15,hs=60;let h=null,P=null,r=null;const ln=new Map,an=new Map,_o=100;let x=null,In=0,kn=0,ys=0,ms=0,Tt=!1,qt=!1,Ks=0,_n=0,Ln=0,Dt=null;const Fo=200,A=document.getElementById("game"),n=A.getContext("2d"),me=document.getElementById("minimap"),E=me.getContext("2d"),Wo=document.getElementById("score"),Yo=document.getElementById("carried"),gs=document.getElementById("tag-cooldown"),zo=document.getElementById("timer"),Go=document.getElementById("game-clock"),$e=document.getElementById("leaderboard"),ee=document.getElementById("connection-overlay"),Ho=document.getElementById("how-to-play"),Xo=document.getElementById("settings-btn"),qs=document.getElementById("settings-panel"),ot=document.getElementById("music-toggle"),Fn=document.getElementById("sfx-toggle"),Ko=document.getElementById("settings-close");document.getElementById("ping");const qo=document.getElementById("switch-server"),Jo=document.getElementById("switch-server-btn"),he=document.getElementById("auth-area"),Qn=document.getElementById("landing"),rn=document.getElementById("game-wrap"),jo=document.getElementById("landing-play"),ae=document.getElementById("landing-nick"),vt=document.getElementById("landing-music-toggle"),Jt=document.getElementById("landing-profile-name"),jt=document.getElementById("landing-profile-avatar"),Cn=document.getElementById("landing-profile-actions"),Tn=document.getElementById("landing-auth-buttons"),He=document.getElementById("referral-status"),Bn=document.getElementById("referral-link"),Wn=document.getElementById("referral-copy-btn"),Vt=document.getElementById("referral-claim-btn"),es=document.getElementById("cookie-banner"),Vo=document.getElementById("cookie-accept"),Zo=document.getElementById("cookie-essential"),Et=document.getElementById("fight-ally-overlay"),Qo=document.getElementById("fight-ally-name"),ei=document.getElementById("fight-ally-fight"),ti=document.getElementById("fight-ally-ally"),Ut=document.getElementById("cpu-warning"),cn=document.getElementById("action-menu"),ni=document.getElementById("action-menu-close"),si=document.getElementById("action-size-text"),oi=document.getElementById("action-size-bar"),ii=document.getElementById("action-tokens-text"),li=document.getElementById("action-tokens-bar"),Ne=document.getElementById("action-build-btn"),ps=document.getElementById("action-build-shelter"),_t=document.getElementById("action-adoption-center"),Ft=document.getElementById("action-gravity"),Wt=document.getElementById("action-advertising"),bs=document.getElementById("action-van-speed"),wt=document.getElementById("action-adoption-btn"),St=document.getElementById("action-gravity-btn"),xt=document.getElementById("action-advertising-btn"),It=document.getElementById("action-van-speed-btn"),Yn=document.getElementById("ground-btn"),Zt=document.getElementById("port-btn"),kt=document.getElementById("build-shelter-btn"),dn=document.getElementById("center-van-btn"),Bt=document.getElementById("center-shelter-btn"),ai=document.getElementById("game-tokens"),et=document.getElementById("lobby-overlay"),zn=document.getElementById("lobby-message"),An=document.getElementById("lobby-countdown"),tt=document.getElementById("lobby-ready-btn"),ri=document.getElementById("lobby-back-btn"),Lt=document.getElementById("lobby-gift-btn"),Gn=document.getElementById("breeder-minigame"),ci=document.getElementById("breeder-timer"),di=document.getElementById("breeder-tokens"),vs=document.getElementById("breeder-pets"),De=document.getElementById("breeder-foods"),Js=document.getElementById("breeder-result"),fi=document.getElementById("breeder-result-title"),js=document.getElementById("breeder-rewards"),ui=document.getElementById("breeder-close-btn"),Vs=document.getElementById("daily-gift-modal"),hi=document.getElementById("daily-gift-close"),Mn=document.getElementById("daily-gift-subtitle"),Es=document.getElementById("daily-gift-grid"),We=document.getElementById("daily-gift-claim-btn"),Ct=document.getElementById("daily-gift-btn"),p={active:!1,pets:[],selectedPetIndex:null,timeLeft:30,timerInterval:null,totalPets:0,rescuedCount:0,level:1,selectedIngredients:[]},Zs={apple:5,carrot:8,chicken:15,seeds:5,water:20,bowl:20},yi={apple:["horse"],carrot:["horse","bird"],chicken:["dog","cat"],seeds:["bird"],water:[],bowl:[]},mi={2:[{ingredients:["chicken","carrot"],worksOn:["dog","cat"]},{ingredients:["seeds","apple"],worksOn:["bird"]},{ingredients:["apple","carrot"],worksOn:["horse"]}],3:[{ingredients:["water","chicken","carrot"],worksOn:["dog","cat"]},{ingredients:["water","seeds","apple"],worksOn:["bird"]},{ingredients:["water","apple","carrot"],worksOn:["horse"]}],4:[{ingredients:["bowl","water","chicken","carrot"],worksOn:["dog","cat"]},{ingredients:["bowl","water","seeds","apple"],worksOn:["bird"]},{ingredients:["bowl","water","apple","carrot"],worksOn:["horse"]}]};function Rt(e){return e<=2?1:e<=5?2:e<=9?3:4}const gi={dog:"ðŸ•",cat:"ðŸ±",horse:"ðŸ´",bird:"ðŸ¦"},ts="cookieConsent",Qs="rescueworld_mode",eo="rescueworld_ref",pi="rescueworld_skin_unlocked";let ze=null;const Hn=new Set,fn=new Set;let Yt=0;const ws=2e3,Ss=new Map,Mt=new Map,Xn=400,xs=new Map,Qt=[],Is=800,bi={dog:"ðŸ•",cat:"ðŸˆ",horse:"ðŸ´",bird:"ðŸ¦"};let vi=0;function ks(e,t,s,i,o){const a=["dog","cat","horse","bird"],d=Date.now();for(let c=0;c<o;c++){const l=a[Math.floor(Math.random()*a.length)],y=c*100,v=(Math.random()-.5)*30,I=(Math.random()-.5)*30;Qt.push({id:`adopt-${vi++}`,startTime:d+y,fromX:e+v,fromY:t+I,toX:s,toY:i,petType:l})}}let q="playing",Pn=0,Ei=0,un=!1;const to="rescueworld_tokens",no="rescueworld_color",so="rescueworld_unlocked_colors",hn={size:50,speed:30,adoptSpeed:40},yn={preset:50,custom:200,gradient:500};let ye="ffa";const Q={sizeBonus:0,speedBoost:!1,adoptSpeed:!1};let Ye=null,Pe=!1;function re(){return parseInt(localStorage.getItem(to)||"0",10)}function Ke(e){localStorage.setItem(to,String(Math.max(0,e)))}function Re(){const e=document.getElementById("landing-tokens");e&&(e.textContent=`Tokens: ${re()} RT`);const t=re();document.querySelectorAll(".landing-buy").forEach(s=>{const i=s.dataset.boost;if(!i||!(i in hn))return;const o=hn[i];s.disabled=t<o||i==="speed"&&Q.speedBoost||i==="adoptSpeed"&&Q.adoptSpeed})}function oo(){return localStorage.getItem(no)||"#7bed9f"}function dt(e){localStorage.setItem(no,e)}function bn(){try{const e=localStorage.getItem(so);if(e)return JSON.parse(e)}catch{}return{preset:!1,custom:null,gradient:null}}function Kn(e){localStorage.setItem(so,JSON.stringify(e))}function Xe(){const e=oo(),t=bn(),s=re();document.querySelectorAll(".color-btn").forEach(o=>{const a=o.dataset.color;o.classList.toggle("selected",a===e)});const i=document.getElementById("preset-colors-row");i&&(i.style.display=t.preset?"flex":"none",i.querySelectorAll(".preset-color").forEach(o=>{const a=o.dataset.color;o.classList.toggle("selected",a===e)})),document.querySelectorAll(".color-buy").forEach(o=>{const a=o.dataset.color,d=yn[a],c=a==="preset"?t.preset:a==="custom"?!!t.custom:!!t.gradient;o.disabled=c||s<d,o.classList.toggle("unlocked",c),c&&(a==="preset"?o.textContent="Preset Colors Unlocked":a==="custom"?o.textContent="Custom Color: Click to use":a==="gradient"&&(o.textContent="Gradient: Click to use"))})}let Rn=null;function Be(e){let t=document.getElementById("toast");t||(t=document.createElement("div"),t.id="toast",t.className="toast",document.body.appendChild(t)),t.textContent=e,t.classList.add("show"),Rn&&clearTimeout(Rn),Rn=setTimeout(()=>{t.classList.remove("show")},3e3)}const en=[];let ue=null,On=!1;function wi(e){en.push(...e),io()}function io(){if(On||en.length===0)return;const e=en.shift();On=!0,ue||(ue=document.createElement("div"),ue.id="announcement-bar",ue.style.cssText=`
      position: fixed;
      top: 60px;
      left: 0;
      width: 100%;
      height: 40px;
      background: linear-gradient(90deg, rgba(255,107,107,0) 0%, rgba(255,107,107,0.9) 15%, rgba(255,107,107,0.9) 85%, rgba(255,107,107,0) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      z-index: 150;
      pointer-events: none;
    `,document.body.appendChild(ue));const t=document.createElement("div");if(t.style.cssText=`
    white-space: nowrap;
    font: bold 18px 'Rubik', sans-serif;
    color: #fff;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 10px rgba(255,107,107,0.8);
    animation: announcementScroll 9s linear forwards;
  `,t.textContent=`âš ï¸ ${e} âš ï¸`,!document.getElementById("announcement-keyframes")){const s=document.createElement("style");s.id="announcement-keyframes",s.textContent=`
      @keyframes announcementScroll {
        0% { transform: translateX(100vw); opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { transform: translateX(-100vw); opacity: 0; }
      }
    `,document.head.appendChild(s)}ue.style.display="flex",ue.innerHTML="",ue.appendChild(t),t.addEventListener("animationend",()=>{On=!1,en.length===0&&ue&&(ue.style.display="none"),io()})}function Si(){const e=window.location.pathname;if(e.includes("rescueworld"))return"/rescueworld/";const t=e.lastIndexOf("/");return t<=0?"/":e.slice(0,t+1)}function xi(){try{const e=new URL(window.location.href),t=e.searchParams.get("ref");t&&(localStorage.setItem(eo,t),e.searchParams.delete("ref"),window.history.replaceState({},document.title,e.toString()))}catch{}}function Ii(){try{const e=localStorage.getItem(eo);return e&&e.length?e:null}catch{return null}}function ie(e){const t=Ii();return t?`${e}?ref=${encodeURIComponent(t)}`:e}function lo(e){const t=Si();return`${window.location.origin}${t}?ref=${encodeURIComponent(e)}`}let oe=null;async function ao(){if(!Pe){oe=null;return}try{const e=await fetch("/referrals/me",{credentials:"include"});if(!e.ok){oe=null;return}oe=await e.json()}catch{oe=null}}function ro(){if(!Pe||!oe){He.textContent="Sign in to get your referral link.",Bn.classList.add("referral-hidden"),Wn.classList.add("referral-hidden"),Vt.classList.add("referral-hidden");return}const e=lo(oe.referralCode);He.textContent=`Referrals: ${oe.referralCount}/${oe.rewardThreshold} (OAuth signups)`,Bn.textContent=e,Bn.classList.remove("referral-hidden"),Wn.classList.remove("referral-hidden"),oe.rewardEligible&&!oe.rewardClaimed?Vt.classList.remove("referral-hidden"):Vt.classList.add("referral-hidden")}async function ki(){try{const t=await(await fetch("/auth/me",{credentials:"include"})).json(),{displayName:s,signedIn:i}=t,o=s??"";if(Ye=o||null,Pe=i,i&&o)he.innerHTML=`
        <span class="auth-profile">${Ls(o)}</span>
        <a href="/auth/signout" class="auth-link">Sign out</a>
      `,Jt.textContent=o,jt.textContent=o.charAt(0).toUpperCase(),Cn.innerHTML='<a href="/auth/signout" class="auth-link" style="font-size:12px">Sign out</a>',Tn.innerHTML=`<a href="${ie("/auth/google")}" class="auth-link" style="display:inline-block">Sign in with Google</a> <a href="${ie("/auth/facebook")}" class="auth-link" style="display:inline-block">Sign in with Facebook</a>`,ae&&(ae.placeholder=o);else{const a=o?`${Ls(o)}`:"Guest";he.innerHTML=`
        <a href="${ie("/auth/google")}" class="auth-link">Sign in with Google</a>
        <a href="${ie("/auth/facebook")}" class="auth-link">Sign in with Facebook</a>
        <span class="auth-guest">${a}</span>
      `,Jt.textContent=o||"Guest",jt.textContent=o?o.charAt(0).toUpperCase():"?",Cn.innerHTML="",Tn.innerHTML=`
        <a href="${ie("/auth/google")}">Sign in with Google</a>
        <a href="${ie("/auth/facebook")}">Sign in with Facebook</a>
      `,ae&&(ae.placeholder=o||"Nickname")}ae&&o&&(ae.value=o)}catch{Ye=null,Pe=!1,he.innerHTML=`
      <a href="${ie("/auth/google")}" class="auth-link">Sign in with Google</a>
      <a href="${ie("/auth/facebook")}" class="auth-link">Sign in with Facebook</a>
      <span class="auth-guest">Guest</span>
    `,Jt.textContent="Guest",jt.textContent="?",Cn.innerHTML="",Tn.innerHTML=`<a href="${ie("/auth/google")}">Sign in with Google</a> <a href="${ie("/auth/facebook")}">Sign in with Facebook</a>`,ae&&(ae.placeholder="Nickname")}await ao(),ro(),await bo()}async function Li(){var s;const e=(s=ae==null?void 0:ae.value)==null?void 0:s.trim();if(e)return Ye=e,e;if(Ye)return Ye;try{const o=await(await fetch("/auth/guest",{method:"POST",credentials:"include"})).json();if(o.displayName)return Ye=o.displayName,Jt.textContent=o.displayName,jt.textContent=o.displayName.charAt(0).toUpperCase(),o.displayName}catch{}const t=`rescue${Date.now().toString(36)}`;return Ye=t,t}function Ls(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function co(){const e=window.innerWidth,t=window.innerHeight;A.width=e,A.height=t}function B(e,t){t?At|=e:At&=~e}let qn=!1;function ut(){const e=r==null?void 0:r.players.find(t=>t.id===P);return(e==null?void 0:e.eliminated)===!0}function Ci(){const e=ut();if(e&&!qn){const t=r==null?void 0:r.players.find(s=>s.id===P);t&&(Ae=t.x,Me=t.y)}qn=e}function Ti(e){if(W[e.code]=!0,p.active){e.preventDefault();return}if(ut()){e.preventDefault();return}(e.code==="KeyW"||e.code==="ArrowUp")&&B(Ce,!0),(e.code==="KeyS"||e.code==="ArrowDown")&&B(Te,!0),(e.code==="KeyA"||e.code==="ArrowLeft")&&B(ke,!0),(e.code==="KeyD"||e.code==="ArrowRight")&&B(Le,!0),e.preventDefault()}function Bi(e){if(W[e.code]=!1,p.active){e.preventDefault();return}if(ut()){e.preventDefault();return}(e.code==="KeyW"||e.code==="ArrowUp")&&B(Ce,!1),(e.code==="KeyS"||e.code==="ArrowDown")&&B(Te,!1),(e.code==="KeyA"||e.code==="ArrowLeft")&&B(ke,!1),(e.code==="KeyD"||e.code==="ArrowRight")&&B(Le,!1),e.preventDefault()}function Ai(){return!!(W.KeyW||W.KeyS||W.KeyA||W.KeyD||W.ArrowUp||W.ArrowDown||W.ArrowLeft||W.ArrowRight)}function Mi(){if(Ai())return;if(p.active){B(ke,!1),B(Le,!1),B(Ce,!1),B(Te,!1);return}if(!ft){B(ke,!1),B(Le,!1),B(Ce,!1),B(Te,!1);return}const e=gn-sn,t=pn-on,s=Math.hypot(e,t);if(s<Uo){B(ke,!1),B(Le,!1),B(Ce,!1),B(Te,!1);return}const i=e/s,o=t/s;B(ke,i<-.3),B(Le,i>.3),B(Ce,o<-.3),B(Te,o>.3)}A.addEventListener("touchstart",e=>{e.preventDefault(),e.touches.length&&(ft=!0,sn=e.touches[0].clientX,on=e.touches[0].clientY,gn=sn,pn=on)},{passive:!1});A.addEventListener("touchmove",e=>{e.preventDefault(),e.touches.length&&ft&&(gn=e.touches[0].clientX,pn=e.touches[0].clientY)},{passive:!1});function fo(){if((h==null?void 0:h.readyState)===WebSocket.OPEN){const e=_s(At,Xs++);h.send(e)}}A.addEventListener("touchend",e=>{e.preventDefault(),e.touches.length===0&&(ft=!1,B(ke,!1),B(Le,!1),B(Ce,!1),B(Te,!1),fo())},{passive:!1});A.addEventListener("touchcancel",e=>{e.preventDefault(),ft=!1,B(ke,!1),B(Le,!1),B(Ce,!1),B(Te,!1),fo()},{passive:!1});let ns=!1,Jn=0,jn=0;A.addEventListener("mousedown",e=>{e.preventDefault(),ut()&&(ns=!0,Jn=e.clientX,jn=e.clientY)});A.addEventListener("mousemove",e=>{if(e.preventDefault(),ut()&&ns){const t=e.clientX-Jn,s=e.clientY-jn;Ae-=t,Me-=s,Ae=Math.max(A.width/2,Math.min(G-A.width/2,Ae)),Me=Math.max(A.height/2,Math.min(V-A.height/2,Me)),Jn=e.clientX,jn=e.clientY}});A.addEventListener("mouseup",e=>{e.preventDefault(),ns=!1});A.addEventListener("contextmenu",e=>{e.preventDefault()});A.addEventListener("click",e=>{if(!r||!P||!h||h.readyState!==WebSocket.OPEN)return;const t=A.getBoundingClientRect(),s=A.width/t.width,i=A.height/t.height,o=(e.clientX-t.left)*s,a=(e.clientY-t.top)*i,d=uo(),c=o+d.x,l=a+d.y;for(const y of r.players){if(y.id===P||y.eliminated)continue;const v=at+y.size*rt;if(c>=y.x-v&&c<=y.x+v&&l>=y.y-v&&l<=y.y+v){fn.has(y.id)||(h.send(JSON.stringify({type:"allyRequest",targetId:y.id})),fn.add(y.id));break}}});window.addEventListener("keydown",Ti);window.addEventListener("keyup",Bi);let Ue=!1;function vn(e,t){const s=me.getBoundingClientRect(),i=e-s.left,o=t-s.top,a=G/120,d=i*a,c=o*a,l=(x==null?void 0:x.x)??G/2,y=(x==null?void 0:x.y)??V/2;qe=d-l,Je=c-y}me.addEventListener("mousedown",e=>{e.preventDefault(),Ue=!0,vn(e.clientX,e.clientY)});me.addEventListener("mousemove",e=>{Ue&&vn(e.clientX,e.clientY)});me.addEventListener("mouseup",()=>{Ue=!1});me.addEventListener("mouseleave",()=>{Ue=!1});me.addEventListener("touchstart",e=>{e.preventDefault(),Ue=!0,e.touches.length>0&&vn(e.touches[0].clientX,e.touches[0].clientY)},{passive:!1});me.addEventListener("touchmove",e=>{Ue&&e.touches.length>0&&(e.preventDefault(),vn(e.touches[0].clientX,e.touches[0].clientY))},{passive:!1});me.addEventListener("touchend",()=>{Ue=!1});me.addEventListener("touchcancel",()=>{Ue=!1});let we=null,Se=null;const Cs=.22;let qe=0,Je=0,Ae=G/2,Me=V/2;const zt=15;let xe=null,Ie=null;const Ts=.28;function uo(){const e=A.width,t=A.height,s=r==null?void 0:r.players.find(v=>v.id===P);if((s==null?void 0:s.eliminated)===!0){const v=Math.max(0,Math.min(G-e,Ae-e/2)),I=Math.max(0,Math.min(V-t,Me-t/2));return{x:v,y:I,w:e,h:t}}let o=(x==null?void 0:x.x)??G/2,a=(x==null?void 0:x.y)??V/2;(!Number.isFinite(o)||!Number.isFinite(a))&&(o=G/2,a=V/2);let d=o-e/2+qe,c=a-t/2+Je;if(d=Math.max(0,Math.min(G-e,d)),c=Math.max(0,Math.min(V-t,c)),x==null)return we=null,Se=null,{x:d,y:c,w:e,h:t};we==null||Se==null||!Number.isFinite(we)||!Number.isFinite(Se)?(we=d,Se=c):(we+=(d-we)*Cs,Se+=(c-Se)*Cs);let l=we,y=Se;return(!Number.isFinite(l)||!Number.isFinite(y))&&(l=d,y=c,we=l,Se=y),l=Math.max(0,Math.min(G-e,l)),y=Math.max(0,Math.min(V-t,y)),{x:l,y,w:e,h:t}}const Pi=30;function Ri(e,t,s){let i=0,o=0;t&ke&&(i-=1),t&Le&&(i+=1),t&Ce&&(o-=1),t&Te&&(o+=1);let a=0,d=0;if(i!==0||o!==0){const v=Math.hypot(i,o)||1,m=((e.speedBoostUntil??0)>0?cs*Io:cs)*s;a=i/v*m,d=o/v*m}const c=Pi;let l=e.x+a,y=e.y+d;return l=Math.max(c,Math.min(G-c,l)),y=Math.max(c,Math.min(V-c,y)),{...e,x:l,y,vx:a,vy:d,petsInside:[...e.petsInside],speedBoostUntil:e.speedBoostUntil??0}}const Bs=1e4;function ss(e){ee.classList.remove("hidden"),ee.innerHTML=`
    <h2>Could not connect</h2>
    <p class="error">${e}</p>
    <p>The game server is not running or not reachable.</p>
    <p><strong>To start the game:</strong></p>
    <p>From the project root folder, run: <code>npm run dev</code></p>
    <p>That starts both the server (ports 4000, 4001) and the client. Wait a few seconds, then refresh this page.</p>
    <p>Or run in two terminals: first <code>npm run dev:server</code>, then <code>npm run dev:client</code>.</p>
  `}async function os(e){Dt&&(clearInterval(Dt),Dt=null),qo.classList.add("hidden");const t=d=>/^wss?:\/\/localhost(\b|:|\/|$)/i.test(d)||/^wss?:\/\/127\.0\.0\.1(\b|:|\/|$)/i.test(d),s=()=>{const{protocol:d,host:c}=window.location;return`${d==="https:"?"wss:":"ws:"}//${c}/ws-game`};let i=t(window.location.href)?"ws://localhost:4001":s();const o=new WebSocket(Do);await new Promise((d,c)=>{const l=setTimeout(()=>{o.close(),c(new Error("Connection timeout. Is the server running? Run: npm run dev"))},Bs);o.onopen=()=>{o.send(JSON.stringify({type:"join",latency:e==null?void 0:e.latency,mode:(e==null?void 0:e.mode)??"ffa"}))},o.onmessage=y=>{try{const v=JSON.parse(y.data);v.type==="joined"&&v.gameUrl&&(clearTimeout(l),i=v.gameUrl,!t(window.location.href)&&t(i)&&(i=s()),d())}catch{}},o.onerror=()=>{clearTimeout(l),c(new Error("WebSocket error. Server not running?"))},o.onclose=()=>{clearTimeout(l),o.readyState!==WebSocket.OPEN&&c(new Error("Signaling connection closed. Run: npm run dev"))}});const a=new WebSocket(i);a.binaryType="arraybuffer",a.onopen=async()=>{h=a;const d=await Li();h.send(JSON.stringify({type:"mode",mode:(e==null?void 0:e.mode)??"ffa",displayName:d})),(Q.sizeBonus>0||Q.speedBoost||Q.adoptSpeed)&&(h.send(JSON.stringify({type:"startingBoosts",sizeBonus:Q.sizeBonus,speedBoost:Q.speedBoost,adoptSpeed:Q.adoptSpeed})),Q.sizeBonus=0,Q.speedBoost=!1,Q.adoptSpeed=!1);const c=oo();h.send(JSON.stringify({type:"setColor",color:c})),(e==null?void 0:e.mode)==="solo"&&Rs&&h.send(JSON.stringify({type:"setCpuBreederBehavior",canShutdown:Rs.checked}))},a.onmessage=d=>{var l,y,v,I;if(typeof d.data=="string"){try{const m=JSON.parse(d.data);if(m.type==="welcome"&&m.playerId&&(P=m.playerId,No()),m.type==="matchState"&&typeof m.phase=="string"&&(q=m.phase,Pn=typeof m.countdownRemainingSec=="number"?m.countdownRemainingSec:0,Ei=typeof m.readyCount=="number"?m.readyCount:0,q==="lobby"?ye==="solo"?et.classList.add("hidden"):(et.classList.remove("hidden"),zn.textContent="Waiting for another playerâ€¦",An.classList.add("hidden"),tt.classList.add("hidden")):q==="countdown"?(et.classList.remove("hidden"),zn.textContent="Match starting soon",An.classList.remove("hidden"),An.textContent=Pn>0?`Starting in ${Pn}sâ€¦`:"Startingâ€¦",tt.classList.remove("hidden"),un?tt.textContent="Ready!":tt.textContent="Ready"):et.classList.add("hidden")),m.type==="pong"&&typeof m.ts=="number"&&(_n=Math.round(Date.now()-m.ts),_n>Fo?Ln=Ln||Date.now():Ln=0),m.type==="groundFailed"&&typeof m.reason=="string"&&Be(m.reason),m.type==="breederStart"&&typeof m.petCount=="number"){const f=typeof m.level=="number"?m.level:1;Xi(m.petCount,f)}if(m.type==="breederRewards"){const f=typeof m.tokenBonus=="number"?m.tokenBonus:0,g=Array.isArray(m.rewards)?m.rewards:[];ji(f,g)}m.type==="announcement"&&Array.isArray(m.messages)&&wi(m.messages)}catch{}return}const c=d.data;if(!(c.byteLength<1)&&new DataView(c).getUint8(0)===Us){const m=To(c);r=m,q!=="playing"&&(q="playing",et.classList.add("hidden"));for(const g of m.players){const L=((l=ln.get(g.id))==null?void 0:l.next)??g;ln.set(g.id,{prev:L,next:{...g},t:0});const M=xs.get(g.id);if(M){const U=g.x-M.x,O=g.y-M.y;Math.hypot(U,O)>200&&!Mt.has(g.id)&&Mt.set(g.id,{startTime:Date.now(),fromX:M.x,fromY:M.y,toX:g.x,toY:g.y,phase:"fadeIn"})}xs.set(g.id,{x:g.x,y:g.y})}for(const g of m.pets){const L=((y=an.get(g.id))==null?void 0:y.next)??g;an.set(g.id,{prev:L,next:{...g},t:0})}const f=m.players.find(g=>g.id===P);if(f){const g=!!f.shelterId;if(f.size>In&&!g&&f.size<50?(Ks=Date.now()+1500,tn()):f.size>In&&tn(),(f.speedBoostUntil??0)>ms&&Mo(),ms=f.speedBoostUntil??0,f.totalAdoptions>kn){Po();const O=f.totalAdoptions-kn,C=(v=r==null?void 0:r.shelters)==null?void 0:v.find(k=>k.ownerId===P);if(C!=null&&C.hasAdoptionCenter)ks(C.x,C.y,C.x,C.y-100,O);else{const k=(I=r==null?void 0:r.adoptionZones)==null?void 0:I[0];k&&ks(f.x,f.y,k.x,k.y,O)}}kn=f.totalAdoptions,f.petsInside.length>ys&&Ro(),ys=f.petsInside.length,In=f.size;const L=(x==null?void 0:x.x)??f.x,M=(x==null?void 0:x.y)??f.y;x={...f,petsInside:[...f.petsInside]},f.inputSeq,Math.hypot(f.x-L,f.y-M)>300&&(we=null,Se=null,qe=0,Je=0,xe=f.x,Ie=f.y)}}},a.onclose=()=>{h=null,P=null,r=null,x=null,q="playing",fn.clear(),un=!1},await new Promise((d,c)=>{const l=Date.now()+Bs,y=()=>{(h==null?void 0:h.readyState)===WebSocket.OPEN?d():Date.now()>l?c(new Error("Game server connection timeout")):setTimeout(y,50)};y()}),ee.classList.add("hidden"),Ho.classList.add("hidden"),Pt(),Dt=setInterval(()=>{(h==null?void 0:h.readyState)===WebSocket.OPEN&&h.send(JSON.stringify({type:"ping",ts:Date.now()}))},2e3)}let Gt=0,As=0;function is(e){var d,c;Gt||(Gt=e);const t=Math.min((e-Gt)/1e3,.1);Gt=e,Mi(),Ci(),ut()&&((W.KeyW||W.ArrowUp)&&(Me-=zt),(W.KeyS||W.ArrowDown)&&(Me+=zt),(W.KeyA||W.ArrowLeft)&&(Ae-=zt),(W.KeyD||W.ArrowRight)&&(Ae+=zt),Ae=Math.max(A.width/2,Math.min(G-A.width/2,Ae)),Me=Math.max(A.height/2,Math.min(V-A.height/2,Me)));const s=r!=null&&r.matchEndAt>0&&r.tick>=r.matchEndAt,i=r==null?void 0:r.players.find(l=>l.id===P),o=q==="playing"&&!s&&!(i!=null&&i.eliminated);if(o&&(h==null?void 0:h.readyState)===WebSocket.OPEN&&e-As>=xo){As=e;const l=_s(At,Xs++);h.send(l)}if(o&&x&&P){x.x,x.y,x=Ri(x,At,t);let l=x.x,y=x.y;(!Number.isFinite(l)||!Number.isFinite(y))&&(l=G/2,y=V/2),xe==null||Ie==null?(xe=l,Ie=y):(xe+=(l-xe)*Ts,Ie+=(y-Ie)*Ts),(!Number.isFinite(xe)||!Number.isFinite(Ie))&&(xe=l,Ie=y);let v=null,I=!1;if(r){const m=r.players.find(g=>g.id===P),f=m!=null&&m.shelterId?(d=r.shelters)==null?void 0:d.find(g=>g.id===m.shelterId):null;if(f){const g=at+f.size*rt;for(const L of r.players){if(L.id===P)continue;const M=L.shelterId?(c=r.shelters)==null?void 0:c.find(C=>C.id===L.shelterId):null;if(!M)continue;const U=at+M.size*rt;if(Math.abs(f.x-M.x)<=g+U&&Math.abs(f.y-M.y)<=g+U&&!(f.size<fs||M.size<fs)){if(L.id.startsWith("cpu-")){I=!0;continue}if(!Hn.has(L.id)){v=L.id;break}}}}}if(v){const m=r.players.find(g=>g.id===v);ze=v,Qo.textContent=(m==null?void 0:m.displayName)??v;const f=Et.classList.contains("hidden");Et.classList.remove("hidden"),f&&Date.now()-Yt>ws&&(Yt=Date.now(),nn())}else Et.classList.add("hidden"),ze=null,Hn.clear();if(I){const m=Ut.classList.contains("hidden");Ut.classList.remove("hidden"),m&&Date.now()-Yt>ws&&(Yt=Date.now(),nn())}else Ut.classList.add("hidden")}else xe=null,Ie=null,Et.classList.add("hidden"),ze=null,Ut.classList.add("hidden");const a=t*(1e3/_o);for(const l of ln.values())l.t=Math.min(1,l.t+a);for(const l of an.values())l.t=Math.min(1,l.t+a);Gi(),requestAnimationFrame(is)}function nt(e,t,s){return e+(t-e)*s}function Oi(e){const t=ln.get(e);if(!t)return null;const s=t.t;return{...t.next,x:nt(t.prev.x,t.next.x,s),y:nt(t.prev.y,t.next.y,s),vx:nt(t.prev.vx,t.next.vx,s),vy:nt(t.prev.vy,t.next.vy,s)}}function Ni(e){const t=an.get(e);if(!t)return null;const s=t.t;return{...t.next,x:nt(t.prev.x,t.next.x,s),y:nt(t.prev.y,t.next.y,s)}}const se=36,Ht=1.8;function ls(e){let t=0;for(let i=0;i<e.length;i++)t=t*31+e.charCodeAt(i)>>>0;return`hsl(${t%360}, 72%, 58%)`}function $i(e){const t=se*2,s=Math.floor((e.x-t)/se)*se,i=Math.floor((e.y-t)/se)*se,o=Math.ceil((e.x+e.w+t)/se)*se,a=Math.ceil((e.y+e.h+t)/se)*se;n.fillStyle="#3d6b3d",n.fillRect(e.x,e.y,e.w,e.h),n.fillStyle="rgba(255,255,255,0.35)";for(let d=i;d<=a;d+=se)for(let c=s;c<=o;c+=se)n.fillRect(c-Ht,d-Ht,Ht*2,Ht*2)}function Di(e){const t=e.x,s=e.y,i=e.radius;n.save(),n.strokeStyle="rgba(123, 237, 159, 0.6)",n.lineWidth=4,n.setLineDash([8,8]),n.strokeRect(t-i,s-i,i*2,i*2),n.setLineDash([]),n.fillStyle="rgba(74, 124, 89, 0.2)",n.fillRect(t-i,s-i,i*2,i*2),n.fillStyle="#7bed9f",n.font="bold 14px Rubik, sans-serif",n.textAlign="center",n.fillText("ADOPTION CENTER",t,s-i-8),n.fillText("Bring pets here to adopt out",t,s),n.restore()}function Ms(e,t,s,i){n.save();const o=60,a=i?s:1-s,d=i?.5+s*.5:1+s*.5;n.translate(e,t),n.scale(d,d),n.beginPath(),n.arc(0,0,o,0,Math.PI*2),n.strokeStyle=`rgba(200, 150, 255, ${a*.8})`,n.lineWidth=4,n.stroke();const c=n.createRadialGradient(0,0,0,0,0,o);c.addColorStop(0,`rgba(180, 120, 255, ${a*.6})`),c.addColorStop(.5,`rgba(140, 80, 220, ${a*.3})`),c.addColorStop(1,"rgba(100, 50, 180, 0)"),n.fillStyle=c,n.beginPath(),n.arc(0,0,o,0,Math.PI*2),n.fill();const l=8,y=Date.now()/100;for(let v=0;v<l;v++){const I=v/l*Math.PI*2+y*.5,m=o*.6*(.8+Math.sin(y+v)*.2),f=Math.cos(I)*m,g=Math.sin(I)*m,L=3+Math.sin(y*2+v)*1.5;n.beginPath(),n.arc(f,g,L,0,Math.PI*2),n.fillStyle=`rgba(255, 255, 255, ${a*.9})`,n.fill()}n.restore()}function Ps(e,t,s,i,o="large"){n.save();const a=o==="small"?.5:1,d=o==="small"?.6:1,c=e-i*(s+8*a),l=t,y=Date.now()/100,v=Math.sin(y*3)*.3+.7,I=Math.cos(y*4)*.2+.8,m=25*a,f=n.createRadialGradient(c,l,0,c,l,m);f.addColorStop(0,`rgba(255, 200, 50, ${.6*v*d})`),f.addColorStop(.5,`rgba(255, 100, 20, ${.4*v*d})`),f.addColorStop(1,"rgba(255, 50, 0, 0)"),n.fillStyle=f,n.beginPath(),n.arc(c,l,m,0,Math.PI*2),n.fill();const g=18*a,L=10*a,M=g+Math.sin(y*5)*4*a,U=L+Math.cos(y*6)*2*a;n.beginPath(),n.moveTo(c+i*5,l-U/2),n.quadraticCurveTo(c-i*M*.6,l-U*.3*I,c-i*M,l),n.quadraticCurveTo(c-i*M*.6,l+U*.3*I,c+i*5,l+U/2),n.closePath();const O=n.createLinearGradient(c+i*5,l,c-i*M,l);O.addColorStop(0,"#FFD700"),O.addColorStop(.3,"#FF8C00"),O.addColorStop(.7,"#FF4500"),O.addColorStop(1,"rgba(255, 69, 0, 0.3)"),n.fillStyle=O,n.fill();const C=M*.6,k=U*.5;n.beginPath(),n.moveTo(c+i*5,l-k/2),n.quadraticCurveTo(c-i*C*.5,l-k*.2,c-i*C,l),n.quadraticCurveTo(c-i*C*.5,l+k*.2,c+i*5,l+k/2),n.closePath(),n.fillStyle="#FFFF80",n.fill(),n.restore()}function Ui(e,t){const o=e.x,a=e.y,d=Mt.get(e.id);let c=1;if(d){const de=Date.now()-d.startTime;d.phase==="fadeIn"&&(c=Math.min(1,de/Xn),de>=Xn&&(Mt.delete(e.id),c=1))}Math.abs(e.vx)>.01&&Ss.set(e.id,e.vx>0?1:-1);const l=Ss.get(e.id)??1;n.save(),n.globalAlpha=c,n.shadowColor="rgba(0,0,0,0.4)",n.shadowBlur=10;const y=(r==null?void 0:r.tick)??0,v=(e.speedBoostUntil??0)>y,I=!!e.vanSpeedUpgrade;e.eliminated||(v?Ps(o,a,50,l,"large"):I&&Ps(o,a,50,l,"small"));let m,f=t?"#7bed9f":ls(e.id);if(e.eliminated)m="rgba(100,100,100,0.5)",f="#666";else if(e.shelterColor)if(e.shelterColor.startsWith("gradient:")){const de=e.shelterColor.split(":"),pe=de[1]||"#ff5500",be=de[2]||"#00aaff",fe=n.createLinearGradient(o-50,a-50*.6,o+50,a+50*.6);fe.addColorStop(0,pe),fe.addColorStop(1,be),m=fe,f=pe}else m=e.shelterColor,f=e.shelterColor;else m=f;const g=50*2,L=50*1.2,M=o-50,U=a-L*.5,O=Math.min(12,50*.3),C=Math.min(10,50*.25);n.translate(o,a),l<0&&n.scale(-1,1),n.fillStyle=m,n.beginPath(),n.roundRect(-50,-L*.5,g,L,O),n.fill();const k=g*.3;n.fillStyle="rgba(0,0,0,0.15)",n.beginPath(),n.roundRect(-50+g-k,-L*.5,k,L,[0,O,O,0]),n.fill();const Y=4,$=k-Y*2,_=L*.4;n.fillStyle="rgba(135,206,250,0.7)",n.beginPath(),n.roundRect(-50+g-k+Y,-L*.5+Y,$,_,4),n.fill();const F=!t&&fn.has(e.id);F?(n.strokeStyle="#7bed9f",n.lineWidth=3,n.setLineDash([6,4])):(n.strokeStyle=t?"rgba(255,255,255,0.9)":"rgba(255,255,255,0.5)",n.lineWidth=t?3:2),n.beginPath(),n.roundRect(-50,-L*.5,g,L,O),n.stroke(),n.setLineDash([]),l<0&&n.scale(-1,1),n.translate(-o,-a),n.fillStyle="#333";const N=U+L+C*.3,J=M+g*.2,X=M+g*.7;n.beginPath(),n.arc(J,N,C,0,Math.PI*2),n.fill(),n.beginPath(),n.arc(X,N,C,0,Math.PI*2),n.fill(),n.fillStyle="#888",n.beginPath(),n.arc(J,N,C*.4,0,Math.PI*2),n.fill(),n.beginPath(),n.arc(X,N,C*.4,0,Math.PI*2),n.fill(),n.fillStyle="#2d2d2d",n.font="bold 12px Rubik, sans-serif",n.textAlign="center";const ce=t?"You":e.displayName??e.id;n.fillText(ce,o,U-6),F&&(n.fillStyle="#7bed9f",n.fillText("ðŸ¤",o+50+10,U+10),n.fillStyle="#2d2d2d"),e.eliminated&&(n.font="18px sans-serif",n.fillText("ðŸ‘»",o-50*.3,a),n.font="bold 12px Rubik, sans-serif");const ge=Math.min(Math.floor(e.size),Ns);n.fillStyle="#fff",n.fillText(`Pets: ${e.petsInside.length}/${ge}`,o,a+4),n.restore()}function _i(e,t,s){const i=e.x,o=e.y,a=at+e.size*rt,d=Math.max(40,a);n.save(),n.shadowColor="rgba(0,0,0,0.4)",n.shadowBlur=12;let c;if(s!=null&&s.startsWith("gradient:")){const $=s.split(":"),_=$[1]||"#7bed9f",F=$[2]||"#3cb371",N=n.createLinearGradient(i-d,o,i+d,o);N.addColorStop(0,_),N.addColorStop(1,F),c=N}else s?c=s:c=t?"#7bed9f":ls(e.ownerId);n.fillStyle=c;const l=d*2,y=d*1.4,v=i-d,I=o-y*.4;n.beginPath(),n.roundRect(v,I,l,y,6),n.fill(),n.fillStyle="#8B4513",n.beginPath(),n.moveTo(v-10,I),n.lineTo(i,I-d*.5),n.lineTo(v+l+10,I),n.closePath(),n.fill(),n.strokeStyle="#654321",n.lineWidth=2,n.stroke();const m=l*.2,f=y*.5;n.fillStyle="#654321",n.fillRect(i-m/2,I+y-f,m,f);const g=12,L=4,M=Math.floor((l-40)/(g+L)),U=Math.min(e.petsInside.length+2,M*2);for(let $=0;$<U;$++){const _=Math.floor($/M),F=$%M,N=v+20+F*(g+L),J=I+15+_*(g+L),X=$<e.petsInside.length;n.fillStyle=X?"#c9a86c":"#aaa",n.fillRect(N,J,g,g),n.strokeStyle="#666",n.lineWidth=1,n.strokeRect(N,J,g,g)}n.setLineDash([5,5]),n.strokeStyle=t?"#7bed9f":"rgba(255,255,255,0.5)",n.lineWidth=2;const O=15;n.strokeRect(v-O,I-d*.5-O,l+O*2,y+d*.5+O*2),n.setLineDash([]);const C=I-d*.5-25;let k=i-30;n.font="14px sans-serif",n.textAlign="center",e.hasAdoptionCenter&&(n.fillText("ðŸ¾",k,C),k+=20),e.hasGravity&&(n.fillText("ðŸ§²",k,C),k+=20),e.hasAdvertising&&(n.fillText("ðŸ“¢",k,C),k+=20),n.fillStyle="#333",n.font="bold 11px Rubik, sans-serif",n.textAlign="center";const Y=t?"Your Shelter":"Shelter";n.fillText(Y,i,I-d*.5-8),n.fillStyle="#fff",n.font="10px Rubik, sans-serif",n.fillText(`Pets: ${e.petsInside.length}`,i,I+y+12),n.fillStyle="#7bed9f",n.fillText(`Adoptions: ${e.totalAdoptions}`,i,I+y+24),n.restore()}function Fi(e){const t=e.x,s=e.y,i=40+e.size*.5;n.save(),n.shadowColor="rgba(255, 0, 0, 0.4)",n.shadowBlur=15,n.fillStyle="#4a1a1a";const o=i*2,a=i*1.4,d=t-i,c=s-a*.4;n.beginPath(),n.roundRect(d,c,o,a,6),n.fill();const l=.5+.5*Math.sin(Date.now()/200);n.strokeStyle=`rgba(255, 68, 68, ${.6+l*.4})`,n.lineWidth=3,n.stroke(),n.fillStyle="#2a0a0a",n.beginPath(),n.moveTo(d-10,c),n.lineTo(t,c-i*.5),n.lineTo(d+o+10,c),n.closePath(),n.fill(),n.font="bold 24px sans-serif",n.textAlign="center",n.textBaseline="middle",n.fillText("â˜ ï¸",t,s),n.fillStyle="#ff4444",n.font="bold 12px Rubik, sans-serif",n.fillText(`Breeder Shelter Lv${e.level}`,t,c-i*.5-12),n.fillStyle="#ffaa00",n.font="10px Rubik, sans-serif",n.fillText("Spawning wild strays!",t,c+a+14),n.restore()}function Wi(e,t){n.save(),n.fillStyle="#c9a86c",n.beginPath(),n.arc(e,t,ds,0,Math.PI*2),n.fill(),n.strokeStyle="#8B4513",n.lineWidth=1.5,n.stroke(),n.font="10px Rubik, sans-serif",n.fillStyle="#333",n.textAlign="center",n.fillText("Stray",e,t+ds+10),n.restore()}function Yi(e,t,s=1){n.save(),n.translate(e,t),n.beginPath(),n.arc(0,0,31,0,Math.PI*2),n.fillStyle="#5a4a3a",n.fill(),n.fillStyle="#8B4513",n.strokeStyle="#5a3810",n.lineWidth=1;for(let m=0;m<12;m++){const f=m/12*Math.PI*2,g=Math.cos(f)*33,L=Math.sin(f)*33;n.save(),n.translate(g,L),n.rotate(f+Math.PI/2),n.beginPath(),n.moveTo(-5/2,18/2),n.lineTo(-5/2,-18/2+3),n.lineTo(0,-18/2-3),n.lineTo(5/2,-18/2+3),n.lineTo(5/2,18/2),n.closePath(),n.fill(),n.stroke(),n.restore()}n.beginPath(),n.moveTo(-12,8),n.lineTo(0,-10),n.lineTo(12,8),n.closePath(),n.fillStyle="#D2B48C",n.fill(),n.strokeStyle="#8B7355",n.lineWidth=1.5,n.stroke(),n.beginPath(),n.moveTo(-4,8),n.lineTo(0,2),n.lineTo(4,8),n.fillStyle="#4a3a2a",n.fill();const c=16,l=4,y=n.createRadialGradient(c,l,0,c,l,12);y.addColorStop(0,"rgba(255, 107, 53, 0.6)"),y.addColorStop(.5,"rgba(255, 165, 0, 0.3)"),y.addColorStop(1,"rgba(255, 69, 0, 0)"),n.beginPath(),n.arc(c,l,12,0,Math.PI*2),n.fillStyle=y,n.fill(),n.fillStyle="#5a4a3a",n.fillRect(c-6,l+2,12,3),n.fillRect(c-4,l+1,8,3),n.beginPath(),n.moveTo(c-4,l+2),n.quadraticCurveTo(c-2,l-6,c,l-8),n.quadraticCurveTo(c+2,l-6,c+4,l+2),n.fillStyle="#FF6B35",n.fill(),n.beginPath(),n.moveTo(c-2,l+1),n.quadraticCurveTo(c,l-4,c+2,l+1),n.fillStyle="#FFD700",n.fill(),n.restore();const v=e+35-10,I=t-35+5;n.fillStyle="#fff",n.beginPath(),n.roundRect(v-10,I-8,20,16,3),n.fill(),n.strokeStyle="#333",n.lineWidth=1,n.stroke(),n.fillStyle="#000",n.font="bold 11px sans-serif",n.textAlign="center",n.textBaseline="middle",n.fillText(`${s}`,v,I),n.font="bold 10px Rubik, sans-serif",n.fillStyle="#ff6b6b",n.textAlign="center",n.textBaseline="alphabetic",n.fillText(`Breeder Camp Lv${s}`,e,t+35+12)}function zi(e){const t=us;if(n.save(),e.type===Ds){Yi(e.x,e.y,e.level??1),n.restore();return}let s="#7bed9f",i="#2d5a38",o="+Size";e.type===Lo?(s="#70a3ff",i="#2d4a6e",o="Speed"):e.type===$s&&(s="#c77dff",i="#6a3d7a",o="Port"),n.fillStyle=s,n.fillRect(e.x-t,e.y-t,t*2,t*2),n.strokeStyle=i,n.lineWidth=2,n.strokeRect(e.x-t,e.y-t,t*2,t*2),n.fillStyle="#333",n.font="10px Rubik, sans-serif",n.textAlign="center",n.fillText(o,e.x,e.y+us+10),n.restore()}function Gi(e){var t;try{const s=uo(),i=Number.isFinite(s.x)?Math.max(0,Math.min(G-s.w,s.x)):0,o=Number.isFinite(s.y)?Math.max(0,Math.min(V-s.h,s.y)):0,a={x:i,y:o,w:s.w,h:s.h};if(n.save(),n.translate(-a.x,-a.y),$i(a),r){for(const b of r.adoptionZones)Di(b);for(const b of r.pickups??[])zi(b);for(const b of r.shelters??[]){const u=b.ownerId===P,S=r.players.find(w=>w.id===b.ownerId),T=S==null?void 0:S.shelterColor;_i(b,u,T)}for(const b of r.breederShelters??[])Fi(b)}for(const b of(r==null?void 0:r.pets)??[]){if(b.insideShelterId!==null)continue;const u=Ni(b.id)??b;!Number.isFinite(u.x)||!Number.isFinite(u.y)||u.x===0&&u.y===0||Wi(u.x,u.y)}const d=[...(r==null?void 0:r.players)??[]].sort((b,u)=>b.size-u.size);for(const b of d){const u=b.id===P;let S;if(u&&x){let T=xe??x.x,w=Ie??x.y;(!Number.isFinite(T)||!Number.isFinite(w))&&(T=x.x,w=x.y),(!Number.isFinite(T)||!Number.isFinite(w))&&(T=G/2,w=V/2),S={...x,x:T,y:w}}else S=Oi(b.id)??b;if(!(!Number.isFinite(S.x)||!Number.isFinite(S.y))&&(Ui(S,u),u&&Ks>Date.now())){n.save(),n.setTransform(1,0,0,1,0,0);const T=A.width/2,w=A.height/2-60;n.fillStyle="#7bed9f",n.font="bold 28px Rubik, sans-serif",n.textAlign="center",n.fillText("+1 Size!",T,w),n.restore()}}const c=Date.now();for(let b=Qt.length-1;b>=0;b--){const u=Qt[b],S=c-u.startTime;if(S<0)continue;if(S>Is){Qt.splice(b,1);continue}const T=S/Is,w=1-Math.pow(1-T,3),R=u.fromX+(u.toX-u.fromX)*w,te=u.fromY+(u.toY-u.fromY)*w-Math.sin(T*Math.PI)*50,ne=T<.8?1:1-(T-.8)/.2;n.save(),n.globalAlpha=ne,n.font="bold 32px sans-serif",n.textAlign="center",n.textBaseline="middle",n.fillText(bi[u.petType],R,te),n.restore()}for(const[b,u]of Mt){const S=Date.now()-u.startTime,T=Math.min(1,S/Xn);u.phase==="fadeIn"&&(Ms(u.toX,u.toY,T,!0),T<.5&&Ms(u.fromX,u.fromY,T*2,!1))}n.restore();const l=120/G;E.fillStyle="#2d4a2d",E.fillRect(0,0,120,120);for(let b=0;b<=V;b+=se*3)for(let u=0;u<=G;u+=se*3)E.fillStyle="rgba(255,255,255,0.15)",E.fillRect(u*l-.8,b*l-.8,1.6,1.6);if(r){for(const u of r.adoptionZones){const S=u.radius*l|0;E.fillStyle="rgba(123, 237, 159, 0.6)",E.fillRect(u.x*l-S,u.y*l-S,S*2,S*2)}for(const u of r.pets)u.insideShelterId===null&&(u.x===0&&u.y===0||(E.fillStyle="#c9a86c",E.fillRect(u.x*l-2,u.y*l-2,4,4)));for(const u of r.pickups??[]){const S=u.x*l,T=u.y*l;if(u.type===Ds){const w=.5+.5*Math.sin(Date.now()/200),R=8+w*4;E.save(),E.shadowColor="#ff4444",E.shadowBlur=R,E.fillStyle="#8B4513",E.beginPath(),E.arc(S,T,4,0,Math.PI*2),E.fill(),E.strokeStyle=`rgba(255, 68, 68, ${.7+w*.3})`,E.lineWidth=2,E.stroke(),E.restore()}else E.fillStyle=u.type===ko?"#7bed9f":u.type===$s?"#c77dff":"#70a3ff",E.fillRect(S-2,T-2,4,4)}for(const u of r.shelters??[]){const S=u.ownerId===P;E.fillStyle=S?"#e8d5b7":"#d4c4a8";const T=(at+u.size*rt)*l,w=Math.max(4,T);if(E.fillRect(u.x*l-w,u.y*l-w,w*2,w*2),E.strokeStyle=S?"#7bed9f":"#8B4513",E.lineWidth=1,E.strokeRect(u.x*l-w,u.y*l-w,w*2,w*2),S){const R=u.x*l,te=u.y*l;E.fillStyle="#7bed9f",E.beginPath(),E.moveTo(R,te-w-4),E.lineTo(R-5,te-w+1),E.lineTo(R+5,te-w+1),E.closePath(),E.fill(),E.fillRect(R-3,te-w+1,6,5)}}for(const u of r.breederShelters??[]){const S=u.x*l,T=u.y*l,w=Math.max(6,(40+u.size*.5)*l),R=.5+.5*Math.sin(Date.now()/200);E.save(),E.shadowColor="#ff4444",E.shadowBlur=5+R*5,E.fillStyle="#4a1a1a",E.fillRect(S-w,T-w,w*2,w*2),E.strokeStyle=`rgba(255, 68, 68, ${.7+R*.3})`,E.lineWidth=2,E.strokeRect(S-w,T-w,w*2,w*2),E.restore()}const b=[...r.players].sort((u,S)=>S.totalAdoptions-u.totalAdoptions);for(const u of r.players){let S=u.id===P?"#7bed9f":ls(u.id);u.shelterColor&&(u.shelterColor.startsWith("gradient:")?S=u.shelterColor.split(":")[1]||S:S=u.shelterColor),E.fillStyle=S;const w=50*l,R=b.indexOf(u),te=R===0?1.5:R<=2?1.2:1,ne=Math.max(2,w)*te;E.fillRect(u.x*l-ne,u.y*l-ne,ne*2,ne*2),R===0&&r.players.length>1&&(E.fillStyle="#ffd700",E.beginPath(),E.arc(u.x*l,u.y*l-ne-3,3,0,Math.PI*2),E.fill())}}const y=a.x*l,v=a.y*l,I=a.w*l,m=a.h*l;if(E.strokeStyle="rgba(255,255,255,0.6)",E.lineWidth=1.5,E.strokeRect(y,v,I,m),E.strokeStyle="rgba(255,255,255,0.2)",E.lineWidth=1,E.strokeRect(.5,.5,119,119),ft){const b=A.getBoundingClientRect(),u=A.width/b.width,S=A.height/b.height,T=(sn-b.left)*u,w=(on-b.top)*S,R=(gn-b.left)*u,te=(pn-b.top)*S,ne=R-T,pt=te-w,Oe=Math.hypot(ne,pt),Nt=Math.min(Oe,hs*u),bt=Oe>0?T+ne/Oe*Nt:T,xn=Oe>0?w+pt/Oe*Nt:w;n.save(),n.globalAlpha=.3,n.strokeStyle="#fff",n.lineWidth=3,n.beginPath(),n.arc(T,w,hs*u,0,Math.PI*2),n.stroke(),n.fillStyle="rgba(255,255,255,0.1)",n.fill(),n.globalAlpha=.6,n.fillStyle="#7bed9f",n.beginPath(),n.arc(bt,xn,20*u,0,Math.PI*2),n.fill(),n.strokeStyle="#fff",n.lineWidth=2,n.stroke(),n.restore()}const f=(r==null?void 0:r.players.find(b=>b.id===P))??x,g=f?Math.floor(f.size):0,L=Math.min(g,Ns),M=(f==null?void 0:f.petsInside.length)??0,U=(r==null?void 0:r.pets.filter(b=>b.insideShelterId===null).length)??0;Wo.textContent=f!=null&&f.eliminated?"Observer Mode":`Size: ${g}`,Yo.textContent=f!=null&&f.eliminated?"WASD to pan | Drag to move":`Pets: ${M}/${L}`;const O=!!(f!=null&&f.shelterId),C=!!(f!=null&&f.eliminated),k=(f==null?void 0:f.money)??0,Y=f&&f.size>=50&&!O&&!C&&q==="playing";ai.textContent=`${k} RT`;const $=f&&!C&&q==="playing";$?(kt.classList.remove("hidden"),kt.disabled=!1,kt.textContent="Menu [E]"):kt.classList.add("hidden"),it&&($?je():(it=!1,cn.classList.add("hidden"))),Yn.classList.add("hidden");const _=(f==null?void 0:f.portCharges)??0;f&&_>0&&!C&&q==="playing"?(Zt.textContent=`Port [P] (${_})`,Zt.classList.remove("hidden")):Zt.classList.add("hidden");const F=Math.abs(qe)>50||Math.abs(Je)>50,N=f!=null&&f.shelterId?((t=r==null?void 0:r.shelters)==null?void 0:t.find(b=>b.id===f.shelterId))??null:null;f&&!C&&q==="playing"&&F?dn.classList.remove("hidden"):dn.classList.add("hidden"),f&&!C&&q==="playing"&&N&&Math.hypot(N.x-((x==null?void 0:x.x)??0)-qe,N.y-((x==null?void 0:x.y)??0)-Je)>100?Bt.classList.remove("hidden"):Bt.classList.add("hidden");const J=(r==null?void 0:r.tick)??0,X=Os,ce=f&&(f.speedBoostUntil??0)>J?((f.speedBoostUntil-J)/X).toFixed(1):"";gs&&(gs.textContent=f?`Adoptions: ${f.totalAdoptions}  â€¢  Strays: ${U}${ce?`  â€¢  Speed: ${ce}s`:""}`:"");const ge=(r==null?void 0:r.matchEndAt)??0,pe=Math.max(0,ge-J)/X,be=(r==null?void 0:r.shelters)??[],fe=G*V,ve=be.reduce((b,u)=>!b||u.size>b.size?u:b,null),_e=ve?at+ve.size*rt:0,ht=Math.PI*_e*_e,Ve=fe>0?Math.floor(ht/fe*100):0,yt=r==null?void 0:r.players.find(b=>b.shelterId===(ve==null?void 0:ve.id)),mt=(yt==null?void 0:yt.displayName)??"None",gt=(r==null?void 0:r.scarcityLevel)??0,En=gt>0?` [Scarcity ${gt}]`:"";zo.textContent=q==="playing"?`Goal: 51% | ${mt}: ${Ve}%${En}`:"";const Ot=(r==null?void 0:r.matchDurationMs)??0,Ze=Math.floor(Ot/1e3),wn=Math.floor(Ze/3600),Sn=Math.floor(Ze%3600/60),Fe=Ze%60;Go.textContent=`${wn.toString().padStart(2,"0")}:${Sn.toString().padStart(2,"0")}:${Fe.toString().padStart(2,"0")}`;const Ee=!!(f!=null&&f.eliminated);if((pe<=0||Ee)&&(r!=null&&r.players.length)){Tt||(Tt=!0,Oo()),$e.classList.add("show");const b=pe<=0&&!(r!=null&&r.matchEndedEarly),u=[...r.players].sort((D,K)=>b?K.size-D.size||K.totalAdoptions-D.totalAdoptions:D.eliminated!==K.eliminated?(D.eliminated?1:0)-(K.eliminated?1:0):D.eliminated?D.totalAdoptions-K.totalAdoptions:K.size-D.size||K.totalAdoptions-D.totalAdoptions),S=u.find(D=>D.id===P),T=S&&!S.eliminated?Math.floor(S.size):0,w=[100,50,25],R=S?u.findIndex(D=>D.id===P)+1:0,te=R>0&&R<=w.length&&!Ee?w[R-1]:0,ne=Ee?0:T+te,pt=Tt&&!qt?re()+ne:re();qt||(Ke(pt),qt=!0);const Oe=R===1?"Win bonus":R===2?"2nd place":R===3?"3rd place":R>0?`${R}th place`:"",Nt=ne>0?`<br><br><strong>Total: ${pt.toLocaleString()} RT</strong>${Oe?`<br>${Oe}: +${te} RT`:""}`:Ee?`<br><br><strong>Total: ${re().toLocaleString()} RT</strong>`:"";let bt="Match over";if(Ee)bt="You were consumed";else if(r&&r.winnerId){const D=r.winnerId,K=r.players.find(So=>So.id===D);bt=`${(K==null?void 0:K.id)===P?"You":(K==null?void 0:K.displayName)??"Someone"} achieved 51% domination!`}const xn=`
      <div class="match-ads">
        <div class="match-ad-slot">
          <h4>Sponsored</h4>
          <div id="match-ad-slot" class="match-ad-placeholder">Ad placeholder</div>
        </div>
        <div class="match-self-promo">
          <h4>Boost your shelter</h4>
          <p>Earn Rescue Tokens each match to buy boosts. Invite friends with your referral link. For every 5 confirmed signups, unlock a special shelter skin.</p>
        </div>
      </div>
    `,wo=D=>D.eliminated?"â€”":`${Math.floor(D.size)}`;$e.innerHTML=`<strong>${bt}</strong><br><br>`+u.map((D,K)=>`${K+1}. ${D.id===P?"You":D.displayName??D.id}: size ${wo(D)} (${D.totalAdoptions} adoptions)`).join("<br>")+Nt+xn+'<button type="button" id="play-again-btn" class="fight-ally-btn ally-btn" style="margin-right:8px">Play again</button><button type="button" id="lobby-btn" class="fight-ally-btn fight-btn">Back to lobby</button>'}else $e.classList.remove("show")}catch(s){console.error("Render error:",s),n.save(),n.setTransform(1,0,0,1,0,0),n.fillStyle="#3d6b3d",n.fillRect(0,0,A.width,A.height),n.restore()}}let Nn=!1;function as(e){Nn||(Nn=!0,setTimeout(()=>{Nn=!1},500),e.id==="play-again-btn"?(h&&(h.close(),h=null),$e.classList.remove("show"),Tt=!1,qn=!1,r=null,ee.classList.remove("hidden"),ee.innerHTML=ye==="ffa"?"<h2>Connectingâ€¦</h2><p>Joining FFA lobbyâ€¦</p>":"<h2>Connectingâ€¦</h2><p>Starting new match.</p>",he.classList.add("hidden"),os({mode:ye}).then(()=>{ee.classList.add("hidden"),ee.innerHTML="",rn.classList.add("visible"),requestAnimationFrame(is)}).catch(t=>ss(t.message||"Connection failed."))):e.id==="lobby-btn"&&(h&&(h.close(),h=null),$e.classList.remove("show"),Tt=!1,qt=!1,r=null,rn.classList.remove("visible"),Qn.classList.remove("hidden"),he.classList.remove("hidden"),Re(),rs()))}$e.addEventListener("click",e=>{const s=e.target.closest("button");s&&(e.preventDefault(),e.stopPropagation(),as(s))},!0);$e.addEventListener("mouseup",e=>{const s=e.target.closest("button");s&&e.button===0&&(e.preventDefault(),e.stopPropagation(),as(s))},!0);$e.addEventListener("touchend",e=>{const s=e.target.closest("button");s&&(e.preventDefault(),e.stopPropagation(),as(s))},{passive:!1,capture:!0});tt.addEventListener("click",()=>{un||q!=="countdown"||!h||h.readyState!==WebSocket.OPEN||(un=!0,h.send(JSON.stringify({type:"ready"})),tt.textContent="Ready!",zn.textContent="You're ready! Waiting for other player(s)â€¦")});ri.addEventListener("click",()=>{h&&(h.close(),h=null),et.classList.add("hidden"),rn.classList.remove("visible"),Qn.classList.remove("hidden"),he.classList.remove("hidden"),Re(),rs()});function ho(e){!ze||!h||h.readyState!==WebSocket.OPEN||(h.send(JSON.stringify({type:"fightAlly",targetId:ze,choice:e})),Hn.add(ze),Et.classList.add("hidden"),ze=null)}ei.addEventListener("click",()=>ho("fight"));ti.addEventListener("click",()=>ho("ally"));Yn.addEventListener("click",()=>{!h||h.readyState!==WebSocket.OPEN||(h.send(JSON.stringify({type:"ground"})),Yn.classList.add("hidden"))});Zt.addEventListener("click",()=>{!h||h.readyState!==WebSocket.OPEN||h.send(JSON.stringify({type:"usePort"}))});dn.addEventListener("click",()=>{qe=0,Je=0,dn.classList.add("hidden")});Bt.addEventListener("click",()=>{var s;const e=r==null?void 0:r.players.find(i=>i.id===P),t=e!=null&&e.shelterId?(s=r==null?void 0:r.shelters)==null?void 0:s.find(i=>i.id===e.shelterId):null;t&&x&&(qe=t.x-x.x,Je=t.y-x.y),Bt.classList.add("hidden")});kt.addEventListener("click",()=>{yo()});let it=!1;function yo(){if(q!=="playing")return;const e=r==null?void 0:r.players.find(t=>t.id===P);!e||e.eliminated||(it=!it,it?(cn.classList.remove("hidden"),je()):cn.classList.add("hidden"))}function Hi(){var s;if(!r)return null;const e=r.players.find(i=>i.id===P);return e!=null&&e.shelterId?((s=r.shelters)==null?void 0:s.find(i=>i.id===e.shelterId))??null:null}function je(){const e=r==null?void 0:r.players.find(f=>f.id===P);if(!e)return;const t=Math.floor(e.size),s=e.money??0,i=!!e.shelterId,o=Hi(),a=!!e.vanSpeedUpgrade;i?(ps.classList.add("hidden"),_t.classList.remove("hidden"),Ft.classList.remove("hidden"),Wt.classList.remove("hidden")):(ps.classList.remove("hidden"),_t.classList.add("hidden"),Ft.classList.add("hidden"),Wt.classList.add("hidden"));const d=Math.min(100,t/50*100),c=Math.min(100,s/250*100);si.textContent=`${t}/50`,oi.style.width=`${d}%`,ii.textContent=`${s}/250 RT`,li.style.width=`${c}%`;const l=t>=50&&s>=250&&!i;if(Ne.disabled=!l,l)Ne.textContent="Build Shelter",Ne.classList.add("ready");else if(i)Ne.textContent="Already Built",Ne.classList.remove("ready");else{const f=[];t<50&&f.push(`Size ${t}/50`),s<250&&f.push(`${s}/250 RT`),Ne.textContent=`Need: ${f.join(" & ")}`,Ne.classList.remove("ready")}const y=i&&!(o!=null&&o.hasAdoptionCenter)&&s>=250,v=i&&!(o!=null&&o.hasGravity)&&s>=300,I=i&&!(o!=null&&o.hasAdvertising)&&s>=200,m=!a&&s>=150;wt.disabled=!y,wt.textContent=o!=null&&o.hasAdoptionCenter?"Owned":"Buy",y?wt.classList.add("ready"):wt.classList.remove("ready"),o!=null&&o.hasAdoptionCenter?_t.classList.add("owned"):_t.classList.remove("owned"),St.disabled=!v,St.textContent=o!=null&&o.hasGravity?"Owned":"Buy",v?St.classList.add("ready"):St.classList.remove("ready"),o!=null&&o.hasGravity?Ft.classList.add("owned"):Ft.classList.remove("owned"),xt.disabled=!I,xt.textContent=o!=null&&o.hasAdvertising?"Owned":"Buy",I?xt.classList.add("ready"):xt.classList.remove("ready"),o!=null&&o.hasAdvertising?Wt.classList.add("owned"):Wt.classList.remove("owned"),It.disabled=!m,It.textContent=a?"Owned":"Buy",m?It.classList.add("ready"):It.classList.remove("ready"),a?bs.classList.add("owned"):bs.classList.remove("owned")}document.addEventListener("keydown",e=>{if((e.key==="e"||e.key==="E")&&yo(),(e.key==="p"||e.key==="P")&&h&&h.readyState===WebSocket.OPEN){const t=r==null?void 0:r.players.find(s=>s.id===P);t&&(t.portCharges??0)>0&&!t.eliminated&&q==="playing"&&h.send(JSON.stringify({type:"usePort"}))}});ni.addEventListener("click",()=>{it=!1,cn.classList.add("hidden")});Ne.addEventListener("click",()=>{if(!h||h.readyState!==WebSocket.OPEN)return;const e=r==null?void 0:r.players.find(t=>t.id===P);!e||e.eliminated||e.shelterId||e.size<50||(e.money??0)<250||(h.send(JSON.stringify({type:"buildShelter"})),je())});wt.addEventListener("click",()=>{!h||h.readyState!==WebSocket.OPEN||(h.send(JSON.stringify({type:"buyAdoptionCenter"})),je())});St.addEventListener("click",()=>{!h||h.readyState!==WebSocket.OPEN||(h.send(JSON.stringify({type:"buyGravity"})),je())});xt.addEventListener("click",()=>{!h||h.readyState!==WebSocket.OPEN||(h.send(JSON.stringify({type:"buyAdvertising"})),je())});It.addEventListener("click",()=>{!h||h.readyState!==WebSocket.OPEN||(h.send(JSON.stringify({type:"buyVanSpeed"})),je())});ot.checked=ct();Fn.checked=Hs();ot.addEventListener("change",()=>{Gs(ot.checked),ot.checked&&Pt()});Fn.addEventListener("change",()=>Bo(Fn.checked));Xo.addEventListener("click",()=>qs.classList.toggle("hidden"));Ko.addEventListener("click",()=>qs.classList.add("hidden"));Jo.addEventListener("click",()=>{h&&(h.close(),h=null),ee.classList.remove("hidden"),ee.innerHTML="<h2>Switching serverâ€¦</h2><p>Reconnecting to a closer server.</p>",he.classList.add("hidden"),os({latency:_n,mode:ye}).then(()=>{ee.classList.add("hidden"),ee.innerHTML=""}).catch(e=>{ss(e.message||"Switch failed."),he.classList.remove("hidden")})});function rs(){document.querySelectorAll(".mode-option").forEach(e=>{e.dataset.mode===ye?e.classList.add("selected"):e.classList.remove("selected")})}const Xt=localStorage.getItem(Qs);(Xt==="ffa"||Xt==="teams"||Xt==="solo")&&(ye=Xt);rs();const $n=document.getElementById("solo-options"),Rs=document.getElementById("cpu-shutdown-breeders");function mo(){$n&&(ye==="solo"?$n.classList.remove("hidden"):$n.classList.add("hidden"))}document.querySelectorAll(".mode-option").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".mode-option").forEach(t=>t.classList.remove("selected")),e.classList.add("selected"),ye=e.dataset.mode,localStorage.setItem(Qs,ye),mo()})});mo();Wn.addEventListener("click",async()=>{if(!oe||!oe.referralCode)return;const e=lo(oe.referralCode);try{await navigator.clipboard.writeText(e),He.textContent="Referral link copied."}catch{const t=document.createElement("input");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),He.textContent="Referral link copied."}});Vt.addEventListener("click",async()=>{try{const t=await(await fetch("/referrals/claim",{method:"POST",credentials:"include"})).json();if(t.ok){const s=typeof t.moneyBonus=="number"?t.moneyBonus:0;s>0&&Ke(re()+s),localStorage.setItem(pi,"1"),He.textContent="Reward claimed. Special skin unlocked.",await ao(),ro(),Re()}else He.textContent="Reward not available yet."}catch{He.textContent="Unable to claim reward. Try again."}});jo.addEventListener("click",()=>{Pt(),Qn.classList.add("hidden"),ee.classList.remove("hidden"),ee.innerHTML="<h2>Connectingâ€¦</h2><p>Waiting for game server.</p>",he.classList.add("hidden"),os({mode:ye}).then(()=>{ee.classList.add("hidden"),rn.classList.add("visible"),ot&&(ot.checked=ct()),requestAnimationFrame(is)}).catch(e=>{ss(e.message||"Connection failed."),he.classList.remove("hidden")})});localStorage.getItem(ts)||es.classList.remove("hidden");Vo.addEventListener("click",()=>{localStorage.setItem(ts,"full"),es.classList.add("hidden")});Zo.addEventListener("click",()=>{localStorage.setItem(ts,"essential"),es.classList.add("hidden")});Re();document.querySelectorAll(".landing-buy").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.boost;if(!t||!(t in hn))return;const s=hn[t],i=re();i<s||(Ke(i-s),t==="size"?Q.sizeBonus+=1:t==="speed"?Q.speedBoost=!0:t==="adoptSpeed"&&(Q.adoptSpeed=!0),Re())})});Xe();document.querySelectorAll(".color-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.color;t&&(dt(t),Xe())})});document.querySelectorAll(".preset-color").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.color;t&&bn().preset&&(dt(t),Xe())})});const le=document.getElementById("color-picker-modal"),Qe=document.getElementById("color-picker-input"),Ge=document.getElementById("color-picker-input2"),Kt=document.getElementById("color-picker-title"),Dn=document.getElementById("color-picker-cancel"),Un=document.getElementById("color-picker-confirm");let Vn="custom";document.querySelectorAll(".color-buy").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.color,s=yn[t],i=bn(),o=re();if(t==="preset"){if(i.preset||o<s)return;Ke(o-s),Kn({...i,preset:!0}),Re(),Xe()}else if(t==="custom"){if(i.custom){dt(i.custom),Xe();return}if(o<s)return;Vn="custom",Kt&&(Kt.textContent="Pick Your Custom Color"),Ge&&(Ge.style.display="none"),le==null||le.classList.remove("hidden")}else if(t==="gradient"){if(i.gradient){dt(i.gradient),Xe();return}if(o<s)return;Vn="gradient",Kt&&(Kt.textContent="Pick Gradient Colors"),Ge&&(Ge.style.display="block"),le==null||le.classList.remove("hidden")}})});Dn==null||Dn.addEventListener("click",()=>{le==null||le.classList.add("hidden")});Un==null||Un.addEventListener("click",()=>{const e=bn(),t=re();if(Vn==="custom"){const s=(Qe==null?void 0:Qe.value)||"#ff5500";Ke(t-yn.custom),Kn({...e,custom:s}),dt(s)}else{const s=(Qe==null?void 0:Qe.value)||"#ff5500",i=(Ge==null?void 0:Ge.value)||"#00aaff",o=`gradient:${s}:${i}`;Ke(t-yn.gradient),Kn({...e,gradient:o}),dt(o)}le==null||le.classList.add("hidden"),Re(),Xe()});vt&&(vt.checked=ct(),vt.addEventListener("change",()=>{Gs(vt.checked),vt.checked&&Pt()}));ct()&&Pt();function Xi(e,t=1){p.active=!0,p.pets=[],p.selectedPetIndex=null,p.timeLeft=30+t*5,p.totalPets=e,p.rescuedCount=0,p.level=t,p.selectedIngredients=[];const s=["dog","cat","horse","bird"];for(let c=0;c<e;c++){const l=s[Math.floor(Math.random()*s.length)];p.pets.push({type:l,rescued:!1})}Ki(t),mn(),lt(),st(),Js.classList.add("hidden"),De.style.display="flex",Gn.classList.add("show");const i=Gn.querySelector(".breeder-title");i&&(i.textContent=`ðŸš¨ Stop Level ${t} Breeders!`);const o=document.getElementById("breeder-instruction-1"),a=document.getElementById("breeder-instruction-2"),d=Rt(t);o&&a&&(d===1?(o.textContent="1. Click a pet to select it",a.textContent="2. Click the matching food to rescue it!"):(o.textContent=`1. Click ${d} ingredients to make a meal`,a.textContent="2. Select a pet - if the meal matches, they're rescued!")),p.timerInterval=setInterval(()=>{p.timeLeft--,ci.textContent=`${p.timeLeft}s`,p.timeLeft<=0&&Zn(!1)},1e3)}function Ki(e){const t=De.querySelector('[data-food="water"]'),s=De.querySelector('[data-food="bowl"]');t&&(t.style.display=e>=6?"flex":"none"),s&&(s.style.display=e>=10?"flex":"none")}function st(){var a;const e=Rt(p.level);let t=document.getElementById("breeder-selected-ingredients");if(t||(t=document.createElement("div"),t.id="breeder-selected-ingredients",t.className="breeder-ingredients",(a=De.parentNode)==null||a.insertBefore(t,De)),e<=1){t.style.display="none";return}t.style.display="flex";const s={apple:"ðŸŽ",carrot:"ðŸ¥•",chicken:"ðŸ—",seeds:"ðŸŒ»",water:"ðŸ’§",bowl:"ðŸ¥£"},i=[];for(let d=0;d<e;d++)if(d<p.selectedIngredients.length){const c=p.selectedIngredients[d];i.push(`<div class="ingredient-slot filled">${s[c]}</div>`)}else i.push('<div class="ingredient-slot empty">?</div>');t.innerHTML=`
    <span class="ingredients-label">Building meal (${p.selectedIngredients.length}/${e}):</span>
    <div class="ingredient-slots">${i.join("")}</div>
    ${p.selectedIngredients.length>0?'<button type="button" class="clear-ingredients-btn" id="clear-ingredients">Clear</button>':""}
  `;const o=document.getElementById("clear-ingredients");o&&o.addEventListener("click",()=>{p.selectedIngredients=[],st(),lt()})}function mn(){vs.innerHTML=p.pets.map((e,t)=>`
    <div class="breeder-pet${e.rescued?" rescued":""}${p.selectedPetIndex===t?" selected":""}" 
         data-index="${t}">
      <span>${gi[e.type]}</span>
      <span class="breeder-pet-label">${e.type}</span>
    </div>
  `).join(""),vs.querySelectorAll(".breeder-pet:not(.rescued)").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.index??"-1",10);t>=0&&!p.pets[t].rescued&&(p.selectedPetIndex=t,mn(),lt())})})}function lt(){const e=r==null?void 0:r.players.find(i=>i.id===P),t=(e==null?void 0:e.money)??0;di.textContent=`Your Tokens: ${t} RT`;const s=Rt(p.level);De.querySelectorAll(".breeder-food-btn").forEach(i=>{const o=i.dataset.food,a=Zs[o],d=t>=a,c=p.selectedIngredients.includes(o);s===1?i.disabled=!d||p.selectedPetIndex===null:i.disabled=!d||c})}function qi(e,t){const s=Rt(p.level),i=mi[s];if(!i)return!1;const o=[...e].sort();for(const a of i){if(!a.worksOn.includes(t))continue;const d=[...a.ingredients].sort();if(o.length!==d.length)continue;let c=!0;for(let l=0;l<o.length;l++)if(o[l]!==d[l]){c=!1;break}if(c)return!0}return!1}function Ji(e){const t=Zs[e],s=r==null?void 0:r.players.find(a=>a.id===P);if(((s==null?void 0:s.money)??0)<t)return;const o=Rt(p.level);if(o===1){if(p.selectedPetIndex===null)return;const a=p.pets[p.selectedPetIndex];if(!a||a.rescued)return;if((h==null?void 0:h.readyState)===WebSocket.OPEN){const c=yi[e].includes(a.type);h.send(JSON.stringify({type:"breederUseFood",food:e,petIndex:p.selectedPetIndex,petType:a.type,success:c})),c?(a.rescued=!0,p.rescuedCount++,p.selectedPetIndex=null,tn(),p.rescuedCount>=p.totalPets?Zn(!0):mn()):nn(),lt()}return}if(p.selectedIngredients.includes(e)){Be("Already added to meal!");return}if((h==null?void 0:h.readyState)===WebSocket.OPEN&&h.send(JSON.stringify({type:"breederUseFood",food:e,petIndex:-1,petType:"ingredient",success:!1})),p.selectedIngredients.push(e),st(),lt(),p.selectedIngredients.length>=o){if(p.selectedPetIndex===null){Be("Select a pet to feed this meal to!");return}const a=p.pets[p.selectedPetIndex];if(!a||a.rescued){p.selectedIngredients=[],st();return}qi(p.selectedIngredients,a.type)?(a.rescued=!0,p.rescuedCount++,p.selectedPetIndex=null,p.selectedIngredients=[],tn(),Be("Meal complete! Pet rescued!"),p.rescuedCount>=p.totalPets?Zn(!0):(mn(),st())):(p.selectedIngredients=[],nn(),Be("Wrong meal! Ingredients wasted."),st()),lt()}}function Zn(e){p.timerInterval&&(clearInterval(p.timerInterval),p.timerInterval=null),(h==null?void 0:h.readyState)===WebSocket.OPEN&&h.send(JSON.stringify({type:"breederComplete",rescuedCount:p.rescuedCount,totalPets:p.totalPets})),De.style.display="none",Js.classList.remove("hidden"),fi.textContent=e?"All Pets Rescued!":`Time's Up! (${p.rescuedCount}/${p.totalPets})`,js.innerHTML='<p style="color:rgba(255,255,255,0.7)">Calculating rewards...</p>'}function ji(e,t){const s=t.some(l=>l.type==="penalty"),i=e>0||t.some(l=>l.type!=="penalty"),o=[],a=t.find(l=>l.type==="penalty");a&&o.push(`<div class="breeder-reward-item" style="color:#ff6b6b;">-${a.amount} Size (pets escaped!)</div>`),e>0&&o.push(`<div class="breeder-reward-item">+${e} RT</div>`),t.forEach(l=>{l.type==="size"&&o.push(`<div class="breeder-reward-item">+${l.amount} Size</div>`),l.type==="speed"&&o.push('<div class="breeder-reward-item">Speed Boost!</div>'),l.type==="port"&&o.push(`<div class="breeder-reward-item">+${l.amount} Port Charge</div>`)});const d=i?"ðŸŽ Rescue Chest":s?"âŒ Breeder Escape!":"No Rewards",c=i?"#ffd93d":"#ff6b6b";js.innerHTML=`
    <div class="breeder-result-title" style="color:${c};margin-bottom:8px;">${d}</div>
    ${o.join("")}
  `}function Vi(){p.active=!1,Gn.classList.remove("show")}De.querySelectorAll(".breeder-food-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.food;t&&Ji(t)})});ui.addEventListener("click",Vi);let j=null;function go(e){const t=[];return e.tokens>0&&t.push(`${e.tokens} RT`),e.sizeBonus&&t.push(`+${e.sizeBonus} Size`),e.speedBoost&&t.push("Speed"),e.portCharge&&t.push("Port"),t.join(" + ")}function po(){if(!j)return;const{currentDay:e,canClaimToday:t,rewards:s}=j;let i="";const o=!Pe;for(let a=0;a<7;a++){const d=a+1,c=s[a];let l=!1,y=!1,v=!0;o||(l=d===e&&t,y=d<e||d===e&&!t,v=d>e);const I=["daily-gift-day",l?"current":"",y?"claimed":"",v||o?"locked":"",d===7?"daily-gift-day7":""].filter(Boolean).join(" ");i+=`
      <div class="${I}">
        <div class="daily-gift-day-label">Day ${d}</div>
        <div class="daily-gift-day-icon">${y?"âœ“":"ðŸ”’"}</div>
        <div class="daily-gift-day-reward">${go(c)}</div>
      </div>
    `}Pe?(Es.innerHTML=i,We.classList.remove("hidden"),t?(We.disabled=!1,We.textContent=`Claim Day ${e} Gift`,Mn.textContent="Play to unlock today's gift!"):(We.disabled=!0,We.textContent="Come back tomorrow!",Mn.textContent=`Next gift: Day ${e>7?1:e}`)):(i=`
      <div class="daily-gift-signin-overlay">
        <div class="daily-gift-signin-message">Sign in for daily gifts!</div>
        <div class="daily-gift-signin-buttons">
          <a href="${ie("/auth/google")}" class="daily-gift-signin-btn google">Sign in with Google</a>
          <a href="${ie("/auth/facebook")}" class="daily-gift-signin-btn facebook">Sign in with Facebook</a>
        </div>
      </div>
      <div class="daily-gift-grid-greyed">${i}</div>
    `,Es.innerHTML=i,We.classList.add("hidden"),Mn.textContent="")}async function bo(){if(Ct.classList.remove("hidden"),!Pe){j={currentDay:1,canClaimToday:!0,lastClaimDate:null,totalClaims:0,rewards:[{tokens:15},{tokens:25,speedBoost:!0},{tokens:40},{tokens:50,sizeBonus:3},{tokens:75,speedBoost:!0},{tokens:100,portCharge:!0},{tokens:150,sizeBonus:5,speedBoost:!0}]},Ct.classList.add("has-gift");return}try{const e=await fetch("/api/daily-gift",{credentials:"include"});if(!e.ok){j=null;return}j=await e.json(),j!=null&&j.canClaimToday?Ct.classList.add("has-gift"):Ct.classList.remove("has-gift")}catch{j=null}Qi()}function vo(){j&&(po(),Vs.classList.add("show"))}function Eo(){Vs.classList.remove("show")}async function Zi(){var e;if(!Pe){Be("Sign in to collect daily rewards!"),Eo();return}if(j!=null&&j.canClaimToday)try{const t=await fetch("/api/daily-gift/claim",{method:"POST",credentials:"include"});if(!t.ok){const o=await t.json();Be(o.error||"Failed to claim gift");return}const s=await t.json();(e=s.reward)!=null&&e.tokens&&(Ke(re()+s.reward.tokens),Re()),await bo(),po();const i=go(s.reward);Be(`Gift claimed: ${i}`)}catch{Be("Failed to claim gift")}}Ct.addEventListener("click",vo);hi.addEventListener("click",Eo);We.addEventListener("click",Zi);Lt.addEventListener("click",vo);function Qi(){j?(Lt.classList.remove("hidden"),j.canClaimToday||!Pe?Lt.classList.add("has-gift"):Lt.classList.remove("has-gift")):Lt.classList.add("hidden")}xi();ki();Re();window.addEventListener("resize",co);co();
